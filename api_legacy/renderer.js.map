{"version":3,"file":"renderer.js","sourceRoot":"","sources":["../../src/api_legacy/renderer.tsx"],"names":[],"mappings":"AAAA;yFACyF;AAEzF,OAAO,EAAE,WAAW,EAAE,MAAM,UAAU,CAAC;AAEvC,OAAO,EAAe,eAAe,EAAE,wBAAwB,EAAE,8BAA8B,EAAE,MAAM,SAAS,CAAC;AAGjH,6EAA6E;AAG7E,iEAAiE;AACjE,iDAAiD;AAGjD,MAAM,cAAe,SAAQ,KAAK;IAChC,YAAmB,gBAA0B;QAC3C,KAAK,CAAC,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QADlB,qBAAgB,GAAhB,gBAAgB,CAAU;QAE3C,MAAM,CAAC,cAAc,CAAC,IAAI,EAAE,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;IACpD,CAAC;CACF;AAGD,MAAM,CAAC,KAAK,UAAU,OAAO,CAAI,YAAoB,EAAE,GAAG,IAAW;IACnE,kGAAkG;IAClG,oCAAoC;IAEpC,MAAM,UAAU,GAAG,wBAAwB,CAAC,YAAY,CAAC,CAAC;IAC1D,OAAO,IAAI,OAAO,CAAI,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;QACxC,SAAS,UAAU,CAAC,GAAQ,EAAE,OAAe;YAC3C,WAAW,CAAC,cAAc,CAAC,UAAU,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;YAC5D,MAAM,IAAI,GAAQ,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,eAAe,CAAC,CAAC;YAEvD,IAAI,IAAI,CAAC,MAAM,KAAK,SAAS,EAAE;gBAC7B,wCAAwC;gBACxC,MAAM,IAAI,GAAmB,IAAI,CAAC;gBAElC,IAAI,IAAI,CAAC,MAAM,KAAK,SAAS,EAAE;oBAC7B,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;wBAC1B,MAAM,CAAC,IAAI,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;qBACzC;yBAAM;wBACL,MAAM,CAAC,IAAI,cAAc,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;qBAC/C;iBACF;gBACD,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;aACtB;iBAAM;gBACL,iDAAiD;gBACjD,MAAM,IAAI,GAAM,IAAI,CAAC;gBACrB,OAAO,CAAC,IAAI,CAAC,CAAC;aACf;QACH,CAAC;QACD,WAAW,CAAC,EAAE,CAAC,UAAU,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;QAChD,WAAW,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC;IAC/D,CAAC,CAAC,CAAC;AACL,CAAC;AAGD,MAAM,UAAU,UAAU,CAAC,YAAoB,EAAE,MAAY;IAC3D,MAAM,UAAU,GAAG,8BAA8B,CAAC,YAAY,CAAC,CAAC;IAChE,WAAW,CAAC,QAAQ,CAAC,UAAU,CAAC,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM,IAAI,EAAE,CAAC,CAAC,CAAC;AACzE,CAAC;AAGD,SAAS,aAAa,CAAC,IAAW;IAChC;;2EAEuE;IAEvE,OAAO,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;AAC9C,CAAC","sourcesContent":["/* Simple API on top of Electron’s IPC framework, the `renderer` side.\n   Provides functions for sending API requests to fetch/store data and/or open window. */\n\nimport { ipcRenderer } from 'electron';\n\nimport { APIResponse, reviveJsonValue, getEventNamesForEndpoint, getEventNamesForWindowEndpoint } from './utils';\n\n\n// TODO (#4): Refactor into generic main APIs, rather than Workspace-centered\n\n\n// TODO: Implement hook for using time travel APIs with undo/redo\n// and transactions for race condition avoidance.\n\n\nclass RequestFailure extends Error {\n  constructor(public errorMessageList: string[]) {\n    super(errorMessageList.join('; '));\n    Object.setPrototypeOf(this, new.target.prototype);\n  }\n}\n\n\nexport async function request<T>(endpointName: string, ...args: any[]): Promise<T> {\n  // TODO: This does not handle a timeout, so if `main` endpoint is misconfigured and never responds\n  // the handler will remain listening\n\n  const eventNames = getEventNamesForEndpoint(endpointName);\n  return new Promise<T>((resolve, reject) => {\n    function handleResp(evt: any, rawData: string) {\n      ipcRenderer.removeListener(eventNames.response, handleResp);\n      const data: any = JSON.parse(rawData, reviveJsonValue);\n\n      if (data.errors !== undefined) {\n        // Means main is using listen(), new API\n        const resp: APIResponse<T> = data;\n\n        if (resp.result === undefined) {\n          if (resp.errors.length > 0) {\n            reject(new RequestFailure(resp.errors));\n          } else {\n            reject(new RequestFailure([\"Unknown error\"]));\n          }\n        }\n        resolve(data.result);\n      } else {\n        // Means main is using makeEndpoint(), legacy API\n        const resp: T = data;\n        resolve(resp);\n      }\n    }\n    ipcRenderer.on(eventNames.response, handleResp);\n    ipcRenderer.send(eventNames.request, ...serializeArgs(args));\n  });\n}\n\n\nexport function openWindow(endpointName: string, params?: any): void {\n  const eventNames = getEventNamesForWindowEndpoint(endpointName);\n  ipcRenderer.sendSync(eventNames.request, JSON.stringify(params || {}));\n}\n\n\nfunction serializeArgs(args: any[]): string[] {\n  /* Helper function that stringifies an array of objects with JSON.\n     We don’t necessarily want Electron to handle that for us,\n     because we might want custom parsing for e.g. timestamps in JSON. */\n\n  return args.map(val => JSON.stringify(val));\n}\n"]}