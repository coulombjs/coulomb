import React from 'react';
import * as log from 'electron-log';
import * as ReactDOM from 'react-dom';
import { NonIdealState, Spinner } from '@blueprintjs/core';
import '!style-loader!css-loader!@blueprintjs/datetime/lib/css/blueprint-datetime.css';
import '!style-loader!css-loader!@blueprintjs/core/lib/css/blueprint.css';
import '!style-loader!css-loader!./normalize.css';
import '!style-loader!css-loader!./renderer.css';
// Render application screen in a new window
// with given top-level window UI component and (if applicable) any parameters
// wrapped in configured context provider components.
export const renderApp = async (config) => {
    // electron-webpack guarantees presence of #app in index.html it bundles
    const appRoot = document.getElementById('app');
    // Add a class allowing platform-specific styling
    document.documentElement.classList.add(`platform--${process.platform}`);
    // Get all params passed to the window via GET query string
    const searchParams = new URLSearchParams(window.location.search);
    // Prepare getter for requested top-level window UI React component
    const componentId = searchParams.get('c');
    const componentImporter = componentId ? config.windowComponents[componentId] : null;
    log.debug(`Requested window component ${componentId}`);
    // Fetch top-level UI component class and render it.
    if (componentImporter) {
        // Show loading indicator while components are being resolved
        ReactDOM.render(React.createElement(Spinner, null), appRoot);
        // Get props prescribed for each context provider component
        var ctxProviderOptions = config.contextProviders.map(item => item.opts);
        // Resolve (import) components in parallel, first UI and then context providers
        const promisedComponents = await Promise.all([
            componentImporter(),
            ...config.contextProviders.map(async (ctxp) => await ctxp.cls()),
        ]);
        // Break down components into top-level window UI & context providers
        const TopWindowComponent = promisedComponents[0].default;
        var ctxProviderComponents = promisedComponents.
            slice(1, promisedComponents.length).
            map(item => item.default);
        // Reorder context providers so that top-most is the most basic
        ctxProviderComponents.reverse();
        ctxProviderOptions.reverse();
        // Write out top-level window component JSX
        var appMarkup = React.createElement(TopWindowComponent, { query: searchParams });
        log.debug(`C/renderApp: Got context provider components`, ctxProviderComponents);
        // Wrap the JSX into context provider components
        for (const [idx, ContextProvider] of ctxProviderComponents.entries()) {
            log.verbose(`C/renderApp: Initializing context provider #${idx}`, ctxProviderComponents[idx], ctxProviderOptions[idx]);
            appMarkup = (React.createElement(ContextProvider, Object.assign({}, ctxProviderOptions[idx](config)), appMarkup));
        }
        log.debug("C/renderApp: Rendering");
        // Render the JSX
        ReactDOM.render(appMarkup, appRoot);
    }
    else {
        // Component specified in GET params is not present in app renderer config.
        // TODO: Handle misconfigured React context providers and failed import at runtime
        ReactDOM.render(React.createElement(NonIdealState, { icon: "error", title: "Unknown component requested" }), appRoot);
    }
    return {
        root: appRoot,
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBwL3JlbmRlcmVyLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxLQUFLLFFBQVEsTUFBTSxXQUFXLENBQUM7QUFJdEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUzRCxPQUFPLCtFQUErRSxDQUFDO0FBQ3ZGLE9BQU8sa0VBQWtFLENBQUM7QUFDMUUsT0FBTywwQ0FBMEMsQ0FBQztBQUNsRCxPQUFPLHlDQUF5QyxDQUFDO0FBUWpELDRDQUE0QztBQUM1Qyw4RUFBOEU7QUFDOUUscURBQXFEO0FBQ3JELE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBRyxLQUFLLEVBQW9ELE1BQVMsRUFBd0IsRUFBRTtJQUVuSCx3RUFBd0U7SUFDeEUsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQWdCLENBQUM7SUFFOUQsaURBQWlEO0lBQ2pELFFBQVEsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxhQUFhLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBRXhFLDJEQUEyRDtJQUMzRCxNQUFNLFlBQVksR0FBRyxJQUFJLGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRWpFLG1FQUFtRTtJQUNuRSxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFDLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUVwRixHQUFHLENBQUMsS0FBSyxDQUFDLDhCQUE4QixXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBRXZELG9EQUFvRDtJQUNwRCxJQUFJLGlCQUFpQixFQUFFO1FBQ3JCLDZEQUE2RDtRQUM3RCxRQUFRLENBQUMsTUFBTSxDQUFDLG9CQUFDLE9BQU8sT0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXRDLDJEQUEyRDtRQUMzRCxJQUFJLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFeEUsK0VBQStFO1FBQy9FLE1BQU0sa0JBQWtCLEdBQWlDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUN6RSxpQkFBaUIsRUFBRTtZQUNuQixHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsTUFBTSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDakUsQ0FBQyxDQUFDO1FBRUgscUVBQXFFO1FBQ3JFLE1BQU0sa0JBQWtCLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ3pELElBQUkscUJBQXFCLEdBQUcsa0JBQWtCO1lBQzVDLEtBQUssQ0FBQyxDQUFDLEVBQUUsa0JBQWtCLENBQUMsTUFBTSxDQUFDO1lBQ25DLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1QiwrREFBK0Q7UUFDL0QscUJBQXFCLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDaEMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFN0IsMkNBQTJDO1FBQzNDLElBQUksU0FBUyxHQUFHLG9CQUFDLGtCQUFrQixJQUFDLEtBQUssRUFBRSxZQUFZLEdBQUksQ0FBQztRQUU1RCxHQUFHLENBQUMsS0FBSyxDQUNQLDhDQUE4QyxFQUM5QyxxQkFBcUIsQ0FBQyxDQUFDO1FBRXpCLGdEQUFnRDtRQUNoRCxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsZUFBZSxDQUFDLElBQUkscUJBQXFCLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDcEUsR0FBRyxDQUFDLE9BQU8sQ0FDVCwrQ0FBK0MsR0FBRyxFQUFFLEVBQ3BELHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxFQUMxQixrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRTNCLFNBQVMsR0FBRyxDQUNWLG9CQUFDLGVBQWUsb0JBQUssa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQ2pELFNBQVMsQ0FDTSxDQUNuQixDQUFDO1NBQ0g7UUFFRCxHQUFHLENBQUMsS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFFcEMsaUJBQWlCO1FBQ2pCLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBRXJDO1NBQU07UUFDTCwyRUFBMkU7UUFDM0Usa0ZBQWtGO1FBQ2xGLFFBQVEsQ0FBQyxNQUFNLENBQUMsb0JBQUMsYUFBYSxJQUM1QixJQUFJLEVBQUMsT0FBTyxFQUNaLEtBQUssRUFBQyw2QkFBNkIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3BEO0lBRUQsT0FBTztRQUNMLElBQUksRUFBRSxPQUFPO0tBQ2QsQ0FBQztBQUVKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcbmltcG9ydCAqIGFzIFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSc7XG5pbXBvcnQgeyBBcHBDb25maWcgfSBmcm9tICcuLi9jb25maWcvYXBwJztcbmltcG9ydCB7IFJlbmRlcmVyQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL3JlbmRlcmVyJztcblxuaW1wb3J0IHsgTm9uSWRlYWxTdGF0ZSwgU3Bpbm5lciB9IGZyb20gJ0BibHVlcHJpbnRqcy9jb3JlJztcblxuaW1wb3J0ICchc3R5bGUtbG9hZGVyIWNzcy1sb2FkZXIhQGJsdWVwcmludGpzL2RhdGV0aW1lL2xpYi9jc3MvYmx1ZXByaW50LWRhdGV0aW1lLmNzcyc7XG5pbXBvcnQgJyFzdHlsZS1sb2FkZXIhY3NzLWxvYWRlciFAYmx1ZXByaW50anMvY29yZS9saWIvY3NzL2JsdWVwcmludC5jc3MnO1xuaW1wb3J0ICchc3R5bGUtbG9hZGVyIWNzcy1sb2FkZXIhLi9ub3JtYWxpemUuY3NzJztcbmltcG9ydCAnIXN0eWxlLWxvYWRlciFjc3MtbG9hZGVyIS4vcmVuZGVyZXIuY3NzJztcblxuXG5pbnRlcmZhY2UgQXBwUmVuZGVyZXIge1xuICByb290OiBIVE1MRWxlbWVudCxcbn1cblxuXG4vLyBSZW5kZXIgYXBwbGljYXRpb24gc2NyZWVuIGluIGEgbmV3IHdpbmRvd1xuLy8gd2l0aCBnaXZlbiB0b3AtbGV2ZWwgd2luZG93IFVJIGNvbXBvbmVudCBhbmQgKGlmIGFwcGxpY2FibGUpIGFueSBwYXJhbWV0ZXJzXG4vLyB3cmFwcGVkIGluIGNvbmZpZ3VyZWQgY29udGV4dCBwcm92aWRlciBjb21wb25lbnRzLlxuZXhwb3J0IGNvbnN0IHJlbmRlckFwcCA9IGFzeW5jIDxBIGV4dGVuZHMgQXBwQ29uZmlnLCBDIGV4dGVuZHMgUmVuZGVyZXJDb25maWc8QT4+KGNvbmZpZzogQyk6IFByb21pc2U8QXBwUmVuZGVyZXI+ID0+IHtcblxuICAvLyBlbGVjdHJvbi13ZWJwYWNrIGd1YXJhbnRlZXMgcHJlc2VuY2Ugb2YgI2FwcCBpbiBpbmRleC5odG1sIGl0IGJ1bmRsZXNcbiAgY29uc3QgYXBwUm9vdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHAnKSBhcyBIVE1MRWxlbWVudDtcblxuICAvLyBBZGQgYSBjbGFzcyBhbGxvd2luZyBwbGF0Zm9ybS1zcGVjaWZpYyBzdHlsaW5nXG4gIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QuYWRkKGBwbGF0Zm9ybS0tJHtwcm9jZXNzLnBsYXRmb3JtfWApO1xuXG4gIC8vIEdldCBhbGwgcGFyYW1zIHBhc3NlZCB0byB0aGUgd2luZG93IHZpYSBHRVQgcXVlcnkgc3RyaW5nXG4gIGNvbnN0IHNlYXJjaFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7XG5cbiAgLy8gUHJlcGFyZSBnZXR0ZXIgZm9yIHJlcXVlc3RlZCB0b3AtbGV2ZWwgd2luZG93IFVJIFJlYWN0IGNvbXBvbmVudFxuICBjb25zdCBjb21wb25lbnRJZCA9IHNlYXJjaFBhcmFtcy5nZXQoJ2MnKTtcbiAgY29uc3QgY29tcG9uZW50SW1wb3J0ZXIgPSBjb21wb25lbnRJZCA/IGNvbmZpZy53aW5kb3dDb21wb25lbnRzW2NvbXBvbmVudElkXSA6IG51bGw7XG5cbiAgbG9nLmRlYnVnKGBSZXF1ZXN0ZWQgd2luZG93IGNvbXBvbmVudCAke2NvbXBvbmVudElkfWApO1xuXG4gIC8vIEZldGNoIHRvcC1sZXZlbCBVSSBjb21wb25lbnQgY2xhc3MgYW5kIHJlbmRlciBpdC5cbiAgaWYgKGNvbXBvbmVudEltcG9ydGVyKSB7XG4gICAgLy8gU2hvdyBsb2FkaW5nIGluZGljYXRvciB3aGlsZSBjb21wb25lbnRzIGFyZSBiZWluZyByZXNvbHZlZFxuICAgIFJlYWN0RE9NLnJlbmRlcig8U3Bpbm5lciAvPiwgYXBwUm9vdCk7XG5cbiAgICAvLyBHZXQgcHJvcHMgcHJlc2NyaWJlZCBmb3IgZWFjaCBjb250ZXh0IHByb3ZpZGVyIGNvbXBvbmVudFxuICAgIHZhciBjdHhQcm92aWRlck9wdGlvbnMgPSBjb25maWcuY29udGV4dFByb3ZpZGVycy5tYXAoaXRlbSA9PiBpdGVtLm9wdHMpO1xuXG4gICAgLy8gUmVzb2x2ZSAoaW1wb3J0KSBjb21wb25lbnRzIGluIHBhcmFsbGVsLCBmaXJzdCBVSSBhbmQgdGhlbiBjb250ZXh0IHByb3ZpZGVyc1xuICAgIGNvbnN0IHByb21pc2VkQ29tcG9uZW50czogeyBkZWZhdWx0OiBSZWFjdC5GQzxhbnk+IH1bXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIGNvbXBvbmVudEltcG9ydGVyKCksXG4gICAgICAuLi5jb25maWcuY29udGV4dFByb3ZpZGVycy5tYXAoYXN5bmMgKGN0eHApID0+IGF3YWl0IGN0eHAuY2xzKCkpLFxuICAgIF0pO1xuXG4gICAgLy8gQnJlYWsgZG93biBjb21wb25lbnRzIGludG8gdG9wLWxldmVsIHdpbmRvdyBVSSAmIGNvbnRleHQgcHJvdmlkZXJzXG4gICAgY29uc3QgVG9wV2luZG93Q29tcG9uZW50ID0gcHJvbWlzZWRDb21wb25lbnRzWzBdLmRlZmF1bHQ7XG4gICAgdmFyIGN0eFByb3ZpZGVyQ29tcG9uZW50cyA9IHByb21pc2VkQ29tcG9uZW50cy5cbiAgICAgIHNsaWNlKDEsIHByb21pc2VkQ29tcG9uZW50cy5sZW5ndGgpLlxuICAgICAgbWFwKGl0ZW0gPT4gaXRlbS5kZWZhdWx0KTtcblxuICAgIC8vIFJlb3JkZXIgY29udGV4dCBwcm92aWRlcnMgc28gdGhhdCB0b3AtbW9zdCBpcyB0aGUgbW9zdCBiYXNpY1xuICAgIGN0eFByb3ZpZGVyQ29tcG9uZW50cy5yZXZlcnNlKCk7XG4gICAgY3R4UHJvdmlkZXJPcHRpb25zLnJldmVyc2UoKTtcblxuICAgIC8vIFdyaXRlIG91dCB0b3AtbGV2ZWwgd2luZG93IGNvbXBvbmVudCBKU1hcbiAgICB2YXIgYXBwTWFya3VwID0gPFRvcFdpbmRvd0NvbXBvbmVudCBxdWVyeT17c2VhcmNoUGFyYW1zfSAvPjtcblxuICAgIGxvZy5kZWJ1ZyggIFxuICAgICAgYEMvcmVuZGVyQXBwOiBHb3QgY29udGV4dCBwcm92aWRlciBjb21wb25lbnRzYCxcbiAgICAgIGN0eFByb3ZpZGVyQ29tcG9uZW50cyk7XG5cbiAgICAvLyBXcmFwIHRoZSBKU1ggaW50byBjb250ZXh0IHByb3ZpZGVyIGNvbXBvbmVudHNcbiAgICBmb3IgKGNvbnN0IFtpZHgsIENvbnRleHRQcm92aWRlcl0gb2YgY3R4UHJvdmlkZXJDb21wb25lbnRzLmVudHJpZXMoKSkge1xuICAgICAgbG9nLnZlcmJvc2UoICBcbiAgICAgICAgYEMvcmVuZGVyQXBwOiBJbml0aWFsaXppbmcgY29udGV4dCBwcm92aWRlciAjJHtpZHh9YCxcbiAgICAgICAgY3R4UHJvdmlkZXJDb21wb25lbnRzW2lkeF0sXG4gICAgICAgIGN0eFByb3ZpZGVyT3B0aW9uc1tpZHhdKTtcblxuICAgICAgYXBwTWFya3VwID0gKFxuICAgICAgICA8Q29udGV4dFByb3ZpZGVyIHsuLi5jdHhQcm92aWRlck9wdGlvbnNbaWR4XShjb25maWcpfT5cbiAgICAgICAgICB7YXBwTWFya3VwfVxuICAgICAgICA8L0NvbnRleHRQcm92aWRlcj5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKFwiQy9yZW5kZXJBcHA6IFJlbmRlcmluZ1wiKTtcblxuICAgIC8vIFJlbmRlciB0aGUgSlNYXG4gICAgUmVhY3RET00ucmVuZGVyKGFwcE1hcmt1cCwgYXBwUm9vdCk7XG5cbiAgfSBlbHNlIHtcbiAgICAvLyBDb21wb25lbnQgc3BlY2lmaWVkIGluIEdFVCBwYXJhbXMgaXMgbm90IHByZXNlbnQgaW4gYXBwIHJlbmRlcmVyIGNvbmZpZy5cbiAgICAvLyBUT0RPOiBIYW5kbGUgbWlzY29uZmlndXJlZCBSZWFjdCBjb250ZXh0IHByb3ZpZGVycyBhbmQgZmFpbGVkIGltcG9ydCBhdCBydW50aW1lXG4gICAgUmVhY3RET00ucmVuZGVyKDxOb25JZGVhbFN0YXRlXG4gICAgICBpY29uPVwiZXJyb3JcIlxuICAgICAgdGl0bGU9XCJVbmtub3duIGNvbXBvbmVudCByZXF1ZXN0ZWRcIiAvPiwgYXBwUm9vdCk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHJvb3Q6IGFwcFJvb3QsXG4gIH07XG5cbn07Il19