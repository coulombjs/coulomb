import * as log from 'electron-log';
import * as fs from 'fs-extra';
import * as path from 'path';
import { listen } from '../../../ipc/main';
import { Setting } from '../../../settings/main';
import { UniqueConstraintError } from '../../errors';
import { VersionedFilesystemBackend, } from '../../main/base';
import { IsoGitWrapper } from './isogit';
class Backend extends VersionedFilesystemBackend {
    constructor(opts, reportBackendStatus) {
        super();
        this.opts = opts;
        this.reportBackendStatus = reportBackendStatus;
        this.fs = opts.fsWrapper;
        this.git = new IsoGitWrapper(fs, this.opts.repoURL, this.opts.upstreamRepoURL, this.opts.username, { name: this.opts.authorName, email: this.opts.authorEmail }, this.opts.workDir, this.opts.corsProxyURL, 
        // The status of this backend is reduced to Git repo status now.
        // Potentially it should include filesystem-related status as well,
        // reporting issues with e.g. insufficient disk space.
        this.reportBackendStatus);
        this.managers = [];
        this.synchronize = this.synchronize.bind(this);
    }
    async describe() {
        return {
            verboseName: "Git+YAML",
            verboseNameLong: "Git-versioned YAML file tree",
            gitRepo: this.opts.repoURL,
            gitUsername: this.opts.username,
            status: this.git.getStatus(),
        };
    }
    static registerSettingsForConfigurableOptions(settings, initialOptions, dbID) {
        const paneLabelPostfix = dbID !== 'default' ? ` for “${dbID}”` : '';
        const settingIDPrefix = `db_${dbID}_`;
        const paneID = `db_${dbID}`;
        settings.configurePane({
            id: paneID,
            label: `Database settings${paneLabelPostfix}`,
            icon: 'git-merge',
        });
        settings.register(new Setting(paneID, `${settingIDPrefix}gitRepoUrl`, 'text', initialOptions.repoURL === undefined, "Git repository URL", "E.g., https://github.com/<username>/<repository name>"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitUsername`, 'text', initialOptions.username === undefined, "Git username"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitAuthorName`, 'text', initialOptions.authorName === undefined, "Git author name"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitAuthorEmail`, 'text', initialOptions.authorEmail === undefined, "Git author email"));
    }
    static async completeOptionsFromSettings(settings, availableOptions, dbID) {
        const settingIDPrefix = `db_${dbID}_`;
        async function getSetting(settingID) {
            return await settings.getValue(`${settingIDPrefix}${settingID}`);
        }
        const fsWrapperClass = (await availableOptions.fsWrapperClass()).default;
        return {
            workDir: availableOptions.workDir,
            corsProxyURL: availableOptions.corsProxyURL,
            upstreamRepoURL: availableOptions.upstreamRepoURL,
            fsWrapperClass: availableOptions.fsWrapperClass,
            fsWrapper: new fsWrapperClass(availableOptions.workDir),
            repoURL: ((await getSetting('gitRepoUrl'))
                || availableOptions.repoURL),
            username: ((await getSetting('gitUsername'))
                || availableOptions.username),
            authorName: ((await getSetting('gitAuthorName'))
                || availableOptions.authorName),
            authorEmail: ((await getSetting('gitAuthorEmail'))
                || availableOptions.authorEmail),
        };
    }
    async registerManager(manager) {
        this.managers.push(manager);
    }
    async init(forceReset = false) {
        let doInitialize;
        try {
            if (forceReset === true) {
                log.warn("C/db/isogit-yaml: Git is being force reinitialized");
                doInitialize = true;
            }
            else if (!(await this.git.isUsingRemoteURLs({
                origin: this.opts.repoURL,
                upstream: this.opts.upstreamRepoURL
            }))) {
                log.warn("C/db/isogit-yaml: Git has mismatching remote URLs, reinitializing");
                doInitialize = true;
            }
            else {
                log.info("C/db/isogit-yaml: Git is already initialized");
                doInitialize = false;
            }
        }
        catch (e) {
            doInitialize = true;
        }
        if (doInitialize) {
            await this.git.destroy();
        }
    }
    async read(objID, metaFields) {
        return await this.fs.read(this.getRef(objID), metaFields);
    }
    async readRaw(objID) {
        return await this.fs.readRaw(this.getRef(objID));
    }
    async exists(objID) {
        return await this.fs.exists(this.getRef(objID));
    }
    async readVersion(objID, version) {
        // NOTE: This will fail with YAMLDirectoryWrapper.
        // objID must refer to a single file.
        // TODO: Support compound objects (directories)
        // by moving the file data parsing logic into manager
        // and adding Backend.readTree().
        const blob = await this.git.readFileBlobAtCommit(this.getRef(objID), version);
        return this.fs.parseData(blob);
    }
    async create(obj, objPath, metaFields) {
        if (await this.fs.exists(objPath)) {
            throw new UniqueConstraintError("filesystem path", objPath);
        }
        await this.fs.write(objPath, obj, metaFields);
    }
    async commit(objIDs, message) {
        await this.resetOrphanedFileChanges();
        const paths = (await this.readUncommittedFileInfo()).
            filter(fileinfo => gitPathMatches(objIDs, fileinfo.path)).
            map(fileinfo => fileinfo.path);
        if (paths.length > 0) {
            // TODO: Make Git track which files got committed (had changes),
            // and return paths
            await this.git.stageAndCommit(paths, message);
        }
    }
    async discard(objIDs) {
        const paths = (await this.readUncommittedFileInfo()).
            filter(fileinfo => gitPathMatches(objIDs, fileinfo.path)).
            map(fileinfo => fileinfo.path);
        if (paths.length > 0) {
            await this.git.resetFiles(paths);
        }
    }
    async listUncommitted() {
        const files = await this.readUncommittedFileInfo();
        const objIDs = files.
            map(fileinfo => fileinfo.path);
        // Discard duplicates from the list
        return objIDs.filter(function (objID, idx, self) {
            return idx === self.indexOf(objID);
        });
    }
    async listIDs(query) {
        return await this.fs.listIDs({ subdir: query.subdir });
    }
    async getIndex(subdir, idField, onlyIDs) {
        const idsToSelect = onlyIDs !== undefined
            ? onlyIDs.map(id => this.getRef(id))
            : undefined;
        const objs = await this.fs.readAll({ subdir, onlyIDs: idsToSelect });
        var idx = {};
        for (const obj of objs) {
            idx[`${obj[idField]}`] = obj;
        }
        return idx;
    }
    async update(objID, newData, idField) {
        await this.fs.write(this.getRef(objID), newData);
    }
    async delete(objID) {
        await this.fs.write(this.getRef(objID), undefined);
    }
    async resetOrphanedFileChanges() {
        /* Remove from filesystem any files under our FS backend path
           that the backend cannot account for,
           but which may appear as unstaged changes to Git. */
        const orphanFilePaths = (await this.readUncommittedFileInfo()).
            map(fileinfo => fileinfo.path).
            filter(filepath => this.managers.map(mgr => mgr.managesFileAtPath(filepath)).indexOf(true) < 0);
        if (orphanFilePaths.length > 0) {
            log.warn("C/db/isogit-yaml: Resetting orphaned files", orphanFilePaths);
            await this.git.resetFiles(orphanFilePaths);
        }
    }
    async readUncommittedFileInfo() {
        /* Returns a list of objects that map Git-relative paths to actual object IDs.
           Where object ID is undefined, that implies file is “orphaned”
           (not recognized as belonging to any object managed by this store). */
        const changedFiles = await this.git.listChangedFiles(['.']);
        return await Promise.all(changedFiles.map(fp => {
            return { path: fp };
        }));
    }
    getRef(objID) {
        /* Returns FS backend reference from DB backend object ID. */
        return `${objID}`;
    }
    async synchronize() {
        await this.git.synchronize();
        log.debug("C/isogit-yaml: Reporting managers’ updated data", Object.keys(this.managers));
        for (const mgr of this.managers) {
            log.debug("C/isogit-yaml: Reporting manager’s updated data");
            await mgr.reportUpdatedData();
        }
    }
    async checkUncommitted() {
        return await this.git.checkUncommitted();
    }
    setUpIPC(dbID) {
        super.setUpIPC(dbID);
        log.verbose("C/db/isogit-yaml: Setting up IPC");
        const prefix = `db-${dbID}`;
        listen(`${prefix}-count-uncommitted`, async () => {
            return { numUncommitted: (await this.git.listChangedFiles()).length };
        });
        listen(`${prefix}-git-trigger-sync`, async () => {
            this.synchronize();
            return { started: true };
        });
        listen(`${prefix}-git-discard-unstaged`, async () => {
            await this.git.resetFiles();
            return { success: true };
        });
        listen(`${prefix}-git-update-status`, async () => {
            return { hasUncommittedChanges: await this.checkUncommitted() };
        });
        listen(`${prefix}-git-set-password`, async ({ password }) => {
            // WARNING: Don’t log password
            log.verbose("C/db/isogit-yaml: received git-set-password request");
            this.git.setPassword(password);
            this.synchronize();
            return { success: true };
        });
        listen(`${prefix}-git-config-get`, async () => {
            log.verbose("C/db/isogit-yaml: received git-config request");
            return {
                originURL: await this.git.getOriginUrl(),
                name: await this.git.configGet('user.name'),
                email: await this.git.configGet('user.email'),
                username: await this.git.configGet('credentials.username'),
            };
        });
    }
}
export const BackendClass = Backend;
export default Backend;
function gitPathMatches(objIDs, gitPath) {
    if (objIDs.indexOf(gitPath) >= 0) {
        return true;
    }
    const parsed = path.parse(gitPath);
    // Backend operates file references as paths without extensions.
    // FS wrapper expands paths, adding extension if necessary.
    // Git, however, doesn’t know about the extensions.
    // For YAML files with extensions (not directories),
    // try comparing with extensions removed.
    return objIDs.indexOf(path.join(parsed.dir, parsed.name)) >= 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9pc29naXQteWFtbC9tYWluL2Jhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQWtCLE1BQU0sd0JBQXdCLENBQUM7QUFHakUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBSXJELE9BQU8sRUFHTCwwQkFBMEIsR0FHM0IsTUFBTSxpQkFBaUIsQ0FBQztBQUl6QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBMkJ6QyxNQUFNLE9BQVEsU0FBUSwwQkFBMEI7SUFPOUMsWUFDWSxJQUFvQixFQUNwQixtQkFBMEM7UUFFcEQsS0FBSyxFQUFFLENBQUM7UUFIRSxTQUFJLEdBQUosSUFBSSxDQUFnQjtRQUNwQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXVCO1FBSXBELElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUV6QixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksYUFBYSxDQUMxQixFQUFFLEVBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFDbEIsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQzVELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUNq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QUM7UUFFSCxNQUFNLENBQ0wsR0FBRyxNQUFNLGlCQUFpQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3RDLEdBQUcsQ0FBQyxPQUFPLENBQUMsK0NBQStDLENBQUMsQ0FBQztZQUM3RCxPQUFPO2dCQUNMLFNBQVMsRUFBRSxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFO2dCQUN4QyxJQUFJLEVBQUUsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7Z0JBQzNDLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQztnQkFDN0MsUUFBUSxFQUFFLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQUM7YUFFM0QsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUEyRSxPQUFPLENBQUE7QUFFM0csZUFBZSxPQUFPLENBQUM7QUFHdkIsU0FBUyxjQUFjLENBQUMsTUFBZ0IsRUFBRSxPQUFlO0lBQ3ZELElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDaEMsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFbkMsZ0VBQWdFO0lBQ2hFLDJEQUEyRDtJQUMzRCxtREFBbUQ7SUFDbkQsb0RBQW9EO0lBQ3BELHlDQUF5QztJQUN6QyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNqRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbG9nIGZyb20gJ2VsZWN0cm9uLWxvZyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBsaXN0ZW4gfSBmcm9tICcuLi8uLi8uLi9pcGMvbWFpbic7XG5pbXBvcnQgeyBTZXR0aW5nLCBTZXR0aW5nTWFuYWdlciB9IGZyb20gJy4uLy4uLy4uL3NldHRpbmdzL21haW4nO1xuXG5pbXBvcnQgeyBJbmRleCB9IGZyb20gJy4uLy4uL3F1ZXJ5JztcbmltcG9ydCB7IFVuaXF1ZUNvbnN0cmFpbnRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XG5cbmltcG9ydCB7IEZpbGVzeXN0ZW1XcmFwcGVyIH0gZnJvbSAnLi4vLi4vbWFpbi9mcy13cmFwcGVyJztcblxuaW1wb3J0IHtcbiAgQmFja2VuZENsYXNzIGFzIEJhc2VCYWNrZW5kQ2xhc3MsXG4gIEJhY2tlbmRTdGF0dXNSZXBvcnRlciBhcyBCYXNlQmFja2VuZFN0YXR1c1JlcG9ydGVyLFxuICBWZXJzaW9uZWRGaWxlc3lzdGVtQmFja2VuZCxcbiAgTW9kZWxNYW5hZ2VyLFxuICBGaWxlc3lzdGVtTWFuYWdlcixcbn0gZnJvbSAnLi4vLi4vbWFpbi9iYXNlJztcblxuaW1wb3J0IHsgQmFja2VuZERlc2NyaXB0aW9uLCBCYWNrZW5kU3RhdHVzIH0gZnJvbSAnLi4vYmFzZSc7XG5cbmltcG9ydCB7IElzb0dpdFdyYXBwZXIgfSBmcm9tICcuL2lzb2dpdCc7XG5cblxuaW50ZXJmYWNlIEZpeGVkQmFja2VuZE9wdGlvbnMge1xuICAvKiBTZXR0aW5ncyBzdXBwbGllZCBieSB0aGUgZGV2ZWxvcGVyICovXG5cbiAgd29ya0Rpcjogc3RyaW5nXG4gIGNvcnNQcm94eVVSTDogc3RyaW5nXG4gIHVwc3RyZWFtUmVwb1VSTDogc3RyaW5nXG4gIGZzV3JhcHBlckNsYXNzOiAoKSA9PiBQcm9taXNlPHsgZGVmYXVsdDogbmV3IChiYXNlRGlyOiBzdHJpbmcpID0+IEZpbGVzeXN0ZW1XcmFwcGVyPGFueT4gfT5cbn1cbmludGVyZmFjZSBDb25maWd1cmFibGVCYWNrZW5kT3B0aW9ucyB7XG4gIC8qIFNldHRpbmdzIHRoYXQgdXNlciBjYW4gb3IgbXVzdCBzcGVjaWZ5ICovXG4gIHJlcG9VUkw6IHN0cmluZ1xuICB1c2VybmFtZTogc3RyaW5nXG4gIGF1dGhvck5hbWU6IHN0cmluZ1xuICBhdXRob3JFbWFpbDogc3RyaW5nXG59XG50eXBlIEJhY2tlbmRPcHRpb25zID0gRml4ZWRCYWNrZW5kT3B0aW9ucyAmIENvbmZpZ3VyYWJsZUJhY2tlbmRPcHRpb25zICYge1xuICBmc1dyYXBwZXI6IEZpbGVzeXN0ZW1XcmFwcGVyPGFueT5cbn1cbnR5cGUgSW5pdGlhbEJhY2tlbmRPcHRpb25zID0gRml4ZWRCYWNrZW5kT3B0aW9ucyAmIFBhcnRpYWw8Q29uZmlndXJhYmxlQmFja2VuZE9wdGlvbnM+XG5cblxudHlwZSBCYWNrZW5kU3RhdHVzUmVwb3J0ZXIgPSBCYXNlQmFja2VuZFN0YXR1c1JlcG9ydGVyPEJhY2tlbmRTdGF0dXM+XG5cblxuY2xhc3MgQmFja2VuZCBleHRlbmRzIFZlcnNpb25lZEZpbGVzeXN0ZW1CYWNrZW5kIHtcbiAgLyogQ29tYmluZXMgYSBmaWxlc3lzdGVtIHN0b3JhZ2Ugd2l0aCBHaXQuICovXG5cbiAgcHJpdmF0ZSBnaXQ6IElzb0dpdFdyYXBwZXI7XG4gIHByaXZhdGUgZnM6IEZpbGVzeXN0ZW1XcmFwcGVyPGFueT47XG4gIHByaXZhdGUgbWFuYWdlcnM6IChGaWxlc3lzdGVtTWFuYWdlciAmIE1vZGVsTWFuYWdlcjxhbnksIGFueSwgYW55PilbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIHByaXZhdGUgb3B0czogQmFja2VuZE9wdGlvbnMsXG4gICAgICBwcml2YXRlIHJlcG9ydEJhY2tlbmRTdGF0dXM6IEJhY2tlbmRTdGF0dXNSZXBvcnRlcikge1xuXG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuZnMgPSBvcHRzLmZzV3JhcHBlcjtcblxuICAgIHRoaXMuZ2l0ID0gbmV3IElzb0dpdFdyYXBwZXIoXG4gICAgICBmcyxcbiAgICAgIHRoaXMub3B0cy5yZXBvVVJMLFxuICAgICAgdGhpcy5vcHRzLnVwc3RyZWFtUmVwb1VSTCxcbiAgICAgIHRoaXMub3B0cy51c2VybmFtZSxcbiAgICAgIHsgbmFtZTogdGhpcy5vcHRzLmF1dGhvck5hbWUsIGVtYWlsOiB0aGlzLm9wdHMuYXV0aG9yRW1haWwgfSxcbiAgICAgIHRoaXMub3B0cy53b3JrRGlyLFxuICAgICAgdGhpcy5vcHRzLmNvcnNQcm94eVVSTCxcblxuICAgICAgLy8gVGhlIHN0YXR1cyBvZiB0aGlzIGJhY2tlbmQgaXMgcmVkdWNlZCB0byBHaXQgcmVwbyBzdGF0dXMgbm93LlxuICAgICAgLy8gUG90ZW50aWFsbHkgaXQgc2hvdWxkIGluY2x1ZGUgZmlsZXN5c3RlbS1yZWxhdGVkIHN0YXR1cyBhcyB3ZWxsLFxuICAgICAgLy8gcmVwb3J0aW5nIGlzc3VlcyB3aXRoIGUuZy4gaW5zdWZmaWNpZW50IGRpc2sgc3BhY2UuXG4gICAgICB0aGlzLnJlcG9ydEJhY2tlbmRTdGF0dXMsXG4gICAgKTtcblxuICAgIHRoaXMubWFuYWdlcnMgPSBbXTtcblxuICAgIHRoaXMuc3luY2hyb25pemUgPSB0aGlzLnN5bmNocm9uaXplLmJpbmQodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVzY3JpYmUoKTogUHJvbWlzZTxCYWNrZW5kRGVzY3JpcHRpb24+IHtcbiAgICByZXR1cm4ge1xuICAgICAgdmVyYm9zZU5hbWU6IFwiR2l0K1lBTUxcIixcbiAgICAgIHZlcmJvc2VOYW1lTG9uZzogXCJHaXQtdmVyc2lvbmVkIFlBTUwgZmlsZSB0cmVlXCIsXG4gICAgICBnaXRSZXBvOiB0aGlzLm9wdHMucmVwb1VSTCxcbiAgICAgIGdpdFVzZXJuYW1lOiB0aGlzLm9wdHMudXNlcm5hbWUsXG4gICAgICBzdGF0dXM6IHRoaXMuZ2l0LmdldFN0YXR1cygpLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgcmVnaXN0ZXJTZXR0aW5nc0ZvckNvbmZpZ3VyYWJsZU9wdGlvbnMoXG4gICAgICBzZXR0aW5nczogU2V0dGluZ01hbmFnZXIsXG4gICAgICBpbml0aWFsT3B0aW9uczogSW5pdGlhbEJhY2tlbmRPcHRpb25zLFxuICAgICAgZGJJRDogc3RyaW5nKSB7XG5cbiAgICBjb25zdCBwYW5lTGFiZWxQb3N0Zml4ID0gZGJJRCAhPT0gJ2RlZmF1bHQnID8gYCBmb3Ig4oCcJHtkYklEfeKAnWAgOiAnJztcbiAgICBjb25zdCBzZXR0aW5nSURQcmVmaXggPSBgZGJfJHtkYklEfV9gO1xuICAgIGNvbnN0IHBhbmVJRCA9IGBkYl8ke2RiSUR9YDtcblxuICAgIHNldHRpbmdzLmNvbmZpZ3VyZVBhbmUoe1xuICAgICAgaWQ6IHBhbmVJRCxcbiAgICAgIGxhYmVsOiBgRGF0YWJhc2Ugc2V0dGluZ3Mke3BhbmVMYWJlbFBvc3RmaXh9YCxcbiAgICAgIGljb246ICdnaXQtbWVyZ2UnLFxuICAgIH0pO1xuXG4gICAgc2V0dGluZ3MucmVnaXN0ZXIobmV3IFNldHRpbmc8c3RyaW5nPihcbiAgICAgIHBhbmVJRCxcbiAgICAgIGAke3NldHRpbmdJRFByZWZpeH1naXRSZXBvVXJsYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLnJlcG9VUkwgPT09IHVuZGVmaW5lZCxcbiAgICAgIFwiR2l0IHJlcG9zaXRvcnkgVVJMXCIsXG4gICAgICBcIkUuZy4sIGh0dHBzOi8vZ2l0aHViLmNvbS88dXNlcm5hbWU+LzxyZXBvc2l0b3J5IG5hbWU+XCIsXG4gICAgKSk7XG5cbiAgICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICAgcGFuZUlELFxuICAgICAgYCR7c2V0dGluZ0lEUHJlZml4fWdpdFVzZXJuYW1lYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLnVzZXJuYW1lID09PSB1bmRlZmluZWQsXG4gICAgICBcIkdpdCB1c2VybmFtZVwiLFxuICAgICkpO1xuXG4gICAgc2V0dGluZ3MucmVnaXN0ZXIobmV3IFNldHRpbmc8c3RyaW5nPihcbiAgICAgIHBhbmVJRCxcbiAgICAgIGAke3NldHRpbmdJRFByZWZpeH1naXRBdXRob3JOYW1lYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLmF1dGhvck5hbWUgPT09IHVuZGVmaW5lZCxcbiAgICAgIFwiR2l0IGF1dGhvciBuYW1lXCIsXG4gICAgKSk7XG5cbiAgICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICAgcGFuZUlELFxuICAgICAgYCR7c2V0dGluZ0lEUHJlZml4fWdpdEF1dGhvckVtYWlsYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLmF1dGhvckVtYWlsID09PSB1bmRlZmluZWQsXG4gICAgICBcIkdpdCBhdXRob3IgZW1haWxcIixcbiAgICApKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgY29tcGxldGVPcHRpb25zRnJvbVNldHRpbmdzKFxuICAgICAgc2V0dGluZ3M6IFNldHRpbmdNYW5hZ2VyLFxuICAgICAgYXZhaWxhYmxlT3B0aW9uczogSW5pdGlhbEJhY2tlbmRPcHRpb25zLFxuICAgICAgZGJJRDogc3RyaW5nKSB7XG5cbiAgICBjb25zdCBzZXR0aW5nSURQcmVmaXggPSBgZGJfJHtkYklEfV9gO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gZ2V0U2V0dGluZzxUPihzZXR0aW5nSUQ6IHN0cmluZyk6IFByb21pc2U8VD4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHNldHRpbmdzLmdldFZhbHVlKGAke3NldHRpbmdJRFByZWZpeH0ke3NldHRpbmdJRH1gKSBhcyBUO1xuICAgIH1cblxuICAgIGNvbnN0IGZzV3JhcHBlckNsYXNzID0gKGF3YWl0IGF2YWlsYWJsZU9wdGlvbnMuZnNXcmFwcGVyQ2xhc3MoKSkuZGVmYXVsdDtcblxuICAgIHJldHVybiB7XG4gICAgICB3b3JrRGlyOiBhdmFpbGFibGVPcHRpb25zLndvcmtEaXIsXG4gICAgICBjb3JzUHJveHlVUkw6IGF2YWlsYWJsZU9wdGlvbnMuY29yc1Byb3h5VVJMLFxuICAgICAgdXBzdHJlYW1SZXBvVVJMOiBhdmFpbGFibGVPcHRpb25zLnVwc3RyZWFtUmVwb1VSTCxcbiAgICAgIGZzV3JhcHBlckNsYXNzOiBhdmFpbGFibGVPcHRpb25zLmZzV3JhcHBlckNsYXNzLFxuICAgICAgZnNXcmFwcGVyOiBuZXcgZnNXcmFwcGVyQ2xhc3MoYXZhaWxhYmxlT3B0aW9ucy53b3JrRGlyKSxcblxuICAgICAgcmVwb1VSTDogKFxuICAgICAgICAoYXdhaXQgZ2V0U2V0dGluZzxzdHJpbmc+KCdnaXRSZXBvVXJsJykpXG4gICAgICAgIHx8IGF2YWlsYWJsZU9wdGlvbnMucmVwb1VSTCkgYXMgc3RyaW5nLFxuICAgICAgdXNlcm5hbWU6IChcbiAgICAgICAgKGF3YWl0IGdldFNldHRpbmc8c3RyaW5nPignZ2l0VXNlcm5hbWUnKSlcbiAgICAgICAgfHwgYXZhaWxhYmxlT3B0aW9ucy51c2VybmFtZSkgYXMgc3RyaW5nLFxuICAgICAgYXV0aG9yTmFtZTogKFxuICAgICAgICAoYXdhaXQgZ2V0U2V0dGluZzxzdHJpbmc+KCdnaXRBdXRob3JOYW1lJykpXG4gICAgICAgIHx8IGF2YWlsYWJsZU9wdGlvbnMuYXV0aG9yTmFtZSkgYXMgc3RyaW5nLFxuICAgICAgYXV0aG9yRW1haWw6IChcbiAgICAgICAgKGF3YWl0IGdldFNldHRpbmc8c3RyaW5nPignZ2l0QXV0aG9yRW1haWwnKSlcbiAgICAgICAgfHwgYXZhaWxhYmxlT3B0aW9ucy5hdXRob3JFbWFpbCkgYXMgc3RyaW5nLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWdpc3Rlck1hbmFnZXIobWFuYWdlcjogRmlsZXN5c3RlbU1hbmFnZXIgJiBNb2RlbE1hbmFnZXI8YW55LCBhbnksIGFueT4pIHtcbiAgICB0aGlzLm1hbmFnZXJzLnB1c2gobWFuYWdlcik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdChmb3JjZVJlc2V0ID0gZmFsc2UpIHtcbiAgICBsZXQgZG9Jbml0aWFsaXplOiBib29sZWFuO1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChmb3JjZVJlc2V0ID09PSB0cnVlKSB7XG4gICAgICAgIGxvZy53YXJuKFwiQy9kYi9pc29naXQteWFtbDogR2l0IGlzIGJlaW5nIGZvcmNlIHJlaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIGRvSW5pdGlhbGl6ZSA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKCEoYXdhaXQgdGhpcy5naXQuaXNVc2luZ1JlbW90ZVVSTHMoe1xuICAgICAgICAgIG9yaWdpbjogdGhpcy5vcHRzLnJlcG9VUkwsXG4gICAgICAgICAgdXBzdHJlYW06IHRoaXMub3B0cy51cHN0cmVhbVJlcG9VUkx9KSkpIHtcbiAgICAgICAgbG9nLndhcm4oXCJDL2RiL2lzb2dpdC15YW1sOiBHaXQgaGFzIG1pc21hdGNoaW5nIHJlbW90ZSBVUkxzLCByZWluaXRpYWxpemluZ1wiKTtcbiAgICAgICAgZG9Jbml0aWFsaXplID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5pbmZvKFwiQy9kYi9pc29naXQteWFtbDogR2l0IGlzIGFscmVhZHkgaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIGRvSW5pdGlhbGl6ZSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGRvSW5pdGlhbGl6ZSA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKGRvSW5pdGlhbGl6ZSkge1xuICAgICAgYXdhaXQgdGhpcy5naXQuZGVzdHJveSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkKG9iaklEOiBzdHJpbmcsIG1ldGFGaWVsZHM/OiBzdHJpbmdbXSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZzLnJlYWQodGhpcy5nZXRSZWYob2JqSUQpLCBtZXRhRmllbGRzKSBhcyBvYmplY3Q7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZFJhdyhvYmpJRDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZnMucmVhZFJhdyh0aGlzLmdldFJlZihvYmpJRCkpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4aXN0cyhvYmpJRDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZnMuZXhpc3RzKHRoaXMuZ2V0UmVmKG9iaklEKSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZFZlcnNpb24ob2JqSUQ6IHN0cmluZywgdmVyc2lvbjogc3RyaW5nKSB7XG4gICAgLy8gTk9URTogVGhpcyB3aWxsIGZhaWwgd2l0aCBZQU1MRGlyZWN0b3J5V3JhcHBlci5cbiAgICAvLyBvYmpJRCBtdXN0IHJlZmVyIHRvIGEgc2luZ2xlIGZpbGUuXG5cbiAgICAvLyBUT0RPOiBTdXBwb3J0IGNvbXBvdW5kIG9iamVjdHMgKGRpcmVjdG9yaWVzKVxuICAgIC8vIGJ5IG1vdmluZyB0aGUgZmlsZSBkYXRhIHBhcnNpbmcgbG9naWMgaW50byBtYW5hZ2VyXG4gICAgLy8gYW5kIGFkZGluZyBCYWNrZW5kLnJlYWRUcmVlKCkuXG5cbiAgICBjb25zdCBibG9iID0gYXdhaXQgdGhpcy5naXQucmVhZEZpbGVCbG9iQXRDb21taXQodGhpcy5nZXRSZWYob2JqSUQpLCB2ZXJzaW9uKTtcbiAgICByZXR1cm4gdGhpcy5mcy5wYXJzZURhdGEoYmxvYik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlPE8gZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+PihvYmo6IE8sIG9ialBhdGg6IHN0cmluZywgbWV0YUZpZWxkcz86IChrZXlvZiBPKVtdKSB7XG4gICAgaWYgKGF3YWl0IHRoaXMuZnMuZXhpc3RzKG9ialBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgVW5pcXVlQ29uc3RyYWludEVycm9yKFwiZmlsZXN5c3RlbSBwYXRoXCIsIG9ialBhdGgpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZnMud3JpdGUob2JqUGF0aCwgb2JqLCBtZXRhRmllbGRzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjb21taXQob2JqSURzOiBzdHJpbmdbXSwgbWVzc2FnZTogc3RyaW5nKSB7XG4gICAgYXdhaXQgdGhpcy5yZXNldE9ycGhhbmVkRmlsZUNoYW5nZXMoKTtcblxuICAgIGNvbnN0IHBhdGhzOiBzdHJpbmdbXSA9IChhd2FpdCB0aGlzLnJlYWRVbmNvbW1pdHRlZEZpbGVJbmZvKCkpLlxuICAgICAgZmlsdGVyKGZpbGVpbmZvID0+IGdpdFBhdGhNYXRjaGVzKG9iaklEcywgZmlsZWluZm8ucGF0aCkpLlxuICAgICAgbWFwKGZpbGVpbmZvID0+IGZpbGVpbmZvLnBhdGgpO1xuXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIFRPRE86IE1ha2UgR2l0IHRyYWNrIHdoaWNoIGZpbGVzIGdvdCBjb21taXR0ZWQgKGhhZCBjaGFuZ2VzKSxcbiAgICAgIC8vIGFuZCByZXR1cm4gcGF0aHNcbiAgICAgIGF3YWl0IHRoaXMuZ2l0LnN0YWdlQW5kQ29tbWl0KHBhdGhzLCBtZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGlzY2FyZChvYmpJRHM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgcGF0aHM6IHN0cmluZ1tdID0gKGF3YWl0IHRoaXMucmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKSkuXG4gICAgICBmaWx0ZXIoZmlsZWluZm8gPT4gZ2l0UGF0aE1hdGNoZXMob2JqSURzLCBmaWxlaW5mby5wYXRoKSkuXG4gICAgICBtYXAoZmlsZWluZm8gPT4gZmlsZWluZm8ucGF0aCk7XG5cbiAgICBpZiAocGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdGhpcy5naXQucmVzZXRGaWxlcyhwYXRocyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RVbmNvbW1pdHRlZCgpIHtcbiAgICBjb25zdCBmaWxlcyA9IGF3YWl0IHRoaXMucmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKTtcblxuICAgIGNvbnN0IG9iaklEczogc3RyaW5nW10gPSBmaWxlcy5cbiAgICAgIG1hcChmaWxlaW5mbyA9PiBmaWxlaW5mby5wYXRoKTtcblxuICAgIC8vIERpc2NhcmQgZHVwbGljYXRlcyBmcm9tIHRoZSBsaXN0XG4gICAgcmV0dXJuIG9iaklEcy5maWx0ZXIoZnVuY3Rpb24gKG9iaklELCBpZHgsIHNlbGYpIHtcbiAgICAgIHJldHVybiBpZHggPT09IHNlbGYuaW5kZXhPZihvYmpJRCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdElEcyhxdWVyeTogeyBzdWJkaXI6IHN0cmluZyB9KSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZnMubGlzdElEcyh7IHN1YmRpcjogcXVlcnkuc3ViZGlyIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEluZGV4KHN1YmRpcjogc3RyaW5nLCBpZEZpZWxkOiBzdHJpbmcsIG9ubHlJRHM/OiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IGlkc1RvU2VsZWN0ID0gb25seUlEcyAhPT0gdW5kZWZpbmVkXG4gICAgICA/IG9ubHlJRHMubWFwKGlkID0+IHRoaXMuZ2V0UmVmKGlkKSlcbiAgICAgIDogdW5kZWZpbmVkO1xuXG4gICAgY29uc3Qgb2JqcyA9IGF3YWl0IHRoaXMuZnMucmVhZEFsbCh7IHN1YmRpciwgb25seUlEczogaWRzVG9TZWxlY3QgfSk7XG5cbiAgICB2YXIgaWR4OiBJbmRleDxhbnk+ID0ge307XG4gICAgZm9yIChjb25zdCBvYmogb2Ygb2Jqcykge1xuICAgICAgaWR4W2Ake29ialtpZEZpZWxkXX1gXSA9IG9iajtcbiAgICB9XG5cbiAgICByZXR1cm4gaWR4O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZShvYmpJRDogc3RyaW5nLCBuZXdEYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCBpZEZpZWxkOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmZzLndyaXRlKHRoaXMuZ2V0UmVmKG9iaklEKSwgbmV3RGF0YSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKG9iaklEOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmZzLndyaXRlKHRoaXMuZ2V0UmVmKG9iaklEKSwgdW5kZWZpbmVkKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZXNldE9ycGhhbmVkRmlsZUNoYW5nZXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLyogUmVtb3ZlIGZyb20gZmlsZXN5c3RlbSBhbnkgZmlsZXMgdW5kZXIgb3VyIEZTIGJhY2tlbmQgcGF0aFxuICAgICAgIHRoYXQgdGhlIGJhY2tlbmQgY2Fubm90IGFjY291bnQgZm9yLFxuICAgICAgIGJ1dCB3aGljaCBtYXkgYXBwZWFyIGFzIHVuc3RhZ2VkIGNoYW5nZXMgdG8gR2l0LiAqL1xuXG4gICAgY29uc3Qgb3JwaGFuRmlsZVBhdGhzID0gKGF3YWl0IHRoaXMucmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKSkuXG4gICAgbWFwKGZpbGVpbmZvID0+IGZpbGVpbmZvLnBhdGgpLlxuICAgIGZpbHRlcihmaWxlcGF0aCA9PiB0aGlzLm1hbmFnZXJzLm1hcChtZ3IgPT4gbWdyLm1hbmFnZXNGaWxlQXRQYXRoKGZpbGVwYXRoKSkuaW5kZXhPZih0cnVlKSA8IDApO1xuXG4gICAgaWYgKG9ycGhhbkZpbGVQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBsb2cud2FybihcIkMvZGIvaXNvZ2l0LXlhbWw6IFJlc2V0dGluZyBvcnBoYW5lZCBmaWxlc1wiLCBvcnBoYW5GaWxlUGF0aHMpO1xuICAgICAgYXdhaXQgdGhpcy5naXQucmVzZXRGaWxlcyhvcnBoYW5GaWxlUGF0aHMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKTogUHJvbWlzZTx7IHBhdGg6IHN0cmluZyB9W10+IHtcbiAgICAvKiBSZXR1cm5zIGEgbGlzdCBvZiBvYmplY3RzIHRoYXQgbWFwIEdpdC1yZWxhdGl2ZSBwYXRocyB0byBhY3R1YWwgb2JqZWN0IElEcy5cbiAgICAgICBXaGVyZSBvYmplY3QgSUQgaXMgdW5kZWZpbmVkLCB0aGF0IGltcGxpZXMgZmlsZSBpcyDigJxvcnBoYW5lZOKAnVxuICAgICAgIChub3QgcmVjb2duaXplZCBhcyBiZWxvbmdpbmcgdG8gYW55IG9iamVjdCBtYW5hZ2VkIGJ5IHRoaXMgc3RvcmUpLiAqL1xuXG4gICAgY29uc3QgY2hhbmdlZEZpbGVzOiBzdHJpbmdbXSA9IGF3YWl0IHRoaXMuZ2l0Lmxpc3RDaGFuZ2VkRmlsZXMoWycuJ10pO1xuICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChjaGFuZ2VkRmlsZXMubWFwKGZwID0+IHtcbiAgICAgIHJldHVybiB7IHBhdGg6IGZwIH07XG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWYob2JqSUQ6IHN0cmluZyB8IG51bWJlcik6IHN0cmluZyB7XG4gICAgLyogUmV0dXJucyBGUyBiYWNrZW5kIHJlZmVyZW5jZSBmcm9tIERCIGJhY2tlbmQgb2JqZWN0IElELiAqL1xuICAgIHJldHVybiBgJHtvYmpJRH1gO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzeW5jaHJvbml6ZSgpIHtcbiAgICBhd2FpdCB0aGlzLmdpdC5zeW5jaHJvbml6ZSgpO1xuXG4gICAgbG9nLmRlYnVnKFxuICAgICAgXCJDL2lzb2dpdC15YW1sOiBSZXBvcnRpbmcgbWFuYWdlcnPigJkgdXBkYXRlZCBkYXRhXCIsXG4gICAgICBPYmplY3Qua2V5cyh0aGlzLm1hbmFnZXJzKSk7XG5cbiAgICBmb3IgKGNvbnN0IG1nciBvZiB0aGlzLm1hbmFnZXJzKSB7XG4gICAgICBsb2cuZGVidWcoXCJDL2lzb2dpdC15YW1sOiBSZXBvcnRpbmcgbWFuYWdlcuKAmXMgdXBkYXRlZCBkYXRhXCIpXG4gICAgICBhd2FpdCBtZ3IucmVwb3J0VXBkYXRlZERhdGEoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrVW5jb21taXR0ZWQoKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2l0LmNoZWNrVW5jb21taXR0ZWQoKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRVcElQQyhkYklEOiBzdHJpbmcpIHtcbiAgICBzdXBlci5zZXRVcElQQyhkYklEKTtcblxuICAgIGxvZy52ZXJib3NlKFwiQy9kYi9pc29naXQteWFtbDogU2V0dGluZyB1cCBJUENcIik7XG5cbiAgICBjb25zdCBwcmVmaXggPSBgZGItJHtkYklEfWA7XG5cbiAgICBsaXN0ZW48e30sIHsgbnVtVW5jb21taXR0ZWQ6IG51bWJlciB9PlxuICAgIChgJHtwcmVmaXh9LWNvdW50LXVuY29tbWl0dGVkYCwgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIHsgbnVtVW5jb21taXR0ZWQ6IChhd2FpdCB0aGlzLmdpdC5saXN0Q2hhbmdlZEZpbGVzKCkpLmxlbmd0aCB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IHN0YXJ0ZWQ6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCwgYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy5zeW5jaHJvbml6ZSgpO1xuICAgICAgcmV0dXJuIHsgc3RhcnRlZDogdHJ1ZSB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IHN1Y2Nlc3M6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtZGlzY2FyZC11bnN0YWdlZGAsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuZ2l0LnJlc2V0RmlsZXMoKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7fSwgeyBoYXNVbmNvbW1pdHRlZENoYW5nZXM6IGJvb2xlYW4gfT5cbiAgICAoYCR7cHJlZml4fS1naXQtdXBkYXRlLXN0YXR1c2AsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiB7IGhhc1VuY29tbWl0dGVkQ2hhbmdlczogYXdhaXQgdGhpcy5jaGVja1VuY29tbWl0dGVkKCkgfTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7IHBhc3N3b3JkOiBzdHJpbmcgfSwgeyBzdWNjZXNzOiB0cnVlIH0+XG4gICAgKGAke3ByZWZpeH0tZ2l0LXNldC1wYXNzd29yZGAsIGFzeW5jICh7IHBhc3N3b3JkIH0pID0+IHtcbiAgICAgIC8vIFdBUk5JTkc6IERvbuKAmXQgbG9nIHBhc3N3b3JkXG4gICAgICBsb2cudmVyYm9zZShcIkMvZGIvaXNvZ2l0LXlhbWw6IHJlY2VpdmVkIGdpdC1zZXQtcGFzc3dvcmQgcmVxdWVzdFwiKTtcblxuICAgICAgdGhpcy5naXQuc2V0UGFzc3dvcmQocGFzc3dvcmQpO1xuICAgICAgdGhpcy5zeW5jaHJvbml6ZSgpO1xuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48e30sIHsgb3JpZ2luVVJMOiBzdHJpbmcgfCBudWxsLCBuYW1lOiBzdHJpbmcgfCBudWxsLCBlbWFpbDogc3RyaW5nIHwgbnVsbCwgdXNlcm5hbWU6IHN0cmluZyB8IG51bGwgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtY29uZmlnLWdldGAsIGFzeW5jICgpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFwiQy9kYi9pc29naXQteWFtbDogcmVjZWl2ZWQgZ2l0LWNvbmZpZyByZXF1ZXN0XCIpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgb3JpZ2luVVJMOiBhd2FpdCB0aGlzLmdpdC5nZXRPcmlnaW5VcmwoKSxcbiAgICAgICAgbmFtZTogYXdhaXQgdGhpcy5naXQuY29uZmlnR2V0KCd1c2VyLm5hbWUnKSxcbiAgICAgICAgZW1haWw6IGF3YWl0IHRoaXMuZ2l0LmNvbmZpZ0dldCgndXNlci5lbWFpbCcpLFxuICAgICAgICB1c2VybmFtZTogYXdhaXQgdGhpcy5naXQuY29uZmlnR2V0KCdjcmVkZW50aWFscy51c2VybmFtZScpLFxuICAgICAgICAvLyBQYXNzd29yZCBtdXN0IG5vdCBiZSByZXR1cm5lZCwgb2YgY291cnNlXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBCYWNrZW5kQ2xhc3M6IEJhc2VCYWNrZW5kQ2xhc3M8SW5pdGlhbEJhY2tlbmRPcHRpb25zLCBCYWNrZW5kT3B0aW9ucywgQmFja2VuZFN0YXR1cz4gPSBCYWNrZW5kXG5cbmV4cG9ydCBkZWZhdWx0IEJhY2tlbmQ7XG5cblxuZnVuY3Rpb24gZ2l0UGF0aE1hdGNoZXMob2JqSURzOiBzdHJpbmdbXSwgZ2l0UGF0aDogc3RyaW5nKSB7XG4gIGlmIChvYmpJRHMuaW5kZXhPZihnaXRQYXRoKSA+PSAwKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgY29uc3QgcGFyc2VkID0gcGF0aC5wYXJzZShnaXRQYXRoKTtcblxuICAvLyBCYWNrZW5kIG9wZXJhdGVzIGZpbGUgcmVmZXJlbmNlcyBhcyBwYXRocyB3aXRob3V0IGV4dGVuc2lvbnMuXG4gIC8vIEZTIHdyYXBwZXIgZXhwYW5kcyBwYXRocywgYWRkaW5nIGV4dGVuc2lvbiBpZiBuZWNlc3NhcnkuXG4gIC8vIEdpdCwgaG93ZXZlciwgZG9lc27igJl0IGtub3cgYWJvdXQgdGhlIGV4dGVuc2lvbnMuXG4gIC8vIEZvciBZQU1MIGZpbGVzIHdpdGggZXh0ZW5zaW9ucyAobm90IGRpcmVjdG9yaWVzKSxcbiAgLy8gdHJ5IGNvbXBhcmluZyB3aXRoIGV4dGVuc2lvbnMgcmVtb3ZlZC5cbiAgcmV0dXJuIG9iaklEcy5pbmRleE9mKHBhdGguam9pbihwYXJzZWQuZGlyLCBwYXJzZWQubmFtZSkpID49IDA7XG59Il19