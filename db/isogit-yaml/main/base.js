import * as log from 'electron-log';
import * as fs from 'fs-extra';
import { ipcMain } from 'electron';
import { listen } from '../../../ipc/main';
import { Setting } from '../../../settings/main';
import { UniqueConstraintError } from '../../errors';
import { YAMLDirectoryWrapper } from './yaml';
import { IsoGitWrapper } from './isogit';
export const Backend = class Backend {
    constructor(opts, reportBackendStatus) {
        this.opts = opts;
        this.reportBackendStatus = reportBackendStatus;
        this.fs = new YAMLDirectoryWrapper(this.opts.workDir);
        this.git = new IsoGitWrapper(fs, this.opts.repoURL, this.opts.upstreamRepoURL, this.opts.workDir, this.opts.corsProxyURL);
        this.managers = [];
        this.synchronize = this.synchronize.bind(this);
        // this.collections = Object.entries(this.opts.collections).map(([collectionID, collectionOptions]) => {
        //   return { [collectionID]: { index: {}, opts: collectionOptions } } as Partial<Collections>;
        // }).reduce((val, acc) => ({ ...acc, ...val }), {} as Partial<Collections>) as Collections;
    }
    static registerSettingsForConfigurableOptions(settings, initialOptions, dbID) {
        const paneLabelPostfix = dbID !== 'default' ? ` for “${dbID}”` : '';
        const settingIDPrefix = `db_${dbID}_`;
        const paneID = `db_${dbID}`;
        settings.configurePane({
            id: paneID,
            label: `Database settings${paneLabelPostfix}`,
            icon: 'git-merge',
        });
        settings.register(new Setting(paneID, `${settingIDPrefix}gitRepoUrl`, 'text', initialOptions.repoURL === undefined, "Git repository URL"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitUsername`, 'text', initialOptions.username === undefined, "Git username"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitAuthorName`, 'text', initialOptions.authorName === undefined, "Git author name"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitAuthorEmail`, 'text', initialOptions.authorEmail === undefined, "Git author email"));
    }
    static async completeOptionsFromSettings(settings, availableOptions, dbID) {
        const settingIDPrefix = `db_${dbID}_`;
        async function getSetting(settingID) {
            return await settings.getValue(`${settingIDPrefix}${settingID}`);
        }
        return {
            workDir: availableOptions.workDir,
            corsProxyURL: availableOptions.corsProxyURL,
            upstreamRepoURL: availableOptions.upstreamRepoURL,
            repoURL: ((await getSetting('gitRepoUrl'))
                || availableOptions.repoURL),
            username: ((await getSetting('gitUsername'))
                || availableOptions.username),
            authorName: ((await getSetting('gitAuthorName'))
                || availableOptions.authorName),
            authorEmail: ((await getSetting('gitAuthorEmail'))
                || availableOptions.authorEmail),
        };
    }
    async registerManager(manager) {
        this.managers.push(manager);
    }
    async init(forceReset = false) {
        let doInitialize;
        if (forceReset === true) {
            log.warn("C/db/isogit-yaml: Git is being force reinitialized");
            doInitialize = true;
        }
        else if (!(await this.git.isInitialized())) {
            log.warn("C/db/isogit-yaml: Git is not initialized yet");
            doInitialize = true;
        }
        else if (!(await this.git.isUsingRemoteURLs({
            origin: this.opts.repoURL,
            upstream: this.opts.upstreamRepoURL
        }))) {
            log.warn("C/db/isogit-yaml: Git has mismatching remote URLs, reinitializing");
            doInitialize = true;
        }
        else {
            log.info("C/db/isogit-yaml: Git is already initialized");
            doInitialize = false;
        }
        if (doInitialize) {
            await this.git.forceInitialize();
        }
        await this.git.loadAuth();
    }
    async read(objID, metaFields) {
        return await this.fs.read(this.getRef(objID), metaFields);
    }
    async create(obj, objPath, metaFields) {
        if (await this.fs.exists(objPath)) {
            throw new UniqueConstraintError("filesystem path", objPath);
        }
        await this.fs.write(objPath, obj, metaFields);
    }
    async commit(objIDs, message) {
        await this.resetOrphanedFileChanges();
        const paths = (await this.readUncommittedFileInfo()).
            filter(fileinfo => objIDs.indexOf(fileinfo.path) >= 0).
            map(fileinfo => fileinfo.path);
        if (paths.length > 0) {
            await this.git.stageAndCommit(paths, message);
        }
    }
    async discard(objIDs) {
        const paths = (await this.readUncommittedFileInfo()).
            filter(fileinfo => objIDs.indexOf(fileinfo.path) >= 0).
            map(fileinfo => fileinfo.path);
        if (paths.length > 0) {
            await this.git.resetFiles(paths);
        }
    }
    async listUncommitted() {
        const files = await this.readUncommittedFileInfo();
        const objIDs = files.
            map(fileinfo => fileinfo.path);
        // Discard duplicates from the list
        return objIDs.filter(function (objID, idx, self) {
            return idx === self.indexOf(objID);
        });
    }
    async readAll(idField) {
        const objs = await this.fs.readAll();
        var idx = {};
        for (const obj of objs) {
            idx[`${obj[idField]}`] = obj;
        }
        return idx;
    }
    async update(objID, newData, idField) {
        if (objID !== newData[idField]) {
            throw new Error("Updating object IDs is not supported at the moment.");
        }
        await this.fs.write(this.getRef(objID), newData);
    }
    async delete(objID) {
        await this.fs.write(this.getRef(objID), undefined);
    }
    async resetOrphanedFileChanges() {
        /* Remove from filesystem any files under our FS backend path
           that the backend cannot account for,
           but which may appear as unstaged changes to Git. */
        const orphanFilePaths = (await this.readUncommittedFileInfo()).
            map(fileinfo => fileinfo.path).
            filter(filepath => this.managers.map(mgr => mgr.managesFileAtPath(filepath)).indexOf(true) >= 0);
        if (orphanFilePaths.length > 0) {
            log.warn("C/db/isogit-yaml: Resetting orphaned files", orphanFilePaths);
            await this.git.resetFiles(orphanFilePaths);
        }
    }
    async readUncommittedFileInfo() {
        /* Returns a list of objects that map Git-relative paths to actual object IDs.
           Where object ID is undefined, that implies file is “orphaned”
           (not recognized as belonging to any object managed by this store). */
        const changedFiles = await this.git.listChangedFiles(['.']);
        return await Promise.all(changedFiles.map(fp => {
            return { path: fp };
        }));
    }
    getRef(objID) {
        /* Returns FS backend reference given object ID. */
        return `${objID}`;
    }
    async synchronize() {
        return await this.git.synchronize(this.reportBackendStatus);
    }
    async checkUncommitted() {
        return await this.git.checkUncommitted(this.reportBackendStatus);
    }
    setUpIPC(dbID) {
        log.verbose("C/db/isogit-yaml: Setting up IPC");
        const prefix = `db-${dbID}`;
        ipcMain.on(`${prefix}-git-trigger-sync`, this.synchronize);
        ipcMain.on(`${prefix}-git-discard-unstaged`, () => this.git.resetFiles());
        ipcMain.on(`${prefix}-git-update-status`, this.checkUncommitted);
        listen(`${prefix}-git-config-set`, async ({ name, email, username }) => {
            log.verbose("C/db/isogit-yaml: received git-config-set request");
            await this.git.configSet('user.name', name);
            await this.git.configSet('user.email', email);
            await this.git.configSet('credentials.username', username);
            await this.git.loadAuth();
            // ^ this.git.auth.username = username
            this.synchronize();
            return { success: true };
        });
        listen(`${prefix}-git-set-password`, async ({ password }) => {
            // WARNING: Don’t log password
            log.verbose("C/db/isogit-yaml: received git-set-password request");
            this.git.setPassword(password);
            this.synchronize();
            return { success: true };
        });
        listen(`${prefix}-git-config-get`, async () => {
            log.verbose("C/db/isogit-yaml: received git-config request");
            return {
                originURL: await this.git.getOriginUrl(),
                name: await this.git.configGet('user.name'),
                email: await this.git.configGet('user.email'),
                username: await this.git.configGet('credentials.username'),
            };
        });
    }
};
export default Backend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9pc29naXQteWFtbC9tYWluL2Jhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFL0IsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBa0IsTUFBTSx3QkFBd0IsQ0FBQztBQUdqRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFVckQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFrQ3pDLE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBdUUsTUFBTSxPQUFPO0lBUXRHLFlBQW9CLElBQW9CLEVBQVUsbUJBQTBDO1FBQXhFLFNBQUksR0FBSixJQUFJLENBQWdCO1FBQVUsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUF1QjtRQUMxRixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV0RCxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksYUFBYSxDQUMxQixFQUFFLEVBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQ3ZCLENBQUM7UUFFRixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMsV0FBVyxH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SUFDTCxDQUFDO0NBQ0YsQ0FBQTtBQUVELGVBQWUsT0FBTyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbG9nIGZyb20gJ2VsZWN0cm9uLWxvZyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5cbmltcG9ydCB7IGlwY01haW4gfSBmcm9tICdlbGVjdHJvbic7XG5cbmltcG9ydCB7IGxpc3RlbiB9IGZyb20gJy4uLy4uLy4uL2lwYy9tYWluJztcbmltcG9ydCB7IFNldHRpbmcsIFNldHRpbmdNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vLi4vc2V0dGluZ3MvbWFpbic7XG5cbmltcG9ydCB7IEluZGV4IH0gZnJvbSAnLi4vLi4vcXVlcnknO1xuaW1wb3J0IHsgVW5pcXVlQ29uc3RyYWludEVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzJztcblxuaW1wb3J0IHtcbiAgQmFja2VuZENsYXNzLFxuICBCYWNrZW5kU3RhdHVzIGFzIEJhc2VCYWNrZW5kU3RhdHVzLFxuICBCYWNrZW5kU3RhdHVzUmVwb3J0ZXIgYXMgQmFzZUJhY2tlbmRTdGF0dXNSZXBvcnRlcixcbiAgVmVyc2lvbmVkRmlsZXN5c3RlbUJhY2tlbmQsXG4gIFZlcnNpb25lZEZpbGVzeXN0ZW1NYW5hZ2VyLFxufSBmcm9tICcuLi8uLi9tYWluL2Jhc2UnO1xuXG5pbXBvcnQgeyBZQU1MRGlyZWN0b3J5V3JhcHBlciB9IGZyb20gJy4veWFtbCc7XG5pbXBvcnQgeyBJc29HaXRXcmFwcGVyIH0gZnJvbSAnLi9pc29naXQnO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgRml4ZWRCYWNrZW5kT3B0aW9ucyB7XG4gIC8qIFNldHRpbmdzIHN1cHBsaWVkIGJ5IHRoZSBkZXZlbG9wZXIgKi9cbiAgd29ya0Rpcjogc3RyaW5nXG4gIGNvcnNQcm94eVVSTDogc3RyaW5nXG4gIHVwc3RyZWFtUmVwb1VSTDogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29uZmlndXJhYmxlQmFja2VuZE9wdGlvbnMge1xuICAvKiBTZXR0aW5ncyB0aGF0IHVzZXIgY2FuIG9yIG11c3Qgc3BlY2lmeSAqL1xuICByZXBvVVJMOiBzdHJpbmdcbiAgdXNlcm5hbWU6IHN0cmluZ1xuICBhdXRob3JOYW1lOiBzdHJpbmdcbiAgYXV0aG9yRW1haWw6IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBCYWNrZW5kT3B0aW9ucyA9IEZpeGVkQmFja2VuZE9wdGlvbnMgJiBDb25maWd1cmFibGVCYWNrZW5kT3B0aW9uc1xuXG5leHBvcnQgdHlwZSBJbml0aWFsQmFja2VuZE9wdGlvbnMgPSBGaXhlZEJhY2tlbmRPcHRpb25zICYgUGFydGlhbDxDb25maWd1cmFibGVCYWNrZW5kT3B0aW9ucz5cblxuXG5leHBvcnQgaW50ZXJmYWNlIEJhY2tlbmRTdGF0dXMgZXh0ZW5kcyBCYXNlQmFja2VuZFN0YXR1cyB7XG4gIGlzT2ZmbGluZTogYm9vbGVhblxuICBoYXNMb2NhbENoYW5nZXM6IGJvb2xlYW5cbiAgbmVlZHNQYXNzd29yZDogYm9vbGVhblxuICBzdGF0dXNSZWxhdGl2ZVRvTG9jYWw6ICdhaGVhZCcgfCAnYmVoaW5kJyB8ICdkaXZlcmdlZCcgfCAndXBkYXRlZCcgfCB1bmRlZmluZWRcbiAgaXNQdXNoaW5nOiBib29sZWFuXG4gIGlzUHVsbGluZzogYm9vbGVhblxufVxuZXhwb3J0IHR5cGUgQmFja2VuZFN0YXR1c1JlcG9ydGVyID0gQmFzZUJhY2tlbmRTdGF0dXNSZXBvcnRlcjxCYWNrZW5kU3RhdHVzPlxuXG5cbmV4cG9ydCBjb25zdCBCYWNrZW5kOiBCYWNrZW5kQ2xhc3M8SW5pdGlhbEJhY2tlbmRPcHRpb25zLCBCYWNrZW5kT3B0aW9ucywgQmFja2VuZFN0YXR1cz4gPSBjbGFzcyBCYWNrZW5kXG5pbXBsZW1lbnRzIFZlcnNpb25lZEZpbGVzeXN0ZW1CYWNrZW5kIHtcbiAgLyogQ29tYmluZXMgYSBmaWxlc3lzdGVtIHN0b3JhZ2Ugd2l0aCBHaXQuICovXG5cbiAgcHJpdmF0ZSBnaXQ6IElzb0dpdFdyYXBwZXI7XG4gIHByaXZhdGUgZnM6IFlBTUxEaXJlY3RvcnlXcmFwcGVyO1xuICBwcml2YXRlIG1hbmFnZXJzOiBWZXJzaW9uZWRGaWxlc3lzdGVtTWFuYWdlcltdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3B0czogQmFja2VuZE9wdGlvbnMsIHByaXZhdGUgcmVwb3J0QmFja2VuZFN0YXR1czogQmFja2VuZFN0YXR1c1JlcG9ydGVyKSB7XG4gICAgdGhpcy5mcyA9IG5ldyBZQU1MRGlyZWN0b3J5V3JhcHBlcih0aGlzLm9wdHMud29ya0Rpcik7XG5cbiAgICB0aGlzLmdpdCA9IG5ldyBJc29HaXRXcmFwcGVyKFxuICAgICAgZnMsXG4gICAgICB0aGlzLm9wdHMucmVwb1VSTCxcbiAgICAgIHRoaXMub3B0cy51cHN0cmVhbVJlcG9VUkwsXG4gICAgICB0aGlzLm9wdHMud29ya0RpcixcbiAgICAgIHRoaXMub3B0cy5jb3JzUHJveHlVUkwsXG4gICAgKTtcblxuICAgIHRoaXMubWFuYWdlcnMgPSBbXTtcblxuICAgIHRoaXMuc3luY2hyb25pemUgPSB0aGlzLnN5bmNocm9uaXplLmJpbmQodGhpcyk7XG5cbiAgICAvLyB0aGlzLmNvbGxlY3Rpb25zID0gT2JqZWN0LmVudHJpZXModGhpcy5vcHRzLmNvbGxlY3Rpb25zKS5tYXAoKFtjb2xsZWN0aW9uSUQsIGNvbGxlY3Rpb25PcHRpb25zXSkgPT4ge1xuICAgIC8vICAgcmV0dXJuIHsgW2NvbGxlY3Rpb25JRF06IHsgaW5kZXg6IHt9LCBvcHRzOiBjb2xsZWN0aW9uT3B0aW9ucyB9IH0gYXMgUGFydGlhbDxDb2xsZWN0aW9ucz47XG4gICAgLy8gfSkucmVkdWNlKCh2YWwsIGFjYykgPT4gKHsgLi4uYWNjLCAuLi52YWwgfSksIHt9IGFzIFBhcnRpYWw8Q29sbGVjdGlvbnM+KSBhcyBDb2xsZWN0aW9ucztcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgcmVnaXN0ZXJTZXR0aW5nc0ZvckNvbmZpZ3VyYWJsZU9wdGlvbnMoXG4gICAgICBzZXR0aW5nczogU2V0dGluZ01hbmFnZXIsXG4gICAgICBpbml0aWFsT3B0aW9uczogSW5pdGlhbEJhY2tlbmRPcHRpb25zLFxuICAgICAgZGJJRDogc3RyaW5nKSB7XG5cbiAgICBjb25zdCBwYW5lTGFiZWxQb3N0Zml4ID0gZGJJRCAhPT0gJ2RlZmF1bHQnID8gYCBmb3Ig4oCcJHtkYklEfeKAnWAgOiAnJztcbiAgICBjb25zdCBzZXR0aW5nSURQcmVmaXggPSBgZGJfJHtkYklEfV9gO1xuICAgIGNvbnN0IHBhbmVJRCA9IGBkYl8ke2RiSUR9YDtcblxuICAgIHNldHRpbmdzLmNvbmZpZ3VyZVBhbmUoe1xuICAgICAgaWQ6IHBhbmVJRCxcbiAgICAgIGxhYmVsOiBgRGF0YWJhc2Ugc2V0dGluZ3Mke3BhbmVMYWJlbFBvc3RmaXh9YCxcbiAgICAgIGljb246ICdnaXQtbWVyZ2UnLFxuICAgIH0pO1xuXG4gICAgc2V0dGluZ3MucmVnaXN0ZXIobmV3IFNldHRpbmc8c3RyaW5nPihcbiAgICAgIHBhbmVJRCxcbiAgICAgIGAke3NldHRpbmdJRFByZWZpeH1naXRSZXBvVXJsYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLnJlcG9VUkwgPT09IHVuZGVmaW5lZCxcbiAgICAgIFwiR2l0IHJlcG9zaXRvcnkgVVJMXCIsXG4gICAgKSk7XG5cbiAgICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICAgcGFuZUlELFxuICAgICAgYCR7c2V0dGluZ0lEUHJlZml4fWdpdFVzZXJuYW1lYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLnVzZXJuYW1lID09PSB1bmRlZmluZWQsXG4gICAgICBcIkdpdCB1c2VybmFtZVwiLFxuICAgICkpO1xuXG4gICAgc2V0dGluZ3MucmVnaXN0ZXIobmV3IFNldHRpbmc8c3RyaW5nPihcbiAgICAgIHBhbmVJRCxcbiAgICAgIGAke3NldHRpbmdJRFByZWZpeH1naXRBdXRob3JOYW1lYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLmF1dGhvck5hbWUgPT09IHVuZGVmaW5lZCxcbiAgICAgIFwiR2l0IGF1dGhvciBuYW1lXCIsXG4gICAgKSk7XG5cbiAgICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICAgcGFuZUlELFxuICAgICAgYCR7c2V0dGluZ0lEUHJlZml4fWdpdEF1dGhvckVtYWlsYCxcbiAgICAgICd0ZXh0JyxcbiAgICAgIGluaXRpYWxPcHRpb25zLmF1dGhvckVtYWlsID09PSB1bmRlZmluZWQsXG4gICAgICBcIkdpdCBhdXRob3IgZW1haWxcIixcbiAgICApKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgY29tcGxldGVPcHRpb25zRnJvbVNldHRpbmdzKFxuICAgICAgc2V0dGluZ3M6IFNldHRpbmdNYW5hZ2VyLFxuICAgICAgYXZhaWxhYmxlT3B0aW9uczogSW5pdGlhbEJhY2tlbmRPcHRpb25zLFxuICAgICAgZGJJRDogc3RyaW5nKSB7XG5cbiAgICBjb25zdCBzZXR0aW5nSURQcmVmaXggPSBgZGJfJHtkYklEfV9gO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gZ2V0U2V0dGluZzxUPihzZXR0aW5nSUQ6IHN0cmluZyk6IFByb21pc2U8VD4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHNldHRpbmdzLmdldFZhbHVlKGAke3NldHRpbmdJRFByZWZpeH0ke3NldHRpbmdJRH1gKSBhcyBUO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB3b3JrRGlyOiBhdmFpbGFibGVPcHRpb25zLndvcmtEaXIsXG4gICAgICBjb3JzUHJveHlVUkw6IGF2YWlsYWJsZU9wdGlvbnMuY29yc1Byb3h5VVJMLFxuICAgICAgdXBzdHJlYW1SZXBvVVJMOiBhdmFpbGFibGVPcHRpb25zLnVwc3RyZWFtUmVwb1VSTCxcblxuICAgICAgcmVwb1VSTDogKFxuICAgICAgICAoYXdhaXQgZ2V0U2V0dGluZzxzdHJpbmc+KCdnaXRSZXBvVXJsJykpXG4gICAgICAgIHx8IGF2YWlsYWJsZU9wdGlvbnMucmVwb1VSTCkgYXMgc3RyaW5nLFxuICAgICAgdXNlcm5hbWU6IChcbiAgICAgICAgKGF3YWl0IGdldFNldHRpbmc8c3RyaW5nPignZ2l0VXNlcm5hbWUnKSlcbiAgICAgICAgfHwgYXZhaWxhYmxlT3B0aW9ucy51c2VybmFtZSkgYXMgc3RyaW5nLFxuICAgICAgYXV0aG9yTmFtZTogKFxuICAgICAgICAoYXdhaXQgZ2V0U2V0dGluZzxzdHJpbmc+KCdnaXRBdXRob3JOYW1lJykpXG4gICAgICAgIHx8IGF2YWlsYWJsZU9wdGlvbnMuYXV0aG9yTmFtZSkgYXMgc3RyaW5nLFxuICAgICAgYXV0aG9yRW1haWw6IChcbiAgICAgICAgKGF3YWl0IGdldFNldHRpbmc8c3RyaW5nPignZ2l0QXV0aG9yRW1haWwnKSlcbiAgICAgICAgfHwgYXZhaWxhYmxlT3B0aW9ucy5hdXRob3JFbWFpbCkgYXMgc3RyaW5nLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWdpc3Rlck1hbmFnZXIobWFuYWdlcjogVmVyc2lvbmVkRmlsZXN5c3RlbU1hbmFnZXIpIHtcbiAgICB0aGlzLm1hbmFnZXJzLnB1c2gobWFuYWdlcik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdChmb3JjZVJlc2V0ID0gZmFsc2UpIHtcbiAgICBsZXQgZG9Jbml0aWFsaXplOiBib29sZWFuO1xuXG4gICAgaWYgKGZvcmNlUmVzZXQgPT09IHRydWUpIHtcbiAgICAgIGxvZy53YXJuKFwiQy9kYi9pc29naXQteWFtbDogR2l0IGlzIGJlaW5nIGZvcmNlIHJlaW5pdGlhbGl6ZWRcIik7XG4gICAgICBkb0luaXRpYWxpemUgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoIShhd2FpdCB0aGlzLmdpdC5pc0luaXRpYWxpemVkKCkpKSB7XG4gICAgICBsb2cud2FybihcIkMvZGIvaXNvZ2l0LXlhbWw6IEdpdCBpcyBub3QgaW5pdGlhbGl6ZWQgeWV0XCIpO1xuICAgICAgZG9Jbml0aWFsaXplID0gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKCEoYXdhaXQgdGhpcy5naXQuaXNVc2luZ1JlbW90ZVVSTHMoe1xuICAgICAgICBvcmlnaW46IHRoaXMub3B0cy5yZXBvVVJMLFxuICAgICAgICB1cHN0cmVhbTogdGhpcy5vcHRzLnVwc3RyZWFtUmVwb1VSTH0pKSkge1xuICAgICAgbG9nLndhcm4oXCJDL2RiL2lzb2dpdC15YW1sOiBHaXQgaGFzIG1pc21hdGNoaW5nIHJlbW90ZSBVUkxzLCByZWluaXRpYWxpemluZ1wiKTtcbiAgICAgIGRvSW5pdGlhbGl6ZSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5pbmZvKFwiQy9kYi9pc29naXQteWFtbDogR2l0IGlzIGFscmVhZHkgaW5pdGlhbGl6ZWRcIik7XG4gICAgICBkb0luaXRpYWxpemUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoZG9Jbml0aWFsaXplKSB7XG4gICAgICBhd2FpdCB0aGlzLmdpdC5mb3JjZUluaXRpYWxpemUoKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmdpdC5sb2FkQXV0aCgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWQob2JqSUQ6IHN0cmluZywgbWV0YUZpZWxkczogc3RyaW5nW10pIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5mcy5yZWFkKHRoaXMuZ2V0UmVmKG9iaklEKSwgbWV0YUZpZWxkcykgYXMgb2JqZWN0O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZTxPIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55Pj4ob2JqOiBPLCBvYmpQYXRoOiBzdHJpbmcsIG1ldGFGaWVsZHM6IChrZXlvZiBPKVtdKSB7XG4gICAgaWYgKGF3YWl0IHRoaXMuZnMuZXhpc3RzKG9ialBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgVW5pcXVlQ29uc3RyYWludEVycm9yKFwiZmlsZXN5c3RlbSBwYXRoXCIsIG9ialBhdGgpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZnMud3JpdGUob2JqUGF0aCwgb2JqLCBtZXRhRmllbGRzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjb21taXQob2JqSURzOiBzdHJpbmdbXSwgbWVzc2FnZTogc3RyaW5nKSB7XG4gICAgYXdhaXQgdGhpcy5yZXNldE9ycGhhbmVkRmlsZUNoYW5nZXMoKTtcblxuICAgIGNvbnN0IHBhdGhzOiBzdHJpbmdbXSA9IChhd2FpdCB0aGlzLnJlYWRVbmNvbW1pdHRlZEZpbGVJbmZvKCkpLlxuICAgICAgZmlsdGVyKGZpbGVpbmZvID0+IG9iaklEcy5pbmRleE9mKGZpbGVpbmZvLnBhdGgpID49IDApLlxuICAgICAgbWFwKGZpbGVpbmZvID0+IGZpbGVpbmZvLnBhdGgpO1xuXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IHRoaXMuZ2l0LnN0YWdlQW5kQ29tbWl0KHBhdGhzLCBtZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGlzY2FyZChvYmpJRHM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgcGF0aHM6IHN0cmluZ1tdID0gKGF3YWl0IHRoaXMucmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKSkuXG4gICAgICBmaWx0ZXIoZmlsZWluZm8gPT4gb2JqSURzLmluZGV4T2YoZmlsZWluZm8ucGF0aCkgPj0gMCkuXG4gICAgICBtYXAoZmlsZWluZm8gPT4gZmlsZWluZm8ucGF0aCk7XG5cbiAgICBpZiAocGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdGhpcy5naXQucmVzZXRGaWxlcyhwYXRocyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RVbmNvbW1pdHRlZCgpIHtcbiAgICBjb25zdCBmaWxlcyA9IGF3YWl0IHRoaXMucmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKTtcblxuICAgIGNvbnN0IG9iaklEczogc3RyaW5nW10gPSBmaWxlcy5cbiAgICAgIG1hcChmaWxlaW5mbyA9PiBmaWxlaW5mby5wYXRoKTtcblxuICAgIC8vIERpc2NhcmQgZHVwbGljYXRlcyBmcm9tIHRoZSBsaXN0XG4gICAgcmV0dXJuIG9iaklEcy5maWx0ZXIoZnVuY3Rpb24gKG9iaklELCBpZHgsIHNlbGYpIHtcbiAgICAgIHJldHVybiBpZHggPT09IHNlbGYuaW5kZXhPZihvYmpJRCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZEFsbChpZEZpZWxkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBvYmpzID0gYXdhaXQgdGhpcy5mcy5yZWFkQWxsKCk7XG4gICAgdmFyIGlkeDogSW5kZXg8YW55PiA9IHt9O1xuICAgIGZvciAoY29uc3Qgb2JqIG9mIG9ianMpIHtcbiAgICAgIGlkeFtgJHtvYmpbaWRGaWVsZF19YF0gPSBvYmo7XG4gICAgfVxuICAgIHJldHVybiBpZHg7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKG9iaklEOiBzdHJpbmcsIG5ld0RhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4sIGlkRmllbGQ6IHN0cmluZykge1xuICAgIGlmIChvYmpJRCAhPT0gbmV3RGF0YVtpZEZpZWxkXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVXBkYXRpbmcgb2JqZWN0IElEcyBpcyBub3Qgc3VwcG9ydGVkIGF0IHRoZSBtb21lbnQuXCIpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZnMud3JpdGUodGhpcy5nZXRSZWYob2JqSUQpLCBuZXdEYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGUob2JqSUQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuZnMud3JpdGUodGhpcy5nZXRSZWYob2JqSUQpLCB1bmRlZmluZWQpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlc2V0T3JwaGFuZWRGaWxlQ2hhbmdlcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvKiBSZW1vdmUgZnJvbSBmaWxlc3lzdGVtIGFueSBmaWxlcyB1bmRlciBvdXIgRlMgYmFja2VuZCBwYXRoXG4gICAgICAgdGhhdCB0aGUgYmFja2VuZCBjYW5ub3QgYWNjb3VudCBmb3IsXG4gICAgICAgYnV0IHdoaWNoIG1heSBhcHBlYXIgYXMgdW5zdGFnZWQgY2hhbmdlcyB0byBHaXQuICovXG5cbiAgICBjb25zdCBvcnBoYW5GaWxlUGF0aHMgPSAoYXdhaXQgdGhpcy5yZWFkVW5jb21taXR0ZWRGaWxlSW5mbygpKS5cbiAgICBtYXAoZmlsZWluZm8gPT4gZmlsZWluZm8ucGF0aCkuXG4gICAgZmlsdGVyKGZpbGVwYXRoID0+IHRoaXMubWFuYWdlcnMubWFwKG1nciA9PiBtZ3IubWFuYWdlc0ZpbGVBdFBhdGgoZmlsZXBhdGgpKS5pbmRleE9mKHRydWUpID49IDApO1xuXG4gICAgaWYgKG9ycGhhbkZpbGVQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBsb2cud2FybihcIkMvZGIvaXNvZ2l0LXlhbWw6IFJlc2V0dGluZyBvcnBoYW5lZCBmaWxlc1wiLCBvcnBoYW5GaWxlUGF0aHMpO1xuICAgICAgYXdhaXQgdGhpcy5naXQucmVzZXRGaWxlcyhvcnBoYW5GaWxlUGF0aHMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKTogUHJvbWlzZTx7IHBhdGg6IHN0cmluZyB9W10+IHtcbiAgICAvKiBSZXR1cm5zIGEgbGlzdCBvZiBvYmplY3RzIHRoYXQgbWFwIEdpdC1yZWxhdGl2ZSBwYXRocyB0byBhY3R1YWwgb2JqZWN0IElEcy5cbiAgICAgICBXaGVyZSBvYmplY3QgSUQgaXMgdW5kZWZpbmVkLCB0aGF0IGltcGxpZXMgZmlsZSBpcyDigJxvcnBoYW5lZOKAnVxuICAgICAgIChub3QgcmVjb2duaXplZCBhcyBiZWxvbmdpbmcgdG8gYW55IG9iamVjdCBtYW5hZ2VkIGJ5IHRoaXMgc3RvcmUpLiAqL1xuXG4gICAgY29uc3QgY2hhbmdlZEZpbGVzOiBzdHJpbmdbXSA9IGF3YWl0IHRoaXMuZ2l0Lmxpc3RDaGFuZ2VkRmlsZXMoWycuJ10pO1xuICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChjaGFuZ2VkRmlsZXMubWFwKGZwID0+IHtcbiAgICAgIHJldHVybiB7IHBhdGg6IGZwIH07XG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWYob2JqSUQ6IHN0cmluZyB8IG51bWJlcik6IHN0cmluZyB7XG4gICAgLyogUmV0dXJucyBGUyBiYWNrZW5kIHJlZmVyZW5jZSBnaXZlbiBvYmplY3QgSUQuICovXG4gICAgcmV0dXJuIGAke29iaklEfWA7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHN5bmNocm9uaXplKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdpdC5zeW5jaHJvbml6ZSh0aGlzLnJlcG9ydEJhY2tlbmRTdGF0dXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjaGVja1VuY29tbWl0dGVkKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdpdC5jaGVja1VuY29tbWl0dGVkKHRoaXMucmVwb3J0QmFja2VuZFN0YXR1cyk7XG4gIH1cblxuICBwdWJsaWMgc2V0VXBJUEMoZGJJRDogc3RyaW5nKSB7XG4gICAgbG9nLnZlcmJvc2UoXCJDL2RiL2lzb2dpdC15YW1sOiBTZXR0aW5nIHVwIElQQ1wiKTtcblxuICAgIGNvbnN0IHByZWZpeCA9IGBkYi0ke2RiSUR9YDtcblxuICAgIGlwY01haW4ub24oYCR7cHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCwgdGhpcy5zeW5jaHJvbml6ZSk7XG4gICAgaXBjTWFpbi5vbihgJHtwcmVmaXh9LWdpdC1kaXNjYXJkLXVuc3RhZ2VkYCwgKCkgPT4gdGhpcy5naXQucmVzZXRGaWxlcygpICk7XG4gICAgaXBjTWFpbi5vbihgJHtwcmVmaXh9LWdpdC11cGRhdGUtc3RhdHVzYCwgdGhpcy5jaGVja1VuY29tbWl0dGVkKTtcblxuICAgIGxpc3Rlbjx7IG5hbWU6IHN0cmluZywgZW1haWw6IHN0cmluZywgdXNlcm5hbWU6IHN0cmluZyB9LCB7IHN1Y2Nlc3M6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtY29uZmlnLXNldGAsIGFzeW5jICh7IG5hbWUsIGVtYWlsLCB1c2VybmFtZSB9KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShcIkMvZGIvaXNvZ2l0LXlhbWw6IHJlY2VpdmVkIGdpdC1jb25maWctc2V0IHJlcXVlc3RcIik7XG5cbiAgICAgIGF3YWl0IHRoaXMuZ2l0LmNvbmZpZ1NldCgndXNlci5uYW1lJywgbmFtZSk7XG4gICAgICBhd2FpdCB0aGlzLmdpdC5jb25maWdTZXQoJ3VzZXIuZW1haWwnLCBlbWFpbCk7XG4gICAgICBhd2FpdCB0aGlzLmdpdC5jb25maWdTZXQoJ2NyZWRlbnRpYWxzLnVzZXJuYW1lJywgdXNlcm5hbWUpO1xuXG4gICAgICBhd2FpdCB0aGlzLmdpdC5sb2FkQXV0aCgpO1xuICAgICAgLy8gXiB0aGlzLmdpdC5hdXRoLnVzZXJuYW1lID0gdXNlcm5hbWVcblxuICAgICAgdGhpcy5zeW5jaHJvbml6ZSgpO1xuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48eyBwYXNzd29yZDogc3RyaW5nIH0sIHsgc3VjY2VzczogdHJ1ZSB9PlxuICAgIChgJHtwcmVmaXh9LWdpdC1zZXQtcGFzc3dvcmRgLCBhc3luYyAoeyBwYXNzd29yZCB9KSA9PiB7XG4gICAgICAvLyBXQVJOSU5HOiBEb27igJl0IGxvZyBwYXNzd29yZFxuICAgICAgbG9nLnZlcmJvc2UoXCJDL2RiL2lzb2dpdC15YW1sOiByZWNlaXZlZCBnaXQtc2V0LXBhc3N3b3JkIHJlcXVlc3RcIik7XG5cbiAgICAgIHRoaXMuZ2l0LnNldFBhc3N3b3JkKHBhc3N3b3JkKTtcbiAgICAgIHRoaXMuc3luY2hyb25pemUoKTtcblxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IG9yaWdpblVSTDogc3RyaW5nIHwgbnVsbCwgbmFtZTogc3RyaW5nIHwgbnVsbCwgZW1haWw6IHN0cmluZyB8IG51bGwsIHVzZXJuYW1lOiBzdHJpbmcgfCBudWxsIH0+XG4gICAgKGAke3ByZWZpeH0tZ2l0LWNvbmZpZy1nZXRgLCBhc3luYyAoKSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShcIkMvZGIvaXNvZ2l0LXlhbWw6IHJlY2VpdmVkIGdpdC1jb25maWcgcmVxdWVzdFwiKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yaWdpblVSTDogYXdhaXQgdGhpcy5naXQuZ2V0T3JpZ2luVXJsKCksXG4gICAgICAgIG5hbWU6IGF3YWl0IHRoaXMuZ2l0LmNvbmZpZ0dldCgndXNlci5uYW1lJyksXG4gICAgICAgIGVtYWlsOiBhd2FpdCB0aGlzLmdpdC5jb25maWdHZXQoJ3VzZXIuZW1haWwnKSxcbiAgICAgICAgdXNlcm5hbWU6IGF3YWl0IHRoaXMuZ2l0LmNvbmZpZ0dldCgnY3JlZGVudGlhbHMudXNlcm5hbWUnKSxcbiAgICAgICAgLy8gUGFzc3dvcmQgbXVzdCBub3QgYmUgcmV0dXJuZWQsIG9mIGNvdXJzZVxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBCYWNrZW5kO1xuIl19