import * as log from 'electron-log';
import * as fs from 'fs-extra';
import { listen } from '../../../ipc/main';
import { Setting } from '../../../settings/main';
import { UniqueConstraintError } from '../../errors';
import { VersionedFilesystemBackend, } from '../../main/base';
import { IsoGitWrapper } from './isogit';
const DEFAULT_SYNC_INTERVAL = 50000;
class Backend extends VersionedFilesystemBackend {
    constructor(opts, reportBackendStatus) {
        super();
        this.opts = opts;
        this.reportBackendStatus = reportBackendStatus;
        this.gitSyncInterval = null;
        this.fs = opts.fsWrapper;
        this.git = new IsoGitWrapper(fs, this.opts.repoURL, this.opts.upstreamRepoURL, this.opts.username, { name: this.opts.authorName, email: this.opts.authorEmail }, this.opts.workDir, this.opts.corsProxyURL, 
        // The status of this backend is reduced to Git repo status now.
        // Potentially it should include filesystem-related status as well,
        // reporting issues with e.g. insufficient disk space.
        this.reportBackendStatus);
        this.managers = [];
        this.gitSyncIntervalDelay = opts.syncInterval || DEFAULT_SYNC_INTERVAL;
        this.synchronize = this.synchronize.bind(this);
    }
    async describe() {
        return {
            verboseName: "Git+YAML",
            verboseNameLong: "Git-versioned YAML file tree",
            gitRepo: this.opts.repoURL,
            gitUsername: this.opts.username,
            status: this.git.getStatus(),
        };
    }
    static registerSettingsForConfigurableOptions(settings, initialOptions, dbID) {
        const paneLabelPostfix = dbID !== 'default' ? ` for “${dbID}”` : '';
        const settingIDPrefix = `db_${dbID}_`;
        const paneID = `db_${dbID}`;
        settings.configurePane({
            id: paneID,
            label: `Database settings${paneLabelPostfix}`,
            icon: 'git-merge',
        });
        settings.register(new Setting(paneID, `${settingIDPrefix}gitRepoUrl`, 'text', initialOptions.repoURL === undefined, "Git repository URL"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitUsername`, 'text', initialOptions.username === undefined, "Git username"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitAuthorName`, 'text', initialOptions.authorName === undefined, "Git author name"));
        settings.register(new Setting(paneID, `${settingIDPrefix}gitAuthorEmail`, 'text', initialOptions.authorEmail === undefined, "Git author email"));
    }
    static async completeOptionsFromSettings(settings, availableOptions, dbID) {
        const settingIDPrefix = `db_${dbID}_`;
        async function getSetting(settingID) {
            return await settings.getValue(`${settingIDPrefix}${settingID}`);
        }
        const fsWrapperClass = (await availableOptions.fsWrapperClass()).default;
        return {
            workDir: availableOptions.workDir,
            corsProxyURL: availableOptions.corsProxyURL,
            upstreamRepoURL: availableOptions.upstreamRepoURL,
            fsWrapperClass: availableOptions.fsWrapperClass,
            fsWrapper: new fsWrapperClass(availableOptions.workDir),
            repoURL: ((await getSetting('gitRepoUrl'))
                || availableOptions.repoURL),
            username: ((await getSetting('gitUsername'))
                || availableOptions.username),
            authorName: ((await getSetting('gitAuthorName'))
                || availableOptions.authorName),
            authorEmail: ((await getSetting('gitAuthorEmail'))
                || availableOptions.authorEmail),
        };
    }
    async registerManager(manager) {
        this.managers.push(manager);
    }
    async init(forceReset = false) {
        let doInitialize;
        try {
            if (forceReset === true) {
                log.warn("C/db/isogit-yaml: Git is being force reinitialized");
                doInitialize = true;
            }
            else if (!(await this.git.isUsingRemoteURLs({
                origin: this.opts.repoURL,
                upstream: this.opts.upstreamRepoURL
            }))) {
                log.warn("C/db/isogit-yaml: Git has mismatching remote URLs, reinitializing");
                doInitialize = true;
            }
            else {
                log.info("C/db/isogit-yaml: Git is already initialized");
                doInitialize = false;
            }
        }
        catch (e) {
            doInitialize = true;
        }
        if (doInitialize) {
            await this.git.destroy();
        }
        if (this.gitSyncInterval) {
            clearInterval(this.gitSyncInterval);
        }
        this.gitSyncInterval = setInterval(this.synchronize, this.gitSyncIntervalDelay);
        await this.synchronize();
    }
    async read(objID, metaFields) {
        return await this.fs.read(this.getRef(objID), metaFields);
    }
    async readVersion(objID, version) {
        // NOTE: This will fail with YAMLDirectoryWrapper.
        // objID must refer to a single file.
        // TODO: Support compound objects (directories)
        // by moving the file data parsing logic into manager
        // and adding Backend.readTree().
        const blob = await this.git.readFileBlobAtCommit(this.getRef(objID), version);
        return this.fs.parseData(blob);
    }
    async create(obj, objPath, metaFields) {
        if (await this.fs.exists(objPath)) {
            throw new UniqueConstraintError("filesystem path", objPath);
        }
        await this.fs.write(objPath, obj, metaFields);
    }
    async commit(objIDs, message) {
        await this.resetOrphanedFileChanges();
        const paths = (await this.readUncommittedFileInfo()).
            filter(fileinfo => objIDs.indexOf(fileinfo.path) >= 0).
            map(fileinfo => fileinfo.path);
        if (paths.length > 0) {
            // TODO: Make Git track which files got committed (had changes),
            // and return paths
            await this.git.stageAndCommit(paths, message);
        }
    }
    async discard(objIDs) {
        const paths = (await this.readUncommittedFileInfo()).
            filter(fileinfo => objIDs.indexOf(fileinfo.path) >= 0).
            map(fileinfo => fileinfo.path);
        if (paths.length > 0) {
            await this.git.resetFiles(paths);
        }
    }
    async listUncommitted() {
        const files = await this.readUncommittedFileInfo();
        const objIDs = files.
            map(fileinfo => fileinfo.path);
        // Discard duplicates from the list
        return objIDs.filter(function (objID, idx, self) {
            return idx === self.indexOf(objID);
        });
    }
    async listIDs(query) {
        return await this.fs.listIDs({ subdir: query.subdir });
    }
    async getIndex(subdir, idField, onlyIDs) {
        const idsToSelect = onlyIDs !== undefined
            ? onlyIDs.map(id => this.getRef(id))
            : undefined;
        const objs = await this.fs.readAll({ subdir, onlyIDs: idsToSelect });
        var idx = {};
        for (const obj of objs) {
            idx[`${obj[idField]}`] = obj;
        }
        return idx;
    }
    async update(objID, newData, idField) {
        await this.fs.write(this.getRef(objID), newData);
    }
    async delete(objID) {
        await this.fs.write(this.getRef(objID), undefined);
    }
    async resetOrphanedFileChanges() {
        /* Remove from filesystem any files under our FS backend path
           that the backend cannot account for,
           but which may appear as unstaged changes to Git. */
        const orphanFilePaths = (await this.readUncommittedFileInfo()).
            map(fileinfo => fileinfo.path).
            filter(filepath => this.managers.map(mgr => mgr.managesFileAtPath(filepath)).indexOf(true) < 0);
        if (orphanFilePaths.length > 0) {
            log.warn("C/db/isogit-yaml: Resetting orphaned files", orphanFilePaths);
            await this.git.resetFiles(orphanFilePaths);
        }
    }
    async readUncommittedFileInfo() {
        /* Returns a list of objects that map Git-relative paths to actual object IDs.
           Where object ID is undefined, that implies file is “orphaned”
           (not recognized as belonging to any object managed by this store). */
        const changedFiles = await this.git.listChangedFiles(['.']);
        return await Promise.all(changedFiles.map(fp => {
            return { path: fp };
        }));
    }
    getRef(objID) {
        /* Returns FS backend reference from DB backend object ID. */
        return `${objID}`;
    }
    async synchronize() {
        await this.git.synchronize();
        for (const mgr of this.managers) {
            mgr.reportUpdatedData();
        }
    }
    async checkUncommitted() {
        return await this.git.checkUncommitted();
    }
    setUpIPC(dbID) {
        super.setUpIPC(dbID);
        log.verbose("C/db/isogit-yaml: Setting up IPC");
        const prefix = `db-${dbID}`;
        listen(`${prefix}-count-uncommitted`, async () => {
            return { numUncommitted: (await this.git.listChangedFiles()).length };
        });
        listen(`${prefix}-git-trigger-sync`, async () => {
            this.synchronize();
            return { started: true };
        });
        listen(`${prefix}-git-discard-unstaged`, async () => {
            await this.git.resetFiles();
            return { success: true };
        });
        listen(`${prefix}-git-update-status`, async () => {
            return { hasUncommittedChanges: await this.checkUncommitted() };
        });
        listen(`${prefix}-git-set-password`, async ({ password }) => {
            // WARNING: Don’t log password
            log.verbose("C/db/isogit-yaml: received git-set-password request");
            this.git.setPassword(password);
            this.synchronize();
            return { success: true };
        });
        listen(`${prefix}-git-config-get`, async () => {
            log.verbose("C/db/isogit-yaml: received git-config request");
            return {
                originURL: await this.git.getOriginUrl(),
                name: await this.git.configGet('user.name'),
                email: await this.git.configGet('user.email'),
                username: await this.git.configGet('credentials.username'),
            };
        });
    }
}
export const BackendClass = Backend;
export default Backend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9pc29naXQteWFtbC9tYWluL2Jhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQWtCLE1BQU0sd0JBQXdCLENBQUM7QUFHakUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBSXJELE9BQU8sRUFHTCwwQkFBMEIsR0FHM0IsTUFBTSxpQkFBaUIsQ0FBQztBQUl6QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBR3pDLE1BQU0scUJBQXFCLEdBQUcsS0FBSyxDQUFDO0FBK0JwQyxNQUFNLE9BQVEsU0FBUSwwQkFBMEI7SUFTOUMsWUFDWSxJQUFvQixFQUNwQixtQkFBMEM7UUFFcEQsS0FBSyxFQUFFLENBQUM7UUFIRSxTQUFJLEdBQUosSUFBSSxDQUFnQjtRQUNwQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXVCO1FBTjlDLG9CQUFlLEdBQTBCLElBQUksQ0FBQztRQVVwRCxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFFekIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLGFBQWEsQ0FDMUIsRUFBRSxFQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQ2xCLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUM1RCxJQUFJ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LE9BQU87Z0JBQ0wsU0FBUyxFQUFFLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUU7Z0JBQ3hDLElBQUksRUFBRSxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztnQkFDM0MsS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDO2dCQUM3QyxRQUFRLEVBQUUsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQzthQUUzRCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQTJFLE9BQU8sQ0FBQTtBQUUzRyxlQUFlLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGxvZyBmcm9tICdlbGVjdHJvbi1sb2cnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuXG5pbXBvcnQgeyBsaXN0ZW4gfSBmcm9tICcuLi8uLi8uLi9pcGMvbWFpbic7XG5pbXBvcnQgeyBTZXR0aW5nLCBTZXR0aW5nTWFuYWdlciB9IGZyb20gJy4uLy4uLy4uL3NldHRpbmdzL21haW4nO1xuXG5pbXBvcnQgeyBJbmRleCB9IGZyb20gJy4uLy4uL3F1ZXJ5JztcbmltcG9ydCB7IFVuaXF1ZUNvbnN0cmFpbnRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XG5cbmltcG9ydCB7IEZpbGVzeXN0ZW1XcmFwcGVyIH0gZnJvbSAnLi4vLi4vbWFpbi9mcy13cmFwcGVyJztcblxuaW1wb3J0IHtcbiAgQmFja2VuZENsYXNzIGFzIEJhc2VCYWNrZW5kQ2xhc3MsXG4gIEJhY2tlbmRTdGF0dXNSZXBvcnRlciBhcyBCYXNlQmFja2VuZFN0YXR1c1JlcG9ydGVyLFxuICBWZXJzaW9uZWRGaWxlc3lzdGVtQmFja2VuZCxcbiAgTW9kZWxNYW5hZ2VyLFxuICBGaWxlc3lzdGVtTWFuYWdlcixcbn0gZnJvbSAnLi4vLi4vbWFpbi9iYXNlJztcblxuaW1wb3J0IHsgQmFja2VuZERlc2NyaXB0aW9uLCBCYWNrZW5kU3RhdHVzIH0gZnJvbSAnLi4vYmFzZSc7XG5cbmltcG9ydCB7IElzb0dpdFdyYXBwZXIgfSBmcm9tICcuL2lzb2dpdCc7XG5cblxuY29uc3QgREVGQVVMVF9TWU5DX0lOVEVSVkFMID0gNTAwMDA7XG5cblxuaW50ZXJmYWNlIEZpeGVkQmFja2VuZE9wdGlvbnMge1xuICAvKiBTZXR0aW5ncyBzdXBwbGllZCBieSB0aGUgZGV2ZWxvcGVyICovXG5cbiAgd29ya0Rpcjogc3RyaW5nXG4gIGNvcnNQcm94eVVSTDogc3RyaW5nXG4gIHVwc3RyZWFtUmVwb1VSTDogc3RyaW5nXG4gIGZzV3JhcHBlckNsYXNzOiAoKSA9PiBQcm9taXNlPHsgZGVmYXVsdDogbmV3IChiYXNlRGlyOiBzdHJpbmcpID0+IEZpbGVzeXN0ZW1XcmFwcGVyPGFueT4gfT5cblxuICBzeW5jSW50ZXJ2YWw/OiBudW1iZXJcbiAgLy8gSG93IG9mdGVuIHRvIHRyeSB0byBzeW5jaHJvbml6ZSBHaXQgcmVtb3RlIGluIGJhY2tncm91bmQsIGluIG1zLlxuICAvLyBTeW5jaHJvbml6YXRpb24gd2lsbCBiZSBza2lwcGVkIGlmIGFub3RoZXIgb25lIGlzIGFscmVhZHkgcnVubmluZy5cbn1cbmludGVyZmFjZSBDb25maWd1cmFibGVCYWNrZW5kT3B0aW9ucyB7XG4gIC8qIFNldHRpbmdzIHRoYXQgdXNlciBjYW4gb3IgbXVzdCBzcGVjaWZ5ICovXG4gIHJlcG9VUkw6IHN0cmluZ1xuICB1c2VybmFtZTogc3RyaW5nXG4gIGF1dGhvck5hbWU6IHN0cmluZ1xuICBhdXRob3JFbWFpbDogc3RyaW5nXG59XG50eXBlIEJhY2tlbmRPcHRpb25zID0gRml4ZWRCYWNrZW5kT3B0aW9ucyAmIENvbmZpZ3VyYWJsZUJhY2tlbmRPcHRpb25zICYge1xuICBmc1dyYXBwZXI6IEZpbGVzeXN0ZW1XcmFwcGVyPGFueT5cbn1cbnR5cGUgSW5pdGlhbEJhY2tlbmRPcHRpb25zID0gRml4ZWRCYWNrZW5kT3B0aW9ucyAmIFBhcnRpYWw8Q29uZmlndXJhYmxlQmFja2VuZE9wdGlvbnM+XG5cblxudHlwZSBCYWNrZW5kU3RhdHVzUmVwb3J0ZXIgPSBCYXNlQmFja2VuZFN0YXR1c1JlcG9ydGVyPEJhY2tlbmRTdGF0dXM+XG5cblxuY2xhc3MgQmFja2VuZCBleHRlbmRzIFZlcnNpb25lZEZpbGVzeXN0ZW1CYWNrZW5kIHtcbiAgLyogQ29tYmluZXMgYSBmaWxlc3lzdGVtIHN0b3JhZ2Ugd2l0aCBHaXQuICovXG5cbiAgcHJpdmF0ZSBnaXQ6IElzb0dpdFdyYXBwZXI7XG4gIHByaXZhdGUgZ2l0U3luY0ludGVydmFsRGVsYXk6IG51bWJlcjtcbiAgcHJpdmF0ZSBnaXRTeW5jSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZnM6IEZpbGVzeXN0ZW1XcmFwcGVyPGFueT47XG4gIHByaXZhdGUgbWFuYWdlcnM6IChGaWxlc3lzdGVtTWFuYWdlciAmIE1vZGVsTWFuYWdlcjxhbnksIGFueSwgYW55PilbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIHByaXZhdGUgb3B0czogQmFja2VuZE9wdGlvbnMsXG4gICAgICBwcml2YXRlIHJlcG9ydEJhY2tlbmRTdGF0dXM6IEJhY2tlbmRTdGF0dXNSZXBvcnRlcikge1xuXG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuZnMgPSBvcHRzLmZzV3JhcHBlcjtcblxuICAgIHRoaXMuZ2l0ID0gbmV3IElzb0dpdFdyYXBwZXIoXG4gICAgICBmcyxcbiAgICAgIHRoaXMub3B0cy5yZXBvVVJMLFxuICAgICAgdGhpcy5vcHRzLnVwc3RyZWFtUmVwb1VSTCxcbiAgICAgIHRoaXMub3B0cy51c2VybmFtZSxcbiAgICAgIHsgbmFtZTogdGhpcy5vcHRzLmF1dGhvck5hbWUsIGVtYWlsOiB0aGlzLm9wdHMuYXV0aG9yRW1haWwgfSxcbiAgICAgIHRoaXMub3B0cy53b3JrRGlyLFxuICAgICAgdGhpcy5vcHRzLmNvcnNQcm94eVVSTCxcblxuICAgICAgLy8gVGhlIHN0YXR1cyBvZiB0aGlzIGJhY2tlbmQgaXMgcmVkdWNlZCB0byBHaXQgcmVwbyBzdGF0dXMgbm93LlxuICAgICAgLy8gUG90ZW50aWFsbHkgaXQgc2hvdWxkIGluY2x1ZGUgZmlsZXN5c3RlbS1yZWxhdGVkIHN0YXR1cyBhcyB3ZWxsLFxuICAgICAgLy8gcmVwb3J0aW5nIGlzc3VlcyB3aXRoIGUuZy4gaW5zdWZmaWNpZW50IGRpc2sgc3BhY2UuXG4gICAgICB0aGlzLnJlcG9ydEJhY2tlbmRTdGF0dXMsXG4gICAgKTtcblxuICAgIHRoaXMubWFuYWdlcnMgPSBbXTtcblxuICAgIHRoaXMuZ2l0U3luY0ludGVydmFsRGVsYXkgPSBvcHRzLnN5bmNJbnRlcnZhbCB8fCBERUZBVUxUX1NZTkNfSU5URVJWQUw7XG4gICAgdGhpcy5zeW5jaHJvbml6ZSA9IHRoaXMuc3luY2hyb25pemUuYmluZCh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXNjcmliZSgpOiBQcm9taXNlPEJhY2tlbmREZXNjcmlwdGlvbj4ge1xuICAgIHJldHVybiB7XG4gICAgICB2ZXJib3NlTmFtZTogXCJHaXQrWUFNTFwiLFxuICAgICAgdmVyYm9zZU5hbWVMb25nOiBcIkdpdC12ZXJzaW9uZWQgWUFNTCBmaWxlIHRyZWVcIixcbiAgICAgIGdpdFJlcG86IHRoaXMub3B0cy5yZXBvVVJMLFxuICAgICAgZ2l0VXNlcm5hbWU6IHRoaXMub3B0cy51c2VybmFtZSxcbiAgICAgIHN0YXR1czogdGhpcy5naXQuZ2V0U3RhdHVzKCksXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyByZWdpc3RlclNldHRpbmdzRm9yQ29uZmlndXJhYmxlT3B0aW9ucyhcbiAgICAgIHNldHRpbmdzOiBTZXR0aW5nTWFuYWdlcixcbiAgICAgIGluaXRpYWxPcHRpb25zOiBJbml0aWFsQmFja2VuZE9wdGlvbnMsXG4gICAgICBkYklEOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IHBhbmVMYWJlbFBvc3RmaXggPSBkYklEICE9PSAnZGVmYXVsdCcgPyBgIGZvciDigJwke2RiSUR94oCdYCA6ICcnO1xuICAgIGNvbnN0IHNldHRpbmdJRFByZWZpeCA9IGBkYl8ke2RiSUR9X2A7XG4gICAgY29uc3QgcGFuZUlEID0gYGRiXyR7ZGJJRH1gO1xuXG4gICAgc2V0dGluZ3MuY29uZmlndXJlUGFuZSh7XG4gICAgICBpZDogcGFuZUlELFxuICAgICAgbGFiZWw6IGBEYXRhYmFzZSBzZXR0aW5ncyR7cGFuZUxhYmVsUG9zdGZpeH1gLFxuICAgICAgaWNvbjogJ2dpdC1tZXJnZScsXG4gICAgfSk7XG5cbiAgICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICAgcGFuZUlELFxuICAgICAgYCR7c2V0dGluZ0lEUHJlZml4fWdpdFJlcG9VcmxgLFxuICAgICAgJ3RleHQnLFxuICAgICAgaW5pdGlhbE9wdGlvbnMucmVwb1VSTCA9PT0gdW5kZWZpbmVkLFxuICAgICAgXCJHaXQgcmVwb3NpdG9yeSBVUkxcIixcbiAgICApKTtcblxuICAgIHNldHRpbmdzLnJlZ2lzdGVyKG5ldyBTZXR0aW5nPHN0cmluZz4oXG4gICAgICBwYW5lSUQsXG4gICAgICBgJHtzZXR0aW5nSURQcmVmaXh9Z2l0VXNlcm5hbWVgLFxuICAgICAgJ3RleHQnLFxuICAgICAgaW5pdGlhbE9wdGlvbnMudXNlcm5hbWUgPT09IHVuZGVmaW5lZCxcbiAgICAgIFwiR2l0IHVzZXJuYW1lXCIsXG4gICAgKSk7XG5cbiAgICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICAgcGFuZUlELFxuICAgICAgYCR7c2V0dGluZ0lEUHJlZml4fWdpdEF1dGhvck5hbWVgLFxuICAgICAgJ3RleHQnLFxuICAgICAgaW5pdGlhbE9wdGlvbnMuYXV0aG9yTmFtZSA9PT0gdW5kZWZpbmVkLFxuICAgICAgXCJHaXQgYXV0aG9yIG5hbWVcIixcbiAgICApKTtcblxuICAgIHNldHRpbmdzLnJlZ2lzdGVyKG5ldyBTZXR0aW5nPHN0cmluZz4oXG4gICAgICBwYW5lSUQsXG4gICAgICBgJHtzZXR0aW5nSURQcmVmaXh9Z2l0QXV0aG9yRW1haWxgLFxuICAgICAgJ3RleHQnLFxuICAgICAgaW5pdGlhbE9wdGlvbnMuYXV0aG9yRW1haWwgPT09IHVuZGVmaW5lZCxcbiAgICAgIFwiR2l0IGF1dGhvciBlbWFpbFwiLFxuICAgICkpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBjb21wbGV0ZU9wdGlvbnNGcm9tU2V0dGluZ3MoXG4gICAgICBzZXR0aW5nczogU2V0dGluZ01hbmFnZXIsXG4gICAgICBhdmFpbGFibGVPcHRpb25zOiBJbml0aWFsQmFja2VuZE9wdGlvbnMsXG4gICAgICBkYklEOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IHNldHRpbmdJRFByZWZpeCA9IGBkYl8ke2RiSUR9X2A7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBnZXRTZXR0aW5nPFQ+KHNldHRpbmdJRDogc3RyaW5nKTogUHJvbWlzZTxUPiB7XG4gICAgICByZXR1cm4gYXdhaXQgc2V0dGluZ3MuZ2V0VmFsdWUoYCR7c2V0dGluZ0lEUHJlZml4fSR7c2V0dGluZ0lEfWApIGFzIFQ7XG4gICAgfVxuXG4gICAgY29uc3QgZnNXcmFwcGVyQ2xhc3MgPSAoYXdhaXQgYXZhaWxhYmxlT3B0aW9ucy5mc1dyYXBwZXJDbGFzcygpKS5kZWZhdWx0O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHdvcmtEaXI6IGF2YWlsYWJsZU9wdGlvbnMud29ya0RpcixcbiAgICAgIGNvcnNQcm94eVVSTDogYXZhaWxhYmxlT3B0aW9ucy5jb3JzUHJveHlVUkwsXG4gICAgICB1cHN0cmVhbVJlcG9VUkw6IGF2YWlsYWJsZU9wdGlvbnMudXBzdHJlYW1SZXBvVVJMLFxuICAgICAgZnNXcmFwcGVyQ2xhc3M6IGF2YWlsYWJsZU9wdGlvbnMuZnNXcmFwcGVyQ2xhc3MsXG4gICAgICBmc1dyYXBwZXI6IG5ldyBmc1dyYXBwZXJDbGFzcyhhdmFpbGFibGVPcHRpb25zLndvcmtEaXIpLFxuXG4gICAgICByZXBvVVJMOiAoXG4gICAgICAgIChhd2FpdCBnZXRTZXR0aW5nPHN0cmluZz4oJ2dpdFJlcG9VcmwnKSlcbiAgICAgICAgfHwgYXZhaWxhYmxlT3B0aW9ucy5yZXBvVVJMKSBhcyBzdHJpbmcsXG4gICAgICB1c2VybmFtZTogKFxuICAgICAgICAoYXdhaXQgZ2V0U2V0dGluZzxzdHJpbmc+KCdnaXRVc2VybmFtZScpKVxuICAgICAgICB8fCBhdmFpbGFibGVPcHRpb25zLnVzZXJuYW1lKSBhcyBzdHJpbmcsXG4gICAgICBhdXRob3JOYW1lOiAoXG4gICAgICAgIChhd2FpdCBnZXRTZXR0aW5nPHN0cmluZz4oJ2dpdEF1dGhvck5hbWUnKSlcbiAgICAgICAgfHwgYXZhaWxhYmxlT3B0aW9ucy5hdXRob3JOYW1lKSBhcyBzdHJpbmcsXG4gICAgICBhdXRob3JFbWFpbDogKFxuICAgICAgICAoYXdhaXQgZ2V0U2V0dGluZzxzdHJpbmc+KCdnaXRBdXRob3JFbWFpbCcpKVxuICAgICAgICB8fCBhdmFpbGFibGVPcHRpb25zLmF1dGhvckVtYWlsKSBhcyBzdHJpbmcsXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlZ2lzdGVyTWFuYWdlcihtYW5hZ2VyOiBGaWxlc3lzdGVtTWFuYWdlciAmIE1vZGVsTWFuYWdlcjxhbnksIGFueSwgYW55Pikge1xuICAgIHRoaXMubWFuYWdlcnMucHVzaChtYW5hZ2VyKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpbml0KGZvcmNlUmVzZXQgPSBmYWxzZSkge1xuICAgIGxldCBkb0luaXRpYWxpemU6IGJvb2xlYW47XG5cbiAgICB0cnkge1xuICAgICAgaWYgKGZvcmNlUmVzZXQgPT09IHRydWUpIHtcbiAgICAgICAgbG9nLndhcm4oXCJDL2RiL2lzb2dpdC15YW1sOiBHaXQgaXMgYmVpbmcgZm9yY2UgcmVpbml0aWFsaXplZFwiKTtcbiAgICAgICAgZG9Jbml0aWFsaXplID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSBpZiAoIShhd2FpdCB0aGlzLmdpdC5pc1VzaW5nUmVtb3RlVVJMcyh7XG4gICAgICAgICAgb3JpZ2luOiB0aGlzLm9wdHMucmVwb1VSTCxcbiAgICAgICAgICB1cHN0cmVhbTogdGhpcy5vcHRzLnVwc3RyZWFtUmVwb1VSTH0pKSkge1xuICAgICAgICBsb2cud2FybihcIkMvZGIvaXNvZ2l0LXlhbWw6IEdpdCBoYXMgbWlzbWF0Y2hpbmcgcmVtb3RlIFVSTHMsIHJlaW5pdGlhbGl6aW5nXCIpO1xuICAgICAgICBkb0luaXRpYWxpemUgPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmluZm8oXCJDL2RiL2lzb2dpdC15YW1sOiBHaXQgaXMgYWxyZWFkeSBpbml0aWFsaXplZFwiKTtcbiAgICAgICAgZG9Jbml0aWFsaXplID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZG9Jbml0aWFsaXplID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAoZG9Jbml0aWFsaXplKSB7XG4gICAgICBhd2FpdCB0aGlzLmdpdC5kZXN0cm95KCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZ2l0U3luY0ludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuZ2l0U3luY0ludGVydmFsKTtcbiAgICB9XG5cbiAgICB0aGlzLmdpdFN5bmNJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuc3luY2hyb25pemUsIHRoaXMuZ2l0U3luY0ludGVydmFsRGVsYXkpO1xuXG4gICAgYXdhaXQgdGhpcy5zeW5jaHJvbml6ZSgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWQob2JqSUQ6IHN0cmluZywgbWV0YUZpZWxkcz86IHN0cmluZ1tdKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZnMucmVhZCh0aGlzLmdldFJlZihvYmpJRCksIG1ldGFGaWVsZHMpIGFzIG9iamVjdDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkVmVyc2lvbihvYmpJRDogc3RyaW5nLCB2ZXJzaW9uOiBzdHJpbmcpIHtcbiAgICAvLyBOT1RFOiBUaGlzIHdpbGwgZmFpbCB3aXRoIFlBTUxEaXJlY3RvcnlXcmFwcGVyLlxuICAgIC8vIG9iaklEIG11c3QgcmVmZXIgdG8gYSBzaW5nbGUgZmlsZS5cblxuICAgIC8vIFRPRE86IFN1cHBvcnQgY29tcG91bmQgb2JqZWN0cyAoZGlyZWN0b3JpZXMpXG4gICAgLy8gYnkgbW92aW5nIHRoZSBmaWxlIGRhdGEgcGFyc2luZyBsb2dpYyBpbnRvIG1hbmFnZXJcbiAgICAvLyBhbmQgYWRkaW5nIEJhY2tlbmQucmVhZFRyZWUoKS5cblxuICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLmdpdC5yZWFkRmlsZUJsb2JBdENvbW1pdCh0aGlzLmdldFJlZihvYmpJRCksIHZlcnNpb24pO1xuICAgIHJldHVybiB0aGlzLmZzLnBhcnNlRGF0YShibG9iKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGU8TyBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4+KG9iajogTywgb2JqUGF0aDogc3RyaW5nLCBtZXRhRmllbGRzPzogKGtleW9mIE8pW10pIHtcbiAgICBpZiAoYXdhaXQgdGhpcy5mcy5leGlzdHMob2JqUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBVbmlxdWVDb25zdHJhaW50RXJyb3IoXCJmaWxlc3lzdGVtIHBhdGhcIiwgb2JqUGF0aCk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5mcy53cml0ZShvYmpQYXRoLCBvYmosIG1ldGFGaWVsZHMpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNvbW1pdChvYmpJRHM6IHN0cmluZ1tdLCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLnJlc2V0T3JwaGFuZWRGaWxlQ2hhbmdlcygpO1xuXG4gICAgY29uc3QgcGF0aHM6IHN0cmluZ1tdID0gKGF3YWl0IHRoaXMucmVhZFVuY29tbWl0dGVkRmlsZUluZm8oKSkuXG4gICAgICBmaWx0ZXIoZmlsZWluZm8gPT4gb2JqSURzLmluZGV4T2YoZmlsZWluZm8ucGF0aCkgPj0gMCkuXG4gICAgICBtYXAoZmlsZWluZm8gPT4gZmlsZWluZm8ucGF0aCk7XG5cbiAgICBpZiAocGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gVE9ETzogTWFrZSBHaXQgdHJhY2sgd2hpY2ggZmlsZXMgZ290IGNvbW1pdHRlZCAoaGFkIGNoYW5nZXMpLFxuICAgICAgLy8gYW5kIHJldHVybiBwYXRoc1xuICAgICAgYXdhaXQgdGhpcy5naXQuc3RhZ2VBbmRDb21taXQocGF0aHMsIG1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkaXNjYXJkKG9iaklEczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBwYXRoczogc3RyaW5nW10gPSAoYXdhaXQgdGhpcy5yZWFkVW5jb21taXR0ZWRGaWxlSW5mbygpKS5cbiAgICAgIGZpbHRlcihmaWxlaW5mbyA9PiBvYmpJRHMuaW5kZXhPZihmaWxlaW5mby5wYXRoKSA+PSAwKS5cbiAgICAgIG1hcChmaWxlaW5mbyA9PiBmaWxlaW5mby5wYXRoKTtcblxuICAgIGlmIChwYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmdpdC5yZXNldEZpbGVzKHBhdGhzKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdFVuY29tbWl0dGVkKCkge1xuICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgdGhpcy5yZWFkVW5jb21taXR0ZWRGaWxlSW5mbygpO1xuXG4gICAgY29uc3Qgb2JqSURzOiBzdHJpbmdbXSA9IGZpbGVzLlxuICAgICAgbWFwKGZpbGVpbmZvID0+IGZpbGVpbmZvLnBhdGgpO1xuXG4gICAgLy8gRGlzY2FyZCBkdXBsaWNhdGVzIGZyb20gdGhlIGxpc3RcbiAgICByZXR1cm4gb2JqSURzLmZpbHRlcihmdW5jdGlvbiAob2JqSUQsIGlkeCwgc2VsZikge1xuICAgICAgcmV0dXJuIGlkeCA9PT0gc2VsZi5pbmRleE9mKG9iaklEKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0SURzKHF1ZXJ5OiB7IHN1YmRpcjogc3RyaW5nIH0pIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5mcy5saXN0SURzKHsgc3ViZGlyOiBxdWVyeS5zdWJkaXIgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0SW5kZXgoc3ViZGlyOiBzdHJpbmcsIGlkRmllbGQ6IHN0cmluZywgb25seUlEcz86IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgaWRzVG9TZWxlY3QgPSBvbmx5SURzICE9PSB1bmRlZmluZWRcbiAgICAgID8gb25seUlEcy5tYXAoaWQgPT4gdGhpcy5nZXRSZWYoaWQpKVxuICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCBvYmpzID0gYXdhaXQgdGhpcy5mcy5yZWFkQWxsKHsgc3ViZGlyLCBvbmx5SURzOiBpZHNUb1NlbGVjdCB9KTtcblxuICAgIHZhciBpZHg6IEluZGV4PGFueT4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IG9iaiBvZiBvYmpzKSB7XG4gICAgICBpZHhbYCR7b2JqW2lkRmllbGRdfWBdID0gb2JqO1xuICAgIH1cblxuICAgIHJldHVybiBpZHg7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKG9iaklEOiBzdHJpbmcsIG5ld0RhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4sIGlkRmllbGQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuZnMud3JpdGUodGhpcy5nZXRSZWYob2JqSUQpLCBuZXdEYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGUob2JqSUQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuZnMud3JpdGUodGhpcy5nZXRSZWYob2JqSUQpLCB1bmRlZmluZWQpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlc2V0T3JwaGFuZWRGaWxlQ2hhbmdlcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvKiBSZW1vdmUgZnJvbSBmaWxlc3lzdGVtIGFueSBmaWxlcyB1bmRlciBvdXIgRlMgYmFja2VuZCBwYXRoXG4gICAgICAgdGhhdCB0aGUgYmFja2VuZCBjYW5ub3QgYWNjb3VudCBmb3IsXG4gICAgICAgYnV0IHdoaWNoIG1heSBhcHBlYXIgYXMgdW5zdGFnZWQgY2hhbmdlcyB0byBHaXQuICovXG5cbiAgICBjb25zdCBvcnBoYW5GaWxlUGF0aHMgPSAoYXdhaXQgdGhpcy5yZWFkVW5jb21taXR0ZWRGaWxlSW5mbygpKS5cbiAgICBtYXAoZmlsZWluZm8gPT4gZmlsZWluZm8ucGF0aCkuXG4gICAgZmlsdGVyKGZpbGVwYXRoID0+IHRoaXMubWFuYWdlcnMubWFwKG1nciA9PiBtZ3IubWFuYWdlc0ZpbGVBdFBhdGgoZmlsZXBhdGgpKS5pbmRleE9mKHRydWUpIDwgMCk7XG5cbiAgICBpZiAob3JwaGFuRmlsZVBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIGxvZy53YXJuKFwiQy9kYi9pc29naXQteWFtbDogUmVzZXR0aW5nIG9ycGhhbmVkIGZpbGVzXCIsIG9ycGhhbkZpbGVQYXRocyk7XG4gICAgICBhd2FpdCB0aGlzLmdpdC5yZXNldEZpbGVzKG9ycGhhbkZpbGVQYXRocyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZWFkVW5jb21taXR0ZWRGaWxlSW5mbygpOiBQcm9taXNlPHsgcGF0aDogc3RyaW5nIH1bXT4ge1xuICAgIC8qIFJldHVybnMgYSBsaXN0IG9mIG9iamVjdHMgdGhhdCBtYXAgR2l0LXJlbGF0aXZlIHBhdGhzIHRvIGFjdHVhbCBvYmplY3QgSURzLlxuICAgICAgIFdoZXJlIG9iamVjdCBJRCBpcyB1bmRlZmluZWQsIHRoYXQgaW1wbGllcyBmaWxlIGlzIOKAnG9ycGhhbmVk4oCdXG4gICAgICAgKG5vdCByZWNvZ25pemVkIGFzIGJlbG9uZ2luZyB0byBhbnkgb2JqZWN0IG1hbmFnZWQgYnkgdGhpcyBzdG9yZSkuICovXG5cbiAgICBjb25zdCBjaGFuZ2VkRmlsZXM6IHN0cmluZ1tdID0gYXdhaXQgdGhpcy5naXQubGlzdENoYW5nZWRGaWxlcyhbJy4nXSk7XG4gICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKGNoYW5nZWRGaWxlcy5tYXAoZnAgPT4ge1xuICAgICAgcmV0dXJuIHsgcGF0aDogZnAgfTtcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGdldFJlZihvYmpJRDogc3RyaW5nIHwgbnVtYmVyKTogc3RyaW5nIHtcbiAgICAvKiBSZXR1cm5zIEZTIGJhY2tlbmQgcmVmZXJlbmNlIGZyb20gREIgYmFja2VuZCBvYmplY3QgSUQuICovXG4gICAgcmV0dXJuIGAke29iaklEfWA7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHN5bmNocm9uaXplKCkge1xuICAgIGF3YWl0IHRoaXMuZ2l0LnN5bmNocm9uaXplKCk7XG5cbiAgICBmb3IgKGNvbnN0IG1nciBvZiB0aGlzLm1hbmFnZXJzKSB7XG4gICAgICBtZ3IucmVwb3J0VXBkYXRlZERhdGEoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrVW5jb21taXR0ZWQoKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2l0LmNoZWNrVW5jb21taXR0ZWQoKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRVcElQQyhkYklEOiBzdHJpbmcpIHtcbiAgICBzdXBlci5zZXRVcElQQyhkYklEKTtcblxuICAgIGxvZy52ZXJib3NlKFwiQy9kYi9pc29naXQteWFtbDogU2V0dGluZyB1cCBJUENcIik7XG5cbiAgICBjb25zdCBwcmVmaXggPSBgZGItJHtkYklEfWA7XG5cbiAgICBsaXN0ZW48e30sIHsgbnVtVW5jb21taXR0ZWQ6IG51bWJlciB9PlxuICAgIChgJHtwcmVmaXh9LWNvdW50LXVuY29tbWl0dGVkYCwgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIHsgbnVtVW5jb21taXR0ZWQ6IChhd2FpdCB0aGlzLmdpdC5saXN0Q2hhbmdlZEZpbGVzKCkpLmxlbmd0aCB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IHN0YXJ0ZWQ6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCwgYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy5zeW5jaHJvbml6ZSgpO1xuICAgICAgcmV0dXJuIHsgc3RhcnRlZDogdHJ1ZSB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IHN1Y2Nlc3M6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtZGlzY2FyZC11bnN0YWdlZGAsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuZ2l0LnJlc2V0RmlsZXMoKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7fSwgeyBoYXNVbmNvbW1pdHRlZENoYW5nZXM6IGJvb2xlYW4gfT5cbiAgICAoYCR7cHJlZml4fS1naXQtdXBkYXRlLXN0YXR1c2AsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiB7IGhhc1VuY29tbWl0dGVkQ2hhbmdlczogYXdhaXQgdGhpcy5jaGVja1VuY29tbWl0dGVkKCkgfTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7IHBhc3N3b3JkOiBzdHJpbmcgfSwgeyBzdWNjZXNzOiB0cnVlIH0+XG4gICAgKGAke3ByZWZpeH0tZ2l0LXNldC1wYXNzd29yZGAsIGFzeW5jICh7IHBhc3N3b3JkIH0pID0+IHtcbiAgICAgIC8vIFdBUk5JTkc6IERvbuKAmXQgbG9nIHBhc3N3b3JkXG4gICAgICBsb2cudmVyYm9zZShcIkMvZGIvaXNvZ2l0LXlhbWw6IHJlY2VpdmVkIGdpdC1zZXQtcGFzc3dvcmQgcmVxdWVzdFwiKTtcblxuICAgICAgdGhpcy5naXQuc2V0UGFzc3dvcmQocGFzc3dvcmQpO1xuICAgICAgdGhpcy5zeW5jaHJvbml6ZSgpO1xuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48e30sIHsgb3JpZ2luVVJMOiBzdHJpbmcgfCBudWxsLCBuYW1lOiBzdHJpbmcgfCBudWxsLCBlbWFpbDogc3RyaW5nIHwgbnVsbCwgdXNlcm5hbWU6IHN0cmluZyB8IG51bGwgfT5cbiAgICAoYCR7cHJlZml4fS1naXQtY29uZmlnLWdldGAsIGFzeW5jICgpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFwiQy9kYi9pc29naXQteWFtbDogcmVjZWl2ZWQgZ2l0LWNvbmZpZyByZXF1ZXN0XCIpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgb3JpZ2luVVJMOiBhd2FpdCB0aGlzLmdpdC5nZXRPcmlnaW5VcmwoKSxcbiAgICAgICAgbmFtZTogYXdhaXQgdGhpcy5naXQuY29uZmlnR2V0KCd1c2VyLm5hbWUnKSxcbiAgICAgICAgZW1haWw6IGF3YWl0IHRoaXMuZ2l0LmNvbmZpZ0dldCgndXNlci5lbWFpbCcpLFxuICAgICAgICB1c2VybmFtZTogYXdhaXQgdGhpcy5naXQuY29uZmlnR2V0KCdjcmVkZW50aWFscy51c2VybmFtZScpLFxuICAgICAgICAvLyBQYXNzd29yZCBtdXN0IG5vdCBiZSByZXR1cm5lZCwgb2YgY291cnNlXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBCYWNrZW5kQ2xhc3M6IEJhc2VCYWNrZW5kQ2xhc3M8SW5pdGlhbEJhY2tlbmRPcHRpb25zLCBCYWNrZW5kT3B0aW9ucywgQmFja2VuZFN0YXR1cz4gPSBCYWNrZW5kXG5cbmV4cG9ydCBkZWZhdWx0IEJhY2tlbmQ7XG4iXX0=