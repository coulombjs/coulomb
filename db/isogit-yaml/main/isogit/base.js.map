{"version":3,"file":"base.js","sourceRoot":"","sources":["../../../../../src/db/isogit-yaml/main/isogit/base.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport * as https from 'https';\n\nimport { spawn, Worker, Thread } from 'threads';\n\nimport AsyncLock from 'async-lock';\nimport * as git from 'isomorphic-git';\nimport * as log from 'electron-log';\n\nimport { GitStatus } from '../../base';\nimport { GitAuthentication } from './types';\n\nimport { GitWorkerSpec, GitMethods } from './worker';\n\n\nconst MAIN_REMOTE = 'origin';\n\n\nconst INITIAL_STATUS: GitStatus = {\n  isOnline: false,\n  isMisconfigured: false,\n  hasLocalChanges: false,\n  needsPassword: false,\n  statusRelativeToLocal: undefined,\n  lastSynchronized: null,\n  isPushing: false,\n  isPulling: false,\n} as const;\n\n\nexport class IsoGitWrapper {\n\n  private auth: GitAuthentication = {};\n\n  private pushPending = false;\n\n  private stagingLock: AsyncLock;\n\n  private status: GitStatus;\n\n  private worker: GitMethods | null = null;\n\n  private async getWorker(): Promise<GitMethods> {\n\n    if (!this.worker) {\n      const worker = await spawn<GitWorkerSpec>(new Worker('./worker'));\n      this.worker = worker;\n      Thread.events(worker).subscribe(evt => {\n        log.info(\"C/db/isogit: Worker event:\", evt)\n        // TODO: Respawn on exit\n      });\n    }\n\n    return this.worker;\n  }\n\n  constructor(\n      private fs: any,\n      private repoUrl: string,\n      private upstreamRepoUrl: string | undefined,\n      username: string,\n      private author: { name: string, email: string },\n      public workDir: string,\n      private corsProxy: string | undefined,\n      private statusReporter: (payload: GitStatus) => Promise<void>) {\n\n    this.stagingLock = new AsyncLock({ timeout: 20000, maxPending: 2 });\n\n    if (this.corsProxy) {\n      log.warn(\"C/db/isogit: CORS proxy parameter is obsolete and will be removed.\");\n    }\n    if (this.upstreamRepoUrl !== undefined) {\n      log.warn(\"C/db/isogit: the upstreamRepoUrl parameter is obsolete and will be removed.\");\n    }\n\n    // Makes it easier to bind these to IPC events\n    this.synchronize = this.synchronize.bind(this);\n    this.resetFiles = this.resetFiles.bind(this);\n    this.checkUncommitted = this.checkUncommitted.bind(this);\n\n    this.auth.username = username;\n\n    this.status = INITIAL_STATUS;\n  }\n\n\n  // Reporting Git status to DB backend,\n  // so that it can be reflected in the GUI\n\n  private async reportStatus() {\n    return await this.statusReporter(this.status);\n  }\n\n  private async setStatus(status: Partial<GitStatus>) {\n    Object.assign(this.status, status);\n    await this.reportStatus();\n  }\n\n  public getStatus(): GitStatus {\n    return this.status;\n  }\n\n\n  // Initilaization\n\n  public async isInitialized(): Promise<boolean> {\n    let hasGitDirectory: boolean;\n    try {\n      hasGitDirectory = (await this.fs.stat(path.join(this.workDir, '.git'))).isDirectory();\n    } catch (e) {\n      hasGitDirectory = false;\n    }\n    return hasGitDirectory;\n  }\n\n  public async isUsingRemoteURLs(remoteUrls: { origin: string }): Promise<boolean> {\n    const origin = (await this.getOriginUrl() || '').trim();\n    return origin === remoteUrls.origin;\n  }\n\n  public needsPassword(): boolean {\n    return (this.auth.password || '').trim() === '';\n  }\n\n  public getUsername(): string | undefined {\n    return this.auth.username;\n  }\n\n  public async destroy() {\n    /* Removes working directory.\n       On next sync Git repo will have to be reinitialized, cloned etc. */\n\n    log.warn(\"C/db/isogit: Initialize: Removing data directory\");\n    await this.fs.remove(this.workDir);\n  }\n\n  private async forceInitialize() {\n    /* Initializes from scratch: wipes work directory, clones repository, adds remotes. */\n\n    return await this.stagingLock.acquire('1', async () => {\n      log.warn(\"C/db/isogit: Initializing\");\n\n      log.silly(\"C/db/isogit: Initialize: Ensuring data directory exists\");\n      await this.fs.ensureDir(this.workDir);\n\n      log.verbose(\"C/db/isogit: Initialize: Cloning\", this.repoUrl);\n\n      const worker = await this.getWorker();\n      try {\n        await worker.clone({\n          action: 'clone',\n          workDir: this.workDir,\n          repoURL: this.repoUrl,\n          auth: this.auth,\n        });\n      } catch (e) {\n        log.error(\"C/db/isogit: Error during initialization: Cannot clone\", JSON.stringify(e))\n        await this.fs.remove(this.workDir);\n        await this._handleGitError(e);\n      }\n    });\n  }\n\n\n  // Authentication\n\n  public async setPassword(value: string | undefined) {\n    this.auth.password = value;\n    this.setStatus({ needsPassword: false });\n  }\n\n\n  // Git operations\n\n  async configSet(prop: string, val: string) {\n    log.verbose(\"C/db/isogit: Set config\");\n    await git.setConfig({ fs: this.fs, dir: this.workDir, path: prop, value: val });\n  }\n\n  async configGet(prop: string): Promise<string> {\n    log.verbose(\"C/db/isogit: Get config\", prop);\n    return await git.getConfig({ fs: this.fs, dir: this.workDir, path: prop });\n  }\n\n  async readFileBlobAtCommit(relativeFilePath: string, commitHash: string): Promise<string> {\n    /* Reads file contents at given path as of given commit. File contents must use UTF-8 encoding. */\n\n    return (await git.readBlob({\n      fs: this.fs,\n      dir: this.workDir,\n      oid: commitHash,\n      filepath: relativeFilePath,\n    })).blob.toString();\n  }\n\n  async pull() {\n    log.verbose(\"C/db/isogit: Pulling master with fast-forward merge\");\n\n    const worker = await this.getWorker();\n    try {\n      await worker.pull({\n        action: 'pull',\n        workDir: this.workDir,\n        repoURL: this.repoUrl,\n        auth: this.auth,\n        author: this.author,\n      });\n    } catch (e) {\n      log.error(\"C/db/isogit: Failed to pull\", e);\n      throw e;\n    }\n  }\n\n  async stage(pathSpecs: string[], removing = false) {\n    log.verbose(`C/db/isogit: Staging changes: ${pathSpecs.join(', ')} using ${removing ? \"remove()\" : \"add()\"}`);\n\n    for (const pathSpec of pathSpecs) {\n      if (removing !== true) {\n        await git.add({\n          fs: this.fs,\n          dir: this.workDir,\n          filepath: pathSpec,\n        });\n      } else {\n        await git.remove({\n          fs: this.fs,\n          dir: this.workDir,\n          filepath: pathSpec,\n        });\n      }\n    }\n  }\n\n  async commit(msg: string) {\n    log.verbose(`C/db/isogit: Committing with message ${msg}`);\n\n    return await git.commit({\n      fs: this.fs,\n      dir: this.workDir,\n      message: msg,\n      author: this.author,\n    });\n  }\n\n  async push() {\n    log.verbose(\"C/db/isogit: Pushing\");\n\n    const worker = await this.getWorker();\n    try {\n      await worker.push({\n        action: 'push',\n        workDir: this.workDir,\n        repoURL: this.repoUrl,\n        auth: this.auth,\n      });\n    } catch (e) {\n      log.error(\"C/db/isogit: Failed to push\", e);\n      throw e;\n    }\n  }\n\n  public async resetFiles(paths?: string[]) {\n    return await this.stagingLock.acquire('1', async () => {\n      log.verbose(\"C/db/isogit: Force resetting files\");\n\n      return await git.checkout({\n        fs: this.fs,\n        dir: this.workDir,\n        force: true,\n        filepaths: paths || (await this.listChangedFiles()),\n      });\n    });\n  }\n\n  async getOriginUrl(): Promise<string | null> {\n    return ((await git.listRemotes({\n      fs: this.fs,\n      dir: this.workDir,\n    })).find(r => r.remote === MAIN_REMOTE) || { url: null }).url;\n  }\n\n  async listLocalCommits(): Promise<string[]> {\n    /* Returns a list of commit messages for commits that were not pushed yet.\n\n       Useful to check which commits will be thrown out\n       if we force update to remote master.\n\n       Does so by walking through last 100 commits starting from current HEAD.\n       When it encounters the first local commit that doesn’t descends from remote master HEAD,\n       it considers all preceding commits to be ahead/local and returns them.\n\n       If it finishes the walk without finding an ancestor, throws an error.\n       It is assumed that the app does not allow to accumulate\n       more than 100 commits without pushing (even 100 is too many!),\n       so there’s probably something strange going on.\n\n       Other assumptions:\n\n       * git.log returns commits from newest to oldest.\n       * The remote was already fetched.\n\n    */\n\n    return await this.stagingLock.acquire('1', async () => {\n      const latestRemoteCommit = await git.resolveRef({\n        fs: this.fs,\n        dir: this.workDir,\n        ref: `${MAIN_REMOTE}/master`,\n      });\n\n      const localCommits = await git.log({\n        fs: this.fs,\n        dir: this.workDir,\n        depth: 100,\n      });\n\n      var commits = [] as string[];\n      for (const commit of localCommits) {\n        if (await git.isDescendent({\n            fs: this.fs,\n            dir: this.workDir,\n            oid: commit.oid,\n            ancestor: latestRemoteCommit,\n          })) {\n          commits.push(commit.commit.message);\n        } else {\n          return commits;\n        }\n      }\n\n      throw new Error(\"Did not find a local commit that is an ancestor of remote master\");\n    });\n  }\n\n  public async listChangedFiles(pathSpecs = ['.']): Promise<string[]> {\n    /* Lists relative paths to all files that were changed and have not been committed. */\n\n    const FILE = 0, HEAD = 1, WORKDIR = 2;\n\n    return (await git.statusMatrix({ fs: this.fs, dir: this.workDir, filepaths: pathSpecs }))\n      .filter(row => row[HEAD] !== row[WORKDIR])\n      .map(row => row[FILE])\n      .filter(filepath => !filepath.startsWith('..') && filepath !== \".DS_Store\");\n  }\n\n  public async stageAndCommit(pathSpecs: string[], msg: string, removing = false): Promise<number> {\n    /* Stages and commits files matching given path spec with given message.\n\n       Any other files staged at the time of the call will be unstaged.\n\n       Returns the number of matching files with unstaged changes prior to staging.\n       If no matching files were found having unstaged changes,\n       skips the rest and returns zero.\n\n       If failIfDiverged is given, attempts a fast-forward pull after the commit.\n       It will fail immediately if main remote had other commits appear in meantime.\n\n       Locks so that this method cannot be run concurrently (by same instance).\n    */\n\n    if (pathSpecs.length < 1) {\n      throw new Error(\"Wasn’t given any paths to commit!\");\n    }\n\n    return await this.stagingLock.acquire('1', async () => {\n      log.verbose(`C/db/isogit: Staging and committing: ${pathSpecs.join(', ')}`);\n\n      const filesChanged = (await this.listChangedFiles(pathSpecs)).length;\n      if (filesChanged < 1) {\n        return 0;\n      }\n\n      await this.unstageAll();\n      await this.stage(pathSpecs, removing);\n      await this.commit(msg);\n\n      return filesChanged;\n    });\n  }\n\n  public async checkUncommitted(): Promise<boolean> {\n    /* Checks for any uncommitted changes locally present.\n       Notifies all windows about the status. */\n\n    log.debug(\"C/db/isogit: Checking for uncommitted changes\");\n    const changedFiles = await this.listChangedFiles();\n    log.debug(\"C/db/isogit: Changed files:\", changedFiles);\n    const hasLocalChanges = changedFiles.length > 0;\n    await this.setStatus({ hasLocalChanges });\n    return hasLocalChanges;\n  }\n\n  public requestPush() {\n    this.pushPending = true;\n  }\n\n  public async synchronize(): Promise<void> {\n    /* Checks for connection, local changes and unpushed commits,\n       tries to push and pull when there’s opportunity.\n\n       Notifies all windows about the status in process. */\n\n    log.verbose(\"C/db/isogit: Checking if clone exists\");\n\n    if (!(await this.isInitialized())) {\n      await this.forceInitialize();\n\n    } else {\n      log.verbose(\"C/db/isogit: Checking for uncommitted changes\");\n\n      await this.setStatus({\n        ...INITIAL_STATUS,\n        hasLocalChanges: false,\n        lastSynchronized: this.status.lastSynchronized,\n      });\n\n      const hasUncommittedChanges = await this.checkUncommitted();\n\n      if (hasUncommittedChanges) {\n        // Do not run pull if there are unstaged/uncommitted changes\n        await this.setStatus({ hasLocalChanges: true });\n        return;\n      } else {\n        // If uncommitted changes weren’t detected, there may still be changed files\n        // that are not managed by the backend (e.g., .DS_Store). Discard any stuff like that.\n        await this.resetFiles(['.']);\n      }\n    }\n\n    if (this.stagingLock.isBusy()) {\n      log.verbose(\"C/db/isogit: Lock is busy, skipping sync\");\n      return;\n    }\n\n    log.verbose(\"C/db/isogit: Queueing sync now, lock is not busy\");\n\n    return await this.stagingLock.acquire('1', async () => {\n      log.verbose(\"C/db/isogit: Starting sync\");\n\n      const isOnline = (await checkOnlineStatus()) === true;\n\n      if (isOnline) {\n        const needsPassword = this.needsPassword();\n        await this.setStatus({ needsPassword });\n        if (needsPassword) {\n          return;\n        }\n\n        await this.setStatus({ isOnline: true });\n\n        await this.setStatus({ isPulling: true });\n        try {\n          await this.pull();\n        } catch (e) {\n          log.error(e);\n          await this.setStatus({\n            isPulling: false,\n            isPushing: false,\n            lastSynchronized: new Date(),\n            isOnline: false,\n          });\n          await this._handleGitError(e);\n          return;\n        }\n        //await this.setStatus({ isPulling: false });\n\n        if (this.pushPending) {\n          // Run push AFTER pull. May result in false-positive non-fast-forward rejection\n          await this.setStatus({ isPushing: true });\n          try {\n            await this.push();\n          } catch (e) {\n            log.error(e);\n            await this.setStatus({\n              isPulling: false,\n              isPushing: false,\n              lastSynchronized: new Date(),\n            });\n            await this._handleGitError(e);\n            return;\n          }\n          this.pushPending = false;\n          //await this.setStatus({ isPushing: false });\n        }\n\n        await this.setStatus({\n          statusRelativeToLocal: 'updated',\n          isOnline: true,\n          isMisconfigured: false,\n          lastSynchronized: new Date(),\n          needsPassword: false,\n          isPushing: false,\n          isPulling: false,\n        });\n      }\n    });\n  }\n\n  private async unstageAll() {\n    log.verbose(\"C/db/isogit: Unstaging all changes\");\n    await git.remove({ fs: this.fs, dir: this.workDir, filepath: '.' });\n  }\n\n  private async _handleGitError(e: Error & { code: string }): Promise<void> {\n    log.debug(\"Handling Git error\", e.code, e);\n\n    if (e.code === 'FastForwardFail' || e.code === 'MergeNotSupportedFail') {\n      // NOTE: There’s also PushRejectedNonFastForward, but it seems to be thrown\n      // for unrelated cases during push (false positive).\n      // Because of that false positive, we ignore that error and instead do pull first,\n      // catching actual fast-forward fails on that step before push.\n      await this.setStatus({ statusRelativeToLocal: 'diverged' });\n    } else if (['MissingUsernameError', 'MissingAuthorError', 'MissingCommitterError'].indexOf(e.code) >= 0) {\n      await this.setStatus({ isMisconfigured: true });\n    } else if (e.code === 'EHOSTDOWN') {\n      await this.setStatus({ isOnline: false });\n      log.warn(\"Possible connection issues\");\n    } else if (\n        e.code === 'MissingPasswordTokenError'\n        || (e.code === 'HTTPError' && e.message.indexOf('Unauthorized') >= 0)) {\n      log.warn(\"Password input required\");\n      await this.setPassword(undefined);\n    }\n  }\n}\n\n\nasync function checkOnlineStatus(timeout = 4500): Promise<boolean> {\n  // TODO: Move to general utility functions\n  return new Promise((resolve) => {\n    log.debug(\"C/db/isogit: Connection test: Starting\");\n\n    const req = https.get('https://github.com/', { timeout }, reportOnline);\n\n    req.on('error', () => req.abort());\n    req.on('response', reportOnline);\n    req.on('connect', reportOnline);\n    req.on('continue', reportOnline);\n    req.on('upgrade', reportOnline);\n    req.on('timeout', reportOffline);\n\n    req.end();\n\n    const checkTimeout = setTimeout(reportOffline, timeout);\n\n    function reportOffline() {\n      log.warn(\"C/db/isogit: Connection test: Report offline\");\n      try { req.abort(); } catch (e) {}\n      clearTimeout(checkTimeout);\n      resolve(false);\n    }\n    function reportOnline() {\n      log.info(\"C/db/isogit: Connection test: Report online\");\n      try { req.abort(); } catch (e) {}\n      clearTimeout(checkTimeout);\n      resolve(true);\n    }\n  });\n}\n\n\n// TODO: Temporary workaround since isomorphic-git doesn’t seem to export its GitError class\n// in any way available to TS, so we can’t use instanceof :(\n\nexport function isGitError(e: Error & { code: string }) {\n  if (!e.code) {\n    return false;\n  }\n  return Object.keys(IsomorphicGitErrorCodes).indexOf(e.code) >= 0;\n}\n\nconst IsomorphicGitErrorCodes = {\n  FileReadError: `FileReadError`,\n  MissingRequiredParameterError: `MissingRequiredParameterError`,\n  InvalidRefNameError: `InvalidRefNameError`,\n  InvalidParameterCombinationError: `InvalidParameterCombinationError`,\n  RefExistsError: `RefExistsError`,\n  RefNotExistsError: `RefNotExistsError`,\n  BranchDeleteError: `BranchDeleteError`,\n  NoHeadCommitError: `NoHeadCommitError`,\n  CommitNotFetchedError: `CommitNotFetchedError`,\n  ObjectTypeUnknownFail: `ObjectTypeUnknownFail`,\n  ObjectTypeAssertionFail: `ObjectTypeAssertionFail`,\n  ObjectTypeAssertionInTreeFail: `ObjectTypeAssertionInTreeFail`,\n  ObjectTypeAssertionInRefFail: `ObjectTypeAssertionInRefFail`,\n  ObjectTypeAssertionInPathFail: `ObjectTypeAssertionInPathFail`,\n  MissingAuthorError: `MissingAuthorError`,\n  MissingCommitterError: `MissingCommitterError`,\n  MissingTaggerError: `MissingTaggerError`,\n  GitRootNotFoundError: `GitRootNotFoundError`,\n  UnparseableServerResponseFail: `UnparseableServerResponseFail`,\n  InvalidDepthParameterError: `InvalidDepthParameterError`,\n  RemoteDoesNotSupportShallowFail: `RemoteDoesNotSupportShallowFail`,\n  RemoteDoesNotSupportDeepenSinceFail: `RemoteDoesNotSupportDeepenSinceFail`,\n  RemoteDoesNotSupportDeepenNotFail: `RemoteDoesNotSupportDeepenNotFail`,\n  RemoteDoesNotSupportDeepenRelativeFail: `RemoteDoesNotSupportDeepenRelativeFail`,\n  RemoteDoesNotSupportSmartHTTP: `RemoteDoesNotSupportSmartHTTP`,\n  CorruptShallowOidFail: `CorruptShallowOidFail`,\n  FastForwardFail: `FastForwardFail`,\n  MergeNotSupportedFail: `MergeNotSupportedFail`,\n  DirectorySeparatorsError: `DirectorySeparatorsError`,\n  ResolveTreeError: `ResolveTreeError`,\n  ResolveCommitError: `ResolveCommitError`,\n  DirectoryIsAFileError: `DirectoryIsAFileError`,\n  TreeOrBlobNotFoundError: `TreeOrBlobNotFoundError`,\n  NotImplementedFail: `NotImplementedFail`,\n  ReadObjectFail: `ReadObjectFail`,\n  NotAnOidFail: `NotAnOidFail`,\n  NoRefspecConfiguredError: `NoRefspecConfiguredError`,\n  MismatchRefValueError: `MismatchRefValueError`,\n  ResolveRefError: `ResolveRefError`,\n  ExpandRefError: `ExpandRefError`,\n  EmptyServerResponseFail: `EmptyServerResponseFail`,\n  AssertServerResponseFail: `AssertServerResponseFail`,\n  HTTPError: `HTTPError`,\n  RemoteUrlParseError: `RemoteUrlParseError`,\n  UnknownTransportError: `UnknownTransportError`,\n  AcquireLockFileFail: `AcquireLockFileFail`,\n  DoubleReleaseLockFileFail: `DoubleReleaseLockFileFail`,\n  InternalFail: `InternalFail`,\n  UnknownOauth2Format: `UnknownOauth2Format`,\n  MissingPasswordTokenError: `MissingPasswordTokenError`,\n  MissingUsernameError: `MissingUsernameError`,\n  MixPasswordTokenError: `MixPasswordTokenError`,\n  MixUsernamePasswordTokenError: `MixUsernamePasswordTokenError`,\n  MissingTokenError: `MissingTokenError`,\n  MixUsernameOauth2formatMissingTokenError: `MixUsernameOauth2formatMissingTokenError`,\n  MixPasswordOauth2formatMissingTokenError: `MixPasswordOauth2formatMissingTokenError`,\n  MixUsernamePasswordOauth2formatMissingTokenError: `MixUsernamePasswordOauth2formatMissingTokenError`,\n  MixUsernameOauth2formatTokenError: `MixUsernameOauth2formatTokenError`,\n  MixPasswordOauth2formatTokenError: `MixPasswordOauth2formatTokenError`,\n  MixUsernamePasswordOauth2formatTokenError: `MixUsernamePasswordOauth2formatTokenError`,\n  MaxSearchDepthExceeded: `MaxSearchDepthExceeded`,\n  PushRejectedNonFastForward: `PushRejectedNonFastForward`,\n  PushRejectedTagExists: `PushRejectedTagExists`,\n  AddingRemoteWouldOverwrite: `AddingRemoteWouldOverwrite`,\n  PluginUndefined: `PluginUndefined`,\n  CoreNotFound: `CoreNotFound`,\n  PluginSchemaViolation: `PluginSchemaViolation`,\n  PluginUnrecognized: `PluginUnrecognized`,\n  AmbiguousShortOid: `AmbiguousShortOid`,\n  ShortOidNotFound: `ShortOidNotFound`,\n  CheckoutConflictError: `CheckoutConflictError`\n}\n\n"]}