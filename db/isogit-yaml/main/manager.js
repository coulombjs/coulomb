import * as log from 'electron-log';
import * as path from 'path';
import { listen } from '../../../ipc/main';
import { ModelManager, CommitError } from '../../main/base';
import { isGitError } from './isogit/base';
class Manager extends ModelManager {
    constructor(db, managerConfig, modelInfo, reportUpdatedData) {
        super();
        this.db = db;
        this.managerConfig = managerConfig;
        this.modelInfo = modelInfo;
        this.reportUpdatedData = reportUpdatedData;
        db.registerManager(this);
    }
    managesFileAtPath(filePath) {
        return true;
    }
    async listIDs(query) {
        return (await this.db.listIDs({ subdir: this.managerConfig.workDir })).
            map(ref => this.getObjID(ref));
    }
    async count(query) {
        return (await this.db.listIDs({ subdir: this.managerConfig.workDir })).length;
    }
    // CRUD methods
    async create(obj, commit = false) {
        const objID = obj[this.managerConfig.idField];
        await this.db.create(obj, this.getDBRef(objID), this.managerConfig.metaFields);
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'create');
            await this.reportUpdatedData([objID]);
        }
    }
    async read(objID) {
        return await this.db.read(this.getDBRef(objID), this.managerConfig.metaFields ? this.managerConfig.metaFields : undefined);
    }
    async readVersion(objID, version) {
        return await this.db.readVersion(this.getDBRef(objID), version);
    }
    async commit(objIDs, message) {
        if (objIDs.length > 0) {
            await this.db.commit(objIDs.map(objID => this.getDBRef(objID)), message);
            await this.reportUpdatedData(objIDs);
        }
    }
    async discard(objIDs) {
        if (objIDs.length > 0) {
            await this.db.discard(objIDs.map(objID => this.getDBRef(objID)));
            await this.reportUpdatedData(objIDs);
        }
    }
    async listUncommitted() {
        if (this.db.listUncommitted) {
            const dbRefs = await this.db.listUncommitted();
            const objIDs = dbRefs.
                filter(ref => this.managesFileAtPath(ref)).
                map(ref => this.getObjID(ref));
            return objIDs.filter(function (objID, idx, self) {
                // Discard duplicates from the list
                return idx === self.indexOf(objID);
            });
        }
        else {
            throw new Error("listUncommitted() is not implemented by DB backend");
        }
    }
    async readAll(query) {
        var _a;
        var idx = await this.db.getIndex(this.managerConfig.workDir, this.managerConfig.idField, ((_a = query) === null || _a === void 0 ? void 0 : _a.onlyIDs) !== undefined
            ? query.onlyIDs.map(id => this.getDBRef(id))
            : undefined);
        return idx;
    }
    async update(objID, newData, commit = false) {
        if (objID !== newData[this.managerConfig.idField]) {
            log.error("Attempt to update object ID", objID, newData);
            throw new Error("Updating object IDs is not supported at the moment.");
        }
        await this.db.update(this.getDBRef(objID), newData, this.managerConfig.idField);
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'update', newData);
            await this.reportUpdatedData([objID]);
        }
    }
    async delete(objID, commit = false) {
        await this.db.delete(this.getDBRef(objID));
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'delete');
            await this.reportUpdatedData([objID]);
        }
    }
    async commitOne(objID, commitMessage, verb, obj) {
        try {
            await this.db.commit([this.getDBRef(objID)], commitMessage !== null
                ? commitMessage
                : this.formatCommitMessage(verb, objID, obj));
        }
        catch (e) {
            // TODO: This is the only thing that makes this manager Git-specific.
            // Get rid of it and make it generic!
            if (isGitError(e)) {
                throw new CommitError(e.code, e.message);
            }
            else {
                throw e;
            }
        }
    }
    formatObjectName(objID, obj) {
        return `${objID}`;
    }
    formatCommitMessage(verb, objID, obj) {
        return `${verb} ${this.modelInfo.shortName} ${this.formatObjectName(objID, obj)}`;
    }
    getDBRef(objID) {
        /* Returns DB backendâ€™s full ID given object ID. */
        return path.join(this.managerConfig.workDir, `${objID}`);
    }
    getObjID(dbRef) {
        if (path.isAbsolute(dbRef)) {
            throw new Error("getObjID() received dbRef which is an absolute filesystem path");
        }
        var relativeRef = path.relative(this.managerConfig.workDir, dbRef);
        // `path.relative()` prepends unnecessary "../" when DB ref is plain filename.
        // This condition is necessary when DB ref is received from `db.listIDs()`,
        // and not necessary when DB ref is received from `db.listUncommitted()`.
        // TODO: See how `listUncommitted()` results are and make `listIDs()` consistent.
        if (relativeRef.startsWith('../')) {
            relativeRef = relativeRef.replace('../', '');
        }
        const baseComponent = relativeRef.split(path.sep)[0];
        // if (!objId || !(await this.isValidId(objId))) {
        //   throw new Error(`Unable to resolve object ID for path ${filepath}`);
        // }
        return baseComponent;
        // NOTE: Will cause errors if IDType is not a string.
        // If IDType is not a string, subclass must cast properly.
    }
    setUpIPC(modelName) {
        super.setUpIPC(modelName);
        const prefix = `model-${modelName}`;
        listen(`${prefix}-read-uncommitted-ids`, async () => {
            return await this.listUncommitted();
        });
        listen(`${prefix}-get-modified-status`, async ({ objectID }) => {
            log.debug("C/isogit-yaml: Requesting modified status", objectID);
            return { modified: (await this.listUncommitted()).includes(objectID) };
        });
        listen(`${prefix}-commit-objects`, async ({ objectIDs, commitMessage }) => {
            await this.commit(objectIDs, commitMessage);
            return { success: true };
        });
        listen(`${prefix}-discard-all-uncommitted`, async ({ objectIDs }) => {
            await this.discard(objectIDs);
            return { success: true };
        });
    }
}
export const ManagerClass = Manager;
export default Manager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9pc29naXQteWFtbC9tYWluL21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBWTNDLE9BQU8sRUFBRSxZQUFZLEVBQXFCLFdBQVcsRUFBNkIsTUFBTSxpQkFBaUIsQ0FBQztBQUUxRyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBb0IzQyxNQUFNLE9BQ04sU0FBUSxZQUEwQjtJQUVoQyxZQUNZLEVBQVcsRUFDWCxhQUFnQyxFQUNoQyxTQUFvQixFQUNyQixpQkFBb0Q7UUFDN0QsS0FBSyxFQUFFLENBQUM7UUFKRSxPQUFFLEdBQUYsRUFBRSxDQUFTO1FBQ1gsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDckIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQztRQUc3RCxFQUFFLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxRQUFnQjtRQUN2QyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQVM7UUFDNUIsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ3RFLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRU0sS0FBSyxDQUFDLEtB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QUEwQixFQUFFLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUU7WUFDNUQsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlCLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQTZELE9BQU8sQ0FBQztBQUU5RixlQUFlLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGxvZyBmcm9tICdlbGVjdHJvbi1sb2cnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgbGlzdGVuIH0gZnJvbSAnLi4vLi4vLi4vaXBjL21haW4nO1xuXG5pbXBvcnQgeyBNb2RlbEluZm8gfSBmcm9tICcuLi8uLi8uLi9jb25maWcvYXBwJztcblxuaW1wb3J0IHtcbiAgTWFuYWdlckNsYXNzIGFzIEJhc2VNYW5hZ2VyQ2xhc3MsXG4gIE1hbmFnZXJPcHRpb25zIGFzIEJhc2VNYW5hZ2VyT3B0aW9ucyxcbn0gZnJvbSAnLi4vLi4vLi4vY29uZmlnL21haW4nO1xuXG5pbXBvcnQgeyBNb2RlbCwgQW55SURUeXBlIH0gZnJvbSAnLi4vLi4vbW9kZWxzJztcbmltcG9ydCB7IEluZGV4IH0gZnJvbSAnLi4vLi4vcXVlcnknO1xuaW1wb3J0IHsgZGVmYXVsdCBhcyBCYWNrZW5kIH0gZnJvbSAnLi9iYXNlJztcbmltcG9ydCB7IE1vZGVsTWFuYWdlciwgRmlsZXN5c3RlbU1hbmFnZXIsIENvbW1pdEVycm9yLCBNYW5hZ2VkRGF0YUNoYW5nZVJlcG9ydGVyIH0gZnJvbSAnLi4vLi4vbWFpbi9iYXNlJztcblxuaW1wb3J0IHsgaXNHaXRFcnJvciB9IGZyb20gJy4vaXNvZ2l0L2Jhc2UnO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFuYWdlck9wdGlvbnM8TSBleHRlbmRzIE1vZGVsPiBleHRlbmRzIEJhc2VNYW5hZ2VyT3B0aW9uczxNPiB7XG4gIC8vIFBhdGggdG8gZGF0YSBmb3IgdGhpcyBtb2RlbCwgcmVsYXRpdmUgdG8gRELigJlzIHdvcmsgZGlyZWN0b3J5XG4gIHdvcmtEaXI6IHN0cmluZ1xuXG4gIC8vIExpc3Qgb2YgZmllbGRzIHRoYXQgZ28gaW50byBtZXRhLnlhbWxcbiAgbWV0YUZpZWxkcz86IChrZXlvZiBNKVtdXG5cbiAgLy8gTmFtZSBvZiBtb2RlbCBmaWVsZCBjb250YWluaW5nIHVucWl1ZSBpZGVudGlmaWVyIGVxdWl2YWxlbnRcbiAgaWRGaWVsZDoga2V5b2YgTVxufVxuXG5cbmludGVyZmFjZSBCYXNpY1F1ZXJ5PElEVHlwZSBleHRlbmRzIEFueUlEVHlwZT4ge1xuICBvbmx5SURzPzogSURUeXBlW11cbn1cblxuXG5jbGFzcyBNYW5hZ2VyPE0gZXh0ZW5kcyBNb2RlbCwgSURUeXBlIGV4dGVuZHMgQW55SURUeXBlLCBRIGV4dGVuZHMgQmFzaWNRdWVyeTxJRFR5cGU+ID0gQmFzaWNRdWVyeTxJRFR5cGU+PlxuZXh0ZW5kcyBNb2RlbE1hbmFnZXI8TSwgSURUeXBlLCBRPiBpbXBsZW1lbnRzIEZpbGVzeXN0ZW1NYW5hZ2VyIHtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIHByaXZhdGUgZGI6IEJhY2tlbmQsXG4gICAgICBwcml2YXRlIG1hbmFnZXJDb25maWc6IE1hbmFnZXJPcHRpb25zPE0+LFxuICAgICAgcHJpdmF0ZSBtb2RlbEluZm86IE1vZGVsSW5mbyxcbiAgICAgIHB1YmxpYyByZXBvcnRVcGRhdGVkRGF0YTogTWFuYWdlZERhdGFDaGFuZ2VSZXBvcnRlcjxJRFR5cGU+KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGRiLnJlZ2lzdGVyTWFuYWdlcih0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBtYW5hZ2VzRmlsZUF0UGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdElEcyhxdWVyeT86IFEpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZGIubGlzdElEcyh7IHN1YmRpcjogdGhpcy5tYW5hZ2VyQ29uZmlnLndvcmtEaXIgfSkpLlxuICAgIG1hcChyZWYgPT4gdGhpcy5nZXRPYmpJRChyZWYpKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjb3VudChxdWVyeT86IFEpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZGIubGlzdElEcyh7IHN1YmRpcjogdGhpcy5tYW5hZ2VyQ29uZmlnLndvcmtEaXIgfSkpLmxlbmd0aDtcbiAgfVxuXG5cbiAgLy8gQ1JVRCBtZXRob2RzXG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZShvYmo6IE0sIGNvbW1pdDogYm9vbGVhbiB8IHN0cmluZyA9IGZhbHNlKSB7XG4gICAgY29uc3Qgb2JqSUQgPSBvYmpbdGhpcy5tYW5hZ2VyQ29uZmlnLmlkRmllbGRdO1xuICAgIGF3YWl0IHRoaXMuZGIuY3JlYXRlKG9iaiwgdGhpcy5nZXREQlJlZihvYmpJRCksIHRoaXMubWFuYWdlckNvbmZpZy5tZXRhRmllbGRzKTtcblxuICAgIGlmIChjb21taXQgIT09IGZhbHNlKSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbW1pdE9uZShcbiAgICAgICAgb2JqSUQsXG4gICAgICAgIGNvbW1pdCAhPT0gdHJ1ZSA/IGNvbW1pdCA6IG51bGwsXG4gICAgICAgICdjcmVhdGUnKTtcbiAgICAgIGF3YWl0IHRoaXMucmVwb3J0VXBkYXRlZERhdGEoW29iaklEXSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWQob2JqSUQ6IElEVHlwZSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmRiLnJlYWQoXG4gICAgICB0aGlzLmdldERCUmVmKG9iaklEKSxcbiAgICAgIHRoaXMubWFuYWdlckNvbmZpZy5tZXRhRmllbGRzID8gKHRoaXMubWFuYWdlckNvbmZpZy5tZXRhRmllbGRzIGFzIHN0cmluZ1tdKSA6IHVuZGVmaW5lZCkgYXMgTTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkVmVyc2lvbihvYmpJRDogSURUeXBlLCB2ZXJzaW9uOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kYi5yZWFkVmVyc2lvbih0aGlzLmdldERCUmVmKG9iaklEKSwgdmVyc2lvbik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY29tbWl0KG9iaklEczogSURUeXBlW10sIG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGlmIChvYmpJRHMubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdGhpcy5kYi5jb21taXQob2JqSURzLm1hcChvYmpJRCA9PiB0aGlzLmdldERCUmVmKG9iaklEKSksIG1lc3NhZ2UpO1xuICAgICAgYXdhaXQgdGhpcy5yZXBvcnRVcGRhdGVkRGF0YShvYmpJRHMpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkaXNjYXJkKG9iaklEczogSURUeXBlW10pIHtcbiAgICBpZiAob2JqSURzLmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuZGlzY2FyZChvYmpJRHMubWFwKG9iaklEID0+IHRoaXMuZ2V0REJSZWYob2JqSUQpKSk7XG4gICAgICBhd2FpdCB0aGlzLnJlcG9ydFVwZGF0ZWREYXRhKG9iaklEcyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RVbmNvbW1pdHRlZCgpIHtcbiAgICBpZiAodGhpcy5kYi5saXN0VW5jb21taXR0ZWQpIHsgIFxuICAgICAgY29uc3QgZGJSZWZzID0gYXdhaXQgdGhpcy5kYi5saXN0VW5jb21taXR0ZWQoKTtcblxuICAgICAgY29uc3Qgb2JqSURzOiBJRFR5cGVbXSA9IGRiUmVmcy5cbiAgICAgICAgZmlsdGVyKHJlZiA9PiB0aGlzLm1hbmFnZXNGaWxlQXRQYXRoKHJlZikpLlxuICAgICAgICBtYXAocmVmID0+IHRoaXMuZ2V0T2JqSUQocmVmKSk7XG5cbiAgICAgIHJldHVybiBvYmpJRHMuZmlsdGVyKGZ1bmN0aW9uIChvYmpJRCwgaWR4LCBzZWxmKSB7XG4gICAgICAgIC8vIERpc2NhcmQgZHVwbGljYXRlcyBmcm9tIHRoZSBsaXN0XG4gICAgICAgIHJldHVybiBpZHggPT09IHNlbGYuaW5kZXhPZihvYmpJRCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwibGlzdFVuY29tbWl0dGVkKCkgaXMgbm90IGltcGxlbWVudGVkIGJ5IERCIGJhY2tlbmRcIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWRBbGwocXVlcnk/OiBRKSB7XG4gICAgdmFyIGlkeDogSW5kZXg8TT4gPSBhd2FpdCB0aGlzLmRiLmdldEluZGV4KFxuICAgICAgdGhpcy5tYW5hZ2VyQ29uZmlnLndvcmtEaXIsXG4gICAgICB0aGlzLm1hbmFnZXJDb25maWcuaWRGaWVsZCBhcyBzdHJpbmcsXG4gICAgICBxdWVyeT8ub25seUlEcyAhPT0gdW5kZWZpbmVkXG4gICAgICAgID8gcXVlcnkub25seUlEcy5tYXAoaWQgPT4gdGhpcy5nZXREQlJlZihpZCkpXG4gICAgICAgIDogdW5kZWZpbmVkKTtcbiAgICByZXR1cm4gaWR4O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZShvYmpJRDogSURUeXBlLCBuZXdEYXRhOiBNLCBjb21taXQ6IGJvb2xlYW4gfCBzdHJpbmcgPSBmYWxzZSkge1xuICAgIGlmIChvYmpJRCAhPT0gbmV3RGF0YVt0aGlzLm1hbmFnZXJDb25maWcuaWRGaWVsZF0pIHtcbiAgICAgIGxvZy5lcnJvcihcIkF0dGVtcHQgdG8gdXBkYXRlIG9iamVjdCBJRFwiLCBvYmpJRCwgbmV3RGF0YSk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVcGRhdGluZyBvYmplY3QgSURzIGlzIG5vdCBzdXBwb3J0ZWQgYXQgdGhlIG1vbWVudC5cIik7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5kYi51cGRhdGUodGhpcy5nZXREQlJlZihvYmpJRCksIG5ld0RhdGEsIHRoaXMubWFuYWdlckNvbmZpZy5pZEZpZWxkIGFzIHN0cmluZyk7XG5cbiAgICBpZiAoY29tbWl0ICE9PSBmYWxzZSkge1xuICAgICAgYXdhaXQgdGhpcy5jb21taXRPbmUoXG4gICAgICAgIG9iaklELFxuICAgICAgICBjb21taXQgIT09IHRydWUgPyBjb21taXQgOiBudWxsLFxuICAgICAgICAndXBkYXRlJyxcbiAgICAgICAgbmV3RGF0YSk7XG5cbiAgICAgIGF3YWl0IHRoaXMucmVwb3J0VXBkYXRlZERhdGEoW29iaklEXSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZShvYmpJRDogSURUeXBlLCBjb21taXQ6IHN0cmluZyB8IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgIGF3YWl0IHRoaXMuZGIuZGVsZXRlKHRoaXMuZ2V0REJSZWYob2JqSUQpKTtcblxuICAgIGlmIChjb21taXQgIT09IGZhbHNlKSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbW1pdE9uZShcbiAgICAgICAgb2JqSUQsXG4gICAgICAgIGNvbW1pdCAhPT0gdHJ1ZSA/IGNvbW1pdCA6IG51bGwsXG4gICAgICAgICdkZWxldGUnKTtcbiAgICAgIGF3YWl0IHRoaXMucmVwb3J0VXBkYXRlZERhdGEoW29iaklEXSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjb21taXRPbmUob2JqSUQ6IElEVHlwZSwgY29tbWl0TWVzc2FnZTogc3RyaW5nIHwgbnVsbCwgdmVyYjogc3RyaW5nLCBvYmo/OiBNKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuY29tbWl0KFxuICAgICAgICBbdGhpcy5nZXREQlJlZihvYmpJRCldLFxuICAgICAgICBjb21taXRNZXNzYWdlICE9PSBudWxsXG4gICAgICAgICAgPyBjb21taXRNZXNzYWdlXG4gICAgICAgICAgOiB0aGlzLmZvcm1hdENvbW1pdE1lc3NhZ2UodmVyYiwgb2JqSUQsIG9iaikpO1xuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gVE9ETzogVGhpcyBpcyB0aGUgb25seSB0aGluZyB0aGF0IG1ha2VzIHRoaXMgbWFuYWdlciBHaXQtc3BlY2lmaWMuXG4gICAgICAvLyBHZXQgcmlkIG9mIGl0IGFuZCBtYWtlIGl0IGdlbmVyaWMhXG4gICAgICBpZiAoaXNHaXRFcnJvcihlKSkge1xuICAgICAgICB0aHJvdyBuZXcgQ29tbWl0RXJyb3IoZS5jb2RlLCBlLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdE9iamVjdE5hbWUob2JqSUQ6IElEVHlwZSwgb2JqPzogTSkge1xuICAgIHJldHVybiBgJHtvYmpJRH1gO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRDb21taXRNZXNzYWdlKHZlcmI6IHN0cmluZywgb2JqSUQ6IElEVHlwZSwgb2JqPzogTSkge1xuICAgIHJldHVybiBgJHt2ZXJifSAke3RoaXMubW9kZWxJbmZvLnNob3J0TmFtZX0gJHt0aGlzLmZvcm1hdE9iamVjdE5hbWUob2JqSUQsIG9iail9YDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXREQlJlZihvYmpJRDogSURUeXBlIHwgc3RyaW5nKSB7XG4gICAgLyogUmV0dXJucyBEQiBiYWNrZW5k4oCZcyBmdWxsIElEIGdpdmVuIG9iamVjdCBJRC4gKi9cbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMubWFuYWdlckNvbmZpZy53b3JrRGlyLCBgJHtvYmpJRH1gKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRPYmpJRChkYlJlZjogc3RyaW5nKSB7XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZShkYlJlZikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImdldE9iaklEKCkgcmVjZWl2ZWQgZGJSZWYgd2hpY2ggaXMgYW4gYWJzb2x1dGUgZmlsZXN5c3RlbSBwYXRoXCIpO1xuICAgIH1cblxuICAgIHZhciByZWxhdGl2ZVJlZiA9IHBhdGgucmVsYXRpdmUodGhpcy5tYW5hZ2VyQ29uZmlnLndvcmtEaXIsIGRiUmVmKTtcbiAgICAvLyBgcGF0aC5yZWxhdGl2ZSgpYCBwcmVwZW5kcyB1bm5lY2Vzc2FyeSBcIi4uL1wiIHdoZW4gREIgcmVmIGlzIHBsYWluIGZpbGVuYW1lLlxuICAgIC8vIFRoaXMgY29uZGl0aW9uIGlzIG5lY2Vzc2FyeSB3aGVuIERCIHJlZiBpcyByZWNlaXZlZCBmcm9tIGBkYi5saXN0SURzKClgLFxuICAgIC8vIGFuZCBub3QgbmVjZXNzYXJ5IHdoZW4gREIgcmVmIGlzIHJlY2VpdmVkIGZyb20gYGRiLmxpc3RVbmNvbW1pdHRlZCgpYC5cbiAgICAvLyBUT0RPOiBTZWUgaG93IGBsaXN0VW5jb21taXR0ZWQoKWAgcmVzdWx0cyBhcmUgYW5kIG1ha2UgYGxpc3RJRHMoKWAgY29uc2lzdGVudC5cbiAgICBpZiAocmVsYXRpdmVSZWYuc3RhcnRzV2l0aCgnLi4vJykpIHsgcmVsYXRpdmVSZWYgPSByZWxhdGl2ZVJlZi5yZXBsYWNlKCcuLi8nLCAnJyk7IH1cblxuICAgIGNvbnN0IGJhc2VDb21wb25lbnQgPSByZWxhdGl2ZVJlZi5zcGxpdChwYXRoLnNlcClbMF07XG5cbiAgICAvLyBpZiAoIW9iaklkIHx8ICEoYXdhaXQgdGhpcy5pc1ZhbGlkSWQob2JqSWQpKSkge1xuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gcmVzb2x2ZSBvYmplY3QgSUQgZm9yIHBhdGggJHtmaWxlcGF0aH1gKTtcbiAgICAvLyB9XG5cbiAgICByZXR1cm4gYmFzZUNvbXBvbmVudCBhcyBJRFR5cGU7XG4gICAgLy8gTk9URTogV2lsbCBjYXVzZSBlcnJvcnMgaWYgSURUeXBlIGlzIG5vdCBhIHN0cmluZy5cbiAgICAvLyBJZiBJRFR5cGUgaXMgbm90IGEgc3RyaW5nLCBzdWJjbGFzcyBtdXN0IGNhc3QgcHJvcGVybHkuXG4gIH1cblxuICBwdWJsaWMgc2V0VXBJUEMobW9kZWxOYW1lOiBzdHJpbmcpIHtcbiAgICBzdXBlci5zZXRVcElQQyhtb2RlbE5hbWUpO1xuXG4gICAgY29uc3QgcHJlZml4ID0gYG1vZGVsLSR7bW9kZWxOYW1lfWA7XG5cbiAgICBsaXN0ZW48e30sIElEVHlwZVtdPlxuICAgIChgJHtwcmVmaXh9LXJlYWQtdW5jb21taXR0ZWQtaWRzYCwgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubGlzdFVuY29tbWl0dGVkKCk7XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48eyBvYmplY3RJRDogSURUeXBlIH0sIHsgbW9kaWZpZWQ6IGJvb2xlYW4gfT5cbiAgICAoYCR7cHJlZml4fS1nZXQtbW9kaWZpZWQtc3RhdHVzYCwgYXN5bmMgKHsgb2JqZWN0SUQgfSkgPT4ge1xuICAgICAgbG9nLmRlYnVnKFwiQy9pc29naXQteWFtbDogUmVxdWVzdGluZyBtb2RpZmllZCBzdGF0dXNcIiwgb2JqZWN0SUQpO1xuICAgICAgcmV0dXJuIHsgbW9kaWZpZWQ6IChhd2FpdCB0aGlzLmxpc3RVbmNvbW1pdHRlZCgpKS5pbmNsdWRlcyhvYmplY3RJRCkgfTtcbiAgICB9KTtcblxuICAgIGxpc3RlbjxcbiAgICAgIHsgb2JqZWN0SURzOiBJRFR5cGVbXSwgY29tbWl0TWVzc2FnZTogc3RyaW5nIH0sXG4gICAgICB7IHN1Y2Nlc3M6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1jb21taXQtb2JqZWN0c2AsIGFzeW5jICh7IG9iamVjdElEcywgY29tbWl0TWVzc2FnZSB9KSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmNvbW1pdChvYmplY3RJRHMsIGNvbW1pdE1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHsgb2JqZWN0SURzOiBJRFR5cGVbXSB9LCB7IHN1Y2Nlc3M6IHRydWUgfT5cbiAgICAoYCR7cHJlZml4fS1kaXNjYXJkLWFsbC11bmNvbW1pdHRlZGAsIGFzeW5jICh7IG9iamVjdElEcyB9KSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmRpc2NhcmQob2JqZWN0SURzKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgTWFuYWdlckNsYXNzOiBCYXNlTWFuYWdlckNsYXNzPGFueSwgYW55LCBNYW5hZ2VyT3B0aW9uczxhbnk+LCBCYWNrZW5kPiA9IE1hbmFnZXI7XG5cbmV4cG9ydCBkZWZhdWx0IE1hbmFnZXI7XG4iXX0=