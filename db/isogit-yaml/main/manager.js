import * as path from 'path';
import { listen } from '../../../ipc/main';
import { CommitError, } from '../../main/base';
import { isGitError } from './isogit/base';
class Manager {
    /* Combines a filesystem storage with Git. */
    constructor(db, managerConfig, modelConfig) {
        this.db = db;
        this.managerConfig = managerConfig;
        this.modelConfig = modelConfig;
        db.registerManager(this);
    }
    managesFileAtPath(filePath) {
        return true;
    }
    // CRUD methods
    async create(obj, commit = false) {
        const objID = obj[this.managerConfig.idField];
        await this.db.create(obj, this.getDBRef(objID), this.managerConfig.metaFields);
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'create');
        }
    }
    async read(objID) {
        return await this.db.read(this.getDBRef(objID), this.managerConfig.metaFields);
    }
    async commit(objIDs, message) {
        if (objIDs.length > 0) {
            await this.db.commit(objIDs.map(objID => this.getDBRef(objID)), message);
        }
    }
    async discard(objIDs) {
        if (objIDs.length > 0) {
            await this.db.discard(objIDs.map(objID => this.getDBRef(objID)));
        }
    }
    async listUncommitted() {
        if (this.db.listUncommitted) {
            const dbRefs = await this.db.listUncommitted();
            const objIDs = dbRefs.
                filter(ref => this.managesFileAtPath(ref)).
                map(ref => this.getObjID(ref));
            return objIDs.filter(function (objID, idx, self) {
                // Discard duplicates from the list
                return idx === self.indexOf(objID);
            });
        }
        else {
            throw new Error("listUncommitted() is not implemented by DB backend");
        }
    }
    async readAll() {
        var idx = await this.db.readAll(this.managerConfig.idField);
        ;
        return idx;
    }
    async update(objID, newData, commit = false) {
        if (objID !== newData[this.managerConfig.idField]) {
            throw new Error("Updating object IDs is not supported at the moment.");
        }
        await this.db.update(this.getDBRef(objID), newData, this.managerConfig.idField);
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'update', newData);
        }
    }
    async delete(objID, commit = false) {
        await this.db.delete(this.getDBRef(objID));
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'delete');
        }
    }
    async commitOne(objID, commitMessage, verb, obj) {
        try {
            await this.db.commit([this.getDBRef(objID)], commitMessage !== null
                ? commitMessage
                : this.formatCommitMessage(verb, objID, obj));
        }
        catch (e) {
            if (isGitError(e)) {
                throw new CommitError(e.code, e.message);
            }
            else {
                throw e;
            }
        }
    }
    formatObjectName(objID, obj) {
        return `${objID}`;
    }
    formatCommitMessage(verb, objID, obj) {
        return `${verb} ${this.modelConfig.shortName} ${this.formatObjectName(objID, obj)}`;
    }
    getDBRef(objID) {
        /* Returns DB backendâ€™s full ID given object ID. */
        return path.join(this.managerConfig.workDir, `${objID}`);
    }
    getObjID(dbRef) {
        if (path.isAbsolute(dbRef)) {
            throw new Error("getObjID() received dbRef which is an absolute filesystem path");
        }
        const relativeRef = path.relative(this.managerConfig.workDir, dbRef);
        const baseComponent = relativeRef.split(path.sep)[0];
        // if (!objId || !(await this.isValidId(objId))) {
        //   throw new Error(`Unable to resolve object ID for path ${filepath}`);
        // }
        return baseComponent;
    }
    setUpIPC(modelName) {
        const prefix = `model-${modelName}`;
        listen(`${prefix}-read-all`, async () => {
            return await this.readAll();
        });
        listen(`${prefix}-read-one`, async ({ objectID }) => {
            return await this.read(objectID);
        });
        listen(`${prefix}-read-uncommitted-ids`, async () => {
            return await this.listUncommitted();
        });
        listen(`${prefix}-commit-objects`, async ({ objectIDs, commitMessage }) => {
            await this.commit(objectIDs, commitMessage);
            return { success: true };
        });
        listen(`${prefix}-discard-all-uncommitted`, async ({ objectIDs }) => {
            await this.discard(objectIDs);
            return { success: true };
        });
    }
}
export default Manager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9pc29naXQteWFtbC9tYWluL21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBTTNDLE9BQU8sRUFJTCxXQUFXLEdBQ1osTUFBTSxpQkFBaUIsQ0FBQztBQUV6QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE1BQU0sT0FBTztJQUVYLDZDQUE2QztJQUU3QyxZQUNZLEVBQThCLEVBQzlCLGFBQWdDLEVBQ2hDLFdBQXdCO1FBRnhCLE9BQUUsR0FBRixFQUFFLENBQTRCO1FBQzlCLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQUNoQyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUNsQyxFQUFFLENBQUMsZUFBZSxDQUFDLElBQWtDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU0saUJBQWlCLENBQUMsUUFBZ0I7UUFDdkMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBR0QsZUFBZTtJQUVSLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBTSxFQUFFLFNBQTJCLEtBQUs7UUFDMUQsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsTUFBTSxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRS9FLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRTtZQUNwQixNQUFNLElBQUksQ0FBQyxTQUFTLENBQ2xCLEtBQUssRUFDTCxNQUFNLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxN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Q0FDTCxHQUFHLE1BQU0sdUJBQXVCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUMsT0FBTyxNQUFNLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FHTCxHQUFHLE1BQU0saUJBQWlCLEVBQUUsS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxFQUFFLEVBQUU7WUFDbEUsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUM1QyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUNMLEdBQUcsTUFBTSwwQkFBMEIsRUFBRSxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFO1lBQzVELE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM5QixPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBR0QsZUFBZSxPQUFPLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBsaXN0ZW4gfSBmcm9tICcuLi8uLi8uLi9pcGMvbWFpbic7XG5cbmltcG9ydCB7IE1vZGVsQ29uZmlnIH0gZnJvbSAnLi4vLi4vLi4vY29uZmlnL2FwcCc7XG5pbXBvcnQgeyBNYW5hZ2VyT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9tYWluJztcbmltcG9ydCB7IE1vZGVsLCBBbnlJRFR5cGUgfSBmcm9tICcuLi8uLi9tb2RlbHMnO1xuaW1wb3J0IHsgSW5kZXggfSBmcm9tICcuLi8uLi9xdWVyeSc7XG5pbXBvcnQge1xuICBWZXJzaW9uZWRGaWxlc3lzdGVtQmFja2VuZCxcbiAgVmVyc2lvbmVkTWFuYWdlcixcbiAgVmVyc2lvbmVkRmlsZXN5c3RlbU1hbmFnZXIsXG4gIENvbW1pdEVycm9yLFxufSBmcm9tICcuLi8uLi9tYWluL2Jhc2UnO1xuXG5pbXBvcnQgeyBpc0dpdEVycm9yIH0gZnJvbSAnLi9pc29naXQvYmFzZSc7XG5cblxuY2xhc3MgTWFuYWdlcjxNIGV4dGVuZHMgTW9kZWwsIElEVHlwZSBleHRlbmRzIEFueUlEVHlwZT5cbmltcGxlbWVudHMgVmVyc2lvbmVkTWFuYWdlcjxNLCBJRFR5cGU+LCBWZXJzaW9uZWRGaWxlc3lzdGVtTWFuYWdlciB7XG4gIC8qIENvbWJpbmVzIGEgZmlsZXN5c3RlbSBzdG9yYWdlIHdpdGggR2l0LiAqL1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgcHJpdmF0ZSBkYjogVmVyc2lvbmVkRmlsZXN5c3RlbUJhY2tlbmQsXG4gICAgICBwcml2YXRlIG1hbmFnZXJDb25maWc6IE1hbmFnZXJPcHRpb25zPE0+LFxuICAgICAgcHJpdmF0ZSBtb2RlbENvbmZpZzogTW9kZWxDb25maWcpIHtcbiAgICBkYi5yZWdpc3Rlck1hbmFnZXIodGhpcyBhcyBWZXJzaW9uZWRGaWxlc3lzdGVtTWFuYWdlcik7XG4gIH1cblxuICBwdWJsaWMgbWFuYWdlc0ZpbGVBdFBhdGgoZmlsZVBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cblxuICAvLyBDUlVEIG1ldGhvZHNcblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlKG9iajogTSwgY29tbWl0OiBib29sZWFuIHwgc3RyaW5nID0gZmFsc2UpIHtcbiAgICBjb25zdCBvYmpJRCA9IG9ialt0aGlzLm1hbmFnZXJDb25maWcuaWRGaWVsZF07XG4gICAgYXdhaXQgdGhpcy5kYi5jcmVhdGUob2JqLCB0aGlzLmdldERCUmVmKG9iaklEKSwgdGhpcy5tYW5hZ2VyQ29uZmlnLm1ldGFGaWVsZHMpO1xuXG4gICAgaWYgKGNvbW1pdCAhPT0gZmFsc2UpIHtcbiAgICAgIGF3YWl0IHRoaXMuY29tbWl0T25lKFxuICAgICAgICBvYmpJRCxcbiAgICAgICAgY29tbWl0ICE9PSB0cnVlID8gY29tbWl0IDogbnVsbCxcbiAgICAgICAgJ2NyZWF0ZScpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkKG9iaklEOiBJRFR5cGUpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kYi5yZWFkKFxuICAgICAgdGhpcy5nZXREQlJlZihvYmpJRCksXG4gICAgICB0aGlzLm1hbmFnZXJDb25maWcubWV0YUZpZWxkcyBhcyBzdHJpbmdbXSkgYXMgTTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjb21taXQob2JqSURzOiBJRFR5cGVbXSwgbWVzc2FnZTogc3RyaW5nKSB7XG4gICAgaWYgKG9iaklEcy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmRiLmNvbW1pdChvYmpJRHMubWFwKG9iaklEID0+IHRoaXMuZ2V0REJSZWYob2JqSUQpKSwgbWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRpc2NhcmQob2JqSURzOiBJRFR5cGVbXSkge1xuICAgIGlmIChvYmpJRHMubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdGhpcy5kYi5kaXNjYXJkKG9iaklEcy5tYXAob2JqSUQgPT4gdGhpcy5nZXREQlJlZihvYmpJRCkpKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdFVuY29tbWl0dGVkKCkge1xuICAgIGlmICh0aGlzLmRiLmxpc3RVbmNvbW1pdHRlZCkgeyAgXG4gICAgICBjb25zdCBkYlJlZnMgPSBhd2FpdCB0aGlzLmRiLmxpc3RVbmNvbW1pdHRlZCgpO1xuXG4gICAgICBjb25zdCBvYmpJRHM6IElEVHlwZVtdID0gZGJSZWZzLlxuICAgICAgICBmaWx0ZXIocmVmID0+IHRoaXMubWFuYWdlc0ZpbGVBdFBhdGgocmVmKSkuXG4gICAgICAgIG1hcChyZWYgPT4gdGhpcy5nZXRPYmpJRChyZWYpKTtcblxuICAgICAgcmV0dXJuIG9iaklEcy5maWx0ZXIoZnVuY3Rpb24gKG9iaklELCBpZHgsIHNlbGYpIHtcbiAgICAgICAgLy8gRGlzY2FyZCBkdXBsaWNhdGVzIGZyb20gdGhlIGxpc3RcbiAgICAgICAgcmV0dXJuIGlkeCA9PT0gc2VsZi5pbmRleE9mKG9iaklEKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJsaXN0VW5jb21taXR0ZWQoKSBpcyBub3QgaW1wbGVtZW50ZWQgYnkgREIgYmFja2VuZFwiKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZEFsbCgpIHtcbiAgICB2YXIgaWR4OiBJbmRleDxNPiA9IGF3YWl0IHRoaXMuZGIucmVhZEFsbCh0aGlzLm1hbmFnZXJDb25maWcuaWRGaWVsZCBhcyBzdHJpbmcpOztcbiAgICByZXR1cm4gaWR4O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZShvYmpJRDogSURUeXBlLCBuZXdEYXRhOiBNLCBjb21taXQ6IGJvb2xlYW4gfCBzdHJpbmcgPSBmYWxzZSkge1xuICAgIGlmIChvYmpJRCAhPT0gbmV3RGF0YVt0aGlzLm1hbmFnZXJDb25maWcuaWRGaWVsZF0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlVwZGF0aW5nIG9iamVjdCBJRHMgaXMgbm90IHN1cHBvcnRlZCBhdCB0aGUgbW9tZW50LlwiKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmRiLnVwZGF0ZSh0aGlzLmdldERCUmVmKG9iaklEKSwgbmV3RGF0YSwgdGhpcy5tYW5hZ2VyQ29uZmlnLmlkRmllbGQgYXMgc3RyaW5nKTtcblxuICAgIGlmIChjb21taXQgIT09IGZhbHNlKSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbW1pdE9uZShcbiAgICAgICAgb2JqSUQsXG4gICAgICAgIGNvbW1pdCAhPT0gdHJ1ZSA/IGNvbW1pdCA6IG51bGwsXG4gICAgICAgICd1cGRhdGUnLFxuICAgICAgICBuZXdEYXRhKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKG9iaklEOiBJRFR5cGUsIGNvbW1pdDogc3RyaW5nIHwgYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgYXdhaXQgdGhpcy5kYi5kZWxldGUodGhpcy5nZXREQlJlZihvYmpJRCkpO1xuXG4gICAgaWYgKGNvbW1pdCAhPT0gZmFsc2UpIHtcbiAgICAgIGF3YWl0IHRoaXMuY29tbWl0T25lKFxuICAgICAgICBvYmpJRCxcbiAgICAgICAgY29tbWl0ICE9PSB0cnVlID8gY29tbWl0IDogbnVsbCxcbiAgICAgICAgJ2RlbGV0ZScpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY29tbWl0T25lKG9iaklEOiBJRFR5cGUsIGNvbW1pdE1lc3NhZ2U6IHN0cmluZyB8IG51bGwsIHZlcmI6IHN0cmluZywgb2JqPzogTSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmRiLmNvbW1pdChcbiAgICAgICAgW3RoaXMuZ2V0REJSZWYob2JqSUQpXSxcbiAgICAgICAgY29tbWl0TWVzc2FnZSAhPT0gbnVsbFxuICAgICAgICAgID8gY29tbWl0TWVzc2FnZVxuICAgICAgICAgIDogdGhpcy5mb3JtYXRDb21taXRNZXNzYWdlKHZlcmIsIG9iaklELCBvYmopKTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChpc0dpdEVycm9yKGUpKSB7XG4gICAgICAgIHRocm93IG5ldyBDb21taXRFcnJvcihlLmNvZGUsIGUubWVzc2FnZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0T2JqZWN0TmFtZShvYmpJRDogSURUeXBlLCBvYmo/OiBNKSB7XG4gICAgcmV0dXJuIGAke29iaklEfWA7XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdENvbW1pdE1lc3NhZ2UodmVyYjogc3RyaW5nLCBvYmpJRDogSURUeXBlLCBvYmo/OiBNKSB7XG4gICAgcmV0dXJuIGAke3ZlcmJ9ICR7dGhpcy5tb2RlbENvbmZpZy5zaG9ydE5hbWV9ICR7dGhpcy5mb3JtYXRPYmplY3ROYW1lKG9iaklELCBvYmopfWA7XG4gIH1cblxuICBwcml2YXRlIGdldERCUmVmKG9iaklEOiBJRFR5cGUpOiBzdHJpbmcge1xuICAgIC8qIFJldHVybnMgREIgYmFja2VuZOKAmXMgZnVsbCBJRCBnaXZlbiBvYmplY3QgSUQuICovXG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLm1hbmFnZXJDb25maWcud29ya0RpciwgYCR7b2JqSUR9YCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0T2JqSUQoZGJSZWY6IHN0cmluZykge1xuICAgIGlmIChwYXRoLmlzQWJzb2x1dGUoZGJSZWYpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJnZXRPYmpJRCgpIHJlY2VpdmVkIGRiUmVmIHdoaWNoIGlzIGFuIGFic29sdXRlIGZpbGVzeXN0ZW0gcGF0aFwiKTtcbiAgICB9XG4gICAgY29uc3QgcmVsYXRpdmVSZWYgPSBwYXRoLnJlbGF0aXZlKHRoaXMubWFuYWdlckNvbmZpZy53b3JrRGlyLCBkYlJlZik7XG4gICAgY29uc3QgYmFzZUNvbXBvbmVudCA9IHJlbGF0aXZlUmVmLnNwbGl0KHBhdGguc2VwKVswXTtcblxuICAgIC8vIGlmICghb2JqSWQgfHwgIShhd2FpdCB0aGlzLmlzVmFsaWRJZChvYmpJZCkpKSB7XG4gICAgLy8gICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byByZXNvbHZlIG9iamVjdCBJRCBmb3IgcGF0aCAke2ZpbGVwYXRofWApO1xuICAgIC8vIH1cblxuICAgIHJldHVybiBiYXNlQ29tcG9uZW50IGFzIElEVHlwZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRVcElQQyhtb2RlbE5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IHByZWZpeCA9IGBtb2RlbC0ke21vZGVsTmFtZX1gO1xuXG4gICAgbGlzdGVuPHt9LCBJbmRleDxNPj5cbiAgICAoYCR7cHJlZml4fS1yZWFkLWFsbGAsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlYWRBbGwoKTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7IG9iamVjdElEOiBJRFR5cGUgfSwgTT5cbiAgICAoYCR7cHJlZml4fS1yZWFkLW9uZWAsIGFzeW5jICh7IG9iamVjdElEIH0pID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlYWQob2JqZWN0SUQpO1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCBJRFR5cGVbXT5cbiAgICAoYCR7cHJlZml4fS1yZWFkLXVuY29tbWl0dGVkLWlkc2AsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmxpc3RVbmNvbW1pdHRlZCgpO1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPFxuICAgICAgeyBvYmplY3RJRHM6IElEVHlwZVtdLCBjb21taXRNZXNzYWdlOiBzdHJpbmcgfSxcbiAgICAgIHsgc3VjY2VzczogdHJ1ZSB9PlxuICAgIChgJHtwcmVmaXh9LWNvbW1pdC1vYmplY3RzYCwgYXN5bmMgKHsgb2JqZWN0SURzLCBjb21taXRNZXNzYWdlIH0pID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuY29tbWl0KG9iamVjdElEcywgY29tbWl0TWVzc2FnZSk7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48eyBvYmplY3RJRHM6IElEVHlwZVtdIH0sIHsgc3VjY2VzczogdHJ1ZSB9PlxuICAgIChgJHtwcmVmaXh9LWRpc2NhcmQtYWxsLXVuY29tbWl0dGVkYCwgYXN5bmMgKHsgb2JqZWN0SURzIH0pID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuZGlzY2FyZChvYmplY3RJRHMpO1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgIH0pO1xuICB9XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgTWFuYWdlcjtcbiJdfQ==