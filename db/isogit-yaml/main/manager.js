import * as log from 'electron-log';
import * as path from 'path';
import { listen } from '../../../ipc/main';
import { ModelManager, CommitError } from '../../main/base';
import { isGitError } from './isogit/base';
class Manager extends ModelManager {
    constructor(db, managerConfig, modelInfo, reportUpdatedData) {
        super();
        this.db = db;
        this.managerConfig = managerConfig;
        this.modelInfo = modelInfo;
        this.reportUpdatedData = reportUpdatedData;
        db.registerManager(this);
    }
    managesFileAtPath(filePath) {
        return true;
    }
    async listIDs(query) {
        return (await this.db.listIDs({ subdir: this.managerConfig.workDir })).
            map(ref => this.getObjID(ref));
    }
    async count(query) {
        return (await this.listIDs(query)).length;
    }
    // CRUD methods
    async create(obj, commit = false) {
        const objID = obj[this.managerConfig.idField];
        await this.db.create(obj, this.getDBRef(objID), this.managerConfig.metaFields);
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'create');
            await this.reportUpdatedData([objID]);
        }
    }
    async read(objID) {
        return await this.db.read(this.getDBRef(objID), this.managerConfig.metaFields ? this.managerConfig.metaFields : undefined);
    }
    async readVersion(objID, version) {
        return await this.db.readVersion(this.getDBRef(objID), version);
    }
    async commit(objIDs, message) {
        if (objIDs.length > 0) {
            await this.db.commit(objIDs.map(objID => this.getDBRef(objID)), message);
            await this.reportUpdatedData(objIDs);
        }
    }
    async discard(objIDs) {
        if (objIDs.length > 0) {
            await this.db.discard(objIDs.map(objID => this.getDBRef(objID)));
            await this.reportUpdatedData(objIDs);
        }
    }
    async listUncommitted() {
        if (this.db.listUncommitted) {
            const dbRefs = await this.db.listUncommitted();
            const objIDs = dbRefs.
                filter(ref => this.managesFileAtPath(ref)).
                map(ref => this.getObjID(ref));
            return objIDs.filter(function (objID, idx, self) {
                // Discard duplicates from the list
                return idx === self.indexOf(objID);
            });
        }
        else {
            throw new Error("listUncommitted() is not implemented by DB backend");
        }
    }
    async readAll(query) {
        var _a;
        var idx = await this.db.getIndex(this.managerConfig.workDir, this.managerConfig.idField, ((_a = query) === null || _a === void 0 ? void 0 : _a.onlyIDs) !== undefined
            ? query.onlyIDs.map(id => this.getDBRef(id))
            : undefined);
        return idx;
    }
    async update(objID, newData, commit = false) {
        if (objID !== newData[this.managerConfig.idField]) {
            log.error("Attempt to update object ID", objID, newData);
            throw new Error("Updating object IDs is not supported at the moment.");
        }
        await this.db.update(this.getDBRef(objID), newData, this.managerConfig.idField);
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'update', newData);
            await this.reportUpdatedData([objID]);
        }
    }
    async delete(objID, commit = false) {
        await this.db.delete(this.getDBRef(objID));
        if (commit !== false) {
            await this.commitOne(objID, commit !== true ? commit : null, 'delete');
            await this.reportUpdatedData([objID]);
        }
    }
    async commitOne(objID, commitMessage, verb, obj) {
        try {
            await this.db.commit([this.getDBRef(objID)], commitMessage !== null
                ? commitMessage
                : this.formatCommitMessage(verb, objID, obj));
        }
        catch (e) {
            // TODO: This is the only thing that makes this manager Git-specific.
            // Get rid of it and make it generic!
            if (isGitError(e)) {
                throw new CommitError(e.code, e.message);
            }
            else {
                throw e;
            }
        }
    }
    formatObjectName(objID, obj) {
        return `${objID}`;
    }
    formatCommitMessage(verb, objID, obj) {
        return `${verb} ${this.modelInfo.shortName} ${this.formatObjectName(objID, obj)}`;
    }
    getDBRef(objID) {
        /* Returns DB backendâ€™s full ID given object ID. */
        return path.join(this.managerConfig.workDir, `${objID}`);
    }
    getObjID(dbRef) {
        if (path.isAbsolute(dbRef)) {
            throw new Error("getObjID() received dbRef which is an absolute filesystem path");
        }
        var relativeRef = path.relative(this.managerConfig.workDir, dbRef);
        // `path.relative()` prepends unnecessary "../" when DB ref is plain filename.
        // This condition is necessary when DB ref is received from `db.listIDs()`,
        // and not necessary when DB ref is received from `db.listUncommitted()`.
        // TODO: See how `listUncommitted()` results are and make `listIDs()` consistent.
        if (relativeRef.startsWith('../')) {
            relativeRef = relativeRef.replace('../', '');
        }
        const baseComponent = relativeRef.split(path.sep)[0];
        // if (!objId || !(await this.isValidId(objId))) {
        //   throw new Error(`Unable to resolve object ID for path ${filepath}`);
        // }
        return baseComponent;
        // NOTE: Will cause errors if IDType is not a string.
        // If IDType is not a string, subclass must cast properly.
    }
    setUpIPC(modelName) {
        super.setUpIPC(modelName);
        const prefix = `model-${modelName}`;
        listen(`${prefix}-read-uncommitted-ids`, async () => {
            return await this.listUncommitted();
        });
        listen(`${prefix}-get-modified-status`, async ({ objectID }) => {
            log.debug("C/isogit-yaml: Requesting modified status", objectID);
            return { modified: (await this.listUncommitted()).includes(objectID) };
        });
        listen(`${prefix}-commit-objects`, async ({ objectIDs, commitMessage }) => {
            await this.commit(objectIDs, commitMessage);
            return { success: true };
        });
        listen(`${prefix}-discard-all-uncommitted`, async ({ objectIDs }) => {
            await this.discard(objectIDs);
            return { success: true };
        });
    }
}
export const ManagerClass = Manager;
export default Manager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9pc29naXQteWFtbC9tYWluL21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBWTNDLE9BQU8sRUFBRSxZQUFZLEVBQXFCLFdBQVcsRUFBNkIsTUFBTSxpQkFBaUIsQ0FBQztBQUUxRyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBb0IzQyxNQUFNLE9BQ04sU0FBUSxZQUEwQjtJQUVoQyxZQUNZLEVBQVcsRUFDWCxhQUFnQyxFQUNoQyxTQUFvQixFQUNyQixpQkFBb0Q7UUFDN0QsS0FBSyxFQUFFLENBQUM7UUFKRSxPQUFFLEdBQUYsRUFBRSxDQUFTO1FBQ1gsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDckIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQztRQUc3RCxFQUFFLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxRQUFnQjtRQUN2QyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQVM7UUFDNUIsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ3RFLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRU0sS0FBSyxDQUFDLEtB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LE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM5QixPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUE2RCxPQUFPLENBQUM7QUFFOUYsZUFBZSxPQUFPLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IGxpc3RlbiB9IGZyb20gJy4uLy4uLy4uL2lwYy9tYWluJztcblxuaW1wb3J0IHsgTW9kZWxJbmZvIH0gZnJvbSAnLi4vLi4vLi4vY29uZmlnL2FwcCc7XG5cbmltcG9ydCB7XG4gIE1hbmFnZXJDbGFzcyBhcyBCYXNlTWFuYWdlckNsYXNzLFxuICBNYW5hZ2VyT3B0aW9ucyBhcyBCYXNlTWFuYWdlck9wdGlvbnMsXG59IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9tYWluJztcblxuaW1wb3J0IHsgTW9kZWwsIEFueUlEVHlwZSB9IGZyb20gJy4uLy4uL21vZGVscyc7XG5pbXBvcnQgeyBJbmRleCB9IGZyb20gJy4uLy4uL3F1ZXJ5JztcbmltcG9ydCB7IGRlZmF1bHQgYXMgQmFja2VuZCB9IGZyb20gJy4vYmFzZSc7XG5pbXBvcnQgeyBNb2RlbE1hbmFnZXIsIEZpbGVzeXN0ZW1NYW5hZ2VyLCBDb21taXRFcnJvciwgTWFuYWdlZERhdGFDaGFuZ2VSZXBvcnRlciB9IGZyb20gJy4uLy4uL21haW4vYmFzZSc7XG5cbmltcG9ydCB7IGlzR2l0RXJyb3IgfSBmcm9tICcuL2lzb2dpdC9iYXNlJztcblxuXG5leHBvcnQgaW50ZXJmYWNlIE1hbmFnZXJPcHRpb25zPE0gZXh0ZW5kcyBNb2RlbD4gZXh0ZW5kcyBCYXNlTWFuYWdlck9wdGlvbnM8TT4ge1xuICAvLyBQYXRoIHRvIGRhdGEgZm9yIHRoaXMgbW9kZWwsIHJlbGF0aXZlIHRvIERC4oCZcyB3b3JrIGRpcmVjdG9yeVxuICB3b3JrRGlyOiBzdHJpbmdcblxuICAvLyBMaXN0IG9mIGZpZWxkcyB0aGF0IGdvIGludG8gbWV0YS55YW1sXG4gIG1ldGFGaWVsZHM/OiAoa2V5b2YgTSlbXVxuXG4gIC8vIE5hbWUgb2YgbW9kZWwgZmllbGQgY29udGFpbmluZyB1bnFpdWUgaWRlbnRpZmllciBlcXVpdmFsZW50XG4gIGlkRmllbGQ6IGtleW9mIE1cbn1cblxuXG5pbnRlcmZhY2UgQmFzaWNRdWVyeTxJRFR5cGUgZXh0ZW5kcyBBbnlJRFR5cGU+IHtcbiAgb25seUlEcz86IElEVHlwZVtdXG59XG5cblxuY2xhc3MgTWFuYWdlcjxNIGV4dGVuZHMgTW9kZWwsIElEVHlwZSBleHRlbmRzIEFueUlEVHlwZSwgUSBleHRlbmRzIEJhc2ljUXVlcnk8SURUeXBlPiA9IEJhc2ljUXVlcnk8SURUeXBlPj5cbmV4dGVuZHMgTW9kZWxNYW5hZ2VyPE0sIElEVHlwZSwgUT4gaW1wbGVtZW50cyBGaWxlc3lzdGVtTWFuYWdlciB7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBwcml2YXRlIGRiOiBCYWNrZW5kLFxuICAgICAgcHJpdmF0ZSBtYW5hZ2VyQ29uZmlnOiBNYW5hZ2VyT3B0aW9uczxNPixcbiAgICAgIHByaXZhdGUgbW9kZWxJbmZvOiBNb2RlbEluZm8sXG4gICAgICBwdWJsaWMgcmVwb3J0VXBkYXRlZERhdGE6IE1hbmFnZWREYXRhQ2hhbmdlUmVwb3J0ZXI8SURUeXBlPikge1xuICAgIHN1cGVyKCk7XG5cbiAgICBkYi5yZWdpc3Rlck1hbmFnZXIodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgbWFuYWdlc0ZpbGVBdFBhdGgoZmlsZVBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RJRHMocXVlcnk/OiBRKSB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmRiLmxpc3RJRHMoeyBzdWJkaXI6IHRoaXMubWFuYWdlckNvbmZpZy53b3JrRGlyIH0pKS5cbiAgICBtYXAocmVmID0+IHRoaXMuZ2V0T2JqSUQocmVmKSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY291bnQocXVlcnk/OiBRKSB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmxpc3RJRHMocXVlcnkpKS5sZW5ndGg7XG4gIH1cblxuXG4gIC8vIENSVUQgbWV0aG9kc1xuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGUob2JqOiBNLCBjb21taXQ6IGJvb2xlYW4gfCBzdHJpbmcgPSBmYWxzZSkge1xuICAgIGNvbnN0IG9iaklEID0gb2JqW3RoaXMubWFuYWdlckNvbmZpZy5pZEZpZWxkXTtcbiAgICBhd2FpdCB0aGlzLmRiLmNyZWF0ZShvYmosIHRoaXMuZ2V0REJSZWYob2JqSUQpLCB0aGlzLm1hbmFnZXJDb25maWcubWV0YUZpZWxkcyk7XG5cbiAgICBpZiAoY29tbWl0ICE9PSBmYWxzZSkge1xuICAgICAgYXdhaXQgdGhpcy5jb21taXRPbmUoXG4gICAgICAgIG9iaklELFxuICAgICAgICBjb21taXQgIT09IHRydWUgPyBjb21taXQgOiBudWxsLFxuICAgICAgICAnY3JlYXRlJyk7XG4gICAgICBhd2FpdCB0aGlzLnJlcG9ydFVwZGF0ZWREYXRhKFtvYmpJRF0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkKG9iaklEOiBJRFR5cGUpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kYi5yZWFkKFxuICAgICAgdGhpcy5nZXREQlJlZihvYmpJRCksXG4gICAgICB0aGlzLm1hbmFnZXJDb25maWcubWV0YUZpZWxkcyA/ICh0aGlzLm1hbmFnZXJDb25maWcubWV0YUZpZWxkcyBhcyBzdHJpbmdbXSkgOiB1bmRlZmluZWQpIGFzIE07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZFZlcnNpb24ob2JqSUQ6IElEVHlwZSwgdmVyc2lvbjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZGIucmVhZFZlcnNpb24odGhpcy5nZXREQlJlZihvYmpJRCksIHZlcnNpb24pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNvbW1pdChvYmpJRHM6IElEVHlwZVtdLCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBpZiAob2JqSURzLmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuY29tbWl0KG9iaklEcy5tYXAob2JqSUQgPT4gdGhpcy5nZXREQlJlZihvYmpJRCkpLCBtZXNzYWdlKTtcbiAgICAgIGF3YWl0IHRoaXMucmVwb3J0VXBkYXRlZERhdGEob2JqSURzKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGlzY2FyZChvYmpJRHM6IElEVHlwZVtdKSB7XG4gICAgaWYgKG9iaklEcy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmRiLmRpc2NhcmQob2JqSURzLm1hcChvYmpJRCA9PiB0aGlzLmdldERCUmVmKG9iaklEKSkpO1xuICAgICAgYXdhaXQgdGhpcy5yZXBvcnRVcGRhdGVkRGF0YShvYmpJRHMpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0VW5jb21taXR0ZWQoKSB7XG4gICAgaWYgKHRoaXMuZGIubGlzdFVuY29tbWl0dGVkKSB7ICBcbiAgICAgIGNvbnN0IGRiUmVmcyA9IGF3YWl0IHRoaXMuZGIubGlzdFVuY29tbWl0dGVkKCk7XG5cbiAgICAgIGNvbnN0IG9iaklEczogSURUeXBlW10gPSBkYlJlZnMuXG4gICAgICAgIGZpbHRlcihyZWYgPT4gdGhpcy5tYW5hZ2VzRmlsZUF0UGF0aChyZWYpKS5cbiAgICAgICAgbWFwKHJlZiA9PiB0aGlzLmdldE9iaklEKHJlZikpO1xuXG4gICAgICByZXR1cm4gb2JqSURzLmZpbHRlcihmdW5jdGlvbiAob2JqSUQsIGlkeCwgc2VsZikge1xuICAgICAgICAvLyBEaXNjYXJkIGR1cGxpY2F0ZXMgZnJvbSB0aGUgbGlzdFxuICAgICAgICByZXR1cm4gaWR4ID09PSBzZWxmLmluZGV4T2Yob2JqSUQpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImxpc3RVbmNvbW1pdHRlZCgpIGlzIG5vdCBpbXBsZW1lbnRlZCBieSBEQiBiYWNrZW5kXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkQWxsKHF1ZXJ5PzogUSkge1xuICAgIHZhciBpZHg6IEluZGV4PE0+ID0gYXdhaXQgdGhpcy5kYi5nZXRJbmRleChcbiAgICAgIHRoaXMubWFuYWdlckNvbmZpZy53b3JrRGlyLFxuICAgICAgdGhpcy5tYW5hZ2VyQ29uZmlnLmlkRmllbGQgYXMgc3RyaW5nLFxuICAgICAgcXVlcnk/Lm9ubHlJRHMgIT09IHVuZGVmaW5lZFxuICAgICAgICA/IHF1ZXJ5Lm9ubHlJRHMubWFwKGlkID0+IHRoaXMuZ2V0REJSZWYoaWQpKVxuICAgICAgICA6IHVuZGVmaW5lZCk7XG4gICAgcmV0dXJuIGlkeDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUob2JqSUQ6IElEVHlwZSwgbmV3RGF0YTogTSwgY29tbWl0OiBib29sZWFuIHwgc3RyaW5nID0gZmFsc2UpIHtcbiAgICBpZiAob2JqSUQgIT09IG5ld0RhdGFbdGhpcy5tYW5hZ2VyQ29uZmlnLmlkRmllbGRdKSB7XG4gICAgICBsb2cuZXJyb3IoXCJBdHRlbXB0IHRvIHVwZGF0ZSBvYmplY3QgSURcIiwgb2JqSUQsIG5ld0RhdGEpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVXBkYXRpbmcgb2JqZWN0IElEcyBpcyBub3Qgc3VwcG9ydGVkIGF0IHRoZSBtb21lbnQuXCIpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZGIudXBkYXRlKHRoaXMuZ2V0REJSZWYob2JqSUQpLCBuZXdEYXRhLCB0aGlzLm1hbmFnZXJDb25maWcuaWRGaWVsZCBhcyBzdHJpbmcpO1xuXG4gICAgaWYgKGNvbW1pdCAhPT0gZmFsc2UpIHtcbiAgICAgIGF3YWl0IHRoaXMuY29tbWl0T25lKFxuICAgICAgICBvYmpJRCxcbiAgICAgICAgY29tbWl0ICE9PSB0cnVlID8gY29tbWl0IDogbnVsbCxcbiAgICAgICAgJ3VwZGF0ZScsXG4gICAgICAgIG5ld0RhdGEpO1xuXG4gICAgICBhd2FpdCB0aGlzLnJlcG9ydFVwZGF0ZWREYXRhKFtvYmpJRF0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGUob2JqSUQ6IElEVHlwZSwgY29tbWl0OiBzdHJpbmcgfCBib29sZWFuID0gZmFsc2UpIHtcbiAgICBhd2FpdCB0aGlzLmRiLmRlbGV0ZSh0aGlzLmdldERCUmVmKG9iaklEKSk7XG5cbiAgICBpZiAoY29tbWl0ICE9PSBmYWxzZSkge1xuICAgICAgYXdhaXQgdGhpcy5jb21taXRPbmUoXG4gICAgICAgIG9iaklELFxuICAgICAgICBjb21taXQgIT09IHRydWUgPyBjb21taXQgOiBudWxsLFxuICAgICAgICAnZGVsZXRlJyk7XG4gICAgICBhd2FpdCB0aGlzLnJlcG9ydFVwZGF0ZWREYXRhKFtvYmpJRF0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY29tbWl0T25lKG9iaklEOiBJRFR5cGUsIGNvbW1pdE1lc3NhZ2U6IHN0cmluZyB8IG51bGwsIHZlcmI6IHN0cmluZywgb2JqPzogTSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmRiLmNvbW1pdChcbiAgICAgICAgW3RoaXMuZ2V0REJSZWYob2JqSUQpXSxcbiAgICAgICAgY29tbWl0TWVzc2FnZSAhPT0gbnVsbFxuICAgICAgICAgID8gY29tbWl0TWVzc2FnZVxuICAgICAgICAgIDogdGhpcy5mb3JtYXRDb21taXRNZXNzYWdlKHZlcmIsIG9iaklELCBvYmopKTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIFRPRE86IFRoaXMgaXMgdGhlIG9ubHkgdGhpbmcgdGhhdCBtYWtlcyB0aGlzIG1hbmFnZXIgR2l0LXNwZWNpZmljLlxuICAgICAgLy8gR2V0IHJpZCBvZiBpdCBhbmQgbWFrZSBpdCBnZW5lcmljIVxuICAgICAgaWYgKGlzR2l0RXJyb3IoZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbW1pdEVycm9yKGUuY29kZSwgZS5tZXNzYWdlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRPYmplY3ROYW1lKG9iaklEOiBJRFR5cGUsIG9iaj86IE0pIHtcbiAgICByZXR1cm4gYCR7b2JqSUR9YDtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0Q29tbWl0TWVzc2FnZSh2ZXJiOiBzdHJpbmcsIG9iaklEOiBJRFR5cGUsIG9iaj86IE0pIHtcbiAgICByZXR1cm4gYCR7dmVyYn0gJHt0aGlzLm1vZGVsSW5mby5zaG9ydE5hbWV9ICR7dGhpcy5mb3JtYXRPYmplY3ROYW1lKG9iaklELCBvYmopfWA7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0REJSZWYob2JqSUQ6IElEVHlwZSB8IHN0cmluZykge1xuICAgIC8qIFJldHVybnMgREIgYmFja2VuZOKAmXMgZnVsbCBJRCBnaXZlbiBvYmplY3QgSUQuICovXG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLm1hbmFnZXJDb25maWcud29ya0RpciwgYCR7b2JqSUR9YCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0T2JqSUQoZGJSZWY6IHN0cmluZykge1xuICAgIGlmIChwYXRoLmlzQWJzb2x1dGUoZGJSZWYpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJnZXRPYmpJRCgpIHJlY2VpdmVkIGRiUmVmIHdoaWNoIGlzIGFuIGFic29sdXRlIGZpbGVzeXN0ZW0gcGF0aFwiKTtcbiAgICB9XG5cbiAgICB2YXIgcmVsYXRpdmVSZWYgPSBwYXRoLnJlbGF0aXZlKHRoaXMubWFuYWdlckNvbmZpZy53b3JrRGlyLCBkYlJlZik7XG4gICAgLy8gYHBhdGgucmVsYXRpdmUoKWAgcHJlcGVuZHMgdW5uZWNlc3NhcnkgXCIuLi9cIiB3aGVuIERCIHJlZiBpcyBwbGFpbiBmaWxlbmFtZS5cbiAgICAvLyBUaGlzIGNvbmRpdGlvbiBpcyBuZWNlc3Nhcnkgd2hlbiBEQiByZWYgaXMgcmVjZWl2ZWQgZnJvbSBgZGIubGlzdElEcygpYCxcbiAgICAvLyBhbmQgbm90IG5lY2Vzc2FyeSB3aGVuIERCIHJlZiBpcyByZWNlaXZlZCBmcm9tIGBkYi5saXN0VW5jb21taXR0ZWQoKWAuXG4gICAgLy8gVE9ETzogU2VlIGhvdyBgbGlzdFVuY29tbWl0dGVkKClgIHJlc3VsdHMgYXJlIGFuZCBtYWtlIGBsaXN0SURzKClgIGNvbnNpc3RlbnQuXG4gICAgaWYgKHJlbGF0aXZlUmVmLnN0YXJ0c1dpdGgoJy4uLycpKSB7IHJlbGF0aXZlUmVmID0gcmVsYXRpdmVSZWYucmVwbGFjZSgnLi4vJywgJycpOyB9XG5cbiAgICBjb25zdCBiYXNlQ29tcG9uZW50ID0gcmVsYXRpdmVSZWYuc3BsaXQocGF0aC5zZXApWzBdO1xuXG4gICAgLy8gaWYgKCFvYmpJZCB8fCAhKGF3YWl0IHRoaXMuaXNWYWxpZElkKG9iaklkKSkpIHtcbiAgICAvLyAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHJlc29sdmUgb2JqZWN0IElEIGZvciBwYXRoICR7ZmlsZXBhdGh9YCk7XG4gICAgLy8gfVxuXG4gICAgcmV0dXJuIGJhc2VDb21wb25lbnQgYXMgSURUeXBlO1xuICAgIC8vIE5PVEU6IFdpbGwgY2F1c2UgZXJyb3JzIGlmIElEVHlwZSBpcyBub3QgYSBzdHJpbmcuXG4gICAgLy8gSWYgSURUeXBlIGlzIG5vdCBhIHN0cmluZywgc3ViY2xhc3MgbXVzdCBjYXN0IHByb3Blcmx5LlxuICB9XG5cbiAgcHVibGljIHNldFVwSVBDKG1vZGVsTmFtZTogc3RyaW5nKSB7XG4gICAgc3VwZXIuc2V0VXBJUEMobW9kZWxOYW1lKTtcblxuICAgIGNvbnN0IHByZWZpeCA9IGBtb2RlbC0ke21vZGVsTmFtZX1gO1xuXG4gICAgbGlzdGVuPHt9LCBJRFR5cGVbXT5cbiAgICAoYCR7cHJlZml4fS1yZWFkLXVuY29tbWl0dGVkLWlkc2AsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmxpc3RVbmNvbW1pdHRlZCgpO1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHsgb2JqZWN0SUQ6IElEVHlwZSB9LCB7IG1vZGlmaWVkOiBib29sZWFuIH0+XG4gICAgKGAke3ByZWZpeH0tZ2V0LW1vZGlmaWVkLXN0YXR1c2AsIGFzeW5jICh7IG9iamVjdElEIH0pID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhcIkMvaXNvZ2l0LXlhbWw6IFJlcXVlc3RpbmcgbW9kaWZpZWQgc3RhdHVzXCIsIG9iamVjdElEKTtcbiAgICAgIHJldHVybiB7IG1vZGlmaWVkOiAoYXdhaXQgdGhpcy5saXN0VW5jb21taXR0ZWQoKSkuaW5jbHVkZXMob2JqZWN0SUQpIH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48XG4gICAgICB7IG9iamVjdElEczogSURUeXBlW10sIGNvbW1pdE1lc3NhZ2U6IHN0cmluZyB9LFxuICAgICAgeyBzdWNjZXNzOiB0cnVlIH0+XG4gICAgKGAke3ByZWZpeH0tY29tbWl0LW9iamVjdHNgLCBhc3luYyAoeyBvYmplY3RJRHMsIGNvbW1pdE1lc3NhZ2UgfSkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5jb21taXQob2JqZWN0SURzLCBjb21taXRNZXNzYWdlKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7IG9iamVjdElEczogSURUeXBlW10gfSwgeyBzdWNjZXNzOiB0cnVlIH0+XG4gICAgKGAke3ByZWZpeH0tZGlzY2FyZC1hbGwtdW5jb21taXR0ZWRgLCBhc3luYyAoeyBvYmplY3RJRHMgfSkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5kaXNjYXJkKG9iamVjdElEcyk7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IE1hbmFnZXJDbGFzczogQmFzZU1hbmFnZXJDbGFzczxhbnksIGFueSwgTWFuYWdlck9wdGlvbnM8YW55PiwgQmFja2VuZD4gPSBNYW5hZ2VyO1xuXG5leHBvcnQgZGVmYXVsdCBNYW5hZ2VyO1xuIl19