import React, { useEffect, useState } from 'react';
import { Button, FormGroup, InputGroup, Popover, Position } from '@blueprintjs/core';
import { openWindow } from '../../../api_legacy/renderer';
import { callIPC, useIPCValue } from '../../../ipc/renderer';
import styles from './status.scss';
const BackendDetails = function ({ dbIPCPrefix, status, description }) {
    const ipcPrefix = dbIPCPrefix;
    useEffect(() => {
        openPasswordPrompt(status.needsPassword);
    }, [status.needsPassword]);
    const [passwordPromptIsOpen, openPasswordPrompt] = useState(false);
    async function setPassword(password) {
        await callIPC(`${ipcPrefix}-git-set-password`, { password });
    }
    return (React.createElement("div", { className: styles.base },
        React.createElement(Button, { minimal: true, small: true, className: styles.sourceInfo, onClick: () => callIPC('open-arbitrary-window', {
                url: description.gitRepo,
                title: "Git repository"
            }) },
            description.gitUsername,
            "@",
            description.gitRepo),
        React.createElement(Popover, { minimal: true, content: React.createElement(PasswordPrompt, { onConfirm: async (password) => { await setPassword(password); openPasswordPrompt(false); } }), position: Position.TOP_RIGHT, isOpen: passwordPromptIsOpen },
            React.createElement(ActionableStatus, { status: status, uncommittedFileCount: useIPCValue(`${ipcPrefix}-count-uncommitted`, { numUncommitted: 0 }).
                    value.numUncommitted, onRequestSync: async () => await callIPC(`${ipcPrefix}-git-trigger-sync`), onDiscardUnstaged: async () => await callIPC(`${ipcPrefix}-git-discard-unstaged`), onTogglePasswordPrompt: () => openPasswordPrompt(!passwordPromptIsOpen), onShowCommitWindow: () => openWindow('batch-commit'), onShowSettingsWindow: () => openWindow('settings') }))));
};
export default BackendDetails;
const ActionableStatus = function ({ status, uncommittedFileCount, onRequestSync, onDiscardUnstaged, onTogglePasswordPrompt, onShowCommitWindow, onShowSettingsWindow }) {
    let statusIcon;
    let tooltipText;
    let statusIntent;
    let action;
    if (status.isMisconfigured) {
        statusIcon = "error";
        tooltipText = "Configuration required; click to resolve";
        statusIntent = "danger";
        action = onShowSettingsWindow;
    }
    else if (status.isOnline !== true) {
        statusIcon = "offline";
        tooltipText = "Offline";
        statusIntent = "danger";
        action = onRequestSync;
    }
    else if (status.needsPassword) {
        statusIcon = "lock";
        tooltipText = "Password required";
        statusIntent = "primary";
        action = onTogglePasswordPrompt;
    }
    else if (status.hasLocalChanges) {
        statusIcon = "git-commit";
        tooltipText = "Uncommitted changes; click to resolve";
        statusIntent = "warning";
        action = async () => {
            if (status.hasLocalChanges && uncommittedFileCount < 1) {
                // NOTE: If hasLocalChanges says yes, but uncommitted file count says no, try to fix it.
                await onDiscardUnstaged();
                await onRequestSync();
            }
            else {
                onShowCommitWindow();
            }
        };
    }
    else if (status.isPulling) {
        statusIcon = "cloud-download";
        tooltipText = "Synchronizing";
        statusIntent = "primary";
        action = null;
    }
    else if (status.isPushing) {
        statusIcon = "cloud-upload";
        tooltipText = "Synchronizing";
        statusIntent = "primary";
        action = null;
    }
    else if (status.statusRelativeToLocal === 'diverged') {
        statusIcon = "git-branch";
        tooltipText = "Diverging changes present; click to retry";
        statusIntent = "danger";
        action = onRequestSync;
    }
    else if (status.statusRelativeToLocal === 'behind') {
        statusIcon = "cloud-upload";
        tooltipText = "Online";
        statusIntent = "warning";
        action = onRequestSync;
    }
    else {
        statusIcon = "updated";
        tooltipText = "Online";
        statusIntent = "success";
        action = onRequestSync;
    }
    return (React.createElement(Button, { className: styles.backendStatus, onClick: action || (() => { }), small: true, minimal: true, icon: statusIcon, intent: statusIntent, disabled: action === null, loading: action === null }, tooltipText));
};
const PasswordPrompt = function ({ onConfirm }) {
    const [value, setValue] = useState('');
    return React.createElement("div", { className: styles.passwordPrompt },
        React.createElement(FormGroup, { label: "Please enter repository password:", helperText: "The password will be kept in memory and not stored to disk." },
            React.createElement(InputGroup, { type: "password", value: value, onChange: (event) => setValue(event.target.value), leftIcon: "key", rightElement: value.trim() === ''
                    ? undefined
                    : React.createElement(Button, { minimal: true, onClick: async () => await onConfirm(value), icon: "tick", intent: "primary" }, "Confirm") })));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdHVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2RiL2lzb2dpdC15YW1sL3JlbmRlcmVyL3N0YXR1cy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBRW5ELE9BQU8sRUFBRSxNQUFNLEVBQVksU0FBUyxFQUFFLFVBQVUsRUFBVSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFdkcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzFELE9BQU8sRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFLN0QsT0FBTyxNQUFNLE1BQU0sZUFBZSxDQUFDO0FBR25DLE1BQU0sY0FBYyxHQUNwQixVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUU7SUFDNUMsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDO0lBRTlCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixrQkFBa0IsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0MsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFFM0IsTUFBTSxDQUFDLG9CQUFvQixFQUFFLGtCQUFrQixDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRW5FLEtBQUssVUFBVSxXQUFXLENBQUMsUUFBZ0I7UUFDekMsTUFBTSxPQUFPLENBQTBDLEdBQUcsU0FBUyxtQkFBbUIsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDeEcsQ0FBQztJQUVELE9BQU8sQ0FDTCw2QkFBSyxTQUFTLEVBQUUsTUFBTSxDQUFDLElBQUk7UUFDekIsb0JBQUMsTUFBTSxJQUNILE9BQU8sRUFBRSxJQUFJLEVBQ2IsS0FBSyxFQUFFLElB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U3RhdGUgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IEJ1dHRvbiwgSWNvbk5hbWUsIEZvcm1Hcm91cCwgSW5wdXRHcm91cCwgSW50ZW50LCBQb3BvdmVyLCBQb3NpdGlvbiB9IGZyb20gJ0BibHVlcHJpbnRqcy9jb3JlJztcblxuaW1wb3J0IHsgb3BlbldpbmRvdyB9IGZyb20gJy4uLy4uLy4uL2FwaV9sZWdhY3kvcmVuZGVyZXInO1xuaW1wb3J0IHsgY2FsbElQQywgdXNlSVBDVmFsdWUgfSBmcm9tICcuLi8uLi8uLi9pcGMvcmVuZGVyZXInO1xuXG5pbXBvcnQgeyBEYXRhYmFzZVN0YXR1c0NvbXBvbmVudFByb3BzIH0gZnJvbSAnLi4vLi4vLi4vY29uZmlnL3JlbmRlcmVyJztcbmltcG9ydCB7IEJhY2tlbmREZXNjcmlwdGlvbiwgQmFja2VuZFN0YXR1cyB9IGZyb20gJy4uL2Jhc2UnO1xuXG5pbXBvcnQgc3R5bGVzIGZyb20gJy4vc3RhdHVzLnNjc3MnO1xuXG5cbmNvbnN0IEJhY2tlbmREZXRhaWxzOiBSZWFjdC5GQzxEYXRhYmFzZVN0YXR1c0NvbXBvbmVudFByb3BzPEJhY2tlbmREZXNjcmlwdGlvbiwgQmFja2VuZFN0YXR1cz4+ID1cbmZ1bmN0aW9uICh7IGRiSVBDUHJlZml4LCBzdGF0dXMsIGRlc2NyaXB0aW9uIH0pIHtcbiAgY29uc3QgaXBjUHJlZml4ID0gZGJJUENQcmVmaXg7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBvcGVuUGFzc3dvcmRQcm9tcHQoc3RhdHVzLm5lZWRzUGFzc3dvcmQpO1xuICB9LCBbc3RhdHVzLm5lZWRzUGFzc3dvcmRdKTtcblxuICBjb25zdCBbcGFzc3dvcmRQcm9tcHRJc09wZW4sIG9wZW5QYXNzd29yZFByb21wdF0gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gc2V0UGFzc3dvcmQocGFzc3dvcmQ6IHN0cmluZykge1xuICAgIGF3YWl0IGNhbGxJUEM8eyBwYXNzd29yZDogc3RyaW5nIH0sIHsgc3VjY2VzczogdHJ1ZSB9PihgJHtpcGNQcmVmaXh9LWdpdC1zZXQtcGFzc3dvcmRgLCB7IHBhc3N3b3JkIH0pO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8ZGl2IGNsYXNzTmFtZT17c3R5bGVzLmJhc2V9PlxuICAgICAgPEJ1dHRvblxuICAgICAgICAgIG1pbmltYWw9e3RydWV9XG4gICAgICAgICAgc21hbGw9e3RydWV9XG4gICAgICAgICAgY2xhc3NOYW1lPXtzdHlsZXMuc291cmNlSW5mb31cbiAgICAgICAgICBvbkNsaWNrPXsoKSA9PiBjYWxsSVBDKCdvcGVuLWFyYml0cmFyeS13aW5kb3cnLCB7XG4gICAgICAgICAgICB1cmw6IGRlc2NyaXB0aW9uLmdpdFJlcG8sXG4gICAgICAgICAgICB0aXRsZTogXCJHaXQgcmVwb3NpdG9yeVwiXG4gICAgICAgICAgfSl9PlxuICAgICAgICB7ZGVzY3JpcHRpb24uZ2l0VXNlcm5hbWV9QHtkZXNjcmlwdGlvbi5naXRSZXBvfVxuICAgICAgPC9CdXR0b24+XG5cbiAgICAgIDxQb3BvdmVyIG1pbmltYWw9e3RydWV9IGNvbnRlbnQ9e1xuICAgICAgICAgIDxQYXNzd29yZFByb21wdFxuICAgICAgICAgICAgb25Db25maXJtPXthc3luYyAocGFzc3dvcmQpID0+IHsgYXdhaXQgc2V0UGFzc3dvcmQocGFzc3dvcmQpOyBvcGVuUGFzc3dvcmRQcm9tcHQoZmFsc2UpOyB9fSAvPn1cbiAgICAgICAgICAgIHBvc2l0aW9uPXtQb3NpdGlvbi5UT1BfUklHSFR9XG4gICAgICAgICAgICBpc09wZW49e3Bhc3N3b3JkUHJvbXB0SXNPcGVufT5cbiAgICAgICAgPEFjdGlvbmFibGVTdGF0dXNcbiAgICAgICAgICBzdGF0dXM9e3N0YXR1c31cbiAgICAgICAgICB1bmNvbW1pdHRlZEZpbGVDb3VudD17XG4gICAgICAgICAgICB1c2VJUENWYWx1ZShgJHtpcGNQcmVmaXh9LWNvdW50LXVuY29tbWl0dGVkYCwgeyBudW1VbmNvbW1pdHRlZDogMCB9KS5cbiAgICAgICAgICAgIHZhbHVlLm51bVVuY29tbWl0dGVkfVxuICAgICAgICAgIG9uUmVxdWVzdFN5bmM9e2FzeW5jICgpID0+IGF3YWl0IGNhbGxJUEMoYCR7aXBjUHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCl9XG4gICAgICAgICAgb25EaXNjYXJkVW5zdGFnZWQ9e2FzeW5jICgpID0+IGF3YWl0IGNhbGxJUEMoYCR7aXBjUHJlZml4fS1naXQtZGlzY2FyZC11bnN0YWdlZGApfVxuICAgICAgICAgIG9uVG9nZ2xlUGFzc3dvcmRQcm9tcHQ9eygpID0+IG9wZW5QYXNzd29yZFByb21wdCghcGFzc3dvcmRQcm9tcHRJc09wZW4pfVxuICAgICAgICAgIG9uU2hvd0NvbW1pdFdpbmRvdz17KCkgPT4gb3BlbldpbmRvdygnYmF0Y2gtY29tbWl0Jyl9XG4gICAgICAgICAgb25TaG93U2V0dGluZ3NXaW5kb3c9eygpID0+IG9wZW5XaW5kb3coJ3NldHRpbmdzJyl9XG4gICAgICAgIC8+XG4gICAgICA8L1BvcG92ZXI+XG4gICAgPC9kaXY+XG4gICk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBCYWNrZW5kRGV0YWlscztcblxuXG5pbnRlcmZhY2UgQWN0aW9uYWJsZVN0YXR1c1Byb3BzIHtcbiAgc3RhdHVzOiBCYWNrZW5kU3RhdHVzXG4gIHVuY29tbWl0dGVkRmlsZUNvdW50OiBudW1iZXJcbiAgb25SZXF1ZXN0U3luYzogKCkgPT4gUHJvbWlzZTx2b2lkPlxuICBvbkRpc2NhcmRVbnN0YWdlZDogKCkgPT4gUHJvbWlzZTx2b2lkPlxuICBvblRvZ2dsZVBhc3N3b3JkUHJvbXB0OiAoKSA9PiB2b2lkXG4gIG9uU2hvd0NvbW1pdFdpbmRvdzogKCkgPT4gdm9pZFxuICBvblNob3dTZXR0aW5nc1dpbmRvdzogKCkgPT4gdm9pZFxufVxuY29uc3QgQWN0aW9uYWJsZVN0YXR1czogUmVhY3QuRkM8QWN0aW9uYWJsZVN0YXR1c1Byb3BzPiA9IGZ1bmN0aW9uICh7XG4gICAgc3RhdHVzLCB1bmNvbW1pdHRlZEZpbGVDb3VudCxcbiAgICBvblJlcXVlc3RTeW5jLCBvbkRpc2NhcmRVbnN0YWdlZCxcbiAgICBvblRvZ2dsZVBhc3N3b3JkUHJvbXB0LFxuICAgIG9uU2hvd0NvbW1pdFdpbmRvdywgb25TaG93U2V0dGluZ3NXaW5kb3cgfSkge1xuXG4gIGxldCBzdGF0dXNJY29uOiBJY29uTmFtZTtcbiAgbGV0IHRvb2x0aXBUZXh0OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGxldCBzdGF0dXNJbnRlbnQ6IEludGVudDtcbiAgbGV0IGFjdGlvbjogbnVsbCB8ICgoKSA9PiB2b2lkKTtcblxuICBpZiAoc3RhdHVzLmlzTWlzY29uZmlndXJlZCkge1xuICAgIHN0YXR1c0ljb24gPSBcImVycm9yXCI7XG4gICAgdG9vbHRpcFRleHQgPSBcIkNvbmZpZ3VyYXRpb24gcmVxdWlyZWQ7IGNsaWNrIHRvIHJlc29sdmVcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcImRhbmdlclwiO1xuICAgIGFjdGlvbiA9IG9uU2hvd1NldHRpbmdzV2luZG93O1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmlzT25saW5lICE9PSB0cnVlKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwib2ZmbGluZVwiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJPZmZsaW5lXCJcbiAgICBzdGF0dXNJbnRlbnQgPSBcImRhbmdlclwiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMubmVlZHNQYXNzd29yZCkge1xuICAgIHN0YXR1c0ljb24gPSBcImxvY2tcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiUGFzc3dvcmQgcmVxdWlyZWRcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInByaW1hcnlcIjtcbiAgICBhY3Rpb24gPSBvblRvZ2dsZVBhc3N3b3JkUHJvbXB0O1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmhhc0xvY2FsQ2hhbmdlcykge1xuICAgIHN0YXR1c0ljb24gPSBcImdpdC1jb21taXRcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiVW5jb21taXR0ZWQgY2hhbmdlczsgY2xpY2sgdG8gcmVzb2x2ZVwiO1xuICAgIHN0YXR1c0ludGVudCA9IFwid2FybmluZ1wiO1xuICAgIGFjdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICAgIGlmIChzdGF0dXMuaGFzTG9jYWxDaGFuZ2VzICYmIHVuY29tbWl0dGVkRmlsZUNvdW50IDwgMSkge1xuICAgICAgICAvLyBOT1RFOiBJZiBoYXNMb2NhbENoYW5nZXMgc2F5cyB5ZXMsIGJ1dCB1bmNvbW1pdHRlZCBmaWxlIGNvdW50IHNheXMgbm8sIHRyeSB0byBmaXggaXQuXG4gICAgICAgIGF3YWl0IG9uRGlzY2FyZFVuc3RhZ2VkKCk7XG4gICAgICAgIGF3YWl0IG9uUmVxdWVzdFN5bmMoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9uU2hvd0NvbW1pdFdpbmRvdygpO1xuICAgICAgfVxuICAgIH1cblxuICB9IGVsc2UgaWYgKHN0YXR1cy5pc1B1bGxpbmcpIHtcbiAgICBzdGF0dXNJY29uID0gXCJjbG91ZC1kb3dubG9hZFwiXG4gICAgdG9vbHRpcFRleHQgPSBcIlN5bmNocm9uaXppbmdcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInByaW1hcnlcIjtcbiAgICBhY3Rpb24gPSBudWxsO1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmlzUHVzaGluZykge1xuICAgIHN0YXR1c0ljb24gPSBcImNsb3VkLXVwbG9hZFwiXG4gICAgdG9vbHRpcFRleHQgPSBcIlN5bmNocm9uaXppbmdcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInByaW1hcnlcIjtcbiAgICBhY3Rpb24gPSBudWxsO1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLnN0YXR1c1JlbGF0aXZlVG9Mb2NhbCA9PT0gJ2RpdmVyZ2VkJykge1xuICAgIHN0YXR1c0ljb24gPSBcImdpdC1icmFuY2hcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJEaXZlcmdpbmcgY2hhbmdlcyBwcmVzZW50OyBjbGljayB0byByZXRyeVwiO1xuICAgIHN0YXR1c0ludGVudCA9IFwiZGFuZ2VyXCI7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0U3luYztcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5zdGF0dXNSZWxhdGl2ZVRvTG9jYWwgPT09ICdiZWhpbmQnKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiY2xvdWQtdXBsb2FkXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiT25saW5lXCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJ3YXJuaW5nXCI7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0U3luYztcblxuICB9IGVsc2Uge1xuICAgIHN0YXR1c0ljb24gPSBcInVwZGF0ZWRcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJPbmxpbmVcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInN1Y2Nlc3NcIjtcbiAgICBhY3Rpb24gPSBvblJlcXVlc3RTeW5jO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8QnV0dG9uXG4gICAgICAgIGNsYXNzTmFtZT17c3R5bGVzLmJhY2tlbmRTdGF0dXN9XG4gICAgICAgIG9uQ2xpY2s9e2FjdGlvbiB8fCAoKCkgPT4ge30pfVxuICAgICAgICBzbWFsbD17dHJ1ZX1cbiAgICAgICAgbWluaW1hbD17dHJ1ZX1cbiAgICAgICAgaWNvbj17c3RhdHVzSWNvbn1cbiAgICAgICAgaW50ZW50PXtzdGF0dXNJbnRlbnR9XG4gICAgICAgIGRpc2FibGVkPXthY3Rpb24gPT09IG51bGx9XG4gICAgICAgIGxvYWRpbmc9e2FjdGlvbiA9PT0gbnVsbH0+XG4gICAgICB7dG9vbHRpcFRleHR9XG4gICAgPC9CdXR0b24+XG4gICk7XG59O1xuXG5cbmNvbnN0IFBhc3N3b3JkUHJvbXB0OiBSZWFjdC5GQzx7IG9uQ29uZmlybTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4gfT4gPSBmdW5jdGlvbiAoeyBvbkNvbmZpcm0gfSkge1xuICBjb25zdCBbdmFsdWUsIHNldFZhbHVlXSA9IHVzZVN0YXRlKCcnKTtcblxuICByZXR1cm4gPGRpdiBjbGFzc05hbWU9e3N0eWxlcy5wYXNzd29yZFByb21wdH0+XG4gICAgPEZvcm1Hcm91cFxuICAgICAgICBsYWJlbD1cIlBsZWFzZSBlbnRlciByZXBvc2l0b3J5IHBhc3N3b3JkOlwiXG4gICAgICAgIGhlbHBlclRleHQ9XCJUaGUgcGFzc3dvcmQgd2lsbCBiZSBrZXB0IGluIG1lbW9yeSBhbmQgbm90IHN0b3JlZCB0byBkaXNrLlwiPlxuICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgdHlwZT1cInBhc3N3b3JkXCJcbiAgICAgICAgdmFsdWU9e3ZhbHVlfVxuICAgICAgICBvbkNoYW5nZT17KGV2ZW50OiBSZWFjdC5Gb3JtRXZlbnQ8SFRNTEVsZW1lbnQ+KSA9PiBzZXRWYWx1ZSgoZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlKX1cbiAgICAgICAgbGVmdEljb249XCJrZXlcIlxuICAgICAgICByaWdodEVsZW1lbnQ9e1xuICAgICAgICAgIHZhbHVlLnRyaW0oKSA9PT0gJydcbiAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgIDogPEJ1dHRvblxuICAgICAgICAgICAgICAgIG1pbmltYWw9e3RydWV9XG4gICAgICAgICAgICAgICAgb25DbGljaz17YXN5bmMgKCkgPT4gYXdhaXQgb25Db25maXJtKHZhbHVlKX1cbiAgICAgICAgICAgICAgICBpY29uPVwidGlja1wiXG4gICAgICAgICAgICAgICAgaW50ZW50PVwicHJpbWFyeVwiPlxuICAgICAgICAgICAgICBDb25maXJtXG4gICAgICAgICAgICA8L0J1dHRvbj59XG4gICAgICAvPlxuICAgIDwvRm9ybUdyb3VwPlxuICA8L2Rpdj47XG59O1xuIl19