import React, { useState } from 'react';
import { Button, FormGroup, InputGroup, ButtonGroup, NonIdealState, Spinner, } from '@blueprintjs/core';
import { callIPC, useIPCValue } from '../../../ipc/renderer';
import styles from './status.scss';
const BackendDetails = function ({ dbIPCPrefix, status, description }) {
    const ipcPrefix = dbIPCPrefix;
    const numUncommitted = useIPCValue(`${ipcPrefix}-count-uncommitted`, { numUncommitted: 0 }).
        value.numUncommitted;
    // Requests sync with push
    async function handleRequestFullSync() {
        await callIPC(`${ipcPrefix}-git-request-push`);
        await callIPC(`${ipcPrefix}-git-trigger-sync`);
    }
    return (React.createElement(ButtonGroup, { fill: true, vertical: true, alignText: "left" },
        React.createElement(Button, { className: styles.sourceInfo, title: `${description.gitUsername}@${description.gitRepo}`, icon: "git-repo", onClick: () => {
                if (description.gitRepo) {
                    require('electron').shell.openExternal(description.gitRepo);
                }
            } },
            description.gitUsername,
            "@",
            description.gitRepo),
        React.createElement(ActionableStatus, { status: status, uncommittedFileCount: numUncommitted, onRequestFullSync: handleRequestFullSync, onShowSettingsWindow: () => callIPC('open-predefined-window', { id: 'settings' }) })));
};
export default BackendDetails;
const ActionableStatus = function ({ status, uncommittedFileCount, onRequestFullSync, onShowSettingsWindow }) {
    let statusIcon;
    let tooltipText;
    let statusIntent;
    let action;
    if (status.isMisconfigured) {
        statusIcon = "error";
        tooltipText = "Configure";
        statusIntent = "danger";
        action = onShowSettingsWindow;
    }
    else if (status.isOnline !== true) {
        statusIcon = "offline";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestFullSync;
    }
    else if (status.hasLocalChanges && uncommittedFileCount > 0) {
        statusIcon = "git-commit";
        tooltipText = "Sync now";
        statusIntent = undefined;
        action = onRequestFullSync;
    }
    else if (status.statusRelativeToLocal === 'diverged') {
        statusIcon = "git-branch";
        tooltipText = "Resolve conflict and sync";
        statusIntent = "warning";
        action = onRequestFullSync;
    }
    else if (status.statusRelativeToLocal === 'behind') {
        statusIcon = "cloud-upload";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestFullSync;
    }
    else {
        statusIcon = "updated";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestFullSync;
    }
    return (React.createElement(Button, { className: styles.backendStatus, onClick: action || (() => { }), icon: statusIcon, intent: statusIntent, disabled: action === null }, tooltipText));
};
export const PasswordPrompt = function ({ dbIPCPrefix, onConfirm }) {
    const [value, setValue] = useState('');
    async function handlePasswordConfirm() {
        await callIPC(`${dbIPCPrefix}-git-set-password`, { password: value });
        await callIPC(`${dbIPCPrefix}-git-trigger-sync`);
        onConfirm();
    }
    return React.createElement("div", { className: styles.passwordPrompt },
        React.createElement(FormGroup, { label: "Please enter repository password:", helperText: "The password will be kept in memory and not stored to disk." },
            React.createElement(InputGroup, { type: "password", value: value, onChange: (event) => setValue(event.target.value), leftIcon: "key", rightElement: value.trim() === ''
                    ? undefined
                    : React.createElement(Button, { minimal: true, onClick: handlePasswordConfirm, icon: "tick", intent: "primary" }, "Confirm") })));
};
export const DBSyncScreen = function ({ dbName, db, onDismiss }) {
    var _a;
    let dbInitializationScreen;
    if (((_a = db) === null || _a === void 0 ? void 0 : _a.status) === undefined) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: React.createElement(Spinner, null), title: "Initializing database" });
    }
    else if (db.status.needsPassword) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: "key", title: "Password required", description: React.createElement(PasswordPrompt, { dbIPCPrefix: `db-${dbName}`, onConfirm: () => void 0 }) });
    }
    else if (db.status.isPushing || db.status.isPulling) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: db.status.isPushing ? "cloud-upload" : "cloud-download", title: "Synchronizing data", description: db.status.isPushing ? "Sending changes" : "Fetching changes" });
    }
    else if (db.status.lastSynchronized === null && db.status.hasLocalChanges === false) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: React.createElement(Spinner, null), title: "Connecting" });
    }
    else if (db.status.lastSynchronized !== null) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: "tick", title: "Ready", description: React.createElement(Button, { onClick: onDismiss, intent: "primary" }, "Dismiss") });
    }
    else {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: "tick", title: "Ready", description: React.createElement(Button, { onClick: onDismiss, intent: "primary" }, "Dismiss") });
    }
    return dbInitializationScreen;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdHVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2RiL2lzb2dpdC15YW1sL3JlbmRlcmVyL3N0YXR1cy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFFeEMsT0FBTyxFQUNMLE1BQU0sRUFBWSxTQUFTLEVBQUUsVUFBVSxFQUN2QyxXQUFXLEVBQUUsYUFBYSxFQUFFLE9BQU8sR0FDcEMsTUFBTSxtQkFBbUIsQ0FBQztBQUUzQixPQUFPLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBSzdELE9BQU8sTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUduQyxNQUFNLGNBQWMsR0FDcEIsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFO0lBQzVDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztJQUU5QixNQUFNLGNBQWMsR0FDbEIsV0FBVyxDQUFDLEdBQUcsU0FBUyxvQkFBb0IsRUFBRSxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNwRSxLQUFLLENBQUMsY0FBYyxDQUFDO0lBRXZCLDBCQUEwQjtJQUMxQixLQUFLLFVBQVUscUJBQXFCO1FBQ2xDLE1BQU0sT0FBTyxDQUFDLEdBQUcsU0FBUyxtQkFBbUIsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sT0FBTyxDQUFDLEdBQUcsU0FBUyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxPQUFPLENBQ0wsb0JBQUMsV0FBVyxJQUFDLElBQUksUUFBQyxRQUFRLFFBQUMsU0FBUyxFQUFDLE1BQU07UUFDekMsb0JBQUMsTUFBTSxJQUNILFNBQVMsRUFBRSxNQUFNLENBQUMsVUFBVSxFQUM1QixLQUFLLEVBQUUsR0FBRyxXQUFXLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsRUFDMUQsSUFBSSxFQUFDLFVBQVUsRUFDZixPQUFPLEVBQUUsR0FBRyxFQUFFO2dCQUNaLElBQUksV0FBVyxDQUFDLE9BQU8sRUFBRTtvQkFDdkIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUM3RDtZQUNILENBQUM7WUFDRixXQUFXLENBQUMsV0FBVzs7WUFBRyxXQUFXLENBQUMsT0FBTyxDQUN2QztRQUVULG9CQUFDLGdCQUFnQixJQUNmLE1BQU0sRUFBRSxNQUFNLEVBQ2Qsb0JBQW9CLEVBQUUsY0FBYyxFQUNwQyxpQkFBaUIsRUFBRSxxQkFBcUIsRUFDeEMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLHdCQUF3QixFQUFFLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDLEdBQ2pGLENBQ1UsQ0FDZixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsZUFBZSxjQUFjLENBQUM7QUFTOUIsTUFBTSxnQkFBZ0IsR0FBb0MsVUFBVSxFQUNoRSxNQUFNLEVBQUUsb0JBQW9CLEVBQzVCLGlCQUFpQixFQUNqQixvQkFBb0IsRUFBRTtJQUV4QixJQUFJLFVBQW9CLENBQUM7SUFDekIsSUFBSSxXQUErQixDQUFDO0lBQ3BDLElBQUksWUFBZ0MsQ0FBQztJQUNyQyxJQUFJLE1BQTJCLENBQUM7SUFFaEMsSUFBSSxNQUFNLENBQUMsZUFBZSxFQUFFO1FBQzFCLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFDckIsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMxQixZQUFZLEdBQUcsUUFBUSxDQUFDO1FBQ3hCLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQztLQUUvQjtTQUFNLElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSyxJQUFJLEVBQUU7UUFDbkMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUN2QixXQUFXLEdBQUcsVUFBVSxDQUFBO1FBQ3hCLFlBQVksR0FBRyxTQUFTLENBQUM7UUFDekIsTUFBTSxHQUFHLGlCQUFpQixDQUFDO0tBRTVCO1NBQU0sSUFBSSxNQUFNLENBQUMsZUFBZSxJQUFJLG9CQUFvQixHQUFHLENBQUMsRUFBRTtRQUM3RCxVQUFVLEdBQUcsWUFBWSxDQUFDO1FBQzFCLFdBQVcsR0FBRyxVQUFVLENBQUM7UUFDekIsWUFBWSxHQUFHLFNBQVMsQ0FBQztRQUN6QixNQUFNLEdBQUcsaUJBQWlCLENBQUM7S0FFNUI7U0FBTSxJQUFJLE1BQU0sQ0FBQyxxQkFBcUIsS0FBSyxVQUFVLEVBQUU7UUFDdEQsVUFBVSxHQUFHLFlBQVksQ0FBQTtRQUN6QixXQUFXLEdBQUcsMkJBQTJCLENBQUM7UUFDMUMsWUFBWSxHQUFHLFNBQVMsQ0FBQztRQUN6QixNQUFNLEdBQUcsaUJBQWlCLENBQUM7S0FFNUI7U0FBTSxJQUFJLE1BQU0sQ0FBQyxxQkFBcUIsS0FBSyxRQUFRLEVBQUU7UUFDcEQsVUFBVSxHQUFHLGNBQWMsQ0FBQTtRQUMzQixXQUFXLEdBQUcsVUFBVSxDQUFDO1FBQ3pCLFlBQVksR0FBRyxTQUFTLENBQUM7UUFDekIsTUFBTSxHQUFHLGlCQUFpQixDQUFDO0tBRTVCO1NBQU07UUFDTCxVQUFVLEdBQUcsU0FBUyxDQUFBO1FBQ3RCLFdBQVcsR0FBRyxVQUFVLENBQUM7UUFDekIsWUFBWSxHQUFHLFNBQVMsQ0FBQztRQUN6QixNQUFNLEdBQUcsaUJBQWlCLENBQUM7S0FDNUI7SUFFRCxPQUFPLENBQ0wsb0JBQUMsTUFBTSxJQUNILFNBQVMsRUFBRSxNQUFNLENBQUMsYUFBYSxFQUMvQixPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLEVBQzdCLElBQUksRUFBRSxVQUFVLEVBQ2hCLE1BQU0sRUFBRSxZQUFZLEVBQ3BCLFFBQVEsRUFBRSxNQUFNLEtBQUssSUFBSSxJQUMxQixXQUFXLENBQ0wsQ0FDVixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBR0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUMzQixVQUFVLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRTtJQUNsQyxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUV2QyxLQUFLLFVBQVUscUJBQXFCO1FBQ2xDLE1BQU0sT0FBTyxDQUEwQyxHQUFHLFdBQVcsbUJBQW1CLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUMvRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLFdBQVcsbUJBQW1CLENBQUMsQ0FBQztRQUNqRCxTQUFTLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFFRCxPQUFPLDZCQUFLLFNBQVMsRUFBRSxNQUFNLENBQUMsY0FBYztRQUMxQyxvQkFBQyxTQUFTLElBQ04sS0FBSyxFQUFDLG1DQUFtQyxFQUN6QyxVQUFVLEVBQUMsNkRBQTZEO1lBQzFFLG9CQUFDLFVBQVUsSUFDVCxJQUFJLEVBQUMsVUFBVSxFQUNmLEtBQUssRUFBRSxLQUFLLEVBQ1osUUFBUSxFQUFFLENBQUMsS0FBbUMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFFLEtBQUssQ0FBQyxNQUEyQixDQUFDLEtBQUssQ0FBQyxFQUNyRyxRQUFRLEVBQUMsS0FBSyxFQUNkLFlBQVksRUFDVixLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRTtvQkFDbkIsQ0FBQyxDQUFDLFNBQVM7b0JBQ1gsQ0FBQyxDQUFDLG9CQUFDLE1BQU0sSUFDSCxPQUFPLEVBQUUsSUFBSSxFQUNiLE9BQU8sRUFBRSxxQkFBcUIsRUFDOUIsSUFBSSxFQUFDLE1BQU0sRUFDWCxNQUFNLEVBQUMsU0FBUyxjQUVYLEdBQ2IsQ0FDUSxDQUNSLENBQUM7QUFDVCxDQUFDLENBQUM7QUFRRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQWdDLFVBQVUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRTs7SUFDMUYsSUFBSSxzQkFBMEMsQ0FBQztJQUUvQyxJQUFJLE9BQUEsRUFBRSwwQ0FBRSxNQUFNLE1BQUssU0FBUyxFQUFFO1FBQzVCLHNCQUFzQixHQUFHLG9CQUFDLGFBQWEsSUFDckMsSUFBSSxFQUFFLG9CQUFDLE9BQU8sT0FBRyxFQUNqQixLQUFLLEVBQUMsdUJBQXVCLEdBQzdCLENBQUE7S0FFSDtTQUFNLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUU7UUFDbEMsc0JBQXNCLEdBQUcsb0JBQUMsYUFBYSxJQUNyQyxJQUFJLEVBQUMsS0FBSyxFQUNWLEtBQUssRUFBQyxtQkFBbUIsRUFDekIsV0FBVyxFQUFFLG9CQUFDLGNBQWMsSUFBQyxXQUFXLEVBQUUsTUFBTSxNQUFNLEVBQUUsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUksR0FDckYsQ0FBQTtLQUVIO1NBQU0sSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUNyRCxzQkFBc0IsR0FBRyxvQkFBQyxhQUFhLElBQ3JDLElBQUksRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsRUFDN0QsS0FBSyxFQUFDLG9CQUFvQixFQUMxQixXQUFXLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxrQkFBa0IsR0FDekUsQ0FBQTtLQUVIO1NBQU0sSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLGdCQUFnQixLQUFLLElBQUksSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsS0FBSyxLQUFLLEVBQUU7UUFDckYsc0JBQXNCLEdBQUcsb0JBQUMsYUFBYSxJQUNyQyxJQUFJLEVBQUUsb0JBQUMsT0FBTyxPQUFHLEVBQ2pCLEtBQUssRUFBQyxZQUFZLEdBQ2xCLENBQUE7S0FFSDtTQUFNLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsS0FBSyxJQUFJLEVBQUU7UUFDOUMsc0JBQXNCLEdBQUcsb0JBQUMsYUFBYSxJQUNyQyxJQUFJLEVBQUMsTUFBTSxFQUNYLEtBQUssRUFBQyxPQUFPLEVBQ2IsV0FBVyxFQUFFLG9CQUFDLE1BQU0sSUFBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBQyxTQUFTLGNBQWlCLEdBQzFFLENBQUE7S0FDSDtTQUFNO1FBQ0wsc0JBQXNCLEdBQUcsb0JBQUMsYUFBYSxJQUNyQyxJQUFJLEVBQUMsTUFBTSxFQUNYLEtBQUssRUFBQyxPQUFPLEVBQ2IsV0FBVyxFQUFFLG9CQUFDLE1BQU0sSUFBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBQyxTQUFTLGNBQWlCLEdBQzFFLENBQUE7S0FDSDtJQUVELE9BQU8sc0JBQXNCLENBQUM7QUFDaEMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQge1xuICBCdXR0b24sIEljb25OYW1lLCBGb3JtR3JvdXAsIElucHV0R3JvdXAsIEludGVudCxcbiAgQnV0dG9uR3JvdXAsIE5vbklkZWFsU3RhdGUsIFNwaW5uZXIsXG59IGZyb20gJ0BibHVlcHJpbnRqcy9jb3JlJztcblxuaW1wb3J0IHsgY2FsbElQQywgdXNlSVBDVmFsdWUgfSBmcm9tICcuLi8uLi8uLi9pcGMvcmVuZGVyZXInO1xuXG5pbXBvcnQgeyBEYXRhYmFzZVN0YXR1c0NvbXBvbmVudFByb3BzIH0gZnJvbSAnLi4vLi4vLi4vY29uZmlnL3JlbmRlcmVyJztcbmltcG9ydCB7IEJhY2tlbmREZXNjcmlwdGlvbiwgQmFja2VuZFN0YXR1cyB9IGZyb20gJy4uL2Jhc2UnO1xuXG5pbXBvcnQgc3R5bGVzIGZyb20gJy4vc3RhdHVzLnNjc3MnO1xuXG5cbmNvbnN0IEJhY2tlbmREZXRhaWxzOiBSZWFjdC5GQzxEYXRhYmFzZVN0YXR1c0NvbXBvbmVudFByb3BzPEJhY2tlbmREZXNjcmlwdGlvbiwgQmFja2VuZFN0YXR1cz4+ID1cbmZ1bmN0aW9uICh7IGRiSVBDUHJlZml4LCBzdGF0dXMsIGRlc2NyaXB0aW9uIH0pIHtcbiAgY29uc3QgaXBjUHJlZml4ID0gZGJJUENQcmVmaXg7XG5cbiAgY29uc3QgbnVtVW5jb21taXR0ZWQgPSBcbiAgICB1c2VJUENWYWx1ZShgJHtpcGNQcmVmaXh9LWNvdW50LXVuY29tbWl0dGVkYCwgeyBudW1VbmNvbW1pdHRlZDogMCB9KS5cbiAgICB2YWx1ZS5udW1VbmNvbW1pdHRlZDtcblxuICAvLyBSZXF1ZXN0cyBzeW5jIHdpdGggcHVzaFxuICBhc3luYyBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0RnVsbFN5bmMoKSB7XG4gICAgYXdhaXQgY2FsbElQQyhgJHtpcGNQcmVmaXh9LWdpdC1yZXF1ZXN0LXB1c2hgKTtcbiAgICBhd2FpdCBjYWxsSVBDKGAke2lwY1ByZWZpeH0tZ2l0LXRyaWdnZXItc3luY2ApO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8QnV0dG9uR3JvdXAgZmlsbCB2ZXJ0aWNhbCBhbGlnblRleHQ9XCJsZWZ0XCI+XG4gICAgICA8QnV0dG9uXG4gICAgICAgICAgY2xhc3NOYW1lPXtzdHlsZXMuc291cmNlSW5mb31cbiAgICAgICAgICB0aXRsZT17YCR7ZGVzY3JpcHRpb24uZ2l0VXNlcm5hbWV9QCR7ZGVzY3JpcHRpb24uZ2l0UmVwb31gfVxuICAgICAgICAgIGljb249XCJnaXQtcmVwb1wiXG4gICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgaWYgKGRlc2NyaXB0aW9uLmdpdFJlcG8pIHtcbiAgICAgICAgICAgICAgcmVxdWlyZSgnZWxlY3Ryb24nKS5zaGVsbC5vcGVuRXh0ZXJuYWwoZGVzY3JpcHRpb24uZ2l0UmVwbyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfX0+XG4gICAgICAgIHtkZXNjcmlwdGlvbi5naXRVc2VybmFtZX1Ae2Rlc2NyaXB0aW9uLmdpdFJlcG99XG4gICAgICA8L0J1dHRvbj5cblxuICAgICAgPEFjdGlvbmFibGVTdGF0dXNcbiAgICAgICAgc3RhdHVzPXtzdGF0dXN9XG4gICAgICAgIHVuY29tbWl0dGVkRmlsZUNvdW50PXtudW1VbmNvbW1pdHRlZH1cbiAgICAgICAgb25SZXF1ZXN0RnVsbFN5bmM9e2hhbmRsZVJlcXVlc3RGdWxsU3luY31cbiAgICAgICAgb25TaG93U2V0dGluZ3NXaW5kb3c9eygpID0+IGNhbGxJUEMoJ29wZW4tcHJlZGVmaW5lZC13aW5kb3cnLCB7IGlkOiAnc2V0dGluZ3MnIH0pfVxuICAgICAgLz5cbiAgICA8L0J1dHRvbkdyb3VwPlxuICApO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgQmFja2VuZERldGFpbHM7XG5cblxuaW50ZXJmYWNlIEFjdGlvbmFibGVTdGF0dXNQcm9wcyB7XG4gIHN0YXR1czogQmFja2VuZFN0YXR1c1xuICB1bmNvbW1pdHRlZEZpbGVDb3VudDogbnVtYmVyXG4gIG9uUmVxdWVzdEZ1bGxTeW5jOiAoKSA9PiBQcm9taXNlPHZvaWQ+XG4gIG9uU2hvd1NldHRpbmdzV2luZG93OiAoKSA9PiB2b2lkXG59XG5jb25zdCBBY3Rpb25hYmxlU3RhdHVzOiBSZWFjdC5GQzxBY3Rpb25hYmxlU3RhdHVzUHJvcHM+ID0gZnVuY3Rpb24gKHtcbiAgICBzdGF0dXMsIHVuY29tbWl0dGVkRmlsZUNvdW50LFxuICAgIG9uUmVxdWVzdEZ1bGxTeW5jLFxuICAgIG9uU2hvd1NldHRpbmdzV2luZG93IH0pIHtcblxuICBsZXQgc3RhdHVzSWNvbjogSWNvbk5hbWU7XG4gIGxldCB0b29sdGlwVGV4dDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBsZXQgc3RhdHVzSW50ZW50OiBJbnRlbnQgfCB1bmRlZmluZWQ7XG4gIGxldCBhY3Rpb246IG51bGwgfCAoKCkgPT4gdm9pZCk7XG5cbiAgaWYgKHN0YXR1cy5pc01pc2NvbmZpZ3VyZWQpIHtcbiAgICBzdGF0dXNJY29uID0gXCJlcnJvclwiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJDb25maWd1cmVcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcImRhbmdlclwiO1xuICAgIGFjdGlvbiA9IG9uU2hvd1NldHRpbmdzV2luZG93O1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmlzT25saW5lICE9PSB0cnVlKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwib2ZmbGluZVwiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jIG5vd1wiXG4gICAgc3RhdHVzSW50ZW50ID0gXCJwcmltYXJ5XCI7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0RnVsbFN5bmM7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuaGFzTG9jYWxDaGFuZ2VzICYmIHVuY29tbWl0dGVkRmlsZUNvdW50ID4gMCkge1xuICAgIHN0YXR1c0ljb24gPSBcImdpdC1jb21taXRcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luYyBub3dcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0RnVsbFN5bmM7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuc3RhdHVzUmVsYXRpdmVUb0xvY2FsID09PSAnZGl2ZXJnZWQnKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiZ2l0LWJyYW5jaFwiXG4gICAgdG9vbHRpcFRleHQgPSBcIlJlc29sdmUgY29uZmxpY3QgYW5kIHN5bmNcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcIndhcm5pbmdcIjtcbiAgICBhY3Rpb24gPSBvblJlcXVlc3RGdWxsU3luYztcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5zdGF0dXNSZWxhdGl2ZVRvTG9jYWwgPT09ICdiZWhpbmQnKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiY2xvdWQtdXBsb2FkXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luYyBub3dcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInByaW1hcnlcIjtcbiAgICBhY3Rpb24gPSBvblJlcXVlc3RGdWxsU3luYztcblxuICB9IGVsc2Uge1xuICAgIHN0YXR1c0ljb24gPSBcInVwZGF0ZWRcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jIG5vd1wiO1xuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdEZ1bGxTeW5jO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8QnV0dG9uXG4gICAgICAgIGNsYXNzTmFtZT17c3R5bGVzLmJhY2tlbmRTdGF0dXN9XG4gICAgICAgIG9uQ2xpY2s9e2FjdGlvbiB8fCAoKCkgPT4ge30pfVxuICAgICAgICBpY29uPXtzdGF0dXNJY29ufVxuICAgICAgICBpbnRlbnQ9e3N0YXR1c0ludGVudH1cbiAgICAgICAgZGlzYWJsZWQ9e2FjdGlvbiA9PT0gbnVsbH0+XG4gICAgICB7dG9vbHRpcFRleHR9XG4gICAgPC9CdXR0b24+XG4gICk7XG59O1xuXG5cbmV4cG9ydCBjb25zdCBQYXNzd29yZFByb21wdDogUmVhY3QuRkM8eyBkYklQQ1ByZWZpeDogc3RyaW5nLCBvbkNvbmZpcm06ICgpID0+IHZvaWQgfT4gPVxuZnVuY3Rpb24gKHsgZGJJUENQcmVmaXgsIG9uQ29uZmlybSB9KSB7XG4gIGNvbnN0IFt2YWx1ZSwgc2V0VmFsdWVdID0gdXNlU3RhdGUoJycpO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVBhc3N3b3JkQ29uZmlybSgpIHtcbiAgICBhd2FpdCBjYWxsSVBDPHsgcGFzc3dvcmQ6IHN0cmluZyB9LCB7IHN1Y2Nlc3M6IHRydWUgfT4oYCR7ZGJJUENQcmVmaXh9LWdpdC1zZXQtcGFzc3dvcmRgLCB7IHBhc3N3b3JkOiB2YWx1ZSB9KTtcbiAgICBhd2FpdCBjYWxsSVBDKGAke2RiSVBDUHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCk7XG4gICAgb25Db25maXJtKCk7XG4gIH1cblxuICByZXR1cm4gPGRpdiBjbGFzc05hbWU9e3N0eWxlcy5wYXNzd29yZFByb21wdH0+XG4gICAgPEZvcm1Hcm91cFxuICAgICAgICBsYWJlbD1cIlBsZWFzZSBlbnRlciByZXBvc2l0b3J5IHBhc3N3b3JkOlwiXG4gICAgICAgIGhlbHBlclRleHQ9XCJUaGUgcGFzc3dvcmQgd2lsbCBiZSBrZXB0IGluIG1lbW9yeSBhbmQgbm90IHN0b3JlZCB0byBkaXNrLlwiPlxuICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgdHlwZT1cInBhc3N3b3JkXCJcbiAgICAgICAgdmFsdWU9e3ZhbHVlfVxuICAgICAgICBvbkNoYW5nZT17KGV2ZW50OiBSZWFjdC5Gb3JtRXZlbnQ8SFRNTEVsZW1lbnQ+KSA9PiBzZXRWYWx1ZSgoZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlKX1cbiAgICAgICAgbGVmdEljb249XCJrZXlcIlxuICAgICAgICByaWdodEVsZW1lbnQ9e1xuICAgICAgICAgIHZhbHVlLnRyaW0oKSA9PT0gJydcbiAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgIDogPEJ1dHRvblxuICAgICAgICAgICAgICAgIG1pbmltYWw9e3RydWV9XG4gICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlUGFzc3dvcmRDb25maXJtfVxuICAgICAgICAgICAgICAgIGljb249XCJ0aWNrXCJcbiAgICAgICAgICAgICAgICBpbnRlbnQ9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICAgIENvbmZpcm1cbiAgICAgICAgICAgIDwvQnV0dG9uPn1cbiAgICAgIC8+XG4gICAgPC9Gb3JtR3JvdXA+XG4gIDwvZGl2Pjtcbn07XG5cblxuaW50ZXJmYWNlIERCU3luY1NjcmVlblByb3BzIHtcbiAgZGJOYW1lOiBzdHJpbmdcbiAgZGI6IEJhY2tlbmREZXNjcmlwdGlvblxuICBvbkRpc21pc3M6ICgpID0+IHZvaWRcbn1cbmV4cG9ydCBjb25zdCBEQlN5bmNTY3JlZW46IFJlYWN0LkZDPERCU3luY1NjcmVlblByb3BzPiA9IGZ1bmN0aW9uICh7IGRiTmFtZSwgZGIsIG9uRGlzbWlzcyB9KSB7XG4gIGxldCBkYkluaXRpYWxpemF0aW9uU2NyZWVuOiBKU1guRWxlbWVudCB8IG51bGw7XG5cbiAgaWYgKGRiPy5zdGF0dXMgPT09IHVuZGVmaW5lZCkge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj17PFNwaW5uZXIgLz59XG4gICAgICB0aXRsZT1cIkluaXRpYWxpemluZyBkYXRhYmFzZVwiXG4gICAgLz5cblxuICB9IGVsc2UgaWYgKGRiLnN0YXR1cy5uZWVkc1Bhc3N3b3JkKSB7XG4gICAgZGJJbml0aWFsaXphdGlvblNjcmVlbiA9IDxOb25JZGVhbFN0YXRlXG4gICAgICBpY29uPVwia2V5XCJcbiAgICAgIHRpdGxlPVwiUGFzc3dvcmQgcmVxdWlyZWRcIlxuICAgICAgZGVzY3JpcHRpb249ezxQYXNzd29yZFByb21wdCBkYklQQ1ByZWZpeD17YGRiLSR7ZGJOYW1lfWB9IG9uQ29uZmlybT17KCkgPT4gdm9pZCAwfSAvPn1cbiAgICAvPlxuXG4gIH0gZWxzZSBpZiAoZGIuc3RhdHVzLmlzUHVzaGluZyB8fCBkYi5zdGF0dXMuaXNQdWxsaW5nKSB7XG4gICAgZGJJbml0aWFsaXphdGlvblNjcmVlbiA9IDxOb25JZGVhbFN0YXRlXG4gICAgICBpY29uPXtkYi5zdGF0dXMuaXNQdXNoaW5nID8gXCJjbG91ZC11cGxvYWRcIiA6IFwiY2xvdWQtZG93bmxvYWRcIn1cbiAgICAgIHRpdGxlPVwiU3luY2hyb25pemluZyBkYXRhXCJcbiAgICAgIGRlc2NyaXB0aW9uPXtkYi5zdGF0dXMuaXNQdXNoaW5nID8gXCJTZW5kaW5nIGNoYW5nZXNcIiA6IFwiRmV0Y2hpbmcgY2hhbmdlc1wifVxuICAgIC8+XG5cbiAgfSBlbHNlIGlmIChkYi5zdGF0dXMubGFzdFN5bmNocm9uaXplZCA9PT0gbnVsbCAmJiBkYi5zdGF0dXMuaGFzTG9jYWxDaGFuZ2VzID09PSBmYWxzZSkge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj17PFNwaW5uZXIgLz59XG4gICAgICB0aXRsZT1cIkNvbm5lY3RpbmdcIlxuICAgIC8+XG5cbiAgfSBlbHNlIGlmIChkYi5zdGF0dXMubGFzdFN5bmNocm9uaXplZCAhPT0gbnVsbCkge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj1cInRpY2tcIlxuICAgICAgdGl0bGU9XCJSZWFkeVwiXG4gICAgICBkZXNjcmlwdGlvbj17PEJ1dHRvbiBvbkNsaWNrPXtvbkRpc21pc3N9IGludGVudD1cInByaW1hcnlcIj5EaXNtaXNzPC9CdXR0b24+fVxuICAgIC8+XG4gIH0gZWxzZSB7XG4gICAgZGJJbml0aWFsaXphdGlvblNjcmVlbiA9IDxOb25JZGVhbFN0YXRlXG4gICAgICBpY29uPVwidGlja1wiXG4gICAgICB0aXRsZT1cIlJlYWR5XCJcbiAgICAgIGRlc2NyaXB0aW9uPXs8QnV0dG9uIG9uQ2xpY2s9e29uRGlzbWlzc30gaW50ZW50PVwicHJpbWFyeVwiPkRpc21pc3M8L0J1dHRvbj59XG4gICAgLz5cbiAgfVxuXG4gIHJldHVybiBkYkluaXRpYWxpemF0aW9uU2NyZWVuO1xufSJdfQ==