import React, { useEffect, useState } from 'react';
import { Button, FormGroup, InputGroup, Popover, Position, ButtonGroup } from '@blueprintjs/core';
import { openWindow } from '../../../api_legacy/renderer';
import { callIPC, useIPCValue } from '../../../ipc/renderer';
import styles from './status.scss';
const BackendDetails = function ({ dbIPCPrefix, status, description }) {
    const ipcPrefix = dbIPCPrefix;
    const numUncommitted = useIPCValue(`${ipcPrefix}-count-uncommitted`, { numUncommitted: 0 }).
        value.numUncommitted;
    useEffect(() => {
        openPasswordPrompt(status.needsPassword);
    }, [status.needsPassword]);
    const [passwordPromptIsOpen, openPasswordPrompt] = useState(false);
    async function setPassword(password) {
        await callIPC(`${ipcPrefix}-git-set-password`, { password });
    }
    return (React.createElement(Popover, { boundary: "viewport", isOpen: passwordPromptIsOpen, position: Position.BOTTOM, targetTagName: "div", targetClassName: styles.base, content: React.createElement(PasswordPrompt, { onConfirm: async (password) => {
                setPassword(password);
                openPasswordPrompt(false);
            } }) },
        React.createElement(ButtonGroup, { fill: true, vertical: true, alignText: "left" },
            React.createElement(Button, { className: styles.sourceInfo, title: `${description.gitUsername}@${description.gitRepo}`, icon: "git-repo", onClick: () => {
                    if (description.gitRepo) {
                        require('electron').shell.openExternal(description.gitRepo);
                    }
                } },
                description.gitUsername,
                "@",
                description.gitRepo),
            React.createElement(ActionableStatus, { status: status, uncommittedFileCount: numUncommitted, onRequestSync: async () => await callIPC(`${ipcPrefix}-git-trigger-sync`), onDiscardUnstaged: async () => await callIPC(`${ipcPrefix}-git-discard-unstaged`), onPromptPassword: () => openPasswordPrompt(true), onShowCommitWindow: () => openWindow('batch-commit'), onShowSettingsWindow: () => openWindow('settings') }))));
};
export default BackendDetails;
const ActionableStatus = function ({ status, uncommittedFileCount, onRequestSync, onDiscardUnstaged, onPromptPassword, onShowCommitWindow, onShowSettingsWindow }) {
    let statusIcon;
    let tooltipText;
    let statusIntent;
    let action;
    if (status.isMisconfigured) {
        statusIcon = "error";
        tooltipText = "Configure…";
        statusIntent = "danger";
        action = onShowSettingsWindow;
    }
    else if (status.isOnline !== true) {
        statusIcon = "offline";
        tooltipText = "Offline (click to retry)";
        statusIntent = "danger";
        action = onRequestSync;
    }
    else if (status.needsPassword) {
        statusIcon = "lock";
        tooltipText = "Provide password…";
        statusIntent = "primary";
        action = onPromptPassword;
    }
    else if (status.hasLocalChanges) {
        statusIcon = "git-commit";
        tooltipText = "Commit outstanding changes…";
        statusIntent = "warning";
        action = async () => {
            if (status.hasLocalChanges && uncommittedFileCount < 1) {
                // NOTE: If hasLocalChanges says yes, but uncommitted file count says no, try to fix it.
                await onDiscardUnstaged();
                await onRequestSync();
            }
            else {
                onShowCommitWindow();
            }
        };
    }
    else if (status.isPulling) {
        statusIcon = "cloud-download";
        tooltipText = "Synchronizing";
        statusIntent = "primary";
        action = null;
    }
    else if (status.isPushing) {
        statusIcon = "cloud-upload";
        tooltipText = "Synchronizing";
        statusIntent = "primary";
        action = null;
    }
    else if (status.statusRelativeToLocal === 'diverged') {
        statusIcon = "git-branch";
        tooltipText = "Diverging changes";
        statusIntent = "danger";
        action = onRequestSync;
    }
    else if (status.statusRelativeToLocal === 'behind') {
        statusIcon = "cloud-upload";
        tooltipText = "Online";
        statusIntent = "warning";
        action = onRequestSync;
    }
    else {
        statusIcon = "updated";
        tooltipText = "Online";
        statusIntent = "success";
        action = onRequestSync;
    }
    return (React.createElement(Button, { className: styles.backendStatus, onClick: action || (() => { }), icon: statusIcon, intent: statusIntent, disabled: action === null, loading: action === null }, tooltipText));
};
const PasswordPrompt = function ({ onConfirm }) {
    const [value, setValue] = useState('');
    return React.createElement("div", { className: styles.passwordPrompt },
        React.createElement(FormGroup, { label: "Please enter repository password:", helperText: "The password will be kept in memory and not stored to disk." },
            React.createElement(InputGroup, { type: "password", value: value, onChange: (event) => setValue(event.target.value), leftIcon: "key", rightElement: value.trim() === ''
                    ? undefined
                    : React.createElement(Button, { minimal: true, onClick: async () => await onConfirm(value), icon: "tick", intent: "primary" }, "Confirm") })));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdHVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2RiL2lzb2dpdC15YW1sL3JlbmRlcmVyL3N0YXR1cy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBRW5ELE9BQU8sRUFBRSxNQUFNLEVBQVksU0FBUyxFQUFFLFVBQVUsRUFBVSxPQUFPLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBSzdELE9BQU8sTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUduQyxNQUFNLGNBQWMsR0FDcEIsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFO0lBQzVDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztJQUU5QixNQUFNLGNBQWMsR0FDbEIsV0FBVyxDQUFDLEdBQUcsU0FBUyxvQkFBb0IsRUFBRSxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNwRSxLQUFLLENBQUMsY0FBYyxDQUFDO0lBRXZCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixrQkFBa0IsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0MsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFFM0IsTUFBTSxDQUFDLG9CQUFvQixFQUFFLGtCQUFrQixDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRW5FLEtBQUssVUFBVSxXQUFXLENBQUMsUUFBZ0I7UUFDekMsTUFBTSxPQUFPLENBQTBDLEdBQUcsU0FBUyxtQkFBbUIsRUFBRSxFQUFFLFFBQVEsRUFBRSxD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QzNDLElBQUksRUFBQyxNQUFNLEVBQ1gsTUFBTSxFQUFDLFNBQVMsY0FFWCxHQUNiLENBQ1EsQ0FDUixDQUFDO0FBQ1QsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZUVmZmVjdCwgdXNlU3RhdGUgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IEJ1dHRvbiwgSWNvbk5hbWUsIEZvcm1Hcm91cCwgSW5wdXRHcm91cCwgSW50ZW50LCBQb3BvdmVyLCBQb3NpdGlvbiwgQnV0dG9uR3JvdXAgfSBmcm9tICdAYmx1ZXByaW50anMvY29yZSc7XG5cbmltcG9ydCB7IG9wZW5XaW5kb3cgfSBmcm9tICcuLi8uLi8uLi9hcGlfbGVnYWN5L3JlbmRlcmVyJztcbmltcG9ydCB7IGNhbGxJUEMsIHVzZUlQQ1ZhbHVlIH0gZnJvbSAnLi4vLi4vLi4vaXBjL3JlbmRlcmVyJztcblxuaW1wb3J0IHsgRGF0YWJhc2VTdGF0dXNDb21wb25lbnRQcm9wcyB9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9yZW5kZXJlcic7XG5pbXBvcnQgeyBCYWNrZW5kRGVzY3JpcHRpb24sIEJhY2tlbmRTdGF0dXMgfSBmcm9tICcuLi9iYXNlJztcblxuaW1wb3J0IHN0eWxlcyBmcm9tICcuL3N0YXR1cy5zY3NzJztcblxuXG5jb25zdCBCYWNrZW5kRGV0YWlsczogUmVhY3QuRkM8RGF0YWJhc2VTdGF0dXNDb21wb25lbnRQcm9wczxCYWNrZW5kRGVzY3JpcHRpb24sIEJhY2tlbmRTdGF0dXM+PiA9XG5mdW5jdGlvbiAoeyBkYklQQ1ByZWZpeCwgc3RhdHVzLCBkZXNjcmlwdGlvbiB9KSB7XG4gIGNvbnN0IGlwY1ByZWZpeCA9IGRiSVBDUHJlZml4O1xuXG4gIGNvbnN0IG51bVVuY29tbWl0dGVkID0gXG4gICAgdXNlSVBDVmFsdWUoYCR7aXBjUHJlZml4fS1jb3VudC11bmNvbW1pdHRlZGAsIHsgbnVtVW5jb21taXR0ZWQ6IDAgfSkuXG4gICAgdmFsdWUubnVtVW5jb21taXR0ZWQ7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBvcGVuUGFzc3dvcmRQcm9tcHQoc3RhdHVzLm5lZWRzUGFzc3dvcmQpO1xuICB9LCBbc3RhdHVzLm5lZWRzUGFzc3dvcmRdKTtcblxuICBjb25zdCBbcGFzc3dvcmRQcm9tcHRJc09wZW4sIG9wZW5QYXNzd29yZFByb21wdF0gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gc2V0UGFzc3dvcmQocGFzc3dvcmQ6IHN0cmluZykge1xuICAgIGF3YWl0IGNhbGxJUEM8eyBwYXNzd29yZDogc3RyaW5nIH0sIHsgc3VjY2VzczogdHJ1ZSB9PihgJHtpcGNQcmVmaXh9LWdpdC1zZXQtcGFzc3dvcmRgLCB7IHBhc3N3b3JkIH0pO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8UG9wb3ZlclxuICAgICAgICBib3VuZGFyeT1cInZpZXdwb3J0XCJcbiAgICAgICAgaXNPcGVuPXtwYXNzd29yZFByb21wdElzT3Blbn1cbiAgICAgICAgcG9zaXRpb249e1Bvc2l0aW9uLkJPVFRPTX1cbiAgICAgICAgdGFyZ2V0VGFnTmFtZT1cImRpdlwiXG4gICAgICAgIHRhcmdldENsYXNzTmFtZT17c3R5bGVzLmJhc2V9XG4gICAgICAgIGNvbnRlbnQ9e1xuICAgICAgICAgIDxQYXNzd29yZFByb21wdCBvbkNvbmZpcm09e2FzeW5jIChwYXNzd29yZCkgPT4ge1xuICAgICAgICAgICAgc2V0UGFzc3dvcmQocGFzc3dvcmQpO1xuICAgICAgICAgICAgb3BlblBhc3N3b3JkUHJvbXB0KGZhbHNlKTtcbiAgICAgICAgICB9fSAvPlxuICAgICAgICB9PlxuICAgICAgPEJ1dHRvbkdyb3VwIGZpbGwgdmVydGljYWwgYWxpZ25UZXh0PVwibGVmdFwiPlxuICAgICAgICA8QnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9e3N0eWxlcy5zb3VyY2VJbmZvfVxuICAgICAgICAgICAgdGl0bGU9e2Ake2Rlc2NyaXB0aW9uLmdpdFVzZXJuYW1lfUAke2Rlc2NyaXB0aW9uLmdpdFJlcG99YH1cbiAgICAgICAgICAgIGljb249XCJnaXQtcmVwb1wiXG4gICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChkZXNjcmlwdGlvbi5naXRSZXBvKSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZSgnZWxlY3Ryb24nKS5zaGVsbC5vcGVuRXh0ZXJuYWwoZGVzY3JpcHRpb24uZ2l0UmVwbyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH19PlxuICAgICAgICAgIHtkZXNjcmlwdGlvbi5naXRVc2VybmFtZX1Ae2Rlc2NyaXB0aW9uLmdpdFJlcG99XG4gICAgICAgIDwvQnV0dG9uPlxuXG4gICAgICAgIDxBY3Rpb25hYmxlU3RhdHVzXG4gICAgICAgICAgc3RhdHVzPXtzdGF0dXN9XG4gICAgICAgICAgdW5jb21taXR0ZWRGaWxlQ291bnQ9e251bVVuY29tbWl0dGVkfVxuICAgICAgICAgIG9uUmVxdWVzdFN5bmM9e2FzeW5jICgpID0+IGF3YWl0IGNhbGxJUEMoYCR7aXBjUHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCl9XG4gICAgICAgICAgb25EaXNjYXJkVW5zdGFnZWQ9e2FzeW5jICgpID0+IGF3YWl0IGNhbGxJUEMoYCR7aXBjUHJlZml4fS1naXQtZGlzY2FyZC11bnN0YWdlZGApfVxuICAgICAgICAgIG9uUHJvbXB0UGFzc3dvcmQ9eygpID0+IG9wZW5QYXNzd29yZFByb21wdCh0cnVlKX1cbiAgICAgICAgICBvblNob3dDb21taXRXaW5kb3c9eygpID0+IG9wZW5XaW5kb3coJ2JhdGNoLWNvbW1pdCcpfVxuICAgICAgICAgIG9uU2hvd1NldHRpbmdzV2luZG93PXsoKSA9PiBvcGVuV2luZG93KCdzZXR0aW5ncycpfVxuICAgICAgICAvPlxuICAgICAgPC9CdXR0b25Hcm91cD5cbiAgICA8L1BvcG92ZXI+XG4gICk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBCYWNrZW5kRGV0YWlscztcblxuXG5pbnRlcmZhY2UgQWN0aW9uYWJsZVN0YXR1c1Byb3BzIHtcbiAgc3RhdHVzOiBCYWNrZW5kU3RhdHVzXG4gIHVuY29tbWl0dGVkRmlsZUNvdW50OiBudW1iZXJcbiAgb25SZXF1ZXN0U3luYzogKCkgPT4gUHJvbWlzZTx2b2lkPlxuICBvbkRpc2NhcmRVbnN0YWdlZDogKCkgPT4gUHJvbWlzZTx2b2lkPlxuICBvblByb21wdFBhc3N3b3JkOiAoKSA9PiB2b2lkXG4gIG9uU2hvd0NvbW1pdFdpbmRvdzogKCkgPT4gdm9pZFxuICBvblNob3dTZXR0aW5nc1dpbmRvdzogKCkgPT4gdm9pZFxufVxuY29uc3QgQWN0aW9uYWJsZVN0YXR1czogUmVhY3QuRkM8QWN0aW9uYWJsZVN0YXR1c1Byb3BzPiA9IGZ1bmN0aW9uICh7XG4gICAgc3RhdHVzLCB1bmNvbW1pdHRlZEZpbGVDb3VudCxcbiAgICBvblJlcXVlc3RTeW5jLCBvbkRpc2NhcmRVbnN0YWdlZCxcbiAgICBvblByb21wdFBhc3N3b3JkLFxuICAgIG9uU2hvd0NvbW1pdFdpbmRvdywgb25TaG93U2V0dGluZ3NXaW5kb3cgfSkge1xuXG4gIGxldCBzdGF0dXNJY29uOiBJY29uTmFtZTtcbiAgbGV0IHRvb2x0aXBUZXh0OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGxldCBzdGF0dXNJbnRlbnQ6IEludGVudDtcbiAgbGV0IGFjdGlvbjogbnVsbCB8ICgoKSA9PiB2b2lkKTtcblxuICBpZiAoc3RhdHVzLmlzTWlzY29uZmlndXJlZCkge1xuICAgIHN0YXR1c0ljb24gPSBcImVycm9yXCI7XG4gICAgdG9vbHRpcFRleHQgPSBcIkNvbmZpZ3VyZeKAplwiO1xuICAgIHN0YXR1c0ludGVudCA9IFwiZGFuZ2VyXCI7XG4gICAgYWN0aW9uID0gb25TaG93U2V0dGluZ3NXaW5kb3c7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuaXNPbmxpbmUgIT09IHRydWUpIHtcbiAgICBzdGF0dXNJY29uID0gXCJvZmZsaW5lXCI7XG4gICAgdG9vbHRpcFRleHQgPSBcIk9mZmxpbmUgKGNsaWNrIHRvIHJldHJ5KVwiXG4gICAgc3RhdHVzSW50ZW50ID0gXCJkYW5nZXJcIjtcbiAgICBhY3Rpb24gPSBvblJlcXVlc3RTeW5jO1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLm5lZWRzUGFzc3dvcmQpIHtcbiAgICBzdGF0dXNJY29uID0gXCJsb2NrXCI7XG4gICAgdG9vbHRpcFRleHQgPSBcIlByb3ZpZGUgcGFzc3dvcmTigKZcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInByaW1hcnlcIjtcbiAgICBhY3Rpb24gPSBvblByb21wdFBhc3N3b3JkO1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmhhc0xvY2FsQ2hhbmdlcykge1xuICAgIHN0YXR1c0ljb24gPSBcImdpdC1jb21taXRcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiQ29tbWl0IG91dHN0YW5kaW5nIGNoYW5nZXPigKZcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcIndhcm5pbmdcIjtcbiAgICBhY3Rpb24gPSBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoc3RhdHVzLmhhc0xvY2FsQ2hhbmdlcyAmJiB1bmNvbW1pdHRlZEZpbGVDb3VudCA8IDEpIHtcbiAgICAgICAgLy8gTk9URTogSWYgaGFzTG9jYWxDaGFuZ2VzIHNheXMgeWVzLCBidXQgdW5jb21taXR0ZWQgZmlsZSBjb3VudCBzYXlzIG5vLCB0cnkgdG8gZml4IGl0LlxuICAgICAgICBhd2FpdCBvbkRpc2NhcmRVbnN0YWdlZCgpO1xuICAgICAgICBhd2FpdCBvblJlcXVlc3RTeW5jKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvblNob3dDb21taXRXaW5kb3coKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuaXNQdWxsaW5nKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiY2xvdWQtZG93bmxvYWRcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jaHJvbml6aW5nXCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJwcmltYXJ5XCI7XG4gICAgYWN0aW9uID0gbnVsbDtcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5pc1B1c2hpbmcpIHtcbiAgICBzdGF0dXNJY29uID0gXCJjbG91ZC11cGxvYWRcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jaHJvbml6aW5nXCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJwcmltYXJ5XCI7XG4gICAgYWN0aW9uID0gbnVsbDtcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5zdGF0dXNSZWxhdGl2ZVRvTG9jYWwgPT09ICdkaXZlcmdlZCcpIHtcbiAgICBzdGF0dXNJY29uID0gXCJnaXQtYnJhbmNoXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiRGl2ZXJnaW5nIGNoYW5nZXNcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcImRhbmdlclwiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuc3RhdHVzUmVsYXRpdmVUb0xvY2FsID09PSAnYmVoaW5kJykge1xuICAgIHN0YXR1c0ljb24gPSBcImNsb3VkLXVwbG9hZFwiXG4gICAgdG9vbHRpcFRleHQgPSBcIk9ubGluZVwiO1xuICAgIHN0YXR1c0ludGVudCA9IFwid2FybmluZ1wiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG5cbiAgfSBlbHNlIHtcbiAgICBzdGF0dXNJY29uID0gXCJ1cGRhdGVkXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiT25saW5lXCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJzdWNjZXNzXCI7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0U3luYztcbiAgfVxuXG4gIHJldHVybiAoXG4gICAgPEJ1dHRvblxuICAgICAgICBjbGFzc05hbWU9e3N0eWxlcy5iYWNrZW5kU3RhdHVzfVxuICAgICAgICBvbkNsaWNrPXthY3Rpb24gfHwgKCgpID0+IHt9KX1cbiAgICAgICAgaWNvbj17c3RhdHVzSWNvbn1cbiAgICAgICAgaW50ZW50PXtzdGF0dXNJbnRlbnR9XG4gICAgICAgIGRpc2FibGVkPXthY3Rpb24gPT09IG51bGx9XG4gICAgICAgIGxvYWRpbmc9e2FjdGlvbiA9PT0gbnVsbH0+XG4gICAgICB7dG9vbHRpcFRleHR9XG4gICAgPC9CdXR0b24+XG4gICk7XG59O1xuXG5cbmNvbnN0IFBhc3N3b3JkUHJvbXB0OiBSZWFjdC5GQzx7IG9uQ29uZmlybTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4gfT4gPSBmdW5jdGlvbiAoeyBvbkNvbmZpcm0gfSkge1xuICBjb25zdCBbdmFsdWUsIHNldFZhbHVlXSA9IHVzZVN0YXRlKCcnKTtcblxuICByZXR1cm4gPGRpdiBjbGFzc05hbWU9e3N0eWxlcy5wYXNzd29yZFByb21wdH0+XG4gICAgPEZvcm1Hcm91cFxuICAgICAgICBsYWJlbD1cIlBsZWFzZSBlbnRlciByZXBvc2l0b3J5IHBhc3N3b3JkOlwiXG4gICAgICAgIGhlbHBlclRleHQ9XCJUaGUgcGFzc3dvcmQgd2lsbCBiZSBrZXB0IGluIG1lbW9yeSBhbmQgbm90IHN0b3JlZCB0byBkaXNrLlwiPlxuICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgdHlwZT1cInBhc3N3b3JkXCJcbiAgICAgICAgdmFsdWU9e3ZhbHVlfVxuICAgICAgICBvbkNoYW5nZT17KGV2ZW50OiBSZWFjdC5Gb3JtRXZlbnQ8SFRNTEVsZW1lbnQ+KSA9PiBzZXRWYWx1ZSgoZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlKX1cbiAgICAgICAgbGVmdEljb249XCJrZXlcIlxuICAgICAgICByaWdodEVsZW1lbnQ9e1xuICAgICAgICAgIHZhbHVlLnRyaW0oKSA9PT0gJydcbiAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgIDogPEJ1dHRvblxuICAgICAgICAgICAgICAgIG1pbmltYWxcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXthc3luYyAoKSA9PiBhd2FpdCBvbkNvbmZpcm0odmFsdWUpfVxuICAgICAgICAgICAgICAgIGljb249XCJ0aWNrXCJcbiAgICAgICAgICAgICAgICBpbnRlbnQ9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICAgIENvbmZpcm1cbiAgICAgICAgICAgIDwvQnV0dG9uPn1cbiAgICAgIC8+XG4gICAgPC9Gb3JtR3JvdXA+XG4gIDwvZGl2Pjtcbn07XG4iXX0=