import React, { useEffect, useState } from 'react';
import { Button, FormGroup, InputGroup, Popover, Position, ButtonGroup } from '@blueprintjs/core';
import { callIPC, useIPCValue } from '../../../ipc/renderer';
import styles from './status.scss';
const BackendDetails = function ({ dbIPCPrefix, status, description }) {
    const ipcPrefix = dbIPCPrefix;
    const numUncommitted = useIPCValue(`${ipcPrefix}-count-uncommitted`, { numUncommitted: 0 }).
        value.numUncommitted;
    useEffect(() => {
        openPasswordPrompt(status.needsPassword);
    }, [status.needsPassword]);
    const [passwordPromptIsOpen, openPasswordPrompt] = useState(false);
    async function setPassword(password) {
        await callIPC(`${ipcPrefix}-git-set-password`, { password });
    }
    return (React.createElement(Popover, { boundary: "viewport", isOpen: passwordPromptIsOpen, position: Position.BOTTOM, targetTagName: "div", targetClassName: styles.base, content: React.createElement(PasswordPrompt, { onConfirm: async (password) => {
                setPassword(password);
                openPasswordPrompt(false);
            } }) },
        React.createElement(ButtonGroup, { fill: true, vertical: true, alignText: "left" },
            React.createElement(Button, { className: styles.sourceInfo, title: `${description.gitUsername}@${description.gitRepo}`, icon: "git-repo", onClick: () => {
                    if (description.gitRepo) {
                        require('electron').shell.openExternal(description.gitRepo);
                    }
                } },
                description.gitUsername,
                "@",
                description.gitRepo),
            React.createElement(ActionableStatus, { status: status, uncommittedFileCount: numUncommitted, onRequestSync: async () => await callIPC(`${ipcPrefix}-git-trigger-sync`), onDiscardUnstaged: async () => await callIPC(`${ipcPrefix}-git-discard-unstaged`), onPromptPassword: () => openPasswordPrompt(true), onShowCommitWindow: () => callIPC('open-predefined-window', { id: 'batchCommit' }), onShowSettingsWindow: () => callIPC('open-predefined-window', { id: 'settings' }) }))));
};
export default BackendDetails;
const ActionableStatus = function ({ status, uncommittedFileCount, onRequestSync, onDiscardUnstaged, onPromptPassword, onShowCommitWindow, onShowSettingsWindow }) {
    let statusIcon;
    let tooltipText;
    let statusIntent;
    let action;
    if (status.isMisconfigured) {
        statusIcon = "error";
        tooltipText = "Configure";
        statusIntent = "danger";
        action = onShowSettingsWindow;
    }
    else if (status.isOnline !== true) {
        statusIcon = "offline";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = status.needsPassword ? onPromptPassword : onRequestSync;
    }
    else if (status.needsPassword) {
        statusIcon = "lock";
        tooltipText = "Provide password & sync";
        statusIntent = "primary";
        action = onPromptPassword;
    }
    else if (status.hasLocalChanges) {
        statusIcon = "git-commit";
        tooltipText = "Commit & sync";
        statusIntent = "primary";
        action = async () => {
            if (status.hasLocalChanges && uncommittedFileCount < 1) {
                // NOTE: If hasLocalChanges says yes, but uncommitted file count says no, try to fix it.
                await onDiscardUnstaged();
                await onRequestSync();
            }
            else {
                onShowCommitWindow();
            }
        };
    }
    else if (status.isPulling) {
        statusIcon = "cloud-download";
        tooltipText = "Syncing…";
        statusIntent = "primary";
        action = null;
    }
    else if (status.isPushing) {
        statusIcon = "cloud-upload";
        tooltipText = "Syncing…";
        statusIntent = "primary";
        action = null;
    }
    else if (status.statusRelativeToLocal === 'diverged') {
        statusIcon = "git-branch";
        tooltipText = "Resolve conflict and sync";
        statusIntent = "warning";
        action = onRequestSync;
    }
    else if (status.statusRelativeToLocal === 'behind') {
        statusIcon = "cloud-upload";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestSync;
    }
    else {
        statusIcon = "updated";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestSync;
    }
    return (React.createElement(Button, { className: styles.backendStatus, onClick: action || (() => { }), icon: statusIcon, intent: statusIntent, disabled: action === null, loading: action === null }, tooltipText));
};
const PasswordPrompt = function ({ onConfirm }) {
    const [value, setValue] = useState('');
    return React.createElement("div", { className: styles.passwordPrompt },
        React.createElement(FormGroup, { label: "Please enter repository password:", helperText: "The password will be kept in memory and not stored to disk." },
            React.createElement(InputGroup, { type: "password", value: value, onChange: (event) => setValue(event.target.value), leftIcon: "key", rightElement: value.trim() === ''
                    ? undefined
                    : React.createElement(Button, { minimal: true, onClick: async () => await onConfirm(value), icon: "tick", intent: "primary" }, "Confirm") })));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdHVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2RiL2lzb2dpdC15YW1sL3JlbmRlcmVyL3N0YXR1cy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBRW5ELE9BQU8sRUFBRSxNQUFNLEVBQVksU0FBUyxFQUFFLFVBQVUsRUFBVSxPQUFPLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBILE9BQU8sRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFLN0QsT0FBTyxNQUFNLE1BQU0sZUFBZSxDQUFDO0FBR25DLE1BQU0sY0FBYyxHQUNwQixVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUU7SUFDNUMsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDO0lBRTlCLE1BQU0sY0FBYyxHQUNsQixXQUFXLENBQUMsR0FBRyxTQUFTLG9CQUFvQixFQUFFLEVBQUUsY0FBYyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3BFLEtBQUssQ0FBQyxjQUFjLENBQUM7SUFFdkIsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMzQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUUzQixNQUFNLENBQUMsb0JBQW9CLEVBQUUsa0JBQWtCLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFbkUsS0FBSyxVQUFVLFdBQVcsQ0FBQyxRQUFnQjtRQUN6QyxNQUFNLE9BQU8sQ0FBMEMsR0FBRyxTQUFTLG1CQUFtQixFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUN4RyxDQUFDO0lBRUQsT0FBTyxDQUNMLG9CQUFDLE9B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SCxPQUFPLFFBQ1AsT0FBTyxFQUFFLEtBQUssSUFBSSxFQUFFLENBQUMsTUFBTSxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQzNDLElBQUksRUFBQyxNQUFNLEVBQ1gsTUFBTSxFQUFDLFNBQVMsY0FFWCxHQUNiLENBQ1EsQ0FDUixDQUFDO0FBQ1QsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZUVmZmVjdCwgdXNlU3RhdGUgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IEJ1dHRvbiwgSWNvbk5hbWUsIEZvcm1Hcm91cCwgSW5wdXRHcm91cCwgSW50ZW50LCBQb3BvdmVyLCBQb3NpdGlvbiwgQnV0dG9uR3JvdXAgfSBmcm9tICdAYmx1ZXByaW50anMvY29yZSc7XG5cbmltcG9ydCB7IGNhbGxJUEMsIHVzZUlQQ1ZhbHVlIH0gZnJvbSAnLi4vLi4vLi4vaXBjL3JlbmRlcmVyJztcblxuaW1wb3J0IHsgRGF0YWJhc2VTdGF0dXNDb21wb25lbnRQcm9wcyB9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9yZW5kZXJlcic7XG5pbXBvcnQgeyBCYWNrZW5kRGVzY3JpcHRpb24sIEJhY2tlbmRTdGF0dXMgfSBmcm9tICcuLi9iYXNlJztcblxuaW1wb3J0IHN0eWxlcyBmcm9tICcuL3N0YXR1cy5zY3NzJztcblxuXG5jb25zdCBCYWNrZW5kRGV0YWlsczogUmVhY3QuRkM8RGF0YWJhc2VTdGF0dXNDb21wb25lbnRQcm9wczxCYWNrZW5kRGVzY3JpcHRpb24sIEJhY2tlbmRTdGF0dXM+PiA9XG5mdW5jdGlvbiAoeyBkYklQQ1ByZWZpeCwgc3RhdHVzLCBkZXNjcmlwdGlvbiB9KSB7XG4gIGNvbnN0IGlwY1ByZWZpeCA9IGRiSVBDUHJlZml4O1xuXG4gIGNvbnN0IG51bVVuY29tbWl0dGVkID0gXG4gICAgdXNlSVBDVmFsdWUoYCR7aXBjUHJlZml4fS1jb3VudC11bmNvbW1pdHRlZGAsIHsgbnVtVW5jb21taXR0ZWQ6IDAgfSkuXG4gICAgdmFsdWUubnVtVW5jb21taXR0ZWQ7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBvcGVuUGFzc3dvcmRQcm9tcHQoc3RhdHVzLm5lZWRzUGFzc3dvcmQpO1xuICB9LCBbc3RhdHVzLm5lZWRzUGFzc3dvcmRdKTtcblxuICBjb25zdCBbcGFzc3dvcmRQcm9tcHRJc09wZW4sIG9wZW5QYXNzd29yZFByb21wdF0gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gc2V0UGFzc3dvcmQocGFzc3dvcmQ6IHN0cmluZykge1xuICAgIGF3YWl0IGNhbGxJUEM8eyBwYXNzd29yZDogc3RyaW5nIH0sIHsgc3VjY2VzczogdHJ1ZSB9PihgJHtpcGNQcmVmaXh9LWdpdC1zZXQtcGFzc3dvcmRgLCB7IHBhc3N3b3JkIH0pO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8UG9wb3ZlclxuICAgICAgICBib3VuZGFyeT1cInZpZXdwb3J0XCJcbiAgICAgICAgaXNPcGVuPXtwYXNzd29yZFByb21wdElzT3Blbn1cbiAgICAgICAgcG9zaXRpb249e1Bvc2l0aW9uLkJPVFRPTX1cbiAgICAgICAgdGFyZ2V0VGFnTmFtZT1cImRpdlwiXG4gICAgICAgIHRhcmdldENsYXNzTmFtZT17c3R5bGVzLmJhc2V9XG4gICAgICAgIGNvbnRlbnQ9e1xuICAgICAgICAgIDxQYXNzd29yZFByb21wdCBvbkNvbmZpcm09e2FzeW5jIChwYXNzd29yZCkgPT4ge1xuICAgICAgICAgICAgc2V0UGFzc3dvcmQocGFzc3dvcmQpO1xuICAgICAgICAgICAgb3BlblBhc3N3b3JkUHJvbXB0KGZhbHNlKTtcbiAgICAgICAgICB9fSAvPlxuICAgICAgICB9PlxuICAgICAgPEJ1dHRvbkdyb3VwIGZpbGwgdmVydGljYWwgYWxpZ25UZXh0PVwibGVmdFwiPlxuICAgICAgICA8QnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9e3N0eWxlcy5zb3VyY2VJbmZvfVxuICAgICAgICAgICAgdGl0bGU9e2Ake2Rlc2NyaXB0aW9uLmdpdFVzZXJuYW1lfUAke2Rlc2NyaXB0aW9uLmdpdFJlcG99YH1cbiAgICAgICAgICAgIGljb249XCJnaXQtcmVwb1wiXG4gICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChkZXNjcmlwdGlvbi5naXRSZXBvKSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZSgnZWxlY3Ryb24nKS5zaGVsbC5vcGVuRXh0ZXJuYWwoZGVzY3JpcHRpb24uZ2l0UmVwbyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH19PlxuICAgICAgICAgIHtkZXNjcmlwdGlvbi5naXRVc2VybmFtZX1Ae2Rlc2NyaXB0aW9uLmdpdFJlcG99XG4gICAgICAgIDwvQnV0dG9uPlxuXG4gICAgICAgIDxBY3Rpb25hYmxlU3RhdHVzXG4gICAgICAgICAgc3RhdHVzPXtzdGF0dXN9XG4gICAgICAgICAgdW5jb21taXR0ZWRGaWxlQ291bnQ9e251bVVuY29tbWl0dGVkfVxuICAgICAgICAgIG9uUmVxdWVzdFN5bmM9e2FzeW5jICgpID0+IGF3YWl0IGNhbGxJUEMoYCR7aXBjUHJlZml4fS1naXQtdHJpZ2dlci1zeW5jYCl9XG4gICAgICAgICAgb25EaXNjYXJkVW5zdGFnZWQ9e2FzeW5jICgpID0+IGF3YWl0IGNhbGxJUEMoYCR7aXBjUHJlZml4fS1naXQtZGlzY2FyZC11bnN0YWdlZGApfVxuICAgICAgICAgIG9uUHJvbXB0UGFzc3dvcmQ9eygpID0+IG9wZW5QYXNzd29yZFByb21wdCh0cnVlKX1cbiAgICAgICAgICBvblNob3dDb21taXRXaW5kb3c9eygpID0+IGNhbGxJUEMoJ29wZW4tcHJlZGVmaW5lZC13aW5kb3cnLCB7IGlkOiAnYmF0Y2hDb21taXQnIH0pfVxuICAgICAgICAgIG9uU2hvd1NldHRpbmdzV2luZG93PXsoKSA9PiBjYWxsSVBDKCdvcGVuLXByZWRlZmluZWQtd2luZG93JywgeyBpZDogJ3NldHRpbmdzJyB9KX1cbiAgICAgICAgLz5cbiAgICAgIDwvQnV0dG9uR3JvdXA+XG4gICAgPC9Qb3BvdmVyPlxuICApO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgQmFja2VuZERldGFpbHM7XG5cblxuaW50ZXJmYWNlIEFjdGlvbmFibGVTdGF0dXNQcm9wcyB7XG4gIHN0YXR1czogQmFja2VuZFN0YXR1c1xuICB1bmNvbW1pdHRlZEZpbGVDb3VudDogbnVtYmVyXG4gIG9uUmVxdWVzdFN5bmM6ICgpID0+IFByb21pc2U8dm9pZD5cbiAgb25EaXNjYXJkVW5zdGFnZWQ6ICgpID0+IFByb21pc2U8dm9pZD5cbiAgb25Qcm9tcHRQYXNzd29yZDogKCkgPT4gdm9pZFxuICBvblNob3dDb21taXRXaW5kb3c6ICgpID0+IHZvaWRcbiAgb25TaG93U2V0dGluZ3NXaW5kb3c6ICgpID0+IHZvaWRcbn1cbmNvbnN0IEFjdGlvbmFibGVTdGF0dXM6IFJlYWN0LkZDPEFjdGlvbmFibGVTdGF0dXNQcm9wcz4gPSBmdW5jdGlvbiAoe1xuICAgIHN0YXR1cywgdW5jb21taXR0ZWRGaWxlQ291bnQsXG4gICAgb25SZXF1ZXN0U3luYywgb25EaXNjYXJkVW5zdGFnZWQsXG4gICAgb25Qcm9tcHRQYXNzd29yZCxcbiAgICBvblNob3dDb21taXRXaW5kb3csIG9uU2hvd1NldHRpbmdzV2luZG93IH0pIHtcblxuICBsZXQgc3RhdHVzSWNvbjogSWNvbk5hbWU7XG4gIGxldCB0b29sdGlwVGV4dDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBsZXQgc3RhdHVzSW50ZW50OiBJbnRlbnQ7XG4gIGxldCBhY3Rpb246IG51bGwgfCAoKCkgPT4gdm9pZCk7XG5cbiAgaWYgKHN0YXR1cy5pc01pc2NvbmZpZ3VyZWQpIHtcbiAgICBzdGF0dXNJY29uID0gXCJlcnJvclwiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJDb25maWd1cmVcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcImRhbmdlclwiO1xuICAgIGFjdGlvbiA9IG9uU2hvd1NldHRpbmdzV2luZG93O1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmlzT25saW5lICE9PSB0cnVlKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwib2ZmbGluZVwiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jIG5vd1wiXG4gICAgc3RhdHVzSW50ZW50ID0gXCJwcmltYXJ5XCI7XG4gICAgYWN0aW9uID0gc3RhdHVzLm5lZWRzUGFzc3dvcmQgPyBvblByb21wdFBhc3N3b3JkIDogb25SZXF1ZXN0U3luYztcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5uZWVkc1Bhc3N3b3JkKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwibG9ja1wiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJQcm92aWRlIHBhc3N3b3JkICYgc3luY1wiO1xuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG9uUHJvbXB0UGFzc3dvcmQ7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuaGFzTG9jYWxDaGFuZ2VzKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiZ2l0LWNvbW1pdFwiO1xuICAgIHRvb2x0aXBUZXh0ID0gXCJDb21taXQgJiBzeW5jXCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJwcmltYXJ5XCI7XG4gICAgYWN0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKHN0YXR1cy5oYXNMb2NhbENoYW5nZXMgJiYgdW5jb21taXR0ZWRGaWxlQ291bnQgPCAxKSB7XG4gICAgICAgIC8vIE5PVEU6IElmIGhhc0xvY2FsQ2hhbmdlcyBzYXlzIHllcywgYnV0IHVuY29tbWl0dGVkIGZpbGUgY291bnQgc2F5cyBubywgdHJ5IHRvIGZpeCBpdC5cbiAgICAgICAgYXdhaXQgb25EaXNjYXJkVW5zdGFnZWQoKTtcbiAgICAgICAgYXdhaXQgb25SZXF1ZXN0U3luYygpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb25TaG93Q29tbWl0V2luZG93KCk7XG4gICAgICB9XG4gICAgfVxuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLmlzUHVsbGluZykge1xuICAgIHN0YXR1c0ljb24gPSBcImNsb3VkLWRvd25sb2FkXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luY2luZ+KAplwiO1xuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG51bGw7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuaXNQdXNoaW5nKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiY2xvdWQtdXBsb2FkXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luY2luZ+KAplwiO1xuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG51bGw7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuc3RhdHVzUmVsYXRpdmVUb0xvY2FsID09PSAnZGl2ZXJnZWQnKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiZ2l0LWJyYW5jaFwiXG4gICAgdG9vbHRpcFRleHQgPSBcIlJlc29sdmUgY29uZmxpY3QgYW5kIHN5bmNcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcIndhcm5pbmdcIjtcbiAgICBhY3Rpb24gPSBvblJlcXVlc3RTeW5jO1xuXG4gIH0gZWxzZSBpZiAoc3RhdHVzLnN0YXR1c1JlbGF0aXZlVG9Mb2NhbCA9PT0gJ2JlaGluZCcpIHtcbiAgICBzdGF0dXNJY29uID0gXCJjbG91ZC11cGxvYWRcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jIG5vd1wiO1xuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG5cbiAgfSBlbHNlIHtcbiAgICBzdGF0dXNJY29uID0gXCJ1cGRhdGVkXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luYyBub3dcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSBcInByaW1hcnlcIjtcbiAgICBhY3Rpb24gPSBvblJlcXVlc3RTeW5jO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8QnV0dG9uXG4gICAgICAgIGNsYXNzTmFtZT17c3R5bGVzLmJhY2tlbmRTdGF0dXN9XG4gICAgICAgIG9uQ2xpY2s9e2FjdGlvbiB8fCAoKCkgPT4ge30pfVxuICAgICAgICBpY29uPXtzdGF0dXNJY29ufVxuICAgICAgICBpbnRlbnQ9e3N0YXR1c0ludGVudH1cbiAgICAgICAgZGlzYWJsZWQ9e2FjdGlvbiA9PT0gbnVsbH1cbiAgICAgICAgbG9hZGluZz17YWN0aW9uID09PSBudWxsfT5cbiAgICAgIHt0b29sdGlwVGV4dH1cbiAgICA8L0J1dHRvbj5cbiAgKTtcbn07XG5cblxuY29uc3QgUGFzc3dvcmRQcm9tcHQ6IFJlYWN0LkZDPHsgb25Db25maXJtOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiB9PiA9IGZ1bmN0aW9uICh7IG9uQ29uZmlybSB9KSB7XG4gIGNvbnN0IFt2YWx1ZSwgc2V0VmFsdWVdID0gdXNlU3RhdGUoJycpO1xuXG4gIHJldHVybiA8ZGl2IGNsYXNzTmFtZT17c3R5bGVzLnBhc3N3b3JkUHJvbXB0fT5cbiAgICA8Rm9ybUdyb3VwXG4gICAgICAgIGxhYmVsPVwiUGxlYXNlIGVudGVyIHJlcG9zaXRvcnkgcGFzc3dvcmQ6XCJcbiAgICAgICAgaGVscGVyVGV4dD1cIlRoZSBwYXNzd29yZCB3aWxsIGJlIGtlcHQgaW4gbWVtb3J5IGFuZCBub3Qgc3RvcmVkIHRvIGRpc2suXCI+XG4gICAgICA8SW5wdXRHcm91cFxuICAgICAgICB0eXBlPVwicGFzc3dvcmRcIlxuICAgICAgICB2YWx1ZT17dmFsdWV9XG4gICAgICAgIG9uQ2hhbmdlPXsoZXZlbnQ6IFJlYWN0LkZvcm1FdmVudDxIVE1MRWxlbWVudD4pID0+IHNldFZhbHVlKChldmVudC50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudCkudmFsdWUpfVxuICAgICAgICBsZWZ0SWNvbj1cImtleVwiXG4gICAgICAgIHJpZ2h0RWxlbWVudD17XG4gICAgICAgICAgdmFsdWUudHJpbSgpID09PSAnJ1xuICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgOiA8QnV0dG9uXG4gICAgICAgICAgICAgICAgbWluaW1hbFxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2FzeW5jICgpID0+IGF3YWl0IG9uQ29uZmlybSh2YWx1ZSl9XG4gICAgICAgICAgICAgICAgaWNvbj1cInRpY2tcIlxuICAgICAgICAgICAgICAgIGludGVudD1cInByaW1hcnlcIj5cbiAgICAgICAgICAgICAgQ29uZmlybVxuICAgICAgICAgICAgPC9CdXR0b24+fVxuICAgICAgLz5cbiAgICA8L0Zvcm1Hcm91cD5cbiAgPC9kaXY+O1xufTtcbiJdfQ==