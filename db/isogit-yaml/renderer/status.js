import React, { useState } from 'react';
import { Button, FormGroup, InputGroup, ButtonGroup, NonIdealState, Spinner, } from '@blueprintjs/core';
import { callIPC, useIPCValue } from '../../../ipc/renderer';
import styles from './status.scss';
const BackendDetails = function ({ dbIPCPrefix, status, description }) {
    const ipcPrefix = dbIPCPrefix;
    const numUncommitted = useIPCValue(`${ipcPrefix}-count-uncommitted`, { numUncommitted: 0 }).
        value.numUncommitted;
    return (React.createElement(ButtonGroup, { fill: true, vertical: true, alignText: "left" },
        React.createElement(Button, { className: styles.sourceInfo, title: `${description.gitUsername}@${description.gitRepo}`, icon: "git-repo", onClick: () => {
                if (description.gitRepo) {
                    require('electron').shell.openExternal(description.gitRepo);
                }
            } },
            description.gitUsername,
            "@",
            description.gitRepo),
        React.createElement(ActionableStatus, { status: status, uncommittedFileCount: numUncommitted, onRequestSync: async () => await callIPC(`${ipcPrefix}-git-trigger-sync`), onShowSettingsWindow: () => callIPC('open-predefined-window', { id: 'settings' }) })));
};
export default BackendDetails;
const ActionableStatus = function ({ status, uncommittedFileCount, onRequestSync, onShowSettingsWindow }) {
    let statusIcon;
    let tooltipText;
    let statusIntent;
    let action;
    if (status.isMisconfigured) {
        statusIcon = "error";
        tooltipText = "Configure";
        statusIntent = "danger";
        action = onShowSettingsWindow;
    }
    else if (status.isOnline !== true) {
        statusIcon = "offline";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestSync;
    }
    else if (status.hasLocalChanges && uncommittedFileCount > 0) {
        statusIcon = "git-commit";
        tooltipText = "Sync now";
        statusIntent = undefined;
        action = onRequestSync;
    }
    else if (status.statusRelativeToLocal === 'diverged') {
        statusIcon = "git-branch";
        tooltipText = "Resolve conflict and sync";
        statusIntent = "warning";
        action = onRequestSync;
    }
    else if (status.statusRelativeToLocal === 'behind') {
        statusIcon = "cloud-upload";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestSync;
    }
    else {
        statusIcon = "updated";
        tooltipText = "Sync now";
        statusIntent = "primary";
        action = onRequestSync;
    }
    return (React.createElement(Button, { className: styles.backendStatus, onClick: action || (() => { }), icon: statusIcon, intent: statusIntent, disabled: action === null }, tooltipText));
};
export const PasswordPrompt = function ({ dbIPCPrefix, onConfirm }) {
    const [value, setValue] = useState('');
    async function handlePasswordConfirm() {
        await callIPC(`${dbIPCPrefix}-git-set-password`, { password: value });
        onConfirm();
    }
    return React.createElement("div", { className: styles.passwordPrompt },
        React.createElement(FormGroup, { label: "Please enter repository password:", helperText: "The password will be kept in memory and not stored to disk." },
            React.createElement(InputGroup, { type: "password", value: value, onChange: (event) => setValue(event.target.value), leftIcon: "key", rightElement: value.trim() === ''
                    ? undefined
                    : React.createElement(Button, { minimal: true, onClick: handlePasswordConfirm, icon: "tick", intent: "primary" }, "Confirm") })));
};
export const DBSyncScreen = function ({ dbName, db, onDismiss }) {
    var _a;
    let dbInitializationScreen;
    if (((_a = db) === null || _a === void 0 ? void 0 : _a.status) === undefined) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: React.createElement(Spinner, null), title: "Initializing database" });
    }
    else if (db.status.needsPassword) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: "key", title: "Password required", description: React.createElement(PasswordPrompt, { dbIPCPrefix: `db-${dbName}`, onConfirm: () => void 0 }) });
    }
    else if (db.status.isPushing || db.status.isPulling) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: db.status.isPushing ? "cloud-upload" : "cloud-download", title: "Synchronizing data", description: db.status.isPushing ? "Pushing changes" : "Pulling changes" });
    }
    else if (db.status.lastSynchronized === null && db.status.hasLocalChanges === false) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: React.createElement(Spinner, null), title: "Connecting" });
    }
    else if (db.status.lastSynchronized !== null) {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: "tick", title: "Ready", description: React.createElement(Button, { onClick: onDismiss, intent: "primary" }, "Dismiss") });
    }
    else {
        dbInitializationScreen = React.createElement(NonIdealState, { icon: "tick", title: "Ready", description: React.createElement(Button, { onClick: onDismiss, intent: "primary" }, "Dismiss") });
    }
    return dbInitializationScreen;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdHVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2RiL2lzb2dpdC15YW1sL3JlbmRlcmVyL3N0YXR1cy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFFeEMsT0FBTyxFQUNMLE1BQU0sRUFBWSxTQUFTLEVBQUUsVUFBVSxFQUN2QyxXQUFXLEVBQUUsYUFBYSxFQUFFLE9BQU8sR0FDcEMsTUFBTSxtQkFBbUIsQ0FBQztBQUUzQixPQUFPLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBSzdELE9BQU8sTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUduQyxNQUFNLGNBQWMsR0FDcEIsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFO0lBQzVDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztJQUU5QixNQUFNLGNBQWMsR0FDbEIsV0FBVyxDQUFDLEdBQUcsU0FBUyxvQkFBb0IsRUFBRSxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNwRSxLQUFLLENBQUMsY0FBYyxDQUFDO0lBRXZCLE9BQU8sQ0FDTCxvQkFBQyxXQUFXLElBQUMsSUFBSSxRQUFDLFFBQVEsUUFBQyxTQUFTLEVBQUMsTUFBTTtRQUN6QyxvQkFBQyxNQUFNLElBQ0gsU0FBUyxFQUFFLE1BQU0sQ0FBQyxVQUFVLEVBQzVCLEtBQUssRUFBRSxHQUFHLFdBQVcsQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLE9BQU8sRUFBRSxFQUMxRCxJQUFJLEVBQUMsVUFBVSxFQUNmLE9BQU8sRUFBRSxHQUFHLEVBQUU7Z0JBQ1osSUFBSSxXQUFXLENBQUMsT0FBTyxFQUFFO29CQUN2QixPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7aUJB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LFdBQVcsRUFBRSxvQkFBQyxNQUFNLElBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUMsU0FBUyxjQUFpQixHQUMxRSxDQUFBO0tBQ0g7SUFFRCxPQUFPLHNCQUFzQixDQUFDO0FBQ2hDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHtcbiAgQnV0dG9uLCBJY29uTmFtZSwgRm9ybUdyb3VwLCBJbnB1dEdyb3VwLCBJbnRlbnQsXG4gIEJ1dHRvbkdyb3VwLCBOb25JZGVhbFN0YXRlLCBTcGlubmVyLFxufSBmcm9tICdAYmx1ZXByaW50anMvY29yZSc7XG5cbmltcG9ydCB7IGNhbGxJUEMsIHVzZUlQQ1ZhbHVlIH0gZnJvbSAnLi4vLi4vLi4vaXBjL3JlbmRlcmVyJztcblxuaW1wb3J0IHsgRGF0YWJhc2VTdGF0dXNDb21wb25lbnRQcm9wcyB9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9yZW5kZXJlcic7XG5pbXBvcnQgeyBCYWNrZW5kRGVzY3JpcHRpb24sIEJhY2tlbmRTdGF0dXMgfSBmcm9tICcuLi9iYXNlJztcblxuaW1wb3J0IHN0eWxlcyBmcm9tICcuL3N0YXR1cy5zY3NzJztcblxuXG5jb25zdCBCYWNrZW5kRGV0YWlsczogUmVhY3QuRkM8RGF0YWJhc2VTdGF0dXNDb21wb25lbnRQcm9wczxCYWNrZW5kRGVzY3JpcHRpb24sIEJhY2tlbmRTdGF0dXM+PiA9XG5mdW5jdGlvbiAoeyBkYklQQ1ByZWZpeCwgc3RhdHVzLCBkZXNjcmlwdGlvbiB9KSB7XG4gIGNvbnN0IGlwY1ByZWZpeCA9IGRiSVBDUHJlZml4O1xuXG4gIGNvbnN0IG51bVVuY29tbWl0dGVkID0gXG4gICAgdXNlSVBDVmFsdWUoYCR7aXBjUHJlZml4fS1jb3VudC11bmNvbW1pdHRlZGAsIHsgbnVtVW5jb21taXR0ZWQ6IDAgfSkuXG4gICAgdmFsdWUubnVtVW5jb21taXR0ZWQ7XG5cbiAgcmV0dXJuIChcbiAgICA8QnV0dG9uR3JvdXAgZmlsbCB2ZXJ0aWNhbCBhbGlnblRleHQ9XCJsZWZ0XCI+XG4gICAgICA8QnV0dG9uXG4gICAgICAgICAgY2xhc3NOYW1lPXtzdHlsZXMuc291cmNlSW5mb31cbiAgICAgICAgICB0aXRsZT17YCR7ZGVzY3JpcHRpb24uZ2l0VXNlcm5hbWV9QCR7ZGVzY3JpcHRpb24uZ2l0UmVwb31gfVxuICAgICAgICAgIGljb249XCJnaXQtcmVwb1wiXG4gICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgaWYgKGRlc2NyaXB0aW9uLmdpdFJlcG8pIHtcbiAgICAgICAgICAgICAgcmVxdWlyZSgnZWxlY3Ryb24nKS5zaGVsbC5vcGVuRXh0ZXJuYWwoZGVzY3JpcHRpb24uZ2l0UmVwbyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfX0+XG4gICAgICAgIHtkZXNjcmlwdGlvbi5naXRVc2VybmFtZX1Ae2Rlc2NyaXB0aW9uLmdpdFJlcG99XG4gICAgICA8L0J1dHRvbj5cblxuICAgICAgPEFjdGlvbmFibGVTdGF0dXNcbiAgICAgICAgc3RhdHVzPXtzdGF0dXN9XG4gICAgICAgIHVuY29tbWl0dGVkRmlsZUNvdW50PXtudW1VbmNvbW1pdHRlZH1cbiAgICAgICAgb25SZXF1ZXN0U3luYz17YXN5bmMgKCkgPT4gYXdhaXQgY2FsbElQQyhgJHtpcGNQcmVmaXh9LWdpdC10cmlnZ2VyLXN5bmNgKX1cbiAgICAgICAgb25TaG93U2V0dGluZ3NXaW5kb3c9eygpID0+IGNhbGxJUEMoJ29wZW4tcHJlZGVmaW5lZC13aW5kb3cnLCB7IGlkOiAnc2V0dGluZ3MnIH0pfVxuICAgICAgLz5cbiAgICA8L0J1dHRvbkdyb3VwPlxuICApO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgQmFja2VuZERldGFpbHM7XG5cblxuaW50ZXJmYWNlIEFjdGlvbmFibGVTdGF0dXNQcm9wcyB7XG4gIHN0YXR1czogQmFja2VuZFN0YXR1c1xuICB1bmNvbW1pdHRlZEZpbGVDb3VudDogbnVtYmVyXG4gIG9uUmVxdWVzdFN5bmM6ICgpID0+IFByb21pc2U8dm9pZD5cbiAgb25TaG93U2V0dGluZ3NXaW5kb3c6ICgpID0+IHZvaWRcbn1cbmNvbnN0IEFjdGlvbmFibGVTdGF0dXM6IFJlYWN0LkZDPEFjdGlvbmFibGVTdGF0dXNQcm9wcz4gPSBmdW5jdGlvbiAoe1xuICAgIHN0YXR1cywgdW5jb21taXR0ZWRGaWxlQ291bnQsXG4gICAgb25SZXF1ZXN0U3luYyxcbiAgICBvblNob3dTZXR0aW5nc1dpbmRvdyB9KSB7XG5cbiAgbGV0IHN0YXR1c0ljb246IEljb25OYW1lO1xuICBsZXQgdG9vbHRpcFRleHQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgbGV0IHN0YXR1c0ludGVudDogSW50ZW50IHwgdW5kZWZpbmVkO1xuICBsZXQgYWN0aW9uOiBudWxsIHwgKCgpID0+IHZvaWQpO1xuXG4gIGlmIChzdGF0dXMuaXNNaXNjb25maWd1cmVkKSB7XG4gICAgc3RhdHVzSWNvbiA9IFwiZXJyb3JcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiQ29uZmlndXJlXCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJkYW5nZXJcIjtcbiAgICBhY3Rpb24gPSBvblNob3dTZXR0aW5nc1dpbmRvdztcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5pc09ubGluZSAhPT0gdHJ1ZSkge1xuICAgIHN0YXR1c0ljb24gPSBcIm9mZmxpbmVcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luYyBub3dcIlxuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuaGFzTG9jYWxDaGFuZ2VzICYmIHVuY29tbWl0dGVkRmlsZUNvdW50ID4gMCkge1xuICAgIHN0YXR1c0ljb24gPSBcImdpdC1jb21taXRcIjtcbiAgICB0b29sdGlwVGV4dCA9IFwiU3luYyBub3dcIjtcbiAgICBzdGF0dXNJbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0U3luYztcblxuICB9IGVsc2UgaWYgKHN0YXR1cy5zdGF0dXNSZWxhdGl2ZVRvTG9jYWwgPT09ICdkaXZlcmdlZCcpIHtcbiAgICBzdGF0dXNJY29uID0gXCJnaXQtYnJhbmNoXCJcbiAgICB0b29sdGlwVGV4dCA9IFwiUmVzb2x2ZSBjb25mbGljdCBhbmQgc3luY1wiO1xuICAgIHN0YXR1c0ludGVudCA9IFwid2FybmluZ1wiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG5cbiAgfSBlbHNlIGlmIChzdGF0dXMuc3RhdHVzUmVsYXRpdmVUb0xvY2FsID09PSAnYmVoaW5kJykge1xuICAgIHN0YXR1c0ljb24gPSBcImNsb3VkLXVwbG9hZFwiXG4gICAgdG9vbHRpcFRleHQgPSBcIlN5bmMgbm93XCI7XG4gICAgc3RhdHVzSW50ZW50ID0gXCJwcmltYXJ5XCI7XG4gICAgYWN0aW9uID0gb25SZXF1ZXN0U3luYztcblxuICB9IGVsc2Uge1xuICAgIHN0YXR1c0ljb24gPSBcInVwZGF0ZWRcIlxuICAgIHRvb2x0aXBUZXh0ID0gXCJTeW5jIG5vd1wiO1xuICAgIHN0YXR1c0ludGVudCA9IFwicHJpbWFyeVwiO1xuICAgIGFjdGlvbiA9IG9uUmVxdWVzdFN5bmM7XG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxCdXR0b25cbiAgICAgICAgY2xhc3NOYW1lPXtzdHlsZXMuYmFja2VuZFN0YXR1c31cbiAgICAgICAgb25DbGljaz17YWN0aW9uIHx8ICgoKSA9PiB7fSl9XG4gICAgICAgIGljb249e3N0YXR1c0ljb259XG4gICAgICAgIGludGVudD17c3RhdHVzSW50ZW50fVxuICAgICAgICBkaXNhYmxlZD17YWN0aW9uID09PSBudWxsfT5cbiAgICAgIHt0b29sdGlwVGV4dH1cbiAgICA8L0J1dHRvbj5cbiAgKTtcbn07XG5cblxuZXhwb3J0IGNvbnN0IFBhc3N3b3JkUHJvbXB0OiBSZWFjdC5GQzx7IGRiSVBDUHJlZml4OiBzdHJpbmcsIG9uQ29uZmlybTogKCkgPT4gdm9pZCB9PiA9XG5mdW5jdGlvbiAoeyBkYklQQ1ByZWZpeCwgb25Db25maXJtIH0pIHtcbiAgY29uc3QgW3ZhbHVlLCBzZXRWYWx1ZV0gPSB1c2VTdGF0ZSgnJyk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlUGFzc3dvcmRDb25maXJtKCkge1xuICAgIGF3YWl0IGNhbGxJUEM8eyBwYXNzd29yZDogc3RyaW5nIH0sIHsgc3VjY2VzczogdHJ1ZSB9PihgJHtkYklQQ1ByZWZpeH0tZ2l0LXNldC1wYXNzd29yZGAsIHsgcGFzc3dvcmQ6IHZhbHVlIH0pO1xuICAgIG9uQ29uZmlybSgpO1xuICB9XG5cbiAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPXtzdHlsZXMucGFzc3dvcmRQcm9tcHR9PlxuICAgIDxGb3JtR3JvdXBcbiAgICAgICAgbGFiZWw9XCJQbGVhc2UgZW50ZXIgcmVwb3NpdG9yeSBwYXNzd29yZDpcIlxuICAgICAgICBoZWxwZXJUZXh0PVwiVGhlIHBhc3N3b3JkIHdpbGwgYmUga2VwdCBpbiBtZW1vcnkgYW5kIG5vdCBzdG9yZWQgdG8gZGlzay5cIj5cbiAgICAgIDxJbnB1dEdyb3VwXG4gICAgICAgIHR5cGU9XCJwYXNzd29yZFwiXG4gICAgICAgIHZhbHVlPXt2YWx1ZX1cbiAgICAgICAgb25DaGFuZ2U9eyhldmVudDogUmVhY3QuRm9ybUV2ZW50PEhUTUxFbGVtZW50PikgPT4gc2V0VmFsdWUoKGV2ZW50LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50KS52YWx1ZSl9XG4gICAgICAgIGxlZnRJY29uPVwia2V5XCJcbiAgICAgICAgcmlnaHRFbGVtZW50PXtcbiAgICAgICAgICB2YWx1ZS50cmltKCkgPT09ICcnXG4gICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICA6IDxCdXR0b25cbiAgICAgICAgICAgICAgICBtaW5pbWFsPXt0cnVlfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZVBhc3N3b3JkQ29uZmlybX1cbiAgICAgICAgICAgICAgICBpY29uPVwidGlja1wiXG4gICAgICAgICAgICAgICAgaW50ZW50PVwicHJpbWFyeVwiPlxuICAgICAgICAgICAgICBDb25maXJtXG4gICAgICAgICAgICA8L0J1dHRvbj59XG4gICAgICAvPlxuICAgIDwvRm9ybUdyb3VwPlxuICA8L2Rpdj47XG59O1xuXG5cbmludGVyZmFjZSBEQlN5bmNTY3JlZW5Qcm9wcyB7XG4gIGRiTmFtZTogc3RyaW5nXG4gIGRiOiBCYWNrZW5kRGVzY3JpcHRpb25cbiAgb25EaXNtaXNzOiAoKSA9PiB2b2lkXG59XG5leHBvcnQgY29uc3QgREJTeW5jU2NyZWVuOiBSZWFjdC5GQzxEQlN5bmNTY3JlZW5Qcm9wcz4gPSBmdW5jdGlvbiAoeyBkYk5hbWUsIGRiLCBvbkRpc21pc3MgfSkge1xuICBsZXQgZGJJbml0aWFsaXphdGlvblNjcmVlbjogSlNYLkVsZW1lbnQgfCBudWxsO1xuXG4gIGlmIChkYj8uc3RhdHVzID09PSB1bmRlZmluZWQpIHtcbiAgICBkYkluaXRpYWxpemF0aW9uU2NyZWVuID0gPE5vbklkZWFsU3RhdGVcbiAgICAgIGljb249ezxTcGlubmVyIC8+fVxuICAgICAgdGl0bGU9XCJJbml0aWFsaXppbmcgZGF0YWJhc2VcIlxuICAgIC8+XG5cbiAgfSBlbHNlIGlmIChkYi5zdGF0dXMubmVlZHNQYXNzd29yZCkge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj1cImtleVwiXG4gICAgICB0aXRsZT1cIlBhc3N3b3JkIHJlcXVpcmVkXCJcbiAgICAgIGRlc2NyaXB0aW9uPXs8UGFzc3dvcmRQcm9tcHQgZGJJUENQcmVmaXg9e2BkYi0ke2RiTmFtZX1gfSBvbkNvbmZpcm09eygpID0+IHZvaWQgMH0gLz59XG4gICAgLz5cblxuICB9IGVsc2UgaWYgKGRiLnN0YXR1cy5pc1B1c2hpbmcgfHwgZGIuc3RhdHVzLmlzUHVsbGluZykge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj17ZGIuc3RhdHVzLmlzUHVzaGluZyA/IFwiY2xvdWQtdXBsb2FkXCIgOiBcImNsb3VkLWRvd25sb2FkXCJ9XG4gICAgICB0aXRsZT1cIlN5bmNocm9uaXppbmcgZGF0YVwiXG4gICAgICBkZXNjcmlwdGlvbj17ZGIuc3RhdHVzLmlzUHVzaGluZyA/IFwiUHVzaGluZyBjaGFuZ2VzXCIgOiBcIlB1bGxpbmcgY2hhbmdlc1wifVxuICAgIC8+XG5cbiAgfSBlbHNlIGlmIChkYi5zdGF0dXMubGFzdFN5bmNocm9uaXplZCA9PT0gbnVsbCAmJiBkYi5zdGF0dXMuaGFzTG9jYWxDaGFuZ2VzID09PSBmYWxzZSkge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj17PFNwaW5uZXIgLz59XG4gICAgICB0aXRsZT1cIkNvbm5lY3RpbmdcIlxuICAgIC8+XG5cbiAgfSBlbHNlIGlmIChkYi5zdGF0dXMubGFzdFN5bmNocm9uaXplZCAhPT0gbnVsbCkge1xuICAgIGRiSW5pdGlhbGl6YXRpb25TY3JlZW4gPSA8Tm9uSWRlYWxTdGF0ZVxuICAgICAgaWNvbj1cInRpY2tcIlxuICAgICAgdGl0bGU9XCJSZWFkeVwiXG4gICAgICBkZXNjcmlwdGlvbj17PEJ1dHRvbiBvbkNsaWNrPXtvbkRpc21pc3N9IGludGVudD1cInByaW1hcnlcIj5EaXNtaXNzPC9CdXR0b24+fVxuICAgIC8+XG4gIH0gZWxzZSB7XG4gICAgZGJJbml0aWFsaXphdGlvblNjcmVlbiA9IDxOb25JZGVhbFN0YXRlXG4gICAgICBpY29uPVwidGlja1wiXG4gICAgICB0aXRsZT1cIlJlYWR5XCJcbiAgICAgIGRlc2NyaXB0aW9uPXs8QnV0dG9uIG9uQ2xpY2s9e29uRGlzbWlzc30gaW50ZW50PVwicHJpbWFyeVwiPkRpc21pc3M8L0J1dHRvbj59XG4gICAgLz5cbiAgfVxuXG4gIHJldHVybiBkYkluaXRpYWxpemF0aW9uU2NyZWVuO1xufSJdfQ==