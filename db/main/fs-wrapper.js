import * as fs from 'fs-extra';
import * as path from 'path';
import AsyncLock from 'async-lock';
export class AbstractLockingFilesystemWrapper {
    constructor(baseDir) {
        this.baseDir = baseDir;
        this.fileAccessLock = new AsyncLock();
    }
    expandPath(objID) {
        return path.join(this.baseDir, objID);
    }
    makeRelativePath(absPath) {
        if (path.isAbsolute(absPath)) {
            return path.relative(this.baseDir, absPath);
        }
        else {
            throw new Error("Expecting an absolute path, but got relative");
        }
    }
    async isValidID(value) {
        return true;
    }
    async readAll(...args) {
        const objIDs = await fs.readdir(this.baseDir);
        var objs = [];
        for (const objID of objIDs) {
            if (await this.isValidID(objID)) {
                objs.push(await this.read(objID, ...args));
            }
        }
        return objs;
    }
    async exists(objID) {
        return await fs.pathExists(this.expandPath(objID));
    }
    async read(objID, ...args) {
        const filePath = this.expandPath(objID);
        return await this.fileAccessLock.acquire(filePath, async () => {
            return this.parseData(await fs.readFile(filePath, { encoding: 'utf8' }));
        });
    }
    async write(objID, newContents, ...args) {
        const filePath = this.expandPath(objID);
        return await this.fileAccessLock.acquire(filePath, async () => {
            if (newContents !== undefined) {
                await fs.writeFile(filePath, this.dumpData(newContents), { encoding: 'utf8' });
            }
            else {
                await fs.remove(filePath);
            }
            return [this.makeRelativePath(filePath)];
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnMtd3JhcHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYi9tYWluL2ZzLXdyYXBwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBdURuQyxNQUFNLE9BQWdCLGdDQUFnQztJQVNwRCxZQUFtQixPQUFlO1FBQWYsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNoQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVNLFVBQVUsQ0FBQyxLQUFhO1FBQzdCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxPQUFlO1FBQ3JDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM3QzthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBYTtRQUNsQyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBVztRQUNqQyxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNkLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQzFCLElBQUksTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQzVDO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQWE7UUFDL0IsT0FBTyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQWEsRUFBRSxHQUFHLElBQVc7UUFDN0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4QyxPQUFPLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzVELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQWEsRUFBRSxXQUEwQixFQUFFLEdBQUcsSUFBVztRQUMxRSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hDLE9BQU8sTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUQsSUFBSSxXQUFXLEtBQUssU0FBUyxFQUFFO2dCQUM3QixNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQzthQUNoRjtpQkFBTTtnQkFDTCxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDM0I7WUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBTUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcblxuXG50eXBlIEZpbGVzeXN0ZW1QYXRoID0gc3RyaW5nO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZXN5c3RlbVdyYXBwZXI8VD4ge1xuICAvKiBTcGVjIGZvciBmaWxlc3lzdGVtIGJhY2tlbmRzXG4gICAgIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBHaXQgZmlsZXN5c3RlbSBvYmplY3Qgc3RvcmUuXG5cbiAgICAgSXQgaGFzIGl0cyBvd24gY29uY2VwdCBvZiDigJxvYmplY3QgSURz4oCdLFxuICAgICB3aGljaCBhcmUgcmVmZXJlbmNlcyB0byBmaWxlc3lzdGVtIGVudHJpZXMuXG4gICAgIElmIGJhY2tlbmQgb3BlcmF0ZXMgb24gZmlsZXMgb2Ygc2luZ2xlIHR5cGUsXG4gICAgIG9iamVjdCBJRHMgd291bGQgcHJvYmFibHkgZXhjbHVkZSBmaWxlbmFtZSBleHRlbnNpb24uXG4gICAgIFRoZSBTdG9yZSB1c2luZyB0aGlzIGJhY2tlbmQgd291bGQgY29udmVydCBvYmplY3QgSURzIHRvICovXG5cbiAgYmFzZURpcjogc3RyaW5nO1xuICAvKiBBYnNvbHV0ZSBwYXRoLlxuICAgICBCYWNrZW5kIGlzIG5vdCBjb25jZXJuZWQgd2l0aCBmaWxlcyBvdXRzaWRlIHRoaXMgcGF0aC5cbiAgICAgVE9ETzogQ291bGQgYmV0dGVyIGJlIG1hZGUgcmVhZC1vbmx5LCBiZWhpbmQgYWNjZXNzb3IgbWV0aG9kLiAqL1xuXG4gIHJlYWQob2JqSUQ6IHN0cmluZywgLi4uYXJnczogYW55W10pOiBQcm9taXNlPFQ+O1xuXG4gIHJlYWRBbGwoLi4uYXJnczogYW55W10pOiBQcm9taXNlPFRbXT47XG4gIC8qIFNjYW4gZmlsZXN5c3RlbSBhbmQgcmV0dXJucyBhbGwgdGhlIG9iamVjdHMgZm91bmQuICovXG5cbiAgd3JpdGUob2JqSUQ6IHN0cmluZywgbmV3RGF0YTogVCB8IHVuZGVmaW5lZCwgLi4uYXJnczogYW55W10pOiBQcm9taXNlPEZpbGVzeXN0ZW1QYXRoW10+O1xuICAvKiBVcGRhdGVzIGdpdmVuIG9iamVjdCBhbmQgcmV0dXJucyBhIGxpc3Qgb2YgZmlsZXN5c3RlbSBwYXRocyB0aGF0IGNvdWxkIGJlIGFmZmVjdGVkLlxuICAgICBJZiBgbmV3RGF0YWAgaXMgdW5kZWZpbmVkLCB0aGUgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGJlIGRlbGV0ZWQuICovXG5cblxuICAvLyBUT0RPOiBGb2xsb3dpbmcgdHdvIGNhbiBiZSByZW5hbWVkIGZvciBjbGFyaXR5LlxuXG4gIGV4cGFuZFBhdGgob2JqSUQ6IHN0cmluZyk6IHN0cmluZztcbiAgLyogUmV0dXJucyBhbiBhYnNvbHV0ZSBwYXRoIHRvIG9iamVjdCBmaWxlIG9yIHJvb3QgZGlyZWN0b3J5LFxuICAgICBnaXZlbiBvYmplY3QgSUQuIEFkZHMgYW4gZXh0ZW5zaW9uIHdoZXJlIGFwcGxpY2FibGUuXG4gICAgIFVzZWQgYnkgcmVhZCgpLCB3cml0ZSgpIHVuZGVyIHRoZSBob29kLiBUT0RPOiBTaG91bGQgYmUgbWFkZSBwcml2YXRlPyAqL1xuXG4gIGV4aXN0cyhvYmpJRDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcbiAgLyogR2l2ZW4gb2JqZWN0IElELCByZXR1cm5zIHRydWUgaWYgdGhlIG9iamVjdCBhY3R1YWxseSBleGlzdHMuXG4gICAgIFVzZWQgd2hlbiBzdG9yaW5nIGUuZy4gdG8gYXZvaWQgb3ZlcndyaXRpbmcgYW4gZXhpc3Rpbmcgb2JqZWN0LiAqL1xuXG4gIGlzVmFsaWRJRChmaWxlcGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcbiAgLyogR2l2ZW4gYSBwYXRoLCByZXR1cm5zIHRydWUgaWYgaXQgbG9va3MgbGlrZSBhIHZhbGlkIG9iamVjdCBJRC5cblxuICAgICBUaGlzIGlzIGludGVuZGVkIHRvIGJlIHVzZWQgZm9yIHdlZWRpbmcgb3V0IHJhbmRvbSBmaWxlc1xuICAgICB0aGF0IGFyZSBub3QgcGFydCBvZiB0aGUgZGF0YWJhc2UsIGUuZy4gc3lzdGVtIGZpbGVzL2RpcmVjdG9yaWVzLFxuICAgICB3aGVuIGxvYWRpbmcgb2JqZWN0cyBmcm9tIGZpbGVzeXN0ZW0uXG5cbiAgICAgVGhpcyBjYW4gYmUgYXMgc2ltcGxlIGFzIGNvbXBhcmluZyB0aGUgZXh0ZW5zaW9uXG4gICAgIGJ1dCBpZiBuZWNlc3NhcnkgY2FuIGRvIGZ1cnRoZXIgY2hlY2tzIG9uIGZpbGUvZGlyZWN0b3J5IGNvbnRlbnRzLiAqL1xuXG59XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFic3RyYWN0TG9ja2luZ0ZpbGVzeXN0ZW1XcmFwcGVyPFQ+IGltcGxlbWVudHMgRmlsZXN5c3RlbVdyYXBwZXI8VD4ge1xuICAvKiBCYXNpYyBmaWxlc3lzdGVtIGJhY2tlbmQgYXJvdW5kIE5vZGUuanMgZnMtZXh0cmEsXG4gICAgIHByb3ZpZGluZyBzdHViIG1ldGhvZHMgZm9yIHBhcnNpbmcvZHVtcGluZyBkYXRhIGZyb20vdG8gcmF3IHN0cmluZyBmaWxlIGNvbnRlbnRzXG4gICAgIGFuZCBpbXBsZW1lbnRpbmcgbG9ja2luZyBhcm91bmQgZmlsZSByZWFkcy93cml0ZXNcbiAgICAgKGxvY2tzIGJhc2VkIG9uIGZpbGUgcGF0aCwgc28gdGhhdCBpdCBjYW5ub3QgYmUgd3JpdHRlbiB0byB3aGlsZSBpdOKAmXMgYmVpbmcgcmVhZCBmcm9tL3dyaXR0ZW4gdG8pLlxuICAqL1xuXG4gIHByaXZhdGUgZmlsZUFjY2Vzc0xvY2s6IEFzeW5jTG9jaztcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgYmFzZURpcjogc3RyaW5nKSB7XG4gICAgdGhpcy5maWxlQWNjZXNzTG9jayA9IG5ldyBBc3luY0xvY2soKTtcbiAgfVxuXG4gIHB1YmxpYyBleHBhbmRQYXRoKG9iaklEOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMuYmFzZURpciwgb2JqSUQpO1xuICB9XG5cbiAgcHVibGljIG1ha2VSZWxhdGl2ZVBhdGgoYWJzUGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZShhYnNQYXRoKSkge1xuICAgICAgcmV0dXJuIHBhdGgucmVsYXRpdmUodGhpcy5iYXNlRGlyLCBhYnNQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXhwZWN0aW5nIGFuIGFic29sdXRlIHBhdGgsIGJ1dCBnb3QgcmVsYXRpdmVcIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGlzVmFsaWRJRCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZEFsbCguLi5hcmdzOiBhbnlbXSkge1xuICAgIGNvbnN0IG9iaklEcyA9IGF3YWl0IGZzLnJlYWRkaXIodGhpcy5iYXNlRGlyKTtcbiAgICB2YXIgb2JqcyA9IFtdO1xuICAgIGZvciAoY29uc3Qgb2JqSUQgb2Ygb2JqSURzKSB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5pc1ZhbGlkSUQob2JqSUQpKSB7XG4gICAgICAgIG9ianMucHVzaChhd2FpdCB0aGlzLnJlYWQob2JqSUQsIC4uLmFyZ3MpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG9ianM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXhpc3RzKG9iaklEOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYXdhaXQgZnMucGF0aEV4aXN0cyh0aGlzLmV4cGFuZFBhdGgob2JqSUQpKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkKG9iaklEOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLmV4cGFuZFBhdGgob2JqSUQpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbGVBY2Nlc3NMb2NrLmFjcXVpcmUoZmlsZVBhdGgsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnBhcnNlRGF0YShhd2FpdCBmcy5yZWFkRmlsZShmaWxlUGF0aCwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB3cml0ZShvYmpJRDogc3RyaW5nLCBuZXdDb250ZW50czogVCB8IHVuZGVmaW5lZCwgLi4uYXJnczogYW55W10pIHtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuZXhwYW5kUGF0aChvYmpJRCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmlsZUFjY2Vzc0xvY2suYWNxdWlyZShmaWxlUGF0aCwgYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKG5ld0NvbnRlbnRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKGZpbGVQYXRoLCB0aGlzLmR1bXBEYXRhKG5ld0NvbnRlbnRzKSwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgZnMucmVtb3ZlKGZpbGVQYXRoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBbdGhpcy5tYWtlUmVsYXRpdmVQYXRoKGZpbGVQYXRoKV07XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcGFyc2VEYXRhKGNvbnRlbnRzOiBzdHJpbmcpOiBUXG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGR1bXBEYXRhKGRhdGE6IFQpOiBzdHJpbmdcblxufVxuIl19