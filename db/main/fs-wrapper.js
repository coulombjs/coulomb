import * as fs from 'fs-extra';
import * as path from 'path';
import AsyncLock from 'async-lock';
export class AbstractLockingFilesystemWrapper {
    constructor(baseDir) {
        this.baseDir = baseDir;
        this.fileAccessLock = new AsyncLock({ maxPending: 100000 });
    }
    expandPath(objID) {
        return path.join(this.baseDir, objID);
    }
    makeRelativePath(absPath) {
        if (path.isAbsolute(absPath)) {
            return path.relative(this.baseDir, absPath);
        }
        else {
            throw new Error("Expecting an absolute path, but got relative");
        }
    }
    async isValidID(value) {
        return true;
    }
    async listIDs(query, ...listArg) {
        const dir = query.subdir ? path.join(this.baseDir, query.subdir) : this.baseDir;
        const potentialIDs = await this.fileAccessLock.acquire(dir, async () => {
            return await fs.readdir(dir);
        });
        var ids = [];
        for (const maybeID of potentialIDs) {
            if (await this.isValidID(query.subdir ? path.join(query.subdir, maybeID) : maybeID)) {
                ids.push(maybeID);
            }
        }
        return ids;
    }
    async readAll(query, ...readArgs) {
        var objIDs = await this.listIDs(query);
        if (query.onlyIDs !== undefined) {
            objIDs = objIDs.filter(id => { var _a; return (_a = query.onlyIDs) === null || _a === void 0 ? void 0 : _a.includes(id); });
        }
        var objs = [];
        for (const objID of objIDs) {
            objs.push(await this.read(objID, ...readArgs));
        }
        return objs;
    }
    async exists(objID) {
        return await fs.pathExists(this.expandPath(objID));
    }
    async read(objID, ...args) {
        const filePath = this.expandPath(objID);
        return await this.fileAccessLock.acquire(filePath, async () => {
            return this.parseData(await fs.readFile(filePath, { encoding: 'utf8' }));
        });
    }
    async write(objID, newContents, ...args) {
        const filePath = this.expandPath(objID);
        return await this.fileAccessLock.acquire(filePath, async () => {
            await fs.ensureDir(path.dirname(filePath));
            if (newContents !== undefined) {
                await fs.writeFile(filePath, this.dumpData(newContents), { encoding: 'utf8' });
            }
            else {
                await fs.remove(filePath);
            }
            return [this.makeRelativePath(filePath)];
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnMtd3JhcHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYi9tYWluL2ZzLXdyYXBwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBK0RuQyxNQUFNLE9BQWdCLGdDQUFnQztJQVNwRCxZQUFtQixPQUFlO1FBQWYsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNoQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksU0FBUyxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVNLFVBQVUsQ0FBQyxLQUFhO1FBQzdCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxPQUFlO1FBQ3JDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM3QzthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBYTtRQUNsQyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQTBCLEVBQUUsR0FBRyxPQUFjO1FBQ2hFLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENB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LENBQUMsQ0FBQzthQUMzQjtZQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FNRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuXG5cbnR5cGUgRmlsZXN5c3RlbVBhdGggPSBzdHJpbmc7XG5cblxuZXhwb3J0IGludGVyZmFjZSBGaWxlc3lzdGVtV3JhcHBlcjxUPiB7XG4gIC8qIFNwZWMgZm9yIGZpbGVzeXN0ZW0gYmFja2VuZHNcbiAgICAgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIEdpdCBmaWxlc3lzdGVtIG9iamVjdCBzdG9yZS5cblxuICAgICBJdCBoYXMgaXRzIG93biBjb25jZXB0IG9mIOKAnG9iamVjdCBJRHPigJ0sXG4gICAgIHdoaWNoIGFyZSByZWZlcmVuY2VzIHRvIGZpbGVzeXN0ZW0gZW50cmllcy5cbiAgICAgSWYgYmFja2VuZCBvcGVyYXRlcyBvbiBmaWxlcyBvZiBzaW5nbGUgdHlwZSxcbiAgICAgb2JqZWN0IElEcyB3b3VsZCBwcm9iYWJseSBleGNsdWRlIGZpbGVuYW1lIGV4dGVuc2lvbi5cbiAgICAgVGhlIFN0b3JlIHVzaW5nIHRoaXMgYmFja2VuZCB3b3VsZCBjb252ZXJ0IG9iamVjdCBJRHMgdG8gKi9cblxuICAvLyBUT0RPOiBNYWtlIG5vbi1nZW5lcmljIGFuZCBvcGVyYXRlIG9uIGBhbnlgLFxuICAvLyBsZXQgb3RoZXIgbGF5ZXJzIGRlYWwgd2l0aCBuYXJyb3dlciB0eXBlcyAoPylcblxuICBiYXNlRGlyOiBzdHJpbmc7XG4gIC8qIEFic29sdXRlIHBhdGguXG4gICAgIEJhY2tlbmQgaXMgbm90IGNvbmNlcm5lZCB3aXRoIGZpbGVzIG91dHNpZGUgdGhpcyBwYXRoLlxuICAgICBUT0RPOiBDb3VsZCBiZXR0ZXIgYmUgbWFkZSByZWFkLW9ubHksIGJlaGluZCBhY2Nlc3NvciBtZXRob2QuICovXG5cbiAgcmVhZChvYmpJRDogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSk6IFByb21pc2U8VD47XG5cbiAgbGlzdElEcyhxdWVyeTogeyBzdWJkaXI/OiBzdHJpbmcgfSwgLi4ubGlzdEFyZ3M6IGFueVtdKTogUHJvbWlzZTxzdHJpbmdbXT47XG5cbiAgcmVhZEFsbChxdWVyeTogeyBzdWJkaXI/OiBzdHJpbmcsIG9ubHlJRHM/OiBzdHJpbmdbXSB9LCAuLi5yZWFkQXJnczogYW55W10pOiBQcm9taXNlPFRbXT47XG4gIC8qIFNjYW4gZmlsZXN5c3RlbSBhbmQgcmV0dXJucyBhbGwgdGhlIG9iamVjdHMgZm91bmQuICovXG5cbiAgd3JpdGUob2JqSUQ6IHN0cmluZywgbmV3RGF0YTogVCB8IHVuZGVmaW5lZCwgLi4uYXJnczogYW55W10pOiBQcm9taXNlPEZpbGVzeXN0ZW1QYXRoW10+O1xuICAvKiBVcGRhdGVzIGdpdmVuIG9iamVjdCBhbmQgcmV0dXJucyBhIGxpc3Qgb2YgZmlsZXN5c3RlbSBwYXRocyB0aGF0IGNvdWxkIGJlIGFmZmVjdGVkLlxuICAgICBJZiBgbmV3RGF0YWAgaXMgdW5kZWZpbmVkLCB0aGUgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGJlIGRlbGV0ZWQuICovXG5cblxuICAvLyBUT0RPOiBGb2xsb3dpbmcgdHdvIGNhbiBiZSByZW5hbWVkIGZvciBjbGFyaXR5LlxuXG4gIGV4cGFuZFBhdGgob2JqSUQ6IHN0cmluZyk6IHN0cmluZztcbiAgLyogUmV0dXJucyBhbiBhYnNvbHV0ZSBwYXRoIHRvIG9iamVjdCBmaWxlIG9yIHJvb3QgZGlyZWN0b3J5LFxuICAgICBnaXZlbiBvYmplY3QgSUQuIEFkZHMgYW4gZXh0ZW5zaW9uIHdoZXJlIGFwcGxpY2FibGUuXG4gICAgIFVzZWQgYnkgcmVhZCgpLCB3cml0ZSgpIHVuZGVyIHRoZSBob29kLiBUT0RPOiBTaG91bGQgYmUgbWFkZSBwcml2YXRlPyAqL1xuXG4gIGV4aXN0cyhvYmpJRDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcbiAgLyogR2l2ZW4gb2JqZWN0IElELCByZXR1cm5zIHRydWUgaWYgdGhlIG9iamVjdCBhY3R1YWxseSBleGlzdHMuXG4gICAgIFVzZWQgd2hlbiBzdG9yaW5nIGUuZy4gdG8gYXZvaWQgb3ZlcndyaXRpbmcgYW4gZXhpc3Rpbmcgb2JqZWN0LiAqL1xuXG4gIGlzVmFsaWRJRChmaWxlcGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcbiAgLyogR2l2ZW4gYSBwYXRoLCByZXR1cm5zIHRydWUgaWYgaXQgbG9va3MgbGlrZSBhIHZhbGlkIG9iamVjdCBJRC5cblxuICAgICBUaGlzIGlzIGludGVuZGVkIHRvIGJlIHVzZWQgZm9yIHdlZWRpbmcgb3V0IHJhbmRvbSBmaWxlc1xuICAgICB0aGF0IGFyZSBub3QgcGFydCBvZiB0aGUgZGF0YWJhc2UsIGUuZy4gc3lzdGVtIGZpbGVzL2RpcmVjdG9yaWVzLFxuICAgICB3aGVuIGxvYWRpbmcgb2JqZWN0cyBmcm9tIGZpbGVzeXN0ZW0uXG5cbiAgICAgVGhpcyBjYW4gYmUgYXMgc2ltcGxlIGFzIGNvbXBhcmluZyB0aGUgZXh0ZW5zaW9uXG4gICAgIGJ1dCBpZiBuZWNlc3NhcnkgY2FuIGRvIGZ1cnRoZXIgY2hlY2tzIG9uIGZpbGUvZGlyZWN0b3J5IGNvbnRlbnRzLiAqL1xuXG4gIHBhcnNlRGF0YShjb250ZW50czogc3RyaW5nKTogVDtcbiAgLyogR2l2ZW4gc3RyaW5nIGNvbnRlbnRzLCByZXR1cm5zIHRoZSBvYmplY3Qgb2YgZXhwZWVjdGVkIHR5cGVcbiAgICAgKGUuZy4sIGRlY29kaW5nIHNlcmlhbGl6ZWQgZm9ybWF0KS4gKi9cbn1cblxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQWJzdHJhY3RMb2NraW5nRmlsZXN5c3RlbVdyYXBwZXI8VD4gaW1wbGVtZW50cyBGaWxlc3lzdGVtV3JhcHBlcjxUPiB7XG4gIC8qIEJhc2ljIGZpbGVzeXN0ZW0gYmFja2VuZCBhcm91bmQgTm9kZS5qcyBmcy1leHRyYSxcbiAgICAgcHJvdmlkaW5nIHN0dWIgbWV0aG9kcyBmb3IgcGFyc2luZy9kdW1waW5nIGRhdGEgZnJvbS90byByYXcgc3RyaW5nIGZpbGUgY29udGVudHNcbiAgICAgYW5kIGltcGxlbWVudGluZyBsb2NraW5nIGFyb3VuZCBmaWxlIHJlYWRzL3dyaXRlc1xuICAgICAobG9ja3MgYmFzZWQgb24gZmlsZSBwYXRoLCBzbyB0aGF0IGl0IGNhbm5vdCBiZSB3cml0dGVuIHRvIHdoaWxlIGl04oCZcyBiZWluZyByZWFkIGZyb20vd3JpdHRlbiB0bykuXG4gICovXG5cbiAgcHJpdmF0ZSBmaWxlQWNjZXNzTG9jazogQXN5bmNMb2NrO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBiYXNlRGlyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmZpbGVBY2Nlc3NMb2NrID0gbmV3IEFzeW5jTG9jayh7IG1heFBlbmRpbmc6IDEwMDAwMCB9KTtcbiAgfVxuXG4gIHB1YmxpYyBleHBhbmRQYXRoKG9iaklEOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMuYmFzZURpciwgb2JqSUQpO1xuICB9XG5cbiAgcHVibGljIG1ha2VSZWxhdGl2ZVBhdGgoYWJzUGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZShhYnNQYXRoKSkge1xuICAgICAgcmV0dXJuIHBhdGgucmVsYXRpdmUodGhpcy5iYXNlRGlyLCBhYnNQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXhwZWN0aW5nIGFuIGFic29sdXRlIHBhdGgsIGJ1dCBnb3QgcmVsYXRpdmVcIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGlzVmFsaWRJRCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdElEcyhxdWVyeTogeyBzdWJkaXI/OiBzdHJpbmcgfSwgLi4ubGlzdEFyZzogYW55W10pIHtcbiAgICBjb25zdCBkaXIgPSBxdWVyeS5zdWJkaXIgPyBwYXRoLmpvaW4odGhpcy5iYXNlRGlyLCBxdWVyeS5zdWJkaXIpIDogdGhpcy5iYXNlRGlyO1xuXG4gICAgY29uc3QgcG90ZW50aWFsSURzID0gYXdhaXQgdGhpcy5maWxlQWNjZXNzTG9jay5hY3F1aXJlKGRpciwgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IGZzLnJlYWRkaXIoZGlyKTtcbiAgICB9KTtcblxuICAgIHZhciBpZHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBtYXliZUlEIG9mIHBvdGVudGlhbElEcykge1xuICAgICAgaWYgKGF3YWl0IHRoaXMuaXNWYWxpZElEKHF1ZXJ5LnN1YmRpciA/IHBhdGguam9pbihxdWVyeS5zdWJkaXIsIG1heWJlSUQpIDogbWF5YmVJRCkpIHtcbiAgICAgICAgaWRzLnB1c2gobWF5YmVJRCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpZHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZEFsbChxdWVyeTogeyBzdWJkaXI/OiBzdHJpbmcsIG9ubHlJRHM/OiBzdHJpbmdbXSB9LCAuLi5yZWFkQXJnczogYW55W10pIHtcbiAgICB2YXIgb2JqSURzID0gYXdhaXQgdGhpcy5saXN0SURzKHF1ZXJ5KTtcblxuICAgIGlmIChxdWVyeS5vbmx5SURzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIG9iaklEcyA9IG9iaklEcy5maWx0ZXIoaWQgPT4gcXVlcnkub25seUlEcz8uaW5jbHVkZXMoaWQpKTtcbiAgICB9XG5cbiAgICB2YXIgb2JqcyA9IFtdO1xuICAgIGZvciAoY29uc3Qgb2JqSUQgb2Ygb2JqSURzKSB7XG4gICAgICBvYmpzLnB1c2goYXdhaXQgdGhpcy5yZWFkKG9iaklELCAuLi5yZWFkQXJncykpO1xuICAgIH1cblxuICAgIHJldHVybiBvYmpzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4aXN0cyhvYmpJRDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGF3YWl0IGZzLnBhdGhFeGlzdHModGhpcy5leHBhbmRQYXRoKG9iaklEKSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZChvYmpJRDogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5leHBhbmRQYXRoKG9iaklEKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maWxlQWNjZXNzTG9jay5hY3F1aXJlKGZpbGVQYXRoLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZURhdGEoYXdhaXQgZnMucmVhZEZpbGUoZmlsZVBhdGgsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgd3JpdGUob2JqSUQ6IHN0cmluZywgbmV3Q29udGVudHM6IFQgfCB1bmRlZmluZWQsIC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLmV4cGFuZFBhdGgob2JqSUQpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbGVBY2Nlc3NMb2NrLmFjcXVpcmUoZmlsZVBhdGgsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZzLmVuc3VyZURpcihwYXRoLmRpcm5hbWUoZmlsZVBhdGgpKTtcbiAgICAgIGlmIChuZXdDb250ZW50cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlUGF0aCwgdGhpcy5kdW1wRGF0YShuZXdDb250ZW50cyksIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IGZzLnJlbW92ZShmaWxlUGF0aCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gW3RoaXMubWFrZVJlbGF0aXZlUGF0aChmaWxlUGF0aCldO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFic3RyYWN0IHBhcnNlRGF0YShjb250ZW50czogc3RyaW5nKTogVFxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBkdW1wRGF0YShkYXRhOiBUKTogc3RyaW5nXG5cbn1cbiJdfQ==