import * as fs from 'fs-extra';
import * as path from 'path';
import AsyncLock from 'async-lock';
export class AbstractLockingFilesystemWrapper {
    constructor(baseDir) {
        this.baseDir = baseDir;
        this.fileAccessLock = new AsyncLock({ maxPending: 100000 });
    }
    expandPath(objID) {
        return path.join(this.baseDir, objID);
    }
    makeRelativePath(absPath) {
        if (path.isAbsolute(absPath)) {
            return path.relative(this.baseDir, absPath);
        }
        else {
            throw new Error("Expecting an absolute path, but got relative");
        }
    }
    async isValidID(value) {
        return true;
    }
    async listIDs(query, ...listArg) {
        const dir = query.subdir ? path.join(this.baseDir, query.subdir) : this.baseDir;
        const potentialIDs = (await fs.readdir(dir));
        var ids = [];
        for (const maybeID of potentialIDs) {
            if (await this.isValidID(maybeID)) {
                ids.push(maybeID);
            }
        }
        return ids;
    }
    async readAll(query, ...readArgs) {
        var objIDs = await this.listIDs(query);
        if (query.onlyIDs !== undefined) {
            objIDs = objIDs.filter(id => { var _a; return (_a = query.onlyIDs) === null || _a === void 0 ? void 0 : _a.includes(id); });
        }
        var objs = [];
        for (const objID of objIDs) {
            objs.push(await this.read(objID, ...readArgs));
        }
        return objs;
    }
    async exists(objID) {
        return await fs.pathExists(this.expandPath(objID));
    }
    async read(objID, ...args) {
        const filePath = this.expandPath(objID);
        return await this.fileAccessLock.acquire(filePath, async () => {
            return this.parseData(await fs.readFile(filePath, { encoding: 'utf8' }));
        });
    }
    async write(objID, newContents, ...args) {
        const filePath = this.expandPath(objID);
        return await this.fileAccessLock.acquire(filePath, async () => {
            await fs.ensureDir(path.dirname(filePath));
            if (newContents !== undefined) {
                await fs.writeFile(filePath, this.dumpData(newContents), { encoding: 'utf8' });
            }
            else {
                await fs.remove(filePath);
            }
            return [this.makeRelativePath(filePath)];
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnMtd3JhcHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYi9tYWluL2ZzLXdyYXBwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBbUVuQyxNQUFNLE9BQWdCLGdDQUFnQztJQVNwRCxZQUFtQixPQUFlO1FBQWYsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNoQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksU0FBUyxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVNLFVBQVUsQ0FBQyxLQUFhO1FBQzdCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxPQUFlO1FBQ3JDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM3QzthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBYTtRQUNsQyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQTBCLEVBQUUsR0FBRyxPQUFjO1FBQ2hFLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENB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YXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcblxuXG50eXBlIEZpbGVzeXN0ZW1QYXRoID0gc3RyaW5nO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZXN5c3RlbVdyYXBwZXI8VD4ge1xuICAvKiBTcGVjIGZvciBmaWxlc3lzdGVtIGJhY2tlbmRzXG4gICAgIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBHaXQgZmlsZXN5c3RlbSBvYmplY3Qgc3RvcmUuXG5cbiAgICAgSXQgaGFzIGl0cyBvd24gY29uY2VwdCBvZiDigJxvYmplY3QgSURz4oCdLFxuICAgICB3aGljaCBhcmUgcmVmZXJlbmNlcyB0byBmaWxlc3lzdGVtIGVudHJpZXMuXG4gICAgIElmIGJhY2tlbmQgb3BlcmF0ZXMgb24gZmlsZXMgb2Ygc2luZ2xlIHR5cGUsXG4gICAgIG9iamVjdCBJRHMgd291bGQgcHJvYmFibHkgZXhjbHVkZSBmaWxlbmFtZSBleHRlbnNpb24uXG4gICAgIFRoZSBTdG9yZSB1c2luZyB0aGlzIGJhY2tlbmQgd291bGQgY29udmVydCBvYmplY3QgSURzIHRvICovXG5cbiAgLy8gVE9ETzogTWFrZSBub24tZ2VuZXJpYyBhbmQgb3BlcmF0ZSBvbiBgYW55YCxcbiAgLy8gbGV0IG90aGVyIGxheWVycyBkZWFsIHdpdGggbmFycm93ZXIgdHlwZXMgKD8pXG5cbiAgYmFzZURpcjogc3RyaW5nO1xuICAvKiBBYnNvbHV0ZSBwYXRoLlxuICAgICBCYWNrZW5kIGlzIG5vdCBjb25jZXJuZWQgd2l0aCBmaWxlcyBvdXRzaWRlIHRoaXMgcGF0aC5cbiAgICAgVE9ETzogQ291bGQgYmV0dGVyIGJlIG1hZGUgcmVhZC1vbmx5LCBiZWhpbmQgYWNjZXNzb3IgbWV0aG9kLiAqL1xuXG4gIHJlYWQob2JqSUQ6IHN0cmluZywgLi4uYXJnczogYW55W10pOiBQcm9taXNlPFQ+O1xuXG4gIC8vcmVhZFJhdyhyZWxhdGl2ZVBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPjtcbiAgLy8gVE9ETzogU3dpdGNoIHRvIHJlYWRSYXcgYmVoYXZpb3IgYXMgZGVmYXVsdCBvbmUsXG4gIC8vIGhhbmRsZSBkYXRhIChkZS0pc2VyaWFsaXphdGlvbiBvbiBEQiBtYW5hZ2VyIGxldmVsP1xuXG4gIGxpc3RJRHMocXVlcnk6IHsgc3ViZGlyPzogc3RyaW5nIH0sIC4uLmxpc3RBcmdzOiBhbnlbXSk6IFByb21pc2U8c3RyaW5nW10+O1xuXG4gIHJlYWRBbGwocXVlcnk6IHsgc3ViZGlyPzogc3RyaW5nLCBvbmx5SURzPzogc3RyaW5nW10gfSwgLi4ucmVhZEFyZ3M6IGFueVtdKTogUHJvbWlzZTxUW10+O1xuICAvKiBTY2FuIGZpbGVzeXN0ZW0gYW5kIHJldHVybnMgYWxsIHRoZSBvYmplY3RzIGZvdW5kLiAqL1xuXG4gIHdyaXRlKG9iaklEOiBzdHJpbmcsIG5ld0RhdGE6IFQgfCB1bmRlZmluZWQsIC4uLmFyZ3M6IGFueVtdKTogUHJvbWlzZTxGaWxlc3lzdGVtUGF0aFtdPjtcbiAgLyogVXBkYXRlcyBnaXZlbiBvYmplY3QgYW5kIHJldHVybnMgYSBsaXN0IG9mIGZpbGVzeXN0ZW0gcGF0aHMgdGhhdCBjb3VsZCBiZSBhZmZlY3RlZC5cbiAgICAgSWYgYG5ld0RhdGFgIGlzIHVuZGVmaW5lZCwgdGhlIG9iamVjdCBpcyBleHBlY3RlZCB0byBiZSBkZWxldGVkLiAqL1xuXG5cbiAgLy8gVE9ETzogRm9sbG93aW5nIHR3byBjYW4gYmUgcmVuYW1lZCBmb3IgY2xhcml0eS5cblxuICBleHBhbmRQYXRoKG9iaklEOiBzdHJpbmcpOiBzdHJpbmc7XG4gIC8qIFJldHVybnMgYW4gYWJzb2x1dGUgcGF0aCB0byBvYmplY3QgZmlsZSBvciByb290IGRpcmVjdG9yeSxcbiAgICAgZ2l2ZW4gb2JqZWN0IElELiBBZGRzIGFuIGV4dGVuc2lvbiB3aGVyZSBhcHBsaWNhYmxlLlxuICAgICBVc2VkIGJ5IHJlYWQoKSwgd3JpdGUoKSB1bmRlciB0aGUgaG9vZC4gVE9ETzogU2hvdWxkIGJlIG1hZGUgcHJpdmF0ZT8gKi9cblxuICBleGlzdHMob2JqSUQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj47XG4gIC8qIEdpdmVuIG9iamVjdCBJRCwgcmV0dXJucyB0cnVlIGlmIHRoZSBvYmplY3QgYWN0dWFsbHkgZXhpc3RzLlxuICAgICBVc2VkIHdoZW4gc3RvcmluZyBlLmcuIHRvIGF2b2lkIG92ZXJ3cml0aW5nIGFuIGV4aXN0aW5nIG9iamVjdC4gKi9cblxuICBpc1ZhbGlkSUQoZmlsZXBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj47XG4gIC8qIEdpdmVuIGEgcGF0aCwgcmV0dXJucyB0cnVlIGlmIGl0IGxvb2tzIGxpa2UgYSB2YWxpZCBvYmplY3QgSUQuXG5cbiAgICAgVGhpcyBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIGZvciB3ZWVkaW5nIG91dCByYW5kb20gZmlsZXNcbiAgICAgdGhhdCBhcmUgbm90IHBhcnQgb2YgdGhlIGRhdGFiYXNlLCBlLmcuIHN5c3RlbSBmaWxlcy9kaXJlY3RvcmllcyxcbiAgICAgd2hlbiBsb2FkaW5nIG9iamVjdHMgZnJvbSBmaWxlc3lzdGVtLlxuXG4gICAgIFRoaXMgY2FuIGJlIGFzIHNpbXBsZSBhcyBjb21wYXJpbmcgdGhlIGV4dGVuc2lvblxuICAgICBidXQgaWYgbmVjZXNzYXJ5IGNhbiBkbyBmdXJ0aGVyIGNoZWNrcyBvbiBmaWxlL2RpcmVjdG9yeSBjb250ZW50cy4gKi9cblxuICBwYXJzZURhdGEoY29udGVudHM6IHN0cmluZyk6IFQ7XG4gIC8qIEdpdmVuIHN0cmluZyBjb250ZW50cywgcmV0dXJucyB0aGUgb2JqZWN0IG9mIGV4cGVlY3RlZCB0eXBlXG4gICAgIChlLmcuLCBkZWNvZGluZyBzZXJpYWxpemVkIGZvcm1hdCkuICovXG59XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFic3RyYWN0TG9ja2luZ0ZpbGVzeXN0ZW1XcmFwcGVyPFQ+IGltcGxlbWVudHMgRmlsZXN5c3RlbVdyYXBwZXI8VD4ge1xuICAvKiBCYXNpYyBmaWxlc3lzdGVtIGJhY2tlbmQgYXJvdW5kIE5vZGUuanMgZnMtZXh0cmEsXG4gICAgIHByb3ZpZGluZyBzdHViIG1ldGhvZHMgZm9yIHBhcnNpbmcvZHVtcGluZyBkYXRhIGZyb20vdG8gcmF3IHN0cmluZyBmaWxlIGNvbnRlbnRzXG4gICAgIGFuZCBpbXBsZW1lbnRpbmcgbG9ja2luZyBhcm91bmQgZmlsZSByZWFkcy93cml0ZXNcbiAgICAgKGxvY2tzIGJhc2VkIG9uIGZpbGUgcGF0aCwgc28gdGhhdCBpdCBjYW5ub3QgYmUgd3JpdHRlbiB0byB3aGlsZSBpdOKAmXMgYmVpbmcgcmVhZCBmcm9tL3dyaXR0ZW4gdG8pLlxuICAqL1xuXG4gIHByaXZhdGUgZmlsZUFjY2Vzc0xvY2s6IEFzeW5jTG9jaztcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgYmFzZURpcjogc3RyaW5nKSB7XG4gICAgdGhpcy5maWxlQWNjZXNzTG9jayA9IG5ldyBBc3luY0xvY2soeyBtYXhQZW5kaW5nOiAxMDAwMDAgfSk7XG4gIH1cblxuICBwdWJsaWMgZXhwYW5kUGF0aChvYmpJRDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLmJhc2VEaXIsIG9iaklEKTtcbiAgfVxuXG4gIHB1YmxpYyBtYWtlUmVsYXRpdmVQYXRoKGFic1BhdGg6IHN0cmluZykge1xuICAgIGlmIChwYXRoLmlzQWJzb2x1dGUoYWJzUGF0aCkpIHtcbiAgICAgIHJldHVybiBwYXRoLnJlbGF0aXZlKHRoaXMuYmFzZURpciwgYWJzUGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkV4cGVjdGluZyBhbiBhYnNvbHV0ZSBwYXRoLCBidXQgZ290IHJlbGF0aXZlXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpc1ZhbGlkSUQodmFsdWU6IHN0cmluZykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RJRHMocXVlcnk6IHsgc3ViZGlyPzogc3RyaW5nIH0sIC4uLmxpc3RBcmc6IGFueVtdKSB7XG4gICAgY29uc3QgZGlyID0gcXVlcnkuc3ViZGlyID8gcGF0aC5qb2luKHRoaXMuYmFzZURpciwgcXVlcnkuc3ViZGlyKSA6IHRoaXMuYmFzZURpcjtcblxuICAgIGNvbnN0IHBvdGVudGlhbElEcyA9IChhd2FpdCBmcy5yZWFkZGlyKGRpcikpO1xuICAgIHZhciBpZHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBtYXliZUlEIG9mIHBvdGVudGlhbElEcykge1xuICAgICAgaWYgKGF3YWl0IHRoaXMuaXNWYWxpZElEKG1heWJlSUQpKSB7XG4gICAgICAgIGlkcy5wdXNoKG1heWJlSUQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaWRzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWRBbGwocXVlcnk6IHsgc3ViZGlyPzogc3RyaW5nLCBvbmx5SURzPzogc3RyaW5nW10gfSwgLi4ucmVhZEFyZ3M6IGFueVtdKSB7XG4gICAgdmFyIG9iaklEcyA9IGF3YWl0IHRoaXMubGlzdElEcyhxdWVyeSk7XG5cbiAgICBpZiAocXVlcnkub25seUlEcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvYmpJRHMgPSBvYmpJRHMuZmlsdGVyKGlkID0+IHF1ZXJ5Lm9ubHlJRHM/LmluY2x1ZGVzKGlkKSk7XG4gICAgfVxuXG4gICAgdmFyIG9ianMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IG9iaklEIG9mIG9iaklEcykge1xuICAgICAgb2Jqcy5wdXNoKGF3YWl0IHRoaXMucmVhZChvYmpJRCwgLi4ucmVhZEFyZ3MpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb2JqcztcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBleGlzdHMob2JqSUQ6IHN0cmluZykge1xuICAgIHJldHVybiBhd2FpdCBmcy5wYXRoRXhpc3RzKHRoaXMuZXhwYW5kUGF0aChvYmpJRCkpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWQob2JqSUQ6IHN0cmluZywgLi4uYXJnczogYW55W10pIHtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuZXhwYW5kUGF0aChvYmpJRCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmlsZUFjY2Vzc0xvY2suYWNxdWlyZShmaWxlUGF0aCwgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VEYXRhKGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoLCB7IGVuY29kaW5nOiAndXRmOCcgfSkpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHdyaXRlKG9iaklEOiBzdHJpbmcsIG5ld0NvbnRlbnRzOiBUIHwgdW5kZWZpbmVkLCAuLi5hcmdzOiBhbnlbXSkge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5leHBhbmRQYXRoKG9iaklEKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maWxlQWNjZXNzTG9jay5hY3F1aXJlKGZpbGVQYXRoLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmcy5lbnN1cmVEaXIocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSk7XG4gICAgICBpZiAobmV3Q29udGVudHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZVBhdGgsIHRoaXMuZHVtcERhdGEobmV3Q29udGVudHMpLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCBmcy5yZW1vdmUoZmlsZVBhdGgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFt0aGlzLm1ha2VSZWxhdGl2ZVBhdGgoZmlsZVBhdGgpXTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhYnN0cmFjdCBwYXJzZURhdGEoY29udGVudHM6IHN0cmluZyk6IFRcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZHVtcERhdGEoZGF0YTogVCk6IHN0cmluZ1xuXG59XG4iXX0=