/* Wraps IPC communication in React hooks & locking queue. */
import AsyncLock from 'async-lock';
import * as log from 'electron-log';
import { ipcRenderer } from 'electron';
import { useEffect, useState } from 'react';
import { reviveJsonValue } from './utils';
ipcRenderer.setMaxListeners(50);
;
class IPCFailure extends Error {
    constructor(errorMessageList) {
        super(errorMessageList.join('; '));
        this.errorMessageList = errorMessageList;
        Object.setPrototypeOf(this, new.target.prototype);
    }
}
const ipcEndpointRequestLock = new AsyncLock({ maxPending: 1000 });
export function useIPCEvent(endpointName, handler, memoizeArguments = []) {
    /* Sets up main -> renderer event listener & cleanup on component destruction. */
    function handleEvent(evt, payload) {
        log.silly("C/ipc/useIPCEvent: Handling IPC event", endpointName, payload);
        handler(payload);
    }
    useEffect(() => {
        ipcRenderer.on(endpointName, handleEvent);
        return function cleanup() {
            ipcRenderer.removeListener(endpointName, handleEvent);
        };
    }, memoizeArguments);
}
export function useIPCValue(endpointName, initialValue, payload) {
    /* Invokes an endpoint and provides result state in the form of a hook.
       State can be updated by calling `refresh()`. */
    const [value, updateValue] = useState(initialValue);
    const [errors, updateErrors] = useState([]);
    const [isUpdating, setUpdating] = useState(true);
    const [reqCounter, updateReqCounter] = useState(0);
    const payloadSnapshot = JSON.stringify(payload || {});
    useEffect(() => {
        let cancelled = false;
        async function doQuery() {
            setUpdating(true);
            const resp = await ipcRenderer.invoke(endpointName, payloadSnapshot);
            const data = JSON.parse(resp, reviveJsonValue);
            if (cancelled) {
                return;
            }
            if (data.errors !== undefined) {
                const resp = data;
                if (resp.result === undefined) {
                    if (resp.errors.length > 0) {
                        updateErrors(resp.errors);
                    }
                    else {
                        updateErrors(["Unknown error"]);
                    }
                    updateValue(initialValue);
                }
                else {
                    updateErrors([]);
                    updateValue(data.result);
                }
            }
            else {
                updateValue(data);
            }
            setUpdating(false);
        }
        ;
        doQuery();
        return () => {
            cancelled = true;
        };
    }, [endpointName, reqCounter, payloadSnapshot]);
    return {
        value: value,
        errors: errors,
        isUpdating: isUpdating,
        refresh: () => updateReqCounter(counter => { return counter += 1; }),
        _reqCounter: reqCounter,
    };
}
export async function callIPC(endpointName, payload) {
    return ipcEndpointRequestLock.acquire(endpointName, async function () {
        const rawData = await ipcRenderer.invoke(endpointName, JSON.stringify(payload));
        return new Promise((resolve, reject) => {
            const data = JSON.parse(rawData, reviveJsonValue);
            if (data.errors !== undefined) {
                // Means main is using listen(), new API
                const resp = data;
                if (resp.result === undefined) {
                    if (resp.errors.length > 0) {
                        reject(new IPCFailure(resp.errors));
                    }
                    else {
                        reject(new IPCFailure(["Unknown error"]));
                    }
                }
                resolve(data.result);
            }
            else {
                // Means main is using makeEndpoint(), legacy API
                const result = data;
                resolve(result);
            }
        });
    });
}
export async function relayIPCEvent(payload) {
    return await callIPC('relay-event-to-all-windows', payload);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaXBjL3JlbmRlcmVyLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw2REFBNkQ7QUFFN0QsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sS0FBSyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdkMsT0FBTyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFFNUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUcxQyxXQUFXLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBYy9CLENBQUM7QUFFRixNQUFNLFVBQVcsU0FBUSxLQUFLO0lBQzVCLFlBQW1CLGdCQUEwQjtRQUMzQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFEbEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFVO1FBRTNDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDcEQsQ0FBQztDQUNGO0FBR0QsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLFNBQVMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBR25FLE1BQU0sVUFBVSxXQUFXLENBQzFCLFlBQW9CLEVBQUUsT0FBNkIsRUFBRSxtQkFBMEIsRUFBRTtJQUNoRixpRkFBaUY7SUFFakYsU0FBUyxXQUFXLENBQUMsR0FBbUIsRUFBRSxPQUFVO1FBQ2xELEdBQUcsQ0FBQyxLQUFLLENBQUMsdUNBQXVDLEVBQUUsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQsU0FBUyxDQUFD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aWNhdGlvbiBpbiBSZWFjdCBob29rcyAmIGxvY2tpbmcgcXVldWUuICovXG5cbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcbmltcG9ydCB7IGlwY1JlbmRlcmVyIH0gZnJvbSAnZWxlY3Ryb24nO1xuaW1wb3J0IHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgcmV2aXZlSnNvblZhbHVlIH0gZnJvbSAnLi91dGlscyc7XG5cblxuaXBjUmVuZGVyZXIuc2V0TWF4TGlzdGVuZXJzKDUwKTtcblxuXG5pbnRlcmZhY2UgSVBDSG9vazxUPiB7XG4gIHZhbHVlOiBUXG4gIGVycm9yczogc3RyaW5nW11cbiAgaXNVcGRhdGluZzogYm9vbGVhblxuICByZWZyZXNoOiAoKSA9PiB2b2lkXG4gIF9yZXFDb3VudGVyOiBudW1iZXJcbn1cblxuaW50ZXJmYWNlIElQQ1Jlc3BvbnNlPE8+IHtcbiAgZXJyb3JzOiBzdHJpbmdbXVxuICByZXN1bHQ6IE8gfCB1bmRlZmluZWRcbn07XG5cbmNsYXNzIElQQ0ZhaWx1cmUgZXh0ZW5kcyBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlcnJvck1lc3NhZ2VMaXN0OiBzdHJpbmdbXSkge1xuICAgIHN1cGVyKGVycm9yTWVzc2FnZUxpc3Quam9pbignOyAnKSk7XG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIG5ldy50YXJnZXQucHJvdG90eXBlKTtcbiAgfVxufVxuXG5cbmNvbnN0IGlwY0VuZHBvaW50UmVxdWVzdExvY2sgPSBuZXcgQXN5bmNMb2NrKHsgbWF4UGVuZGluZzogMTAwMCB9KTtcblxuXG5leHBvcnQgZnVuY3Rpb24gdXNlSVBDRXZlbnQ8UCBleHRlbmRzIG9iamVjdD5cbihlbmRwb2ludE5hbWU6IHN0cmluZywgaGFuZGxlcjogKHBheWxvYWQ6IFApID0+IHZvaWQsIG1lbW9pemVBcmd1bWVudHM6IGFueVtdID0gW10pIHtcbiAgLyogU2V0cyB1cCBtYWluIC0+IHJlbmRlcmVyIGV2ZW50IGxpc3RlbmVyICYgY2xlYW51cCBvbiBjb21wb25lbnQgZGVzdHJ1Y3Rpb24uICovXG5cbiAgZnVuY3Rpb24gaGFuZGxlRXZlbnQoZXZ0OiBFbGVjdHJvbi5FdmVudCwgcGF5bG9hZDogUCkge1xuICAgIGxvZy5zaWxseShcIkMvaXBjL3VzZUlQQ0V2ZW50OiBIYW5kbGluZyBJUEMgZXZlbnRcIiwgZW5kcG9pbnROYW1lLCBwYXlsb2FkKTtcbiAgICBoYW5kbGVyKHBheWxvYWQpO1xuICB9XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpcGNSZW5kZXJlci5vbihlbmRwb2ludE5hbWUsIGhhbmRsZUV2ZW50KTtcbiAgICByZXR1cm4gZnVuY3Rpb24gY2xlYW51cCgpIHtcbiAgICAgIGlwY1JlbmRlcmVyLnJlbW92ZUxpc3RlbmVyKGVuZHBvaW50TmFtZSwgaGFuZGxlRXZlbnQpO1xuICAgIH1cbiAgfSwgbWVtb2l6ZUFyZ3VtZW50cyk7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZUlQQ1ZhbHVlPEkgZXh0ZW5kcyBvYmplY3QsIE8+XG4oZW5kcG9pbnROYW1lOiBzdHJpbmcsIGluaXRpYWxWYWx1ZTogTywgcGF5bG9hZD86IEkpOiBJUENIb29rPE8+IHtcbiAgLyogSW52b2tlcyBhbiBlbmRwb2ludCBhbmQgcHJvdmlkZXMgcmVzdWx0IHN0YXRlIGluIHRoZSBmb3JtIG9mIGEgaG9vay5cbiAgICAgU3RhdGUgY2FuIGJlIHVwZGF0ZWQgYnkgY2FsbGluZyBgcmVmcmVzaCgpYC4gKi9cblxuICBjb25zdCBbdmFsdWUsIHVwZGF0ZVZhbHVlXSA9IHVzZVN0YXRlKGluaXRpYWxWYWx1ZSk7XG4gIGNvbnN0IFtlcnJvcnMsIHVwZGF0ZUVycm9yc10gPSB1c2VTdGF0ZShbXSBhcyBzdHJpbmdbXSk7XG4gIGNvbnN0IFtpc1VwZGF0aW5nLCBzZXRVcGRhdGluZ10gPSB1c2VTdGF0ZSh0cnVlKTtcblxuICBjb25zdCBbcmVxQ291bnRlciwgdXBkYXRlUmVxQ291bnRlcl0gPSB1c2VTdGF0ZSgwKTtcbiAgY29uc3QgcGF5bG9hZFNuYXBzaG90ID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCB8fCB7fSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBsZXQgY2FuY2VsbGVkID0gZmFsc2U7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBkb1F1ZXJ5KCkge1xuICAgICAgc2V0VXBkYXRpbmcodHJ1ZSk7XG5cbiAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBpcGNSZW5kZXJlci5pbnZva2UoZW5kcG9pbnROYW1lLCBwYXlsb2FkU25hcHNob3QpO1xuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UocmVzcCwgcmV2aXZlSnNvblZhbHVlKTtcblxuICAgICAgaWYgKGNhbmNlbGxlZCkgeyByZXR1cm47IH1cblxuICAgICAgaWYgKGRhdGEuZXJyb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29uc3QgcmVzcCA9IGRhdGEgYXMgSVBDUmVzcG9uc2U8Tz47XG5cbiAgICAgICAgaWYgKHJlc3AucmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBpZiAocmVzcC5lcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdXBkYXRlRXJyb3JzKHJlc3AuZXJyb3JzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXBkYXRlRXJyb3JzKFtcIlVua25vd24gZXJyb3JcIl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICB1cGRhdGVWYWx1ZShpbml0aWFsVmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHVwZGF0ZUVycm9ycyhbXSk7XG4gICAgICAgICAgdXBkYXRlVmFsdWUoZGF0YS5yZXN1bHQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB1cGRhdGVWYWx1ZShkYXRhIGFzIE8pO1xuICAgICAgfVxuXG4gICAgICBzZXRVcGRhdGluZyhmYWxzZSk7XG4gICAgfTtcblxuICAgIGRvUXVlcnkoKTtcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjYW5jZWxsZWQgPSB0cnVlO1xuICAgIH1cblxuICB9LCBbZW5kcG9pbnROYW1lLCByZXFDb3VudGVyLCBwYXlsb2FkU25hcHNob3RdKTtcblxuICByZXR1cm4ge1xuICAgIHZhbHVlOiB2YWx1ZSxcbiAgICBlcnJvcnM6IGVycm9ycyxcbiAgICBpc1VwZGF0aW5nOiBpc1VwZGF0aW5nLFxuICAgIHJlZnJlc2g6ICgpID0+IHVwZGF0ZVJlcUNvdW50ZXIoY291bnRlciA9PiB7IHJldHVybiBjb3VudGVyICs9IDEgfSksXG4gICAgX3JlcUNvdW50ZXI6IHJlcUNvdW50ZXIsXG4gIH07XG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbGxJUEM8SSBleHRlbmRzIG9iamVjdCwgTz5cbihlbmRwb2ludE5hbWU6IHN0cmluZywgcGF5bG9hZD86IEkpOiBQcm9taXNlPE8+IHtcbiAgcmV0dXJuIGlwY0VuZHBvaW50UmVxdWVzdExvY2suYWNxdWlyZShlbmRwb2ludE5hbWUsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCByYXdEYXRhID0gYXdhaXQgaXBjUmVuZGVyZXIuaW52b2tlKGVuZHBvaW50TmFtZSwgSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxPPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyYXdEYXRhLCByZXZpdmVKc29uVmFsdWUpO1xuICAgICAgaWYgKGRhdGEuZXJyb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gTWVhbnMgbWFpbiBpcyB1c2luZyBsaXN0ZW4oKSwgbmV3IEFQSVxuICAgICAgICBjb25zdCByZXNwOiBJUENSZXNwb25zZTxPPiA9IGRhdGE7XG5cbiAgICAgICAgaWYgKHJlc3AucmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBpZiAocmVzcC5lcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBJUENGYWlsdXJlKHJlc3AuZXJyb3JzKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgSVBDRmFpbHVyZShbXCJVbmtub3duIGVycm9yXCJdKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoZGF0YS5yZXN1bHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTWVhbnMgbWFpbiBpcyB1c2luZyBtYWtlRW5kcG9pbnQoKSwgbGVnYWN5IEFQSVxuICAgICAgICBjb25zdCByZXN1bHQ6IE8gPSBkYXRhO1xuICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWxheUlQQ0V2ZW50XG48XG4gIEkgZXh0ZW5kcyBvYmplY3QgPSB7IGV2ZW50TmFtZTogc3RyaW5nLCBldmVudFBheWxvYWQ/OiBhbnkgfSxcbiAgTyA9IHsgc3VjY2VzczogdHJ1ZSB9LFxuPlxuKHBheWxvYWQ6IEkpOiBQcm9taXNlPE8+IHtcbiAgcmV0dXJuIGF3YWl0IGNhbGxJUEM8SSwgTz4oJ3JlbGF5LWV2ZW50LXRvLWFsbC13aW5kb3dzJywgcGF5bG9hZCk7XG59XG4iXX0=