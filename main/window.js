import * as path from 'path';
import { format as formatUrl } from 'url';
import { BrowserWindow, Menu } from 'electron';
const isDevelopment = process.env.NODE_ENV !== 'production';
const isMacOS = process.platform === 'darwin';
// Keeps track of windows and ensures (?) they do not get garbage collected
export var windows = [];
// Allows to locate window ID by label
var windowsByTitle = {};
export const openWindow = async ({ title, url, component, componentParams, dimensions, frameless, winParams, menuTemplate, ignoreCache, showWhileLoading, config }) => {
    if ((component || '').trim() === '' && (url || '').trim() === '') {
        throw new Error("openWindow() requires either `component` or `url`");
    }
    const _existingWindow = getWindowByTitle(title);
    if (_existingWindow !== undefined) {
        _existingWindow.show();
        _existingWindow.focus();
        return _existingWindow;
    }
    const _framelessOpts = {
        titleBarStyle: isMacOS ? 'hiddenInset' : undefined,
    };
    const _winParams = Object.assign(Object.assign({ width: (dimensions || {}).width, minWidth: (dimensions || {}).minWidth, height: (dimensions || {}).height, minHeight: (dimensions || {}).minHeight }, (frameless === true ? _framelessOpts : {})), winParams);
    let window;
    if (component) {
        const params = `c=${component}&${componentParams ? componentParams : ''}`;
        window = await createWindowForLocalComponent(title, params, _winParams, showWhileLoading === true, config.forceDevelopmentMode || false);
    }
    else if (url) {
        window = await createWindow(title, url, _winParams, showWhileLoading === true, ignoreCache);
    }
    else {
        throw new Error("Either component or url must be given to openWindow()");
    }
    if (menuTemplate && !isMacOS) {
        window.setMenu(Menu.buildFromTemplate(menuTemplate));
    }
    windows.push(window);
    windowsByTitle[title] = window;
    window.on('closed', () => { delete windowsByTitle[title]; cleanUpWindows(); });
    return window;
};
export function getWindowByTitle(title) {
    return windowsByTitle[title];
}
export function closeWindow(title) {
    const win = getWindowByTitle(title);
    if (win !== undefined) {
        win.close();
    }
}
export function getWindow(func) {
    return windows.find(func);
}
// Iterate over array of windows and try accessing window ID.
// If it throws, window was closed and we remove it from the array.
// Supposed to be run after any window is closed
function cleanUpWindows() {
    var deletedWindows = [];
    for (const [idx, win] of windows.entries()) {
        // When accessing the id attribute of a closed window,
        // it’ll throw. We’ll mark its index for deletion then.
        try {
            win.id;
        }
        catch (e) {
            deletedWindows.push(idx - deletedWindows.length);
        }
    }
    for (const idx of deletedWindows) {
        windows.splice(idx, 1);
    }
}
async function createWindowForLocalComponent(title, params, winParams, showWhileLoading, forceDebug) {
    let url;
    if (isDevelopment) {
        url = `http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}?${params}`;
    }
    else {
        url = `${formatUrl({
            pathname: path.join(__dirname, 'index.html'),
            protocol: 'file',
            slashes: true,
        })}?${params}`;
    }
    const window = await createWindow(title, url, winParams, showWhileLoading, forceDebug || isDevelopment);
    if (forceDebug || isDevelopment) {
        window.webContents.on('devtools-opened', () => {
            window.focus();
            setImmediate(() => {
                window.focus();
            });
        });
        window.webContents.openDevTools();
    }
    return window;
}
async function createWindow(title, url, winParams, showWhileLoading, debug = false) {
    const window = new BrowserWindow(Object.assign({ webPreferences: { nodeIntegration: true, webSecurity: !debug }, title: title, show: showWhileLoading === true }, winParams));
    const promise = new Promise((resolve, reject) => {
        window.once('ready-to-show', () => {
            if (showWhileLoading !== true) {
                window.show();
            }
            resolve(window);
        });
    });
    if (debug) {
        window.loadURL(url, { 'extraHeaders': 'pragma: no-cache\n' });
    }
    else {
        window.loadURL(url);
    }
    return promise;
}
export async function notifyAllWindows(eventName, payload) {
    await Promise.all(windows.map(async (window) => {
        if (window) {
            await window.webContents.send(eventName, payload);
        }
        return;
    }));
}
export async function notifyWindow(windowTitle, eventName, payload) {
    const window = getWindowByTitle(windowTitle);
    if (window) {
        await window.webContents.send(eventName, payload);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21haW4vd2luZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFBO0FBQzVCLE9BQU8sRUFBRSxNQUFNLElBQUksU0FBUyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUE4QixNQUFNLFVBQVUsQ0FBQztBQUszRSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLENBQUM7QUFDNUQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUM7QUFFOUMsMkVBQTJFO0FBQzNFLE1BQU0sQ0FBQyxJQUFJLE9BQU8sR0FBb0IsRUFBRSxDQUFDO0FBRXpDLHNDQUFzQztBQUN0QyxJQUFJLGNBQWMsR0FBdUMsRUFBRSxDQUFDO0FBeUI1RCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQWlCLEtBQUssRUFBRSxFQUMzQyxLQUFLLEVBQ0wsR0FBRyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQy9CLFVBQVUsRUFBRSxTQUFTLEVBQ3JCLFNBQVMsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUNwQyxnQkFBZ0IsRUFDaEIsTUFBTSxFQUFFLEVBQUUsRUFBRTtJQUVkLElBQUksQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNoRSxNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7S0FDdEU7SUFFRCxNQUFNLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoRCxJQUFJLGVBQWUsS0FBSyxTQUFTLEVBQUU7UUFDakMsZUFBZSxDQUFDLElB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TSxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDbkQ7UUFDRCxPQUFPO0lBQ1QsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNOLENBQUM7QUFHRCxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVksQ0FBQyxXQUFtQixFQUFFLFNBQWlCLEVBQUUsT0FBYTtJQUN0RixNQUFNLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM3QyxJQUFJLE1BQU0sRUFBRTtRQUNWLE1BQU0sTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ25EO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCB7IGZvcm1hdCBhcyBmb3JtYXRVcmwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgQnJvd3NlcldpbmRvdywgTWVudSwgTWVudUl0ZW1Db25zdHJ1Y3Rvck9wdGlvbnMgfSBmcm9tICdlbGVjdHJvbic7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9hcHAnO1xuXG5cbmNvbnN0IGlzRGV2ZWxvcG1lbnQgPSBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nO1xuY29uc3QgaXNNYWNPUyA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICdkYXJ3aW4nO1xuXG4vLyBLZWVwcyB0cmFjayBvZiB3aW5kb3dzIGFuZCBlbnN1cmVzICg/KSB0aGV5IGRvIG5vdCBnZXQgZ2FyYmFnZSBjb2xsZWN0ZWRcbmV4cG9ydCB2YXIgd2luZG93czogQnJvd3NlcldpbmRvd1tdID0gW107XG5cbi8vIEFsbG93cyB0byBsb2NhdGUgd2luZG93IElEIGJ5IGxhYmVsXG52YXIgd2luZG93c0J5VGl0bGU6IHsgW3RpdGxlOiBzdHJpbmddOiBCcm93c2VyV2luZG93IH0gPSB7fTtcblxuXG4vLyBPcGVuIG5ldyB3aW5kb3csIG9yIGZvY3VzIGlmIG9uZSB3aXRoIHRoZSBzYW1lIHRpdGxlIGFscmVhZHkgZXhpc3RzXG5leHBvcnQgaW50ZXJmYWNlIFdpbmRvd09wZW5lclBhcmFtcyB7XG4gIHRpdGxlOiBzdHJpbmdcbiAgdXJsPzogc3RyaW5nXG4gIGNvbXBvbmVudD86IHN0cmluZ1xuICBjb21wb25lbnRQYXJhbXM/OiBzdHJpbmdcbiAgZGltZW5zaW9ucz86IHtcbiAgICBtaW5IZWlnaHQ/OiBudW1iZXJcbiAgICBtaW5XaWR0aD86IG51bWJlclxuICAgIGhlaWdodD86IG51bWJlclxuICAgIHdpZHRoPzogbnVtYmVyXG4gICAgbWF4SGVpZ2h0PzogbnVtYmVyXG4gICAgbWF4V2lkdGg/OiBudW1iZXJcbiAgfVxuICBmcmFtZWxlc3M/OiBib29sZWFuXG4gIHdpblBhcmFtcz86IGFueVxuICBtZW51VGVtcGxhdGU/OiBNZW51SXRlbUNvbnN0cnVjdG9yT3B0aW9uc1tdXG4gIGlnbm9yZUNhY2hlPzogYm9vbGVhblxuICBzaG93V2hpbGVMb2FkaW5nPzogYm9vbGVhblxuICBjb25maWc6IEFwcENvbmZpZ1xufVxuZXhwb3J0IHR5cGUgV2luZG93T3BlbmVyID0gKHByb3BzOiBXaW5kb3dPcGVuZXJQYXJhbXMpID0+IFByb21pc2U8QnJvd3NlcldpbmRvdz47XG5leHBvcnQgY29uc3Qgb3BlbldpbmRvdzogV2luZG93T3BlbmVyID0gYXN5bmMgKHtcbiAgICB0aXRsZSxcbiAgICB1cmwsIGNvbXBvbmVudCwgY29tcG9uZW50UGFyYW1zLFxuICAgIGRpbWVuc2lvbnMsIGZyYW1lbGVzcyxcbiAgICB3aW5QYXJhbXMsIG1lbnVUZW1wbGF0ZSwgaWdub3JlQ2FjaGUsXG4gICAgc2hvd1doaWxlTG9hZGluZyxcbiAgICBjb25maWcgfSkgPT4ge1xuXG4gIGlmICgoY29tcG9uZW50IHx8ICcnKS50cmltKCkgPT09ICcnICYmICh1cmwgfHwgJycpLnRyaW0oKSA9PT0gJycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJvcGVuV2luZG93KCkgcmVxdWlyZXMgZWl0aGVyIGBjb21wb25lbnRgIG9yIGB1cmxgXCIpO1xuICB9XG5cbiAgY29uc3QgX2V4aXN0aW5nV2luZG93ID0gZ2V0V2luZG93QnlUaXRsZSh0aXRsZSk7XG4gIGlmIChfZXhpc3RpbmdXaW5kb3cgIT09IHVuZGVmaW5lZCkge1xuICAgIF9leGlzdGluZ1dpbmRvdy5zaG93KCk7XG4gICAgX2V4aXN0aW5nV2luZG93LmZvY3VzKCk7XG4gICAgcmV0dXJuIF9leGlzdGluZ1dpbmRvdztcbiAgfVxuXG4gIGNvbnN0IF9mcmFtZWxlc3NPcHRzID0ge1xuICAgIHRpdGxlQmFyU3R5bGU6IGlzTWFjT1MgPyAnaGlkZGVuSW5zZXQnIDogdW5kZWZpbmVkLFxuICB9O1xuXG4gIGNvbnN0IF93aW5QYXJhbXMgPSB7XG4gICAgd2lkdGg6IChkaW1lbnNpb25zIHx8IHt9KS53aWR0aCxcbiAgICBtaW5XaWR0aDogKGRpbWVuc2lvbnMgfHwge30pLm1pbldpZHRoLFxuICAgIGhlaWdodDogKGRpbWVuc2lvbnMgfHwge30pLmhlaWdodCxcbiAgICBtaW5IZWlnaHQ6IChkaW1lbnNpb25zIHx8IHt9KS5taW5IZWlnaHQsXG4gICAgLi4uKGZyYW1lbGVzcyA9PT0gdHJ1ZSA/IF9mcmFtZWxlc3NPcHRzIDoge30pLFxuICAgIC4uLndpblBhcmFtcyxcbiAgfTtcblxuICBsZXQgd2luZG93OiBCcm93c2VyV2luZG93O1xuXG4gIGlmIChjb21wb25lbnQpIHtcbiAgICBjb25zdCBwYXJhbXMgPSBgYz0ke2NvbXBvbmVudH0mJHtjb21wb25lbnRQYXJhbXMgPyBjb21wb25lbnRQYXJhbXMgOiAnJ31gO1xuICAgIHdpbmRvdyA9IGF3YWl0IGNyZWF0ZVdpbmRvd0ZvckxvY2FsQ29tcG9uZW50KHRpdGxlLCBwYXJhbXMsIF93aW5QYXJhbXMsIHNob3dXaGlsZUxvYWRpbmcgPT09IHRydWUsIGNvbmZpZy5mb3JjZURldmVsb3BtZW50TW9kZSB8fCBmYWxzZSk7XG4gIH0gZWxzZSBpZiAodXJsKSB7XG4gICAgd2luZG93ID0gYXdhaXQgY3JlYXRlV2luZG93KHRpdGxlLCB1cmwsIF93aW5QYXJhbXMsIHNob3dXaGlsZUxvYWRpbmcgPT09IHRydWUsIGlnbm9yZUNhY2hlKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJFaXRoZXIgY29tcG9uZW50IG9yIHVybCBtdXN0IGJlIGdpdmVuIHRvIG9wZW5XaW5kb3coKVwiKTtcbiAgfVxuXG4gIGlmIChtZW51VGVtcGxhdGUgJiYgIWlzTWFjT1MpIHtcbiAgICB3aW5kb3cuc2V0TWVudShNZW51LmJ1aWxkRnJvbVRlbXBsYXRlKG1lbnVUZW1wbGF0ZSkpO1xuICB9XG5cbiAgd2luZG93cy5wdXNoKHdpbmRvdyk7XG4gIHdpbmRvd3NCeVRpdGxlW3RpdGxlXSA9IHdpbmRvdztcbiAgd2luZG93Lm9uKCdjbG9zZWQnLCAoKSA9PiB7IGRlbGV0ZSB3aW5kb3dzQnlUaXRsZVt0aXRsZV07IGNsZWFuVXBXaW5kb3dzKCk7IH0pO1xuXG4gIHJldHVybiB3aW5kb3c7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdpbmRvd0J5VGl0bGUodGl0bGU6IHN0cmluZyk6IEJyb3dzZXJXaW5kb3cgfCB1bmRlZmluZWQge1xuICByZXR1cm4gd2luZG93c0J5VGl0bGVbdGl0bGVdO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBjbG9zZVdpbmRvdyh0aXRsZTogc3RyaW5nKSB7XG4gIGNvbnN0IHdpbiA9IGdldFdpbmRvd0J5VGl0bGUodGl0bGUpO1xuICBpZiAod2luICE9PSB1bmRlZmluZWQpIHtcbiAgICB3aW4uY2xvc2UoKTtcbiAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRXaW5kb3coZnVuYzogKHdpbjogQnJvd3NlcldpbmRvdykgPT4gYm9vbGVhbik6IEJyb3dzZXJXaW5kb3cgfCB1bmRlZmluZWQge1xuICByZXR1cm4gd2luZG93cy5maW5kKGZ1bmMpO1xufVxuXG5cbi8vIEl0ZXJhdGUgb3ZlciBhcnJheSBvZiB3aW5kb3dzIGFuZCB0cnkgYWNjZXNzaW5nIHdpbmRvdyBJRC5cbi8vIElmIGl0IHRocm93cywgd2luZG93IHdhcyBjbG9zZWQgYW5kIHdlIHJlbW92ZSBpdCBmcm9tIHRoZSBhcnJheS5cbi8vIFN1cHBvc2VkIHRvIGJlIHJ1biBhZnRlciBhbnkgd2luZG93IGlzIGNsb3NlZFxuZnVuY3Rpb24gY2xlYW5VcFdpbmRvd3MoKSB7XG4gIHZhciBkZWxldGVkV2luZG93czogbnVtYmVyW10gPSBbXTtcbiAgZm9yIChjb25zdCBbaWR4LCB3aW5dIG9mIHdpbmRvd3MuZW50cmllcygpKSB7XG4gICAgLy8gV2hlbiBhY2Nlc3NpbmcgdGhlIGlkIGF0dHJpYnV0ZSBvZiBhIGNsb3NlZCB3aW5kb3csXG4gICAgLy8gaXTigJlsbCB0aHJvdy4gV2XigJlsbCBtYXJrIGl0cyBpbmRleCBmb3IgZGVsZXRpb24gdGhlbi5cbiAgICB0cnkge1xuICAgICAgd2luLmlkO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGRlbGV0ZWRXaW5kb3dzLnB1c2goaWR4IC0gZGVsZXRlZFdpbmRvd3MubGVuZ3RoKTtcbiAgICB9XG4gIH1cbiAgZm9yIChjb25zdCBpZHggb2YgZGVsZXRlZFdpbmRvd3MpIHtcbiAgICB3aW5kb3dzLnNwbGljZShpZHgsIDEpO1xuICB9XG59XG5cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlV2luZG93Rm9yTG9jYWxDb21wb25lbnQoXG4gICAgdGl0bGU6IHN0cmluZyxcbiAgICBwYXJhbXM6IHN0cmluZyxcbiAgICB3aW5QYXJhbXM6IGFueSxcbiAgICBzaG93V2hpbGVMb2FkaW5nOiBib29sZWFuLFxuICAgIGZvcmNlRGVidWc6IGJvb2xlYW4pOiBQcm9taXNlPEJyb3dzZXJXaW5kb3c+IHtcblxuICBsZXQgdXJsOiBzdHJpbmc7XG5cbiAgaWYgKGlzRGV2ZWxvcG1lbnQpIHtcbiAgICB1cmwgPSBgaHR0cDovL2xvY2FsaG9zdDoke3Byb2Nlc3MuZW52LkVMRUNUUk9OX1dFQlBBQ0tfV0RTX1BPUlR9PyR7cGFyYW1zfWA7XG4gIH1cbiAgZWxzZSB7XG4gICAgdXJsID0gYCR7Zm9ybWF0VXJsKHtcbiAgICAgIHBhdGhuYW1lOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnaW5kZXguaHRtbCcpLFxuICAgICAgcHJvdG9jb2w6ICdmaWxlJyxcbiAgICAgIHNsYXNoZXM6IHRydWUsXG4gICAgfSl9PyR7cGFyYW1zfWA7XG4gIH1cblxuICBjb25zdCB3aW5kb3cgPSBhd2FpdCBjcmVhdGVXaW5kb3codGl0bGUsIHVybCwgd2luUGFyYW1zLCBzaG93V2hpbGVMb2FkaW5nLCBmb3JjZURlYnVnIHx8IGlzRGV2ZWxvcG1lbnQpO1xuXG4gIGlmIChmb3JjZURlYnVnIHx8IGlzRGV2ZWxvcG1lbnQpIHtcbiAgICB3aW5kb3cud2ViQ29udGVudHMub24oJ2RldnRvb2xzLW9wZW5lZCcsICgpID0+IHtcbiAgICAgIHdpbmRvdy5mb2N1cygpO1xuICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IHtcbiAgICAgICAgd2luZG93LmZvY3VzKClcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHdpbmRvdy53ZWJDb250ZW50cy5vcGVuRGV2VG9vbHMoKTtcbiAgfVxuXG4gIHJldHVybiB3aW5kb3c7XG59XG5cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlV2luZG93KFxuICAgIHRpdGxlOiBzdHJpbmcsXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgd2luUGFyYW1zOiBhbnksXG4gICAgc2hvd1doaWxlTG9hZGluZzogYm9vbGVhbixcbiAgICBkZWJ1ZzogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxCcm93c2VyV2luZG93PiB7XG5cbiAgY29uc3Qgd2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coe1xuICAgIHdlYlByZWZlcmVuY2VzOiB7IG5vZGVJbnRlZ3JhdGlvbjogdHJ1ZSwgd2ViU2VjdXJpdHk6ICFkZWJ1ZyB9LFxuICAgIHRpdGxlOiB0aXRsZSxcbiAgICBzaG93OiBzaG93V2hpbGVMb2FkaW5nID09PSB0cnVlLFxuICAgIC4uLndpblBhcmFtc1xuICB9KTtcblxuICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2U8QnJvd3NlcldpbmRvdz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHdpbmRvdy5vbmNlKCdyZWFkeS10by1zaG93JywgKCkgPT4ge1xuICAgICAgaWYgKHNob3dXaGlsZUxvYWRpbmcgIT09IHRydWUpIHtcbiAgICAgICAgd2luZG93LnNob3coKTtcbiAgICAgIH1cbiAgICAgIHJlc29sdmUod2luZG93KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaWYgKGRlYnVnKSB7XG4gICAgd2luZG93LmxvYWRVUkwodXJsLCB7J2V4dHJhSGVhZGVycyc6ICdwcmFnbWE6IG5vLWNhY2hlXFxuJ30pO1xuICB9IGVsc2Uge1xuICAgIHdpbmRvdy5sb2FkVVJMKHVybCk7XG4gIH1cblxuICByZXR1cm4gcHJvbWlzZTtcbn1cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbm90aWZ5QWxsV2luZG93cyhldmVudE5hbWU6IHN0cmluZywgcGF5bG9hZD86IGFueSkge1xuICBhd2FpdCBQcm9taXNlLmFsbCh3aW5kb3dzLm1hcChhc3luYyAod2luZG93KSA9PiB7XG4gICAgaWYgKHdpbmRvdykge1xuICAgICAgYXdhaXQgd2luZG93LndlYkNvbnRlbnRzLnNlbmQoZXZlbnROYW1lLCBwYXlsb2FkKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9KSk7XG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG5vdGlmeVdpbmRvdyh3aW5kb3dUaXRsZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgcGF5bG9hZD86IGFueSkge1xuICBjb25zdCB3aW5kb3cgPSBnZXRXaW5kb3dCeVRpdGxlKHdpbmRvd1RpdGxlKTtcbiAgaWYgKHdpbmRvdykge1xuICAgIGF3YWl0IHdpbmRvdy53ZWJDb250ZW50cy5zZW5kKGV2ZW50TmFtZSwgcGF5bG9hZCk7XG4gIH1cbn1cbiJdfQ==