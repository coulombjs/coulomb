import * as path from 'path';
import { format as formatUrl } from 'url';
import { BrowserWindow, Menu } from 'electron';
const isDevelopment = process.env.NODE_ENV !== 'production';
const isMacOS = process.platform === 'darwin';
// Keeps track of windows and ensures (?) they do not get garbage collected
export var windows = [];
// Allows to locate window ID by label
var windowsByTitle = {};
export const openWindow = async ({ title, url, component, componentParams, dimensions, frameless, winParams, menuTemplate, ignoreCache }) => {
    if ((component || '').trim() === '' && (url || '').trim() === '') {
        throw new Error("openWindow() requires either `component` or `url`");
    }
    const _existingWindow = getWindowByTitle(title);
    if (_existingWindow !== undefined) {
        _existingWindow.show();
        _existingWindow.focus();
        return _existingWindow;
    }
    const _framelessOpts = {
        titleBarStyle: isMacOS ? 'hiddenInset' : undefined,
    };
    const _winParams = Object.assign(Object.assign({ width: (dimensions || {}).width, minWidth: (dimensions || {}).minWidth, height: (dimensions || {}).height, minHeight: (dimensions || {}).minHeight }, (frameless === true ? _framelessOpts : {})), winParams);
    let window;
    if (component) {
        const params = `c=${component}&${componentParams ? componentParams : ''}`;
        window = await createWindowForLocalComponent(title, params, _winParams);
    }
    else if (url) {
        window = await createWindow(title, url, _winParams, ignoreCache);
    }
    else {
        throw new Error("Either component or url must be given to openWindow()");
    }
    if (menuTemplate && !isMacOS) {
        window.setMenu(Menu.buildFromTemplate(menuTemplate));
    }
    windows.push(window);
    windowsByTitle[title] = window;
    window.on('closed', () => { delete windowsByTitle[title]; cleanUpWindows(); });
    return window;
};
export function getWindowByTitle(title) {
    return windowsByTitle[title];
}
export function closeWindow(title) {
    const win = getWindowByTitle(title);
    if (win !== undefined) {
        win.close();
    }
}
export function getWindow(func) {
    return windows.find(func);
}
// Iterate over array of windows and try accessing window ID.
// If it throws, window was closed and we remove it from the array.
// Supposed to be run after any window is closed
function cleanUpWindows() {
    var deletedWindows = [];
    for (const [idx, win] of windows.entries()) {
        // When accessing the id attribute of a closed window,
        // it’ll throw. We’ll mark its index for deletion then.
        try {
            win.id;
        }
        catch (e) {
            deletedWindows.push(idx - deletedWindows.length);
        }
    }
    for (const idx of deletedWindows) {
        windows.splice(idx, 1);
    }
}
function createWindowForLocalComponent(title, params, winParams) {
    let url;
    if (isDevelopment) {
        url = `http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}?${params}`;
    }
    else {
        url = `${formatUrl({
            pathname: path.join(__dirname, 'index.html'),
            protocol: 'file',
            slashes: true,
        })}?${params}`;
    }
    return createWindow(title, url, winParams);
}
function createWindow(title, url, winParams, ignoreCache = false) {
    const window = new BrowserWindow(Object.assign({ webPreferences: { nodeIntegration: true }, title: title, show: false }, winParams));
    const promise = new Promise((resolve, reject) => {
        window.once('ready-to-show', () => {
            window.show();
            resolve(window);
        });
    });
    if (isDevelopment) {
        window.webContents.openDevTools();
    }
    if (ignoreCache) {
        window.loadURL(url, { 'extraHeaders': 'pragma: no-cache\n' });
    }
    else {
        window.loadURL(url);
    }
    window.webContents.on('devtools-opened', () => {
        window.focus();
        setImmediate(() => {
            window.focus();
        });
    });
    return promise;
}
export async function notifyAllWindows(eventName, payload) {
    return await Promise.all(windows.map(async (window) => {
        if (window) {
            await window.webContents.send(eventName, payload);
        }
        return;
    }));
}
export async function notifyWindow(windowTitle, eventName, payload) {
    const window = getWindowByTitle(windowTitle);
    if (window) {
        await window.webContents.send(eventName, payload);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21haW4vd2luZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFBO0FBQzVCLE9BQU8sRUFBRSxNQUFNLElBQUksU0FBUyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUE4QixNQUFNLFVBQVUsQ0FBQztBQUczRSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLENBQUM7QUFDNUQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUM7QUFFOUMsMkVBQTJFO0FBQzNFLE1BQU0sQ0FBQyxJQUFJLE9BQU8sR0FBb0IsRUFBRSxDQUFDO0FBRXpDLHNDQUFzQztBQUN0QyxJQUFJLGNBQWMsR0FBdUMsRUFBRSxDQUFDO0FBdUI1RCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQWlCLEtBQUssRUFBRSxFQUMzQyxLQUFLLEVBQ0wsR0FBRyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQy9CLFVBQVUsRUFBRSxTQUFTLEVBQ3JCLFNBQVMsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRTtJQUU1QyxJQUFJLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDaEUsTUFBTSxJQUFJLEtBQUssQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO0tBQ3RFO0lBRUQsTUFBTSxlQUFlLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEQsSUFBSSxlQUFlLEtBQUssU0FBUyxFQUFFO1FBQ2pDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixlQUFl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Q0FBQztLQUNuRDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBmb3JtYXQgYXMgZm9ybWF0VXJsIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IEJyb3dzZXJXaW5kb3csIE1lbnUsIE1lbnVJdGVtQ29uc3RydWN0b3JPcHRpb25zIH0gZnJvbSAnZWxlY3Ryb24nO1xuXG5cbmNvbnN0IGlzRGV2ZWxvcG1lbnQgPSBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nO1xuY29uc3QgaXNNYWNPUyA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICdkYXJ3aW4nO1xuXG4vLyBLZWVwcyB0cmFjayBvZiB3aW5kb3dzIGFuZCBlbnN1cmVzICg/KSB0aGV5IGRvIG5vdCBnZXQgZ2FyYmFnZSBjb2xsZWN0ZWRcbmV4cG9ydCB2YXIgd2luZG93czogQnJvd3NlcldpbmRvd1tdID0gW107XG5cbi8vIEFsbG93cyB0byBsb2NhdGUgd2luZG93IElEIGJ5IGxhYmVsXG52YXIgd2luZG93c0J5VGl0bGU6IHsgW3RpdGxlOiBzdHJpbmddOiBCcm93c2VyV2luZG93IH0gPSB7fTtcblxuXG4vLyBPcGVuIG5ldyB3aW5kb3csIG9yIGZvY3VzIGlmIG9uZSB3aXRoIHRoZSBzYW1lIHRpdGxlIGFscmVhZHkgZXhpc3RzXG5leHBvcnQgaW50ZXJmYWNlIFdpbmRvd09wZW5lclBhcmFtcyB7XG4gIHRpdGxlOiBzdHJpbmcsXG4gIHVybD86IHN0cmluZyxcbiAgY29tcG9uZW50Pzogc3RyaW5nLFxuICBjb21wb25lbnRQYXJhbXM/OiBzdHJpbmcsXG4gIGRpbWVuc2lvbnM/OiB7XG4gICAgbWluSGVpZ2h0PzogbnVtYmVyLFxuICAgIG1pbldpZHRoPzogbnVtYmVyLFxuICAgIGhlaWdodD86IG51bWJlcixcbiAgICB3aWR0aD86IG51bWJlcixcbiAgICBtYXhIZWlnaHQ/OiBudW1iZXIsXG4gICAgbWF4V2lkdGg/OiBudW1iZXIsXG4gIH0sXG4gIGZyYW1lbGVzcz86IGJvb2xlYW4sXG4gIHdpblBhcmFtcz86IGFueSxcbiAgbWVudVRlbXBsYXRlPzogTWVudUl0ZW1Db25zdHJ1Y3Rvck9wdGlvbnNbXSxcbiAgaWdub3JlQ2FjaGU/OiBib29sZWFuLFxufVxuZXhwb3J0IHR5cGUgV2luZG93T3BlbmVyID0gKHByb3BzOiBXaW5kb3dPcGVuZXJQYXJhbXMpID0+IFByb21pc2U8QnJvd3NlcldpbmRvdz47XG5leHBvcnQgY29uc3Qgb3BlbldpbmRvdzogV2luZG93T3BlbmVyID0gYXN5bmMgKHtcbiAgICB0aXRsZSxcbiAgICB1cmwsIGNvbXBvbmVudCwgY29tcG9uZW50UGFyYW1zLFxuICAgIGRpbWVuc2lvbnMsIGZyYW1lbGVzcyxcbiAgICB3aW5QYXJhbXMsIG1lbnVUZW1wbGF0ZSwgaWdub3JlQ2FjaGUgfSkgPT4ge1xuXG4gIGlmICgoY29tcG9uZW50IHx8ICcnKS50cmltKCkgPT09ICcnICYmICh1cmwgfHwgJycpLnRyaW0oKSA9PT0gJycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJvcGVuV2luZG93KCkgcmVxdWlyZXMgZWl0aGVyIGBjb21wb25lbnRgIG9yIGB1cmxgXCIpO1xuICB9XG5cbiAgY29uc3QgX2V4aXN0aW5nV2luZG93ID0gZ2V0V2luZG93QnlUaXRsZSh0aXRsZSk7XG4gIGlmIChfZXhpc3RpbmdXaW5kb3cgIT09IHVuZGVmaW5lZCkge1xuICAgIF9leGlzdGluZ1dpbmRvdy5zaG93KCk7XG4gICAgX2V4aXN0aW5nV2luZG93LmZvY3VzKCk7XG4gICAgcmV0dXJuIF9leGlzdGluZ1dpbmRvdztcbiAgfVxuXG4gIGNvbnN0IF9mcmFtZWxlc3NPcHRzID0ge1xuICAgIHRpdGxlQmFyU3R5bGU6IGlzTWFjT1MgPyAnaGlkZGVuSW5zZXQnIDogdW5kZWZpbmVkLFxuICB9O1xuXG4gIGNvbnN0IF93aW5QYXJhbXMgPSB7XG4gICAgd2lkdGg6IChkaW1lbnNpb25zIHx8IHt9KS53aWR0aCxcbiAgICBtaW5XaWR0aDogKGRpbWVuc2lvbnMgfHwge30pLm1pbldpZHRoLFxuICAgIGhlaWdodDogKGRpbWVuc2lvbnMgfHwge30pLmhlaWdodCxcbiAgICBtaW5IZWlnaHQ6IChkaW1lbnNpb25zIHx8IHt9KS5taW5IZWlnaHQsXG4gICAgLi4uKGZyYW1lbGVzcyA9PT0gdHJ1ZSA/IF9mcmFtZWxlc3NPcHRzIDoge30pLFxuICAgIC4uLndpblBhcmFtcyxcbiAgfTtcblxuICBsZXQgd2luZG93OiBCcm93c2VyV2luZG93O1xuXG4gIGlmIChjb21wb25lbnQpIHtcbiAgICBjb25zdCBwYXJhbXMgPSBgYz0ke2NvbXBvbmVudH0mJHtjb21wb25lbnRQYXJhbXMgPyBjb21wb25lbnRQYXJhbXMgOiAnJ31gO1xuICAgIHdpbmRvdyA9IGF3YWl0IGNyZWF0ZVdpbmRvd0ZvckxvY2FsQ29tcG9uZW50KHRpdGxlLCBwYXJhbXMsIF93aW5QYXJhbXMpO1xuICB9IGVsc2UgaWYgKHVybCkge1xuICAgIHdpbmRvdyA9IGF3YWl0IGNyZWF0ZVdpbmRvdyh0aXRsZSwgdXJsLCBfd2luUGFyYW1zLCBpZ25vcmVDYWNoZSk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRWl0aGVyIGNvbXBvbmVudCBvciB1cmwgbXVzdCBiZSBnaXZlbiB0byBvcGVuV2luZG93KClcIik7XG4gIH1cblxuICBpZiAobWVudVRlbXBsYXRlICYmICFpc01hY09TKSB7XG4gICAgd2luZG93LnNldE1lbnUoTWVudS5idWlsZEZyb21UZW1wbGF0ZShtZW51VGVtcGxhdGUpKTtcbiAgfVxuXG4gIHdpbmRvd3MucHVzaCh3aW5kb3cpO1xuICB3aW5kb3dzQnlUaXRsZVt0aXRsZV0gPSB3aW5kb3c7XG4gIHdpbmRvdy5vbignY2xvc2VkJywgKCkgPT4geyBkZWxldGUgd2luZG93c0J5VGl0bGVbdGl0bGVdOyBjbGVhblVwV2luZG93cygpOyB9KTtcblxuICByZXR1cm4gd2luZG93O1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRXaW5kb3dCeVRpdGxlKHRpdGxlOiBzdHJpbmcpOiBCcm93c2VyV2luZG93IHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIHdpbmRvd3NCeVRpdGxlW3RpdGxlXTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gY2xvc2VXaW5kb3codGl0bGU6IHN0cmluZykge1xuICBjb25zdCB3aW4gPSBnZXRXaW5kb3dCeVRpdGxlKHRpdGxlKTtcbiAgaWYgKHdpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgd2luLmNsb3NlKCk7XG4gIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0V2luZG93KGZ1bmM6ICh3aW46IEJyb3dzZXJXaW5kb3cpID0+IGJvb2xlYW4pOiBCcm93c2VyV2luZG93IHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIHdpbmRvd3MuZmluZChmdW5jKTtcbn1cblxuXG4vLyBJdGVyYXRlIG92ZXIgYXJyYXkgb2Ygd2luZG93cyBhbmQgdHJ5IGFjY2Vzc2luZyB3aW5kb3cgSUQuXG4vLyBJZiBpdCB0aHJvd3MsIHdpbmRvdyB3YXMgY2xvc2VkIGFuZCB3ZSByZW1vdmUgaXQgZnJvbSB0aGUgYXJyYXkuXG4vLyBTdXBwb3NlZCB0byBiZSBydW4gYWZ0ZXIgYW55IHdpbmRvdyBpcyBjbG9zZWRcbmZ1bmN0aW9uIGNsZWFuVXBXaW5kb3dzKCkge1xuICB2YXIgZGVsZXRlZFdpbmRvd3M6IG51bWJlcltdID0gW107XG4gIGZvciAoY29uc3QgW2lkeCwgd2luXSBvZiB3aW5kb3dzLmVudHJpZXMoKSkge1xuICAgIC8vIFdoZW4gYWNjZXNzaW5nIHRoZSBpZCBhdHRyaWJ1dGUgb2YgYSBjbG9zZWQgd2luZG93LFxuICAgIC8vIGl04oCZbGwgdGhyb3cuIFdl4oCZbGwgbWFyayBpdHMgaW5kZXggZm9yIGRlbGV0aW9uIHRoZW4uXG4gICAgdHJ5IHtcbiAgICAgIHdpbi5pZDtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBkZWxldGVkV2luZG93cy5wdXNoKGlkeCAtIGRlbGV0ZWRXaW5kb3dzLmxlbmd0aCk7XG4gICAgfVxuICB9XG4gIGZvciAoY29uc3QgaWR4IG9mIGRlbGV0ZWRXaW5kb3dzKSB7XG4gICAgd2luZG93cy5zcGxpY2UoaWR4LCAxKTtcbiAgfVxufVxuXG5cbmZ1bmN0aW9uIGNyZWF0ZVdpbmRvd0ZvckxvY2FsQ29tcG9uZW50KHRpdGxlOiBzdHJpbmcsIHBhcmFtczogc3RyaW5nLCB3aW5QYXJhbXM6IGFueSk6IFByb21pc2U8QnJvd3NlcldpbmRvdz4ge1xuICBsZXQgdXJsOiBzdHJpbmc7XG5cbiAgaWYgKGlzRGV2ZWxvcG1lbnQpIHtcbiAgICB1cmwgPSBgaHR0cDovL2xvY2FsaG9zdDoke3Byb2Nlc3MuZW52LkVMRUNUUk9OX1dFQlBBQ0tfV0RTX1BPUlR9PyR7cGFyYW1zfWA7XG4gIH1cbiAgZWxzZSB7XG4gICAgdXJsID0gYCR7Zm9ybWF0VXJsKHtcbiAgICAgIHBhdGhuYW1lOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnaW5kZXguaHRtbCcpLFxuICAgICAgcHJvdG9jb2w6ICdmaWxlJyxcbiAgICAgIHNsYXNoZXM6IHRydWUsXG4gICAgfSl9PyR7cGFyYW1zfWA7XG4gIH1cblxuICByZXR1cm4gY3JlYXRlV2luZG93KHRpdGxlLCB1cmwsIHdpblBhcmFtcyk7XG59XG5cblxuZnVuY3Rpb24gY3JlYXRlV2luZG93KHRpdGxlOiBzdHJpbmcsIHVybDogc3RyaW5nLCB3aW5QYXJhbXM6IGFueSwgaWdub3JlQ2FjaGU6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8QnJvd3NlcldpbmRvdz4ge1xuICBjb25zdCB3aW5kb3cgPSBuZXcgQnJvd3NlcldpbmRvdyh7XG4gICAgd2ViUHJlZmVyZW5jZXM6IHtub2RlSW50ZWdyYXRpb246IHRydWV9LFxuICAgIHRpdGxlOiB0aXRsZSxcbiAgICBzaG93OiBmYWxzZSxcbiAgICAuLi53aW5QYXJhbXNcbiAgfSk7XG5cbiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlPEJyb3dzZXJXaW5kb3c+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB3aW5kb3cub25jZSgncmVhZHktdG8tc2hvdycsICgpID0+IHtcbiAgICAgIHdpbmRvdy5zaG93KCk7XG4gICAgICByZXNvbHZlKHdpbmRvdyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGlmIChpc0RldmVsb3BtZW50KSB7XG4gICAgd2luZG93LndlYkNvbnRlbnRzLm9wZW5EZXZUb29scygpO1xuICB9XG5cbiAgaWYgKGlnbm9yZUNhY2hlKSB7XG4gICAgd2luZG93LmxvYWRVUkwodXJsLCB7J2V4dHJhSGVhZGVycyc6ICdwcmFnbWE6IG5vLWNhY2hlXFxuJ30pO1xuICB9IGVsc2Uge1xuICAgIHdpbmRvdy5sb2FkVVJMKHVybCk7XG4gIH1cblxuICB3aW5kb3cud2ViQ29udGVudHMub24oJ2RldnRvb2xzLW9wZW5lZCcsICgpID0+IHtcbiAgICB3aW5kb3cuZm9jdXMoKTtcbiAgICBzZXRJbW1lZGlhdGUoKCkgPT4ge1xuICAgICAgd2luZG93LmZvY3VzKClcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIHByb21pc2U7XG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG5vdGlmeUFsbFdpbmRvd3MoZXZlbnROYW1lOiBzdHJpbmcsIHBheWxvYWQ/OiBhbnkpIHtcbiAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHdpbmRvd3MubWFwKGFzeW5jICh3aW5kb3cpID0+IHtcbiAgICBpZiAod2luZG93KSB7XG4gICAgICBhd2FpdCB3aW5kb3cud2ViQ29udGVudHMuc2VuZChldmVudE5hbWUsIHBheWxvYWQpO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH0pKTtcbn1cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbm90aWZ5V2luZG93KHdpbmRvd1RpdGxlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBwYXlsb2FkPzogYW55KSB7XG4gIGNvbnN0IHdpbmRvdyA9IGdldFdpbmRvd0J5VGl0bGUod2luZG93VGl0bGUpO1xuICBpZiAod2luZG93KSB7XG4gICAgYXdhaXQgd2luZG93LndlYkNvbnRlbnRzLnNlbmQoZXZlbnROYW1lLCBwYXlsb2FkKTtcbiAgfVxufVxuIl19