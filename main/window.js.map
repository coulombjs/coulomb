{"version":3,"file":"window.js","sourceRoot":"","sources":["../../src/main/window.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path'\nimport { format as formatUrl } from 'url';\nimport { BrowserWindow, Menu, MenuItemConstructorOptions } from 'electron';\n\nimport { AppConfig } from '../config/app';\n\n\nconst isDevelopment = process.env.NODE_ENV !== 'production';\nconst isMacOS = process.platform === 'darwin';\n\n// Keeps track of windows and ensures (?) they do not get garbage collected\nexport var windows: BrowserWindow[] = [];\n\n// Allows to locate window ID by label\nvar windowsByTitle: { [title: string]: BrowserWindow } = {};\n\n\n// Open new window, or focus if one with the same title already exists\nexport interface WindowOpenerParams {\n  title: string\n  url?: string\n  component?: string\n  componentParams?: string\n  dimensions?: {\n    minHeight?: number\n    minWidth?: number\n    height?: number\n    width?: number\n    maxHeight?: number\n    maxWidth?: number\n  }\n  frameless?: boolean\n  winParams?: any\n  menuTemplate?: MenuItemConstructorOptions[]\n  ignoreCache?: boolean\n  showWhileLoading?: boolean\n  config: AppConfig\n}\nexport type WindowOpener = (props: WindowOpenerParams) => Promise<BrowserWindow>;\nexport const openWindow: WindowOpener = async ({\n    title,\n    url, component, componentParams,\n    dimensions, frameless,\n    winParams, menuTemplate, ignoreCache,\n    showWhileLoading,\n    config }) => {\n\n  if ((component || '').trim() === '' && (url || '').trim() === '') {\n    throw new Error(\"openWindow() requires either `component` or `url`\");\n  }\n\n  const _existingWindow = getWindowByTitle(title);\n  if (_existingWindow !== undefined) {\n    _existingWindow.show();\n    _existingWindow.focus();\n    return _existingWindow;\n  }\n\n  const _framelessOpts = {\n    titleBarStyle: isMacOS ? 'hiddenInset' : undefined,\n  };\n\n  const _winParams = {\n    width: (dimensions || {}).width,\n    minWidth: (dimensions || {}).minWidth,\n    height: (dimensions || {}).height,\n    minHeight: (dimensions || {}).minHeight,\n    ...(frameless === true ? _framelessOpts : {}),\n    ...winParams,\n  };\n\n  let window: BrowserWindow;\n\n  if (component) {\n    const params = `c=${component}&${componentParams ? componentParams : ''}`;\n    window = await createWindowForLocalComponent(title, params, _winParams, showWhileLoading === true, config.forceDevelopmentMode || false);\n  } else if (url) {\n    window = await createWindow(title, url, _winParams, showWhileLoading === true, ignoreCache);\n  } else {\n    throw new Error(\"Either component or url must be given to openWindow()\");\n  }\n\n  if (menuTemplate && !isMacOS) {\n    window.setMenu(Menu.buildFromTemplate(menuTemplate));\n  }\n\n  windows.push(window);\n  windowsByTitle[title] = window;\n  window.on('closed', () => { delete windowsByTitle[title]; cleanUpWindows(); });\n\n  return window;\n}\n\n\nexport function getWindowByTitle(title: string): BrowserWindow | undefined {\n  return windowsByTitle[title];\n}\n\n\nexport function closeWindow(title: string) {\n  const win = getWindowByTitle(title);\n  if (win !== undefined) {\n    win.close();\n  }\n}\n\n\nexport function getWindow(func: (win: BrowserWindow) => boolean): BrowserWindow | undefined {\n  return windows.find(func);\n}\n\n\n// Iterate over array of windows and try accessing window ID.\n// If it throws, window was closed and we remove it from the array.\n// Supposed to be run after any window is closed\nfunction cleanUpWindows() {\n  var deletedWindows: number[] = [];\n  for (const [idx, win] of windows.entries()) {\n    // When accessing the id attribute of a closed window,\n    // it’ll throw. We’ll mark its index for deletion then.\n    try {\n      win.id;\n    } catch (e) {\n      deletedWindows.push(idx - deletedWindows.length);\n    }\n  }\n  for (const idx of deletedWindows) {\n    windows.splice(idx, 1);\n  }\n}\n\n\nasync function createWindowForLocalComponent(\n    title: string,\n    params: string,\n    winParams: any,\n    showWhileLoading: boolean,\n    forceDebug: boolean): Promise<BrowserWindow> {\n\n  let url: string;\n\n  if (isDevelopment) {\n    url = `http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}?${params}`;\n  }\n  else {\n    url = `${formatUrl({\n      pathname: path.join(__dirname, 'index.html'),\n      protocol: 'file',\n      slashes: true,\n    })}?${params}`;\n  }\n\n  const window = await createWindow(title, url, winParams, showWhileLoading, forceDebug || isDevelopment);\n\n  if (forceDebug || isDevelopment) {\n    window.webContents.on('devtools-opened', () => {\n      window.focus();\n      setImmediate(() => {\n        window.focus()\n      });\n    });\n    window.webContents.openDevTools();\n  }\n\n  return window;\n}\n\n\nasync function createWindow(\n    title: string,\n    url: string,\n    winParams: any,\n    showWhileLoading: boolean,\n    debug: boolean = false): Promise<BrowserWindow> {\n\n  const window = new BrowserWindow({\n    webPreferences: {\n      nodeIntegration: true,\n      webSecurity: !debug,\n      enableRemoteModule: true,\n    },\n    title: title,\n    show: showWhileLoading === true,\n    ...winParams\n  });\n\n  const promise = new Promise<BrowserWindow>((resolve, reject) => {\n    window.once('ready-to-show', () => {\n      if (showWhileLoading !== true) {\n        window.show();\n      }\n      resolve(window);\n    });\n  });\n\n  if (debug) {\n    window.loadURL(url, {'extraHeaders': 'pragma: no-cache\\n'});\n  } else {\n    window.loadURL(url);\n  }\n\n  return promise;\n}\n\n\nexport async function notifyAllWindows(eventName: string, payload?: any) {\n  await Promise.all(windows.map(async (window) => {\n    if (window) {\n      await window.webContents.send(eventName, payload);\n    }\n    return;\n  }));\n}\n\n\nexport async function notifyWindow(windowTitle: string, eventName: string, payload?: any) {\n  const window = getWindowByTitle(windowTitle);\n  if (window) {\n    await window.webContents.send(eventName, payload);\n  }\n}\n"]}