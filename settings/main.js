import * as path from 'path';
import * as fs from 'fs-extra';
import * as log from 'electron-log';
import { ipcMain } from 'electron';
import { listen } from '../ipc/main';
import { default as YAMLWrapper } from '../db/isogit-yaml/main/yaml/file';
export class Setting {
    constructor(paneID, 
    /* ID of the pane to show the setting under. */
    id, 
    /* Setting ID should be unique across all settings. */
    input, 
    /* Determines input widget shown by default. */
    required, 
    /* Indicates whether the setting is required for app operation. */
    label, 
    /* Setting label shown to the user should be unique within given pane,
       to avoid confusion. */
    helpText) {
        this.paneID = paneID;
        this.id = id;
        this.input = input;
        this.required = required;
        this.label = label;
        this.helpText = helpText;
    }
    toUseable(val) { return val; }
    /* Converts stored setting value to useable object. */
    toStoreable(val) { return val; }
}
export class SettingManager {
    constructor(appDataPath, settingsFileName) {
        this.appDataPath = appDataPath;
        this.settingsFileName = settingsFileName;
        this.registry = [];
        this.panes = [];
        this.data = null;
        this.settingsPath = path.join(appDataPath, `${settingsFileName}.yaml`);
        log.debug(`C/settings: Configuring w/path ${this.settingsPath}`);
        this.yaml = new YAMLWrapper(appDataPath);
    }
    async listMissingRequiredSettings() {
        var requiredSettingIDs = [];
        for (const setting of this.registry) {
            if (setting.required == true && (await this.getValue(setting.id)) === undefined) {
                requiredSettingIDs.push(setting.id);
            }
        }
        return requiredSettingIDs;
    }
    async getValue(id) {
        const setting = this.get(id);
        if (setting) {
            if (this.data === null) {
                let settingsFileExists;
                try {
                    settingsFileExists = (await fs.stat(this.settingsPath)).isFile();
                }
                catch (e) {
                    settingsFileExists = false;
                }
                if (settingsFileExists) {
                    this.data = (await this.yaml.read(this.settingsFileName)) || {};
                }
                else {
                    this.data = {};
                }
            }
            const rawVal = this.data[id];
            return rawVal !== undefined ? setting.toUseable(rawVal) : undefined;
        }
        else {
            log.warn(`C/settings: Attempted to get value for non-existent setting ${id}`);
            throw new Error(`Setting to get value for is not found: ${id}`);
        }
    }
    async setValue(id, val) {
        // DANGER: Never log settingâ€™s val in raw form
        log.debug(`C/settings: Set value for setting ${id}`);
        const setting = this.get(id);
        if (setting) {
            const storeable = setting.toStoreable(val);
            this.data[id] = storeable;
            await this.commit();
        }
        else {
            throw new Error(`Setting to set value for is not found: ${id}`);
        }
    }
    async deleteValue(id) {
        log.debug(`C/settings: Delete setting: ${id}`);
        delete this.data[id];
        await this.commit();
    }
    async commit() {
        log.info("C/settings: Commit new settings");
        log.debug("C/settings: Commit: Remove file");
        await fs.remove(this.settingsPath);
        log.debug("C/settings: Commit: Write new file");
        await this.yaml.write(this.settingsFileName, this.data);
    }
    get(id) {
        return this.registry.find(s => s.id === id);
    }
    register(setting) {
        log.debug("C/settings: Register setting");
        if (this.panes.find(p => p.id === setting.paneID)) {
            this.registry.push(setting);
        }
        else {
            log.error("C/settings: Unable to register a setting: Invalid pane ID");
            throw new Error("Invalid pane ID");
        }
    }
    configurePane(pane) {
        this.panes.push(pane);
    }
    setUpIPC() {
        log.verbose("C/settings: Register API endpoints");
        listen('settingPaneList', async () => {
            return { panes: this.panes };
        });
        listen('settingList', async () => {
            return { settings: this.registry };
        });
        listen('settingValue', async ({ name }) => {
            return await this.getValue(name);
        });
        listen('commitSetting', async ({ name, value }) => {
            await this.setValue(name, value);
            return { success: true };
        });
        ipcMain.on('set-setting', async (evt, name, value) => {
            return await this.setValue(name, value);
        });
        ipcMain.on('get-setting', async (evt, name) => {
            const value = await this.getValue(name);
            evt.reply('get-setting', name, value);
        });
        ipcMain.on('clear-setting', async (evt, name) => {
            log.debug(`C/settings: received clear-setting request for ${name}`);
            await this.deleteValue(name);
            evt.reply('clear-setting', 'ok');
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXR0aW5ncy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sS0FBSyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBRXBDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVyQyxPQUFPLEVBQUUsT0FBTyxJQUFJLFdBQVcsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBVzFFLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLFlBRVMsTUFBYztJQUNyQiwrQ0FBK0M7SUFFeEMsRUFBVTtJQUNqQixzREFBc0Q7SUFFL0MsS0FBd0I7SUFDL0IsK0NBQStDO0lBRXhDLFFBQWlCO0lBQ3hCLGtFQUFrRTtJQUUzRCxLQUFhO0lBQ3BCOzZCQUN5QjtJQUVsQixRQUFpQjtRQWhCakIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUdkLE9BQUUsR0FBRixFQUFFLENBQVE7UUFHVixVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQUd4QixhQUFRLEdBQVIsUUFBUSxDQUFTO1FBR2pCLFVBQUssR0FBTCxLQUFLLENBQVE7UUFJYixhQUFRLEdBQVIsUUFBUSxDQUFTO0lBRXZCLENBQUM7SUFFSixTQUFTLENBQUMsR0FBWSxJQUFPLE9BQU8sR0FBUSxDQUFBLENBQUMsQ0FBQztJQUM5QyxzREFBc0Q7SUFFdEQsV0FBVyxDQUFDLEdBQU0sSUFBUyxPQUFPLEdBQVUsQ0FBQSxDQUFDLENBQUM7Q0FHL0M7QUFHRCxNQUFNLE9BQU8sY0FBYztJQU96QixZQUFtQixXQUFtQixFQUFTLGdCQUF3QjtRQUFwRCxnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUFTLHFCQUFnQixHQUFoQixnQkFBZ0Is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QUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLElBQVksRUFBRSxFQUFFO1lBQ3pELE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QyxHQUFHLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLGVBQWUsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLElBQVksRUFBRSxFQUFFO1lBQzNELEdBQUcsQ0FBQyxLQUFLLENBQUMsa0RBQWtELElBQUksRUFBRSxDQUFDLENBQUM7WUFFcEUsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdCLEdBQUcsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIGxvZyBmcm9tICdlbGVjdHJvbi1sb2cnO1xuXG5pbXBvcnQgeyBpcGNNYWluIH0gZnJvbSAnZWxlY3Ryb24nO1xuaW1wb3J0IHsgbGlzdGVuIH0gZnJvbSAnLi4vaXBjL21haW4nO1xuXG5pbXBvcnQgeyBkZWZhdWx0IGFzIFlBTUxXcmFwcGVyIH0gZnJvbSAnLi4vZGIvaXNvZ2l0LXlhbWwvbWFpbi95YW1sL2ZpbGUnO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFuZSB7XG4gIGlkOiBzdHJpbmc7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIGljb24/OiBzdHJpbmc7XG4gIGhlbHBUZXh0Pzogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCBjbGFzcyBTZXR0aW5nPFQ+IHtcbiAgY29uc3RydWN0b3IoXG5cbiAgICBwdWJsaWMgcGFuZUlEOiBzdHJpbmcsXG4gICAgLyogSUQgb2YgdGhlIHBhbmUgdG8gc2hvdyB0aGUgc2V0dGluZyB1bmRlci4gKi9cblxuICAgIHB1YmxpYyBpZDogc3RyaW5nLFxuICAgIC8qIFNldHRpbmcgSUQgc2hvdWxkIGJlIHVuaXF1ZSBhY3Jvc3MgYWxsIHNldHRpbmdzLiAqL1xuXG4gICAgcHVibGljIGlucHV0OiAndGV4dCcgfCAnbnVtYmVyJyxcbiAgICAvKiBEZXRlcm1pbmVzIGlucHV0IHdpZGdldCBzaG93biBieSBkZWZhdWx0LiAqL1xuXG4gICAgcHVibGljIHJlcXVpcmVkOiBib29sZWFuLFxuICAgIC8qIEluZGljYXRlcyB3aGV0aGVyIHRoZSBzZXR0aW5nIGlzIHJlcXVpcmVkIGZvciBhcHAgb3BlcmF0aW9uLiAqL1xuXG4gICAgcHVibGljIGxhYmVsOiBzdHJpbmcsXG4gICAgLyogU2V0dGluZyBsYWJlbCBzaG93biB0byB0aGUgdXNlciBzaG91bGQgYmUgdW5pcXVlIHdpdGhpbiBnaXZlbiBwYW5lLFxuICAgICAgIHRvIGF2b2lkIGNvbmZ1c2lvbi4gKi9cblxuICAgIHB1YmxpYyBoZWxwVGV4dD86IHN0cmluZyxcblxuICApIHt9XG5cbiAgdG9Vc2VhYmxlKHZhbDogdW5rbm93bik6IFQgeyByZXR1cm4gdmFsIGFzIFQgfVxuICAvKiBDb252ZXJ0cyBzdG9yZWQgc2V0dGluZyB2YWx1ZSB0byB1c2VhYmxlIG9iamVjdC4gKi9cblxuICB0b1N0b3JlYWJsZSh2YWw6IFQpOiBhbnkgeyByZXR1cm4gdmFsIGFzIGFueSB9XG4gIC8qIENvbnZlcnRzIEpTL1RTIG9iamVjdCB0byBzdG9yZWFibGUgdmVyc2lvbiBvZiB0aGUgc2V0dGluZy4gKi9cblxufVxuXG5cbmV4cG9ydCBjbGFzcyBTZXR0aW5nTWFuYWdlciB7XG4gIHByaXZhdGUgcmVnaXN0cnk6IFNldHRpbmc8YW55PltdID0gW107XG4gIHByaXZhdGUgcGFuZXM6IFBhbmVbXSA9IFtdO1xuICBwcml2YXRlIGRhdGE6IGFueSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHlhbWw6IFlBTUxXcmFwcGVyO1xuICBwcml2YXRlIHNldHRpbmdzUGF0aDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBhcHBEYXRhUGF0aDogc3RyaW5nLCBwdWJsaWMgc2V0dGluZ3NGaWxlTmFtZTogc3RyaW5nKSB7XG4gICAgdGhpcy5zZXR0aW5nc1BhdGggPSBwYXRoLmpvaW4oYXBwRGF0YVBhdGgsIGAke3NldHRpbmdzRmlsZU5hbWV9LnlhbWxgKTtcbiAgICBsb2cuZGVidWcoYEMvc2V0dGluZ3M6IENvbmZpZ3VyaW5nIHcvcGF0aCAke3RoaXMuc2V0dGluZ3NQYXRofWApO1xuXG4gICAgdGhpcy55YW1sID0gbmV3IFlBTUxXcmFwcGVyKGFwcERhdGFQYXRoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0TWlzc2luZ1JlcXVpcmVkU2V0dGluZ3MoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHZhciByZXF1aXJlZFNldHRpbmdJRHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBzZXR0aW5nIG9mIHRoaXMucmVnaXN0cnkpIHtcbiAgICAgIGlmIChzZXR0aW5nLnJlcXVpcmVkID09IHRydWUgJiYgKGF3YWl0IHRoaXMuZ2V0VmFsdWUoc2V0dGluZy5pZCkpID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVxdWlyZWRTZXR0aW5nSURzLnB1c2goc2V0dGluZy5pZCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXF1aXJlZFNldHRpbmdJRHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWUoaWQ6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgIGNvbnN0IHNldHRpbmcgPSB0aGlzLmdldChpZCk7XG5cbiAgICBpZiAoc2V0dGluZykge1xuICAgICAgaWYgKHRoaXMuZGF0YSA9PT0gbnVsbCkge1xuICAgICAgICBsZXQgc2V0dGluZ3NGaWxlRXhpc3RzOiBib29sZWFuO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHNldHRpbmdzRmlsZUV4aXN0cyA9IChhd2FpdCBmcy5zdGF0KHRoaXMuc2V0dGluZ3NQYXRoKSkuaXNGaWxlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBzZXR0aW5nc0ZpbGVFeGlzdHMgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2V0dGluZ3NGaWxlRXhpc3RzKSB7XG4gICAgICAgICAgdGhpcy5kYXRhID0gKGF3YWl0IHRoaXMueWFtbC5yZWFkKHRoaXMuc2V0dGluZ3NGaWxlTmFtZSkpIHx8IHt9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuZGF0YSA9IHt9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCByYXdWYWwgPSB0aGlzLmRhdGFbaWRdO1xuICAgICAgcmV0dXJuIHJhd1ZhbCAhPT0gdW5kZWZpbmVkID8gc2V0dGluZy50b1VzZWFibGUocmF3VmFsKSA6IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oYEMvc2V0dGluZ3M6IEF0dGVtcHRlZCB0byBnZXQgdmFsdWUgZm9yIG5vbi1leGlzdGVudCBzZXR0aW5nICR7aWR9YCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNldHRpbmcgdG8gZ2V0IHZhbHVlIGZvciBpcyBub3QgZm91bmQ6ICR7aWR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNldFZhbHVlKGlkOiBzdHJpbmcsIHZhbDogdW5rbm93bikge1xuICAgIC8vIERBTkdFUjogTmV2ZXIgbG9nIHNldHRpbmfigJlzIHZhbCBpbiByYXcgZm9ybVxuXG4gICAgbG9nLmRlYnVnKGBDL3NldHRpbmdzOiBTZXQgdmFsdWUgZm9yIHNldHRpbmcgJHtpZH1gKTtcblxuICAgIGNvbnN0IHNldHRpbmcgPSB0aGlzLmdldChpZCk7XG4gICAgaWYgKHNldHRpbmcpIHtcbiAgICAgIGNvbnN0IHN0b3JlYWJsZSA9IHNldHRpbmcudG9TdG9yZWFibGUodmFsKTtcbiAgICAgIHRoaXMuZGF0YVtpZF0gPSBzdG9yZWFibGU7XG4gICAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNldHRpbmcgdG8gc2V0IHZhbHVlIGZvciBpcyBub3QgZm91bmQ6ICR7aWR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZVZhbHVlKGlkOiBzdHJpbmcpIHtcbiAgICBsb2cuZGVidWcoYEMvc2V0dGluZ3M6IERlbGV0ZSBzZXR0aW5nOiAke2lkfWApO1xuICAgIGRlbGV0ZSB0aGlzLmRhdGFbaWRdO1xuICAgIGF3YWl0IHRoaXMuY29tbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNvbW1pdCgpIHtcbiAgICBsb2cuaW5mbyhcIkMvc2V0dGluZ3M6IENvbW1pdCBuZXcgc2V0dGluZ3NcIik7XG5cbiAgICBsb2cuZGVidWcoXCJDL3NldHRpbmdzOiBDb21taXQ6IFJlbW92ZSBmaWxlXCIpO1xuICAgIGF3YWl0IGZzLnJlbW92ZSh0aGlzLnNldHRpbmdzUGF0aCk7XG5cbiAgICBsb2cuZGVidWcoXCJDL3NldHRpbmdzOiBDb21taXQ6IFdyaXRlIG5ldyBmaWxlXCIpO1xuICAgIGF3YWl0IHRoaXMueWFtbC53cml0ZSh0aGlzLnNldHRpbmdzRmlsZU5hbWUsIHRoaXMuZGF0YSk7XG4gIH1cblxuICBwcml2YXRlIGdldChpZDogc3RyaW5nKTogU2V0dGluZzxhbnk+IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5yZWdpc3RyeS5maW5kKHMgPT4gcy5pZCA9PT0gaWQpO1xuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyKHNldHRpbmc6IFNldHRpbmc8YW55Pikge1xuICAgIGxvZy5kZWJ1ZyhcIkMvc2V0dGluZ3M6IFJlZ2lzdGVyIHNldHRpbmdcIik7XG4gICAgaWYgKHRoaXMucGFuZXMuZmluZChwID0+IHAuaWQgPT09IHNldHRpbmcucGFuZUlEKSkge1xuICAgICAgdGhpcy5yZWdpc3RyeS5wdXNoKHNldHRpbmcpO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5lcnJvcihcIkMvc2V0dGluZ3M6IFVuYWJsZSB0byByZWdpc3RlciBhIHNldHRpbmc6IEludmFsaWQgcGFuZSBJRFwiKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgcGFuZSBJRFwiKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY29uZmlndXJlUGFuZShwYW5lOiBQYW5lKSB7XG4gICAgdGhpcy5wYW5lcy5wdXNoKHBhbmUpO1xuICB9XG5cbiAgcHVibGljIHNldFVwSVBDKCkge1xuICAgIGxvZy52ZXJib3NlKFwiQy9zZXR0aW5nczogUmVnaXN0ZXIgQVBJIGVuZHBvaW50c1wiKTtcblxuICAgIGxpc3Rlbjx7fSwgeyBwYW5lczogUGFuZVtdIH0+XG4gICAgKCdzZXR0aW5nUGFuZUxpc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4geyBwYW5lczogdGhpcy5wYW5lcyB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IHNldHRpbmdzOiBTZXR0aW5nPGFueT5bXSB9PlxuICAgICgnc2V0dGluZ0xpc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4geyBzZXR0aW5nczogdGhpcy5yZWdpc3RyeSB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHsgbmFtZTogc3RyaW5nIH0sIHsgdmFsdWU6IGFueSB9PlxuICAgICgnc2V0dGluZ1ZhbHVlJywgYXN5bmMgKHsgbmFtZSB9KSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRWYWx1ZShuYW1lKSBhcyBhbnk7XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48eyBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkgfSwgeyBzdWNjZXNzOiB0cnVlIH0+XG4gICAgKCdjb21taXRTZXR0aW5nJywgYXN5bmMoeyBuYW1lLCB2YWx1ZSB9KSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLnNldFZhbHVlKG5hbWUsIHZhbHVlKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICB9KVxuXG4gICAgaXBjTWFpbi5vbignc2V0LXNldHRpbmcnLCBhc3luYyAoZXZ0OiBhbnksIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2V0VmFsdWUobmFtZSwgdmFsdWUpO1xuICAgIH0pO1xuXG4gICAgaXBjTWFpbi5vbignZ2V0LXNldHRpbmcnLCBhc3luYyAoZXZ0OiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmdldFZhbHVlKG5hbWUpO1xuICAgICAgZXZ0LnJlcGx5KCdnZXQtc2V0dGluZycsIG5hbWUsIHZhbHVlKTtcbiAgICB9KTtcblxuICAgIGlwY01haW4ub24oJ2NsZWFyLXNldHRpbmcnLCBhc3luYyAoZXZ0OiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgbG9nLmRlYnVnKGBDL3NldHRpbmdzOiByZWNlaXZlZCBjbGVhci1zZXR0aW5nIHJlcXVlc3QgZm9yICR7bmFtZX1gKTtcblxuICAgICAgYXdhaXQgdGhpcy5kZWxldGVWYWx1ZShuYW1lKTtcbiAgICAgIGV2dC5yZXBseSgnY2xlYXItc2V0dGluZycsICdvaycpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=