import * as path from 'path';
import * as fs from 'fs-extra';
import * as log from 'electron-log';
import { ipcMain } from 'electron';
import { listen } from '../ipc/main';
import { YAMLWrapper } from '../db/isogit-yaml/main/yaml/index';
export class Setting {
    constructor(paneID, 
    /* ID of the pane to show the setting under. */
    id, 
    /* Setting ID should be unique across all settings. */
    input, 
    /* Determines input widget shown by default. */
    required, 
    /* Indicates whether the setting is required for app operation. */
    label) {
        this.paneID = paneID;
        this.id = id;
        this.input = input;
        this.required = required;
        this.label = label;
    }
    toUseable(val) { return val; }
    /* Converts stored setting value to useable object. */
    toStoreable(val) { return val; }
}
export class SettingManager {
    constructor(appDataPath, settingsFileName) {
        this.appDataPath = appDataPath;
        this.settingsFileName = settingsFileName;
        this.registry = [];
        this.panes = [];
        this.data = null;
        this.settingsPath = path.join(appDataPath, `${settingsFileName}.yaml`);
        log.debug(`C/settings: Configuring w/path ${this.settingsPath}`);
        this.yaml = new YAMLWrapper(appDataPath);
    }
    async listMissingRequiredSettings() {
        var requiredSettingIDs = [];
        for (const setting of this.registry) {
            if (setting.required == true && (await this.getValue(setting.id)) === undefined) {
                requiredSettingIDs.push(setting.id);
            }
        }
        return requiredSettingIDs;
    }
    async getValue(id) {
        const setting = this.get(id);
        if (setting) {
            if (this.data === null) {
                let settingsFileExists;
                try {
                    settingsFileExists = (await fs.stat(this.settingsPath)).isFile();
                }
                catch (e) {
                    settingsFileExists = false;
                }
                if (settingsFileExists) {
                    this.data = (await this.yaml.read(this.settingsFileName)) || {};
                }
                else {
                    this.data = {};
                }
            }
            const rawVal = this.data[id];
            return rawVal !== undefined ? setting.toUseable(rawVal) : undefined;
        }
        else {
            log.warn(`C/settings: Attempted to get value for non-existent setting ${id}`);
            throw new Error(`Setting to get value for is not found: ${id}`);
        }
    }
    async setValue(id, val) {
        // DANGER: Never log settingâ€™s val in raw form
        log.debug(`C/settings: Set value for setting ${id}`);
        const setting = this.get(id);
        if (setting) {
            const storeable = setting.toStoreable(val);
            this.data[id] = storeable;
            await this.commit();
        }
        else {
            throw new Error(`Setting to set value for is not found: ${id}`);
        }
    }
    async deleteValue(id) {
        log.debug(`C/settings: Delete setting: ${id}`);
        delete this.data[id];
        await this.commit();
    }
    async commit() {
        log.info("C/settings: Commit new settings");
        log.debug("C/settings: Commit: Remove file");
        await fs.remove(this.settingsPath);
        log.debug("C/settings: Commit: Write new file");
        await this.yaml.write(this.settingsFileName, this.data);
    }
    get(id) {
        return this.registry.find(s => s.id === id);
    }
    register(setting) {
        log.debug("C/settings: Register setting");
        if (this.panes.find(p => p.id === setting.paneID)) {
            this.registry.push(setting);
        }
        else {
            throw new Error("Invalid pane ID");
        }
    }
    configurePane(pane) {
        this.panes.push(pane);
    }
    setUpIPC() {
        log.verbose("C/settings: Register API endpoints");
        listen('settingPaneList', async () => {
            return { panes: this.panes };
        });
        listen('settingList', async () => {
            return { settings: this.registry };
        });
        listen('settingValue', async ({ name }) => {
            return await this.getValue(name);
        });
        listen('commitSetting', async ({ name, value }) => {
            await this.setValue(name, value);
            return { success: true };
        });
        ipcMain.on('set-setting', async (evt, name, value) => {
            return await this.setValue(name, value);
        });
        ipcMain.on('get-setting', async (evt, name) => {
            const value = await this.getValue(name);
            evt.reply('get-setting', name, value);
        });
        ipcMain.on('clear-setting', async (evt, name) => {
            log.debug(`C/settings: received clear-setting request for ${name}`);
            await this.deleteValue(name);
            evt.reply('clear-setting', 'ok');
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXR0aW5ncy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sS0FBSyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBRXBDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVyQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFVaEUsTUFBTSxPQUFPLE9BQU87SUFDbEIsWUFFUyxNQUFjO0lBQ3JCLCtDQUErQztJQUV4QyxFQUFVO0lBQ2pCLHNEQUFzRDtJQUUvQyxLQUF3QjtJQUMvQiwrQ0FBK0M7SUFFeEMsUUFBaUI7SUFDeEIsa0VBQWtFO0lBRTNELEtBQWE7UUFaYixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBR2QsT0FBRSxHQUFGLEVBQUUsQ0FBUTtRQUdWLFVBQUssR0FBTCxLQUFLLENBQW1CO1FBR3hCLGFBQVEsR0FBUixRQUFRLENBQVM7UUFHakIsVUFBSyxHQUFMLEtBQUssQ0FBUTtJQUluQixDQUFDO0lBRUosU0FBUyxDQUFDLEdBQVksSUFBTyxPQUFPLEdBQVEsQ0FBQSxDQUFDLENBQUM7SUFDOUMsc0RBQXNEO0lBRXRELFdBQVcsQ0FBQyxHQUFNLElBQVMsT0FBTyxHQUFVLENBQUEsQ0FBQyxDQUFDO0NBRy9DO0FBR0QsTUFBTSxPQUFPLGNBQWM7SUFPekIsWUFBbUIsV0FBbUIsRUFBUyxnQkFBd0I7UUFBcEQsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFBUyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQVE7UUFOL0QsYUFBUSxHQUFtQixFQUFFLENBQUM7UUFDOUIsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUNu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SUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QyxHQUFHLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLGVBQWUsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLElBQVksRUFBRSxFQUFFO1lBQzNELEdBQUcsQ0FBQyxLQUFLLENBQUMsa0RBQWtELElBQUksRUFBRSxDQUFDLENBQUM7WUFFcEUsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdCLEdBQUcsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIGxvZyBmcm9tICdlbGVjdHJvbi1sb2cnO1xuXG5pbXBvcnQgeyBpcGNNYWluIH0gZnJvbSAnZWxlY3Ryb24nO1xuaW1wb3J0IHsgbGlzdGVuIH0gZnJvbSAnLi4vaXBjL21haW4nO1xuXG5pbXBvcnQgeyBZQU1MV3JhcHBlciB9IGZyb20gJy4uL2RiL2lzb2dpdC15YW1sL21haW4veWFtbC9pbmRleCc7XG5cblxuZXhwb3J0IGludGVyZmFjZSBQYW5lIHtcbiAgaWQ6IHN0cmluZztcbiAgbGFiZWw6IHN0cmluZztcbiAgaWNvbj86IHN0cmluZztcbn1cblxuXG5leHBvcnQgY2xhc3MgU2V0dGluZzxUPiB7XG4gIGNvbnN0cnVjdG9yKFxuXG4gICAgcHVibGljIHBhbmVJRDogc3RyaW5nLFxuICAgIC8qIElEIG9mIHRoZSBwYW5lIHRvIHNob3cgdGhlIHNldHRpbmcgdW5kZXIuICovXG5cbiAgICBwdWJsaWMgaWQ6IHN0cmluZyxcbiAgICAvKiBTZXR0aW5nIElEIHNob3VsZCBiZSB1bmlxdWUgYWNyb3NzIGFsbCBzZXR0aW5ncy4gKi9cblxuICAgIHB1YmxpYyBpbnB1dDogJ3RleHQnIHwgJ251bWJlcicsXG4gICAgLyogRGV0ZXJtaW5lcyBpbnB1dCB3aWRnZXQgc2hvd24gYnkgZGVmYXVsdC4gKi9cblxuICAgIHB1YmxpYyByZXF1aXJlZDogYm9vbGVhbixcbiAgICAvKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgc2V0dGluZyBpcyByZXF1aXJlZCBmb3IgYXBwIG9wZXJhdGlvbi4gKi9cblxuICAgIHB1YmxpYyBsYWJlbDogc3RyaW5nLFxuICAgIC8qIFNldHRpbmcgbGFiZWwgc2hvd24gdG8gdGhlIHVzZXIgc2hvdWxkIGJlIHVuaXF1ZSB3aXRoaW4gZ2l2ZW4gcGFuZSxcbiAgICAgICB0byBhdm9pZCBjb25mdXNpb24uICovXG5cbiAgKSB7fVxuXG4gIHRvVXNlYWJsZSh2YWw6IHVua25vd24pOiBUIHsgcmV0dXJuIHZhbCBhcyBUIH1cbiAgLyogQ29udmVydHMgc3RvcmVkIHNldHRpbmcgdmFsdWUgdG8gdXNlYWJsZSBvYmplY3QuICovXG5cbiAgdG9TdG9yZWFibGUodmFsOiBUKTogYW55IHsgcmV0dXJuIHZhbCBhcyBhbnkgfVxuICAvKiBDb252ZXJ0cyBKUy9UUyBvYmplY3QgdG8gc3RvcmVhYmxlIHZlcnNpb24gb2YgdGhlIHNldHRpbmcuICovXG5cbn1cblxuXG5leHBvcnQgY2xhc3MgU2V0dGluZ01hbmFnZXIge1xuICBwcml2YXRlIHJlZ2lzdHJ5OiBTZXR0aW5nPGFueT5bXSA9IFtdO1xuICBwcml2YXRlIHBhbmVzOiBQYW5lW10gPSBbXTtcbiAgcHJpdmF0ZSBkYXRhOiBhbnkgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSB5YW1sOiBZQU1MV3JhcHBlcjtcbiAgcHJpdmF0ZSBzZXR0aW5nc1BhdGg6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgYXBwRGF0YVBhdGg6IHN0cmluZywgcHVibGljIHNldHRpbmdzRmlsZU5hbWU6IHN0cmluZykge1xuICAgIHRoaXMuc2V0dGluZ3NQYXRoID0gcGF0aC5qb2luKGFwcERhdGFQYXRoLCBgJHtzZXR0aW5nc0ZpbGVOYW1lfS55YW1sYCk7XG4gICAgbG9nLmRlYnVnKGBDL3NldHRpbmdzOiBDb25maWd1cmluZyB3L3BhdGggJHt0aGlzLnNldHRpbmdzUGF0aH1gKTtcblxuICAgIHRoaXMueWFtbCA9IG5ldyBZQU1MV3JhcHBlcihhcHBEYXRhUGF0aCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdE1pc3NpbmdSZXF1aXJlZFNldHRpbmdzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICB2YXIgcmVxdWlyZWRTZXR0aW5nSURzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAoY29uc3Qgc2V0dGluZyBvZiB0aGlzLnJlZ2lzdHJ5KSB7XG4gICAgICBpZiAoc2V0dGluZy5yZXF1aXJlZCA9PSB0cnVlICYmIChhd2FpdCB0aGlzLmdldFZhbHVlKHNldHRpbmcuaWQpKSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlcXVpcmVkU2V0dGluZ0lEcy5wdXNoKHNldHRpbmcuaWQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVxdWlyZWRTZXR0aW5nSURzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFZhbHVlKGlkOiBzdHJpbmcpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICBjb25zdCBzZXR0aW5nID0gdGhpcy5nZXQoaWQpO1xuXG4gICAgaWYgKHNldHRpbmcpIHtcbiAgICAgIGlmICh0aGlzLmRhdGEgPT09IG51bGwpIHtcbiAgICAgICAgbGV0IHNldHRpbmdzRmlsZUV4aXN0czogYm9vbGVhbjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBzZXR0aW5nc0ZpbGVFeGlzdHMgPSAoYXdhaXQgZnMuc3RhdCh0aGlzLnNldHRpbmdzUGF0aCkpLmlzRmlsZSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgc2V0dGluZ3NGaWxlRXhpc3RzID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNldHRpbmdzRmlsZUV4aXN0cykge1xuICAgICAgICAgIHRoaXMuZGF0YSA9IChhd2FpdCB0aGlzLnlhbWwucmVhZCh0aGlzLnNldHRpbmdzRmlsZU5hbWUpKSB8fCB7fTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmRhdGEgPSB7fTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgcmF3VmFsID0gdGhpcy5kYXRhW2lkXTtcbiAgICAgIHJldHVybiByYXdWYWwgIT09IHVuZGVmaW5lZCA/IHNldHRpbmcudG9Vc2VhYmxlKHJhd1ZhbCkgOiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGBDL3NldHRpbmdzOiBBdHRlbXB0ZWQgdG8gZ2V0IHZhbHVlIGZvciBub24tZXhpc3RlbnQgc2V0dGluZyAke2lkfWApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTZXR0aW5nIHRvIGdldCB2YWx1ZSBmb3IgaXMgbm90IGZvdW5kOiAke2lkfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRWYWx1ZShpZDogc3RyaW5nLCB2YWw6IHVua25vd24pIHtcbiAgICAvLyBEQU5HRVI6IE5ldmVyIGxvZyBzZXR0aW5n4oCZcyB2YWwgaW4gcmF3IGZvcm1cblxuICAgIGxvZy5kZWJ1ZyhgQy9zZXR0aW5nczogU2V0IHZhbHVlIGZvciBzZXR0aW5nICR7aWR9YCk7XG5cbiAgICBjb25zdCBzZXR0aW5nID0gdGhpcy5nZXQoaWQpO1xuICAgIGlmIChzZXR0aW5nKSB7XG4gICAgICBjb25zdCBzdG9yZWFibGUgPSBzZXR0aW5nLnRvU3RvcmVhYmxlKHZhbCk7XG4gICAgICB0aGlzLmRhdGFbaWRdID0gc3RvcmVhYmxlO1xuICAgICAgYXdhaXQgdGhpcy5jb21taXQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTZXR0aW5nIHRvIHNldCB2YWx1ZSBmb3IgaXMgbm90IGZvdW5kOiAke2lkfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGVWYWx1ZShpZDogc3RyaW5nKSB7XG4gICAgbG9nLmRlYnVnKGBDL3NldHRpbmdzOiBEZWxldGUgc2V0dGluZzogJHtpZH1gKTtcbiAgICBkZWxldGUgdGhpcy5kYXRhW2lkXTtcbiAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjb21taXQoKSB7XG4gICAgbG9nLmluZm8oXCJDL3NldHRpbmdzOiBDb21taXQgbmV3IHNldHRpbmdzXCIpO1xuICAgIGxvZy5kZWJ1ZyhcIkMvc2V0dGluZ3M6IENvbW1pdDogUmVtb3ZlIGZpbGVcIik7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHRoaXMuc2V0dGluZ3NQYXRoKTtcbiAgICBsb2cuZGVidWcoXCJDL3NldHRpbmdzOiBDb21taXQ6IFdyaXRlIG5ldyBmaWxlXCIpO1xuICAgIGF3YWl0IHRoaXMueWFtbC53cml0ZSh0aGlzLnNldHRpbmdzRmlsZU5hbWUsIHRoaXMuZGF0YSk7XG4gIH1cblxuICBwcml2YXRlIGdldChpZDogc3RyaW5nKTogU2V0dGluZzxhbnk+IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5yZWdpc3RyeS5maW5kKHMgPT4gcy5pZCA9PT0gaWQpO1xuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyKHNldHRpbmc6IFNldHRpbmc8YW55Pikge1xuICAgIGxvZy5kZWJ1ZyhcIkMvc2V0dGluZ3M6IFJlZ2lzdGVyIHNldHRpbmdcIik7XG4gICAgaWYgKHRoaXMucGFuZXMuZmluZChwID0+IHAuaWQgPT09IHNldHRpbmcucGFuZUlEKSkge1xuICAgICAgdGhpcy5yZWdpc3RyeS5wdXNoKHNldHRpbmcpO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgcGFuZSBJRFwiKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY29uZmlndXJlUGFuZShwYW5lOiBQYW5lKSB7XG4gICAgdGhpcy5wYW5lcy5wdXNoKHBhbmUpO1xuICB9XG5cbiAgcHVibGljIHNldFVwSVBDKCkge1xuICAgIGxvZy52ZXJib3NlKFwiQy9zZXR0aW5nczogUmVnaXN0ZXIgQVBJIGVuZHBvaW50c1wiKTtcblxuICAgIGxpc3Rlbjx7fSwgeyBwYW5lczogUGFuZVtdIH0+XG4gICAgKCdzZXR0aW5nUGFuZUxpc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4geyBwYW5lczogdGhpcy5wYW5lcyB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHt9LCB7IHNldHRpbmdzOiBTZXR0aW5nPGFueT5bXSB9PlxuICAgICgnc2V0dGluZ0xpc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4geyBzZXR0aW5nczogdGhpcy5yZWdpc3RyeSB9O1xuICAgIH0pO1xuXG4gICAgbGlzdGVuPHsgbmFtZTogc3RyaW5nIH0sIHsgdmFsdWU6IGFueSB9PlxuICAgICgnc2V0dGluZ1ZhbHVlJywgYXN5bmMgKHsgbmFtZSB9KSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRWYWx1ZShuYW1lKSBhcyBhbnk7XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48eyBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkgfSwgeyBzdWNjZXNzOiB0cnVlIH0+XG4gICAgKCdjb21taXRTZXR0aW5nJywgYXN5bmMoeyBuYW1lLCB2YWx1ZSB9KSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLnNldFZhbHVlKG5hbWUsIHZhbHVlKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICB9KVxuXG4gICAgaXBjTWFpbi5vbignc2V0LXNldHRpbmcnLCBhc3luYyAoZXZ0OiBhbnksIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2V0VmFsdWUobmFtZSwgdmFsdWUpO1xuICAgIH0pO1xuXG4gICAgaXBjTWFpbi5vbignZ2V0LXNldHRpbmcnLCBhc3luYyAoZXZ0OiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmdldFZhbHVlKG5hbWUpO1xuICAgICAgZXZ0LnJlcGx5KCdnZXQtc2V0dGluZycsIG5hbWUsIHZhbHVlKTtcbiAgICB9KTtcblxuICAgIGlwY01haW4ub24oJ2NsZWFyLXNldHRpbmcnLCBhc3luYyAoZXZ0OiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgbG9nLmRlYnVnKGBDL3NldHRpbmdzOiByZWNlaXZlZCBjbGVhci1zZXR0aW5nIHJlcXVlc3QgZm9yICR7bmFtZX1gKTtcblxuICAgICAgYXdhaXQgdGhpcy5kZWxldGVWYWx1ZShuYW1lKTtcbiAgICAgIGV2dC5yZXBseSgnY2xlYXItc2V0dGluZycsICdvaycpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=