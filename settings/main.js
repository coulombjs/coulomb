import * as path from 'path';
import * as fs from 'fs-extra';
import * as log from 'electron-log';
import { ipcMain } from 'electron';
import { listen } from '../ipc/main';
import { default as YAMLWrapper } from '../db/isogit-yaml/main/yaml/file';
export class Setting {
    constructor(paneID, 
    /* ID of the pane to show the setting under. */
    id, 
    /* Setting ID should be unique across all settings. */
    input, 
    /* Determines input widget shown by default. */
    required, 
    /* Indicates whether the setting is required for app operation. */
    label) {
        this.paneID = paneID;
        this.id = id;
        this.input = input;
        this.required = required;
        this.label = label;
    }
    toUseable(val) { return val; }
    /* Converts stored setting value to useable object. */
    toStoreable(val) { return val; }
}
export class SettingManager {
    constructor(appDataPath, settingsFileName) {
        this.appDataPath = appDataPath;
        this.settingsFileName = settingsFileName;
        this.registry = [];
        this.panes = [];
        this.data = null;
        this.settingsPath = path.join(appDataPath, `${settingsFileName}.yaml`);
        log.debug(`C/settings: Configuring w/path ${this.settingsPath}`);
        this.yaml = new YAMLWrapper(appDataPath);
    }
    async listMissingRequiredSettings() {
        var requiredSettingIDs = [];
        for (const setting of this.registry) {
            if (setting.required == true && (await this.getValue(setting.id)) === undefined) {
                requiredSettingIDs.push(setting.id);
            }
        }
        return requiredSettingIDs;
    }
    async getValue(id) {
        const setting = this.get(id);
        if (setting) {
            if (this.data === null) {
                let settingsFileExists;
                try {
                    settingsFileExists = (await fs.stat(this.settingsPath)).isFile();
                }
                catch (e) {
                    settingsFileExists = false;
                }
                if (settingsFileExists) {
                    this.data = (await this.yaml.read(this.settingsFileName)) || {};
                }
                else {
                    this.data = {};
                }
            }
            const rawVal = this.data[id];
            return rawVal !== undefined ? setting.toUseable(rawVal) : undefined;
        }
        else {
            log.warn(`C/settings: Attempted to get value for non-existent setting ${id}`);
            throw new Error(`Setting to get value for is not found: ${id}`);
        }
    }
    async setValue(id, val) {
        // DANGER: Never log settingâ€™s val in raw form
        log.debug(`C/settings: Set value for setting ${id}`);
        const setting = this.get(id);
        if (setting) {
            const storeable = setting.toStoreable(val);
            this.data[id] = storeable;
            await this.commit();
        }
        else {
            throw new Error(`Setting to set value for is not found: ${id}`);
        }
    }
    async deleteValue(id) {
        log.debug(`C/settings: Delete setting: ${id}`);
        delete this.data[id];
        await this.commit();
    }
    async commit() {
        log.info("C/settings: Commit new settings");
        log.debug("C/settings: Commit: Remove file");
        await fs.remove(this.settingsPath);
        log.debug("C/settings: Commit: Write new file");
        await this.yaml.write(this.settingsFileName, this.data);
    }
    get(id) {
        return this.registry.find(s => s.id === id);
    }
    register(setting) {
        log.debug("C/settings: Register setting");
        if (this.panes.find(p => p.id === setting.paneID)) {
            this.registry.push(setting);
        }
        else {
            throw new Error("Invalid pane ID");
        }
    }
    configurePane(pane) {
        this.panes.push(pane);
    }
    setUpIPC() {
        log.verbose("C/settings: Register API endpoints");
        listen('settingPaneList', async () => {
            return { panes: this.panes };
        });
        listen('settingList', async () => {
            return { settings: this.registry };
        });
        listen('settingValue', async ({ name }) => {
            return await this.getValue(name);
        });
        listen('commitSetting', async ({ name, value }) => {
            await this.setValue(name, value);
            return { success: true };
        });
        ipcMain.on('set-setting', async (evt, name, value) => {
            return await this.setValue(name, value);
        });
        ipcMain.on('get-setting', async (evt, name) => {
            const value = await this.getValue(name);
            evt.reply('get-setting', name, value);
        });
        ipcMain.on('clear-setting', async (evt, name) => {
            log.debug(`C/settings: received clear-setting request for ${name}`);
            await this.deleteValue(name);
            evt.reply('clear-setting', 'ok');
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXR0aW5ncy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sS0FBSyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBRXBDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVyQyxPQUFPLEVBQUUsT0FBTyxJQUFJLFdBQVcsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBVTFFLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLFlBRVMsTUFBYztJQUNyQiwrQ0FBK0M7SUFFeEMsRUFBVTtJQUNqQixzREFBc0Q7SUFFL0MsS0FBd0I7SUFDL0IsK0NBQStDO0lBRXhDLFFBQWlCO0lBQ3hCLGtFQUFrRTtJQUUzRCxLQUFhO1FBWmIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUdkLE9BQUUsR0FBRixFQUFFLENBQVE7UUFHVixVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQUd4QixhQUFRLEdBQVIsUUFBUSxDQUFTO1FBR2pCLFVBQUssR0FBTCxLQUFLLENBQVE7SUFJbkIsQ0FBQztJQUVKLFNBQVMsQ0FBQyxHQUFZLElBQU8sT0FBTyxHQUFRLENBQUEsQ0FBQyxDQUFDO0lBQzlDLHNEQUFzRDtJQUV0RCxXQUFXLENBQUMsR0FBTSxJQUFTLE9BQU8sR0FBVSxDQUFBLENBQUMsQ0FBQztDQUcvQztBQUdELE1BQU0sT0FBTyxjQUFjO0lBT3pCLFlBQW1CLFdBQW1CLEVBQVMsZ0JBQXdCO1FBQXBELGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQVMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFRO1FBTi9ELGFBQVEsR0FBbUIsRUFBRSxDQUFDO1FBQzlCLFVBQUssR0FBVyxFQUFF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R0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEMsR0FBRyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEVBQUUsQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLEdBQVEsRUFBRSxJQUFZLEVBQUUsRUFBRTtZQUMzRCxHQUFHLENBQUMsS0FBSyxDQUFDLGtEQUFrRCxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBRXBFLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QixHQUFHLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcblxuaW1wb3J0IHsgaXBjTWFpbiB9IGZyb20gJ2VsZWN0cm9uJztcbmltcG9ydCB7IGxpc3RlbiB9IGZyb20gJy4uL2lwYy9tYWluJztcblxuaW1wb3J0IHsgZGVmYXVsdCBhcyBZQU1MV3JhcHBlciB9IGZyb20gJy4uL2RiL2lzb2dpdC15YW1sL21haW4veWFtbC9maWxlJztcblxuXG5leHBvcnQgaW50ZXJmYWNlIFBhbmUge1xuICBpZDogc3RyaW5nO1xuICBsYWJlbDogc3RyaW5nO1xuICBpY29uPzogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCBjbGFzcyBTZXR0aW5nPFQ+IHtcbiAgY29uc3RydWN0b3IoXG5cbiAgICBwdWJsaWMgcGFuZUlEOiBzdHJpbmcsXG4gICAgLyogSUQgb2YgdGhlIHBhbmUgdG8gc2hvdyB0aGUgc2V0dGluZyB1bmRlci4gKi9cblxuICAgIHB1YmxpYyBpZDogc3RyaW5nLFxuICAgIC8qIFNldHRpbmcgSUQgc2hvdWxkIGJlIHVuaXF1ZSBhY3Jvc3MgYWxsIHNldHRpbmdzLiAqL1xuXG4gICAgcHVibGljIGlucHV0OiAndGV4dCcgfCAnbnVtYmVyJyxcbiAgICAvKiBEZXRlcm1pbmVzIGlucHV0IHdpZGdldCBzaG93biBieSBkZWZhdWx0LiAqL1xuXG4gICAgcHVibGljIHJlcXVpcmVkOiBib29sZWFuLFxuICAgIC8qIEluZGljYXRlcyB3aGV0aGVyIHRoZSBzZXR0aW5nIGlzIHJlcXVpcmVkIGZvciBhcHAgb3BlcmF0aW9uLiAqL1xuXG4gICAgcHVibGljIGxhYmVsOiBzdHJpbmcsXG4gICAgLyogU2V0dGluZyBsYWJlbCBzaG93biB0byB0aGUgdXNlciBzaG91bGQgYmUgdW5pcXVlIHdpdGhpbiBnaXZlbiBwYW5lLFxuICAgICAgIHRvIGF2b2lkIGNvbmZ1c2lvbi4gKi9cblxuICApIHt9XG5cbiAgdG9Vc2VhYmxlKHZhbDogdW5rbm93bik6IFQgeyByZXR1cm4gdmFsIGFzIFQgfVxuICAvKiBDb252ZXJ0cyBzdG9yZWQgc2V0dGluZyB2YWx1ZSB0byB1c2VhYmxlIG9iamVjdC4gKi9cblxuICB0b1N0b3JlYWJsZSh2YWw6IFQpOiBhbnkgeyByZXR1cm4gdmFsIGFzIGFueSB9XG4gIC8qIENvbnZlcnRzIEpTL1RTIG9iamVjdCB0byBzdG9yZWFibGUgdmVyc2lvbiBvZiB0aGUgc2V0dGluZy4gKi9cblxufVxuXG5cbmV4cG9ydCBjbGFzcyBTZXR0aW5nTWFuYWdlciB7XG4gIHByaXZhdGUgcmVnaXN0cnk6IFNldHRpbmc8YW55PltdID0gW107XG4gIHByaXZhdGUgcGFuZXM6IFBhbmVbXSA9IFtdO1xuICBwcml2YXRlIGRhdGE6IGFueSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHlhbWw6IFlBTUxXcmFwcGVyO1xuICBwcml2YXRlIHNldHRpbmdzUGF0aDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBhcHBEYXRhUGF0aDogc3RyaW5nLCBwdWJsaWMgc2V0dGluZ3NGaWxlTmFtZTogc3RyaW5nKSB7XG4gICAgdGhpcy5zZXR0aW5nc1BhdGggPSBwYXRoLmpvaW4oYXBwRGF0YVBhdGgsIGAke3NldHRpbmdzRmlsZU5hbWV9LnlhbWxgKTtcbiAgICBsb2cuZGVidWcoYEMvc2V0dGluZ3M6IENvbmZpZ3VyaW5nIHcvcGF0aCAke3RoaXMuc2V0dGluZ3NQYXRofWApO1xuXG4gICAgdGhpcy55YW1sID0gbmV3IFlBTUxXcmFwcGVyKGFwcERhdGFQYXRoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0TWlzc2luZ1JlcXVpcmVkU2V0dGluZ3MoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHZhciByZXF1aXJlZFNldHRpbmdJRHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBzZXR0aW5nIG9mIHRoaXMucmVnaXN0cnkpIHtcbiAgICAgIGlmIChzZXR0aW5nLnJlcXVpcmVkID09IHRydWUgJiYgKGF3YWl0IHRoaXMuZ2V0VmFsdWUoc2V0dGluZy5pZCkpID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVxdWlyZWRTZXR0aW5nSURzLnB1c2goc2V0dGluZy5pZCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXF1aXJlZFNldHRpbmdJRHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWUoaWQ6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgIGNvbnN0IHNldHRpbmcgPSB0aGlzLmdldChpZCk7XG5cbiAgICBpZiAoc2V0dGluZykge1xuICAgICAgaWYgKHRoaXMuZGF0YSA9PT0gbnVsbCkge1xuICAgICAgICBsZXQgc2V0dGluZ3NGaWxlRXhpc3RzOiBib29sZWFuO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHNldHRpbmdzRmlsZUV4aXN0cyA9IChhd2FpdCBmcy5zdGF0KHRoaXMuc2V0dGluZ3NQYXRoKSkuaXNGaWxlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBzZXR0aW5nc0ZpbGVFeGlzdHMgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2V0dGluZ3NGaWxlRXhpc3RzKSB7XG4gICAgICAgICAgdGhpcy5kYXRhID0gKGF3YWl0IHRoaXMueWFtbC5yZWFkKHRoaXMuc2V0dGluZ3NGaWxlTmFtZSkpIHx8IHt9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuZGF0YSA9IHt9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCByYXdWYWwgPSB0aGlzLmRhdGFbaWRdO1xuICAgICAgcmV0dXJuIHJhd1ZhbCAhPT0gdW5kZWZpbmVkID8gc2V0dGluZy50b1VzZWFibGUocmF3VmFsKSA6IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oYEMvc2V0dGluZ3M6IEF0dGVtcHRlZCB0byBnZXQgdmFsdWUgZm9yIG5vbi1leGlzdGVudCBzZXR0aW5nICR7aWR9YCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNldHRpbmcgdG8gZ2V0IHZhbHVlIGZvciBpcyBub3QgZm91bmQ6ICR7aWR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNldFZhbHVlKGlkOiBzdHJpbmcsIHZhbDogdW5rbm93bikge1xuICAgIC8vIERBTkdFUjogTmV2ZXIgbG9nIHNldHRpbmfigJlzIHZhbCBpbiByYXcgZm9ybVxuXG4gICAgbG9nLmRlYnVnKGBDL3NldHRpbmdzOiBTZXQgdmFsdWUgZm9yIHNldHRpbmcgJHtpZH1gKTtcblxuICAgIGNvbnN0IHNldHRpbmcgPSB0aGlzLmdldChpZCk7XG4gICAgaWYgKHNldHRpbmcpIHtcbiAgICAgIGNvbnN0IHN0b3JlYWJsZSA9IHNldHRpbmcudG9TdG9yZWFibGUodmFsKTtcbiAgICAgIHRoaXMuZGF0YVtpZF0gPSBzdG9yZWFibGU7XG4gICAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNldHRpbmcgdG8gc2V0IHZhbHVlIGZvciBpcyBub3QgZm91bmQ6ICR7aWR9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZVZhbHVlKGlkOiBzdHJpbmcpIHtcbiAgICBsb2cuZGVidWcoYEMvc2V0dGluZ3M6IERlbGV0ZSBzZXR0aW5nOiAke2lkfWApO1xuICAgIGRlbGV0ZSB0aGlzLmRhdGFbaWRdO1xuICAgIGF3YWl0IHRoaXMuY29tbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNvbW1pdCgpIHtcbiAgICBsb2cuaW5mbyhcIkMvc2V0dGluZ3M6IENvbW1pdCBuZXcgc2V0dGluZ3NcIik7XG4gICAgbG9nLmRlYnVnKFwiQy9zZXR0aW5nczogQ29tbWl0OiBSZW1vdmUgZmlsZVwiKTtcbiAgICBhd2FpdCBmcy5yZW1vdmUodGhpcy5zZXR0aW5nc1BhdGgpO1xuICAgIGxvZy5kZWJ1ZyhcIkMvc2V0dGluZ3M6IENvbW1pdDogV3JpdGUgbmV3IGZpbGVcIik7XG4gICAgYXdhaXQgdGhpcy55YW1sLndyaXRlKHRoaXMuc2V0dGluZ3NGaWxlTmFtZSwgdGhpcy5kYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0KGlkOiBzdHJpbmcpOiBTZXR0aW5nPGFueT4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LmZpbmQocyA9PiBzLmlkID09PSBpZCk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXIoc2V0dGluZzogU2V0dGluZzxhbnk+KSB7XG4gICAgbG9nLmRlYnVnKFwiQy9zZXR0aW5nczogUmVnaXN0ZXIgc2V0dGluZ1wiKTtcbiAgICBpZiAodGhpcy5wYW5lcy5maW5kKHAgPT4gcC5pZCA9PT0gc2V0dGluZy5wYW5lSUQpKSB7XG4gICAgICB0aGlzLnJlZ2lzdHJ5LnB1c2goc2V0dGluZyk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBwYW5lIElEXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjb25maWd1cmVQYW5lKHBhbmU6IFBhbmUpIHtcbiAgICB0aGlzLnBhbmVzLnB1c2gocGFuZSk7XG4gIH1cblxuICBwdWJsaWMgc2V0VXBJUEMoKSB7XG4gICAgbG9nLnZlcmJvc2UoXCJDL3NldHRpbmdzOiBSZWdpc3RlciBBUEkgZW5kcG9pbnRzXCIpO1xuXG4gICAgbGlzdGVuPHt9LCB7IHBhbmVzOiBQYW5lW10gfT5cbiAgICAoJ3NldHRpbmdQYW5lTGlzdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiB7IHBhbmVzOiB0aGlzLnBhbmVzIH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48e30sIHsgc2V0dGluZ3M6IFNldHRpbmc8YW55PltdIH0+XG4gICAgKCdzZXR0aW5nTGlzdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiB7IHNldHRpbmdzOiB0aGlzLnJlZ2lzdHJ5IH07XG4gICAgfSk7XG5cbiAgICBsaXN0ZW48eyBuYW1lOiBzdHJpbmcgfSwgeyB2YWx1ZTogYW55IH0+XG4gICAgKCdzZXR0aW5nVmFsdWUnLCBhc3luYyAoeyBuYW1lIH0pID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFZhbHVlKG5hbWUpIGFzIGFueTtcbiAgICB9KTtcblxuICAgIGxpc3Rlbjx7IG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSB9LCB7IHN1Y2Nlc3M6IHRydWUgfT5cbiAgICAoJ2NvbW1pdFNldHRpbmcnLCBhc3luYyh7IG5hbWUsIHZhbHVlIH0pID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUobmFtZSwgdmFsdWUpO1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgIH0pXG5cbiAgICBpcGNNYWluLm9uKCdzZXQtc2V0dGluZycsIGFzeW5jIChldnQ6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZXRWYWx1ZShuYW1lLCB2YWx1ZSk7XG4gICAgfSk7XG5cbiAgICBpcGNNYWluLm9uKCdnZXQtc2V0dGluZycsIGFzeW5jIChldnQ6IGFueSwgbmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuZ2V0VmFsdWUobmFtZSk7XG4gICAgICBldnQucmVwbHkoJ2dldC1zZXR0aW5nJywgbmFtZSwgdmFsdWUpO1xuICAgIH0pO1xuXG4gICAgaXBjTWFpbi5vbignY2xlYXItc2V0dGluZycsIGFzeW5jIChldnQ6IGFueSwgbmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBsb2cuZGVidWcoYEMvc2V0dGluZ3M6IHJlY2VpdmVkIGNsZWFyLXNldHRpbmcgcmVxdWVzdCBmb3IgJHtuYW1lfWApO1xuXG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZVZhbHVlKG5hbWUpO1xuICAgICAgZXZ0LnJlcGx5KCdjbGVhci1zZXR0aW5nJywgJ29rJyk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==